- en: Uncovering the Limitations of Traditional DiD Method
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 揭示传统DiD方法的局限性
- en: 原文：[https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a](https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a](https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a)
- en: Dealing with Multiple Time Periods and Staggered Treatment Timing
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 处理多个时间周期和错开处理时间
- en: '[](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[![Nazlı
    Alagöz](../Images/7275df914f7e3e492861ffe20df10b8f.png)](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    [Nazlı Alagöz](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[![Nazlı
    Alagöz](../Images/7275df914f7e3e492861ffe20df10b8f.png)](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    [Nazlı Alagöz](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)'
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    ·11 min read·Feb 21, 2023
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: ·发表于[Towards Data Science](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    ·阅读时间11分钟·2023年2月21日
- en: --
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: '![](../Images/44dea706340ac506d236a11bad3313ec.png)'
  id: totrans-6
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/44dea706340ac506d236a11bad3313ec.png)'
- en: Cover image, generated by the author using [NightCafé](https://creator.nightcafe.studio/)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 封面图，由作者使用[NightCafé](https://creator.nightcafe.studio/)生成
- en: Difference-in-Differences (DiD) is a popular statistical method for estimating
    the causal impact of interventions in observational studies by comparing the outcome
    difference between two groups before and after treatment. Most DiD guides focus
    solely on the canonical DiD setup where there are only two periods and two groups
    (treated and nontreated).
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 差分中的差分（DiD）是一种流行的统计方法，通过比较干预前后两个组的结果差异来估计观察研究中的因果影响。大多数DiD指南专注于经典的DiD设置，其中仅有两个时期和两个组（处理组和对照组）。
- en: However, in many real-world applications of DiD, there are multiple time periods
    and variations in the treatment timing. **Recent studies on DiD show that DiD
    may give significantly misleading estimates of the treatment effects in these
    situations**. In certain scenarios, the treatment effect estimates may show an
    opposite sign compared to the actual treatment effect.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，在许多DiD的实际应用中，存在多个时间周期和处理时间的变化。**近期对DiD的研究表明，在这些情况下，DiD可能会给出显著误导性的处理效果估计**。在某些场景下，处理效果估计可能与实际处理效果的符号相反。
- en: '**In this article, I’ll discuss an important issue that can occur in the canonical
    DiD setup when staggered treatment timing and multiple time periods are present**.
    I’ll also present solutions to address this issue. It’s important to note that
    while I will focus solely on this one issue in DiD, for a more comprehensive overview
    of other potential challenges, you can refer to [my previous article](/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65).
    Additionally, I’ll provide further resources at the end of this article for those
    who wish to delve deeper into DiD issues.'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: '**在这篇文章中，我将讨论在经典DiD设置中，当存在错开处理时间和多个时间周期时可能出现的重要问题**。我还会提出解决这个问题的方案。值得注意的是，虽然我将专注于DiD中的这一问题，但对于其他潜在挑战的更全面概述，你可以参考[我之前的文章](/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65)。此外，我将在本文末尾提供进一步的资源，供那些希望深入探讨DiD问题的人。'
- en: Lockdowns and Music Consumption Example
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 封锁与音乐消费实例
- en: To provide an example, let's consider a hypothetical scenario. Imagine that
    we run a music streaming service that operates in various countries. We want to
    investigate the effects of Covid-19 lockdowns on music consumption in these countries.
    By examining the impact of reduced mobility, we can gain insights into whether
    listening to music is associated with certain activities, such as commuting, as
    opposed to working from home.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 举个例子，我们考虑一个假设的场景。假设我们运营一个在多个国家运行的音乐流媒体服务。我们希望调查Covid-19封锁对这些国家音乐消费的影响。通过检查减少流动性的影响，我们可以深入了解听音乐是否与某些活动（如通勤）相关，而不是在家工作。
- en: Since we cannot manipulate the implementation of lockdowns, it’s not feasible
    to conduct an A/B test to examine their effects. Therefore, we must rely on observational
    data. In this case, we utilize the varying times that lockdowns were imposed in
    the countries included in our dataset. In this example, the treatment is the implementation
    of a lockdown. For this toy example, I simulated a dataset, the details of which
    can be found [in my previous article](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65)
    and [this Gist](https://gist.github.com/nazlialagoz/b66b15b295029029bca9162d1df00cef).
    All the analysis code is also available in [this Gist](https://gist.github.com/nazlialagoz/85d0713f157ffeacdc71b581a0da07d0).
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们无法操控封锁的实施，因此无法进行A/B测试来检查其效果。因此，我们必须依赖观察性数据。在这种情况下，我们利用了数据集中包含的各国实施封锁的不同时间。在这个例子中，治疗是封锁的实施。对于这个玩具示例，我模拟了一个数据集，详细信息可以在[我的上一篇文章](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65)和[这个Gist](https://gist.github.com/nazlialagoz/b66b15b295029029bca9162d1df00cef)中找到。所有分析代码也可以在[这个Gist](https://gist.github.com/nazlialagoz/85d0713f157ffeacdc71b581a0da07d0)中找到。
- en: '[PRE0]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '![](../Images/15f5cf79cb4b9e3d3d32e2e41ca2d706.png)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/15f5cf79cb4b9e3d3d32e2e41ca2d706.png)'
- en: A snapshot of the data for selected columns, image by the author.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 选定列的数据快照，图片由作者提供。
- en: 'We have data on 1000 units or customers for each period that they are observed.
    `cohort_period`indicates in which period a unit is treated and therefore which
    treatment cohort they belong to. A unit is treated ( `treat = 1`) when `cohort_period
    >= period.` `hrs_listened` is the outcome of interest indicating the total music
    consumption (hours). There are two cohorts in the dataset: the early-treated cohort
    and the late-treated cohort. The early cohort is treated in period 2 and the late
    cohort is treated in period 3\. In total, there are five periods, starting from
    period 0 and ending with period 4.'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 我们有1000个单位或客户的数据，涵盖他们被观察到的每个周期。`cohort_period`指示一个单位在哪个周期接受治疗，因此属于哪个治疗队列。当`cohort_period
    >= period`时，单位被视为接受治疗（`treat = 1`）。`hrs_listened`是我们关注的结果，表示总音乐消费（小时）。数据集中有两个队列：早期治疗队列和晚期治疗队列。早期队列在第2周期接受治疗，晚期队列在第3周期接受治疗。总共有五个周期，从第0周期开始，到第4周期结束。
- en: As we have an observational dataset, where treatment is not randomly assigned,
    a simple difference-in-means approach cannot be employed to estimate the treatment
    effect. Instead, we aim to distinguish the treatment effects from customer- and
    season-related factors, and to achieve this, we utilize a DiD framework.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们拥有一个观察性数据集，其中治疗不是随机分配的，因此不能使用简单的均值差异方法来估计治疗效果。相反，我们的目标是将治疗效果与客户和季节相关因素区分开来，为此我们使用了DiD框架。
- en: Just before we get into DiD, although this is not possible in real-life applications,
    in this simulated dataset I know the true treatment effects for each treatment
    cohort and period. Below, I visualize these as they will be necessary to evaluate
    the estimated treatment effects in the next steps.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们进入DiD之前，虽然在现实应用中这并不可能，但在这个模拟数据集中，我知道每个治疗队列和周期的真实治疗效果。如下图所示，这些效果将在下一步评估估计的治疗效果时是必要的。
- en: '![](../Images/21f5cbd4922d737f3964f05d45b5b33e.png)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/21f5cbd4922d737f3964f05d45b5b33e.png)'
- en: True treatment effects per cohort and period, image by the author.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 每个队列和周期的真实治疗效果，图片由作者提供。
- en: As seen in this graph, the true treatment effects for both cohorts are positive
    for all the periods. The treatment effect increases over time for both cohorts.
    However, overall the treatment effect is greater and increases quite a lot over
    the treated periods for cohort 2 compared to cohort 3\. Thus, there is heterogeneity
    in treatment effects across treatment cohorts and periods.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 从这张图表中可以看出，两个队列在所有时期的真实处理效果都是正的。两个队列的处理效果随时间增加。然而，总体而言，与队列 3 相比，队列 2 在处理时期的处理效果更大且增加显著。因此，不同处理队列和时期之间存在处理效果的异质性。
- en: Canonical DiD
  id: totrans-23
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 经典 DiD
- en: 'Suppose that we are not aware that having multiple periods and staggered treatment
    can lead to misleading estimates when using the canonical DiD method. Thus, naively,
    we decide to use the canonical DiD setup to account for seasonality in the listening
    patterns and customer-specific effects in our observational dataset. We use a
    DiD setup like this [1]:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们没有意识到多期和错开的处理可能在使用经典 DiD 方法时导致误导性估计。因此，我们天真地决定使用经典 DiD 设置来考虑听力模式的季节性和我们观察数据集中的客户特定效应。我们使用这样的
    DiD 设置 [1]：
- en: '![](../Images/062129395b7660bb69c16370b5ca0e6d.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/062129395b7660bb69c16370b5ca0e6d.png)'
- en: Canonical DiD, image by the author.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 经典 DiD，图片由作者提供。
- en: '*Y*ᵢₜ is the outcome of interest. αᵢ is the unit-fixed effects that controls
    for time-constant unit characteristics. γₜ is the time-fixed effects that controls
    for time trends or seasonality. D*ᵢₜ* is the treatment dummy at time *t* for unit
    *i.* ϵᵢₜ is the random error. The coefficient of interest βᵈᵈindicates the treatment
    effect.'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: '*Y*ᵢₜ 是关注的结果。αᵢ 是单位固定效应，用于控制时间不变的单位特征。γₜ 是时间固定效应，用于控制时间趋势或季节性。D*ᵢₜ* 是单位 *i*
    在时间 *t* 的处理虚拟变量。ϵᵢₜ 是随机误差。关注的系数 βᵈᵈ 表示处理效果。'
- en: 'We estimate the treatment effect using canonical DiD setup in R:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用 R 中的经典 DiD 设置来估计处理效果：
- en: '[PRE1]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '![](../Images/adbb0868f1b2df6270f98e77665c5648.png)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/adbb0868f1b2df6270f98e77665c5648.png)'
- en: Canonical DiD estimates, image by the author.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 经典 DiD 估计，图片由作者提供。
- en: 'The estimated treatment effect is -0.47 (though not statistically significant)!
    But how can this be when we have positive (and generally big) treatment effects
    for each treated cohort and period? **The reason for this is that DiD estimator
    is a weighted average of all possible two-group/two-period DiD estimators in the
    data** [2]. In other words, the canonical DiD estimate can be decomposed into
    a weighted average two-group x two-period treatment estimates. This is called
    **Goodman-Bacon decomposition**. Let’s get the weights and estimates used to calculate
    the canonical DiD estimates using ‘bacondecomp’ package [2]:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 估计的处理效果是 -0.47（虽然统计上不显著）！但当我们对每个处理组和时期都有正的（且通常较大的）处理效果时，这怎么可能呢？**原因在于 DiD 估计量是数据中所有可能的两组/两期
    DiD 估计量的加权平均** [2]。换句话说，经典 DiD 估计可以分解为加权平均的两组 x 两期处理估计。这被称为**Goodman-Bacon 分解**。我们来使用‘bacondecomp’
    包 [2] 获取计算经典 DiD 估计所用的权重和估计值：
- en: '[PRE2]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '![](../Images/991331562951380ee12132bbd7ae77a2.png)'
  id: totrans-34
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/991331562951380ee12132bbd7ae77a2.png)'
- en: Goodman-Bacon Decomposition, image by the author.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: Goodman-Bacon 分解，图片由作者提供。
- en: 'In the image above, I show the Goodman-Bacon decomposition for our canonical
    DiD estimate. Indeed, if we sum these estimates up with their respective weights
    we get exactly the treatment effect estimated by the canonical DiD: 0.5 x -4.53
    + 0.5 x 3.59 = -0.47\. Since we have 2 groups and 2 periods where the treatment
    indicator changes we have 2 comparisons.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 在上面的图像中，我展示了我们的经典 DiD 估计的 Goodman-Bacon 分解。确实，如果我们将这些估计值按其各自的权重相加，就会得到经典 DiD
    估计的处理效果：0.5 x -4.53 + 0.5 x 3.59 = -0.47。由于我们有 2 个组和 2 个时期，其中处理指示符发生变化，我们有 2 个比较。
- en: Let’s examine this table in detail to see what the issue is. We start with the
    second comparison where the treatment estimate is 3.59\. Here, the control group
    (‘untreated’) is the late-treated group, cohort 3\. The ‘treated’ group is the
    early-treated group, cohort 2\. I am putting the ‘treated’ and ‘untreated’ in
    quotes because as you might remember all groups in our dataset are eventually
    treated. ‘treated’ and ‘untreated’, here, rather refer to groups used as **treatment**
    and **control** groups by the canonical DiD estimator.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们详细检查这个表格，看看问题在哪里。我们从第二个比较开始，其中处理估计为 3.59。在这里，对照组（‘未处理’）是晚处理组，队列 3。‘处理’组是早处理组，队列
    2。我将‘处理’和‘未处理’放在引号中，因为如你所记，数据集中所有组最终都会被处理。在这里，‘处理’和‘未处理’更准确地说指的是经典 DiD 估计器所使用的**处理**和**对照**组。
- en: Let’s move on to the first comparison highlighted in red where the estimate
    is -4.53\. **Here, the early-treated group (cohort 2) is used as the control group
    for the late-treated group by the canonical estimator**! This comparison does
    not make much sense. Still, everything would work fine if the treatment effects
    were constant across cohorts and periods. In this application, as well as in many
    others, this is not the case. Since the treatment effects are higher and dynamically
    increasing for the early-treated group, in comparison it seems as if the treatment
    effect for the late-treated group is negative! **The comparisons where the early-treated
    group is used as the control group for the late-treated groups are called forbidden
    comparisons** [2].
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们继续讨论第一个用红色突出显示的比较，其估计值为-4.53。**在这里，早期治疗组（队列2）被用作晚期治疗组的控制组，这由标准估计器提供**！这个比较没有多大意义。然而，如果治疗效果在各个队列和时期之间保持不变，一切都会正常。在这个应用中以及许多其他应用中，情况并非如此。由于早期治疗组的治疗效果更高并且动态增加，比较起来似乎晚期治疗组的治疗效果是负的！**将早期治疗组用作晚期治疗组控制组的比较称为禁止比较**[2]。
- en: How to address this problem?
  id: totrans-39
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何解决这个问题？
- en: The main solution to this problem is to not restrict the treatment effect to
    a single estimate and to carefully choose the control group. In the next steps,
    we are going to see how to do this. First, I am going to demonstrate how to address
    this problem without a particular DiD package. Later, I will use an R package
    that’s specifically designed for DiD with multiple time periods.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 解决这个问题的主要方法是不要将治疗效果限制为单一估计，并仔细选择控制组。在接下来的步骤中，我们将看到如何做到这一点。首先，我将展示如何在没有特定DiD包的情况下解决这个问题。随后，我将使用专为多时间期设计的R包。
- en: Addressing the issue without relying on a specific DiD package
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 解决不依赖于特定DiD包的问题
- en: 'First, let''s address this problem without relying on a specific DiD package.
    I know that there are two things that I need to do to get a good estimate of the
    treatment effect: **(1) not restrict the treatment effect estimation to a single
    coefficient, (2) make sure that I have a good control group** [3][4].'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们解决这个问题，而不依赖于特定的DiD包。我知道为了获得治疗效果的良好估计，我需要做两件事：**（1）不将治疗效果估计限制为单一系数，（2）确保我有一个好的控制组**[3][4]。
- en: In essence, it is necessary to account for variations in treatment effects across
    different cohorts and periods. Moreover, it's crucial to ensure that there are
    untreated observations available for each period being assessed for treatment
    effects. This is because using treated observations as controls can lead to significantly
    misleading results, as previously noted.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 本质上，有必要考虑不同队列和时期的治疗效果的变化。此外，确保每个被评估的时期都有未治疗的观察数据也至关重要。因为使用治疗过的观察数据作为控制组可能会导致显著误导的结果，正如之前所提到的那样。
- en: 'As you remember, I only have treated groups in this dataset: the cohort treated
    in period 2 (early-treated) and the cohort treated in period 3 (late-treated).
    Clearly, I cannot estimate any treatment effects for the late-treated cohort as
    there are no not-yet-treated observations to use as controls when they are treated.'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 正如你记得的那样，我的数据集中只有治疗组：在第二期接受治疗的队列（早期治疗组）和在第三期接受治疗的队列（晚期治疗组）。显然，由于没有尚未治疗的观察数据可以作为对照组，我无法估计晚期治疗队列的任何治疗效果。
- en: There is more hope for the early-treated group as when they were treated the
    late-treated group was not yet treated. This means that we can certainly estimate
    a treatment effect in period 2 for the early treated cohort. However, we cannot
    estimate any treatment effects for further periods as there are no untreated observations
    from period 3 onward. This is why we will drop periods that have no untreated
    units. Let’s code this up.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 早期治疗组的希望更大，因为在他们接受治疗时，晚期治疗组尚未接受治疗。这意味着我们可以在第二期对早期治疗队列估计治疗效果。然而，由于从第三期开始没有未治疗的观察数据，我们无法估计进一步时期的治疗效果。这就是为什么我们将剔除没有未治疗单位的时期。让我们来编码实现这一点。
- en: '[PRE3]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Now, it is time to estimate the only treatment effect that we can estimate.
    We will only estimate a treatment effect for the early treated group in period
    2.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，是时候估计我们唯一可以估计的治疗效果了。我们将只对第二期的早期治疗组估计治疗效果。
- en: '[PRE4]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '![](../Images/f9ca9b36528b05c2c5ba3b2b3258d4df.png)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/f9ca9b36528b05c2c5ba3b2b3258d4df.png)'
- en: Regression results after accounting for staggered treatment, image by the author.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 在考虑了错位治疗后的回归结果，图片由作者提供。
- en: 'As seen from the results above, the estimated treatment effect is much more
    sensible this time: 3.6\. This means that the lockdown resulted in a 3.6 hours
    increase in music consumption for this cohort in this period. The point estimate
    is not exactly equal to the true treatment effect (approx. 4 hrs) because of the
    noise in the data.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 从上述结果可以看出，估计的处理效果这次要合理得多：3.6。这意味着封锁措施导致该队列在这个时期的音乐消费增加了3.6小时。点估计值与真实处理效果（大约4小时）不完全相等，因为数据中存在噪声。
- en: Addressing the issue using ‘did’ package
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用‘did’包来解决问题
- en: As an alternative to doing everything manually let’s use the `[did](https://bcallaway11.github.io/did/index.html)`
    [package by Callaway and Sant’Anna](https://bcallaway11.github.io/did/index.html)
    [3]. What we need to do is to use `att_gt` function to estimate the treatment
    effects at cohort- and period-level using the right control group. Below, the
    code is given. One thing here that is important is that you need to specify the
    `control_group` as `'notyettreated'` because this function by default tries to
    find an untreated group to use as the control group.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 作为手动处理所有事情的替代方案，我们可以使用[**did**](https://bcallaway11.github.io/did/index.html)
    [Callaway和Sant’Anna的包](https://bcallaway11.github.io/did/index.html) [3]。我们需要做的是使用`att_gt`函数，利用正确的控制组来估计队列和时期层面的处理效果。下面给出了代码。这里需要注意的一点是，你需要将`control_group`指定为`'notyettreated'`，因为该函数默认会尝试找到一个未处理的组作为控制组。
- en: '[PRE5]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '![](../Images/f862df108ad3bd9c38ebe29f766d4a64.png)'
  id: totrans-55
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/f862df108ad3bd9c38ebe29f766d4a64.png)'
- en: did package results, image by author.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 打包结果，图像由作者提供。
- en: '`att_gt` function estimates cohort-period-specific treatment effects, i.e.,
    `ATT(g,t)`. We are interested in the treatment effect for cohort 2 in period 2
    and this is given as 3.4 hrs. This is almost the same as the treatment effects
    we estimated without relying on this package. There can be some differences in
    the estimates due to the exact process of estimation. The ‘treatment effects’
    for the period before the treatment is also reported in the first line and this
    is not statistically significant as expected because in this case, I know that
    there are no systemic changes to the outcome variable prior to the intervention.
    We can also graph these results with a single line of code:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '`att_gt`函数估计队列-时期特定的处理效果，即`ATT(g,t)`。我们对第2队列第2时期的处理效果感兴趣，结果为3.4小时。这与我们在没有依赖这个包的情况下估计的处理效果几乎相同。由于估计的精确过程，估计值之间可能会有一些差异。处理前时期的‘处理效果’也在第一行中报告，这在统计上并不显著，因为在这种情况下，我知道干预之前结果变量没有系统性变化。我们还可以用一行代码将这些结果绘制成图：'
- en: '[PRE6]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '![](../Images/8af2f0d0cf4c9208732971e0605e22b8.png)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/8af2f0d0cf4c9208732971e0605e22b8.png)'
- en: Visualizing did package results, image by author.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 可视化打包结果，图像由作者提供。
- en: This graph is also useful to check the overtime trends pre- and post-treatment.
    This type of visualization comes especially handy when estimating treatment effects
    for many cohorts and periods, though in this case I only have one cohort and two
    periods for which I can make estimations.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 这个图表也有助于检查处理前后随时间的趋势。这种可视化在估计许多队列和时期的处理效果时特别有用，尽管在这种情况下我只有一个队列和两个时期可以进行估计。
- en: Using this package has additional advantages compared to my manual method relevant
    here. As long as you specify the required variables for the `att_gt` function
    you don’t need to do much else. You don't even need to drop the periods without
    untreated observations as this package already takes this into account and estimates
    effects only for periods where there is a valid control group. Another nice advantage
    is that the package as default reports uniform confidence intervals that accounts
    for multiple hypothesis testing (and this results in wider confidence bands due
    to a higher critical value used). The differences in the exact estimates between
    the two methods are due to the exact estimation method is not exactly the same.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这个包相比于我的手动方法有额外的优点。只要你为`att_gt`函数指定了所需的变量，你不需要做太多其他的操作。你甚至不需要删除没有未处理观察的时期，因为这个包已经考虑了这一点，并且只对有有效控制组的时期进行效果估计。另一个优点是，包默认报告考虑了多重假设检验的均匀置信区间（这会导致由于使用了更高的临界值而使置信带变宽）。两个方法之间的精确估计差异是由于精确的估计方法不完全相同。
- en: Coming back to our example, we see that the lockdown has a positive effect on
    music consumption (though we were able to estimate this only for one cohort in
    one period). This indicates that actually music listening is complementary to
    staying at home.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 回到我们的例子，我们看到封锁对音乐消费有积极的影响（尽管我们只能对一个群体在一个时期进行估计）。这表明实际上音乐听取与居家隔离是互补的。
- en: Conclusions
  id: totrans-64
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 结论
- en: 'Here are the key takeaways from this article:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是本文的关键要点：
- en: Canonical DiD can lead to misleading estimates in applications where there are
    multiple periods and variations in treatment timing.
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 经典的DiD方法在存在多个时间周期和治疗时间变化的应用中可能会导致误导性的估计。
- en: To prevent this issue, one can use estimators that account for multiple periods
    and variations in treatment timing.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了防止这个问题，可以使用考虑多个时间周期和治疗时间变化的估计量。
- en: These estimators are suitable for staggered treatment contexts because they
    allow for flexible treatment effects and only estimate treatment effects for periods
    in which there is a valid control group.
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这些估计量适用于错开处理背景，因为它们允许灵活的处理效果，并且仅估计存在有效对照组的时期的处理效果。
- en: This is not the only issue that might come up when doing DiD analysis. For other
    issues, [see my previous post on event studies](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65).
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这不是进行DiD分析时可能出现的唯一问题。有关其他问题，[请参阅我之前关于事件研究的文章](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65)。
- en: '*References*'
  id: totrans-70
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '*参考文献*'
- en: '[1] Angrist, J. D., & Pischke, J. S. (2009). [*Mostly harmless econometrics:
    An empiricist’s companion*](https://www.mostlyharmlesseconometrics.com/). Princeton
    university press.'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: '[1] Angrist, J. D., & Pischke, J. S. (2009). [*大多数无害的计量经济学：经验主义者的伴侣*](https://www.mostlyharmlesseconometrics.com/).
    普林斯顿大学出版社。'
- en: '[2] Goodman-Bacon, Andrew. (2021) “[Difference-in-differences with variation
    in treatment timing](https://www.nber.org/papers/w25018).” *Journal of Econometrics*
    225.2: 254–277.'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '[2] Goodman-Bacon, Andrew. (2021) “[具有治疗时间变化的差分中的差分](https://www.nber.org/papers/w25018).”
    *计量经济学期刊* 225.2: 254–277.'
- en: '[3] Callaway, B., & Sant’Anna, P. H. (2021). [Difference-in-differences with
    multiple time periods](https://doi.org/10.1016/j.jeconom.2020.12.001). *Journal
    of Econometrics*, *225*(2), 200–230.'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '[3] Callaway, B., & Sant’Anna, P. H. (2021). [具有多个时间周期的差分中的差分](https://doi.org/10.1016/j.jeconom.2020.12.001).
    *计量经济学期刊*, *225*(2), 200–230.'
- en: '[4] Wooldridge, J. M. (2021). [Two-way fixed effects, the two-way mundlak regression,
    and difference-in-differences estimators](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3906345).
    *Available at SSRN 3906345*.'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '[4] Wooldridge, J. M. (2021). [双向固定效应、双向 Mundlak 回归和差分中的差分估计量](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3906345).
    *可在SSRN 3906345获取*.'
- en: Other Useful Resources on DiD
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 其他有用的DiD资源
- en: '***Videos:***'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: '***视频：***'
- en: '[Pedro H.C. Sant’Anna — “Difference-in-Differences with Multiple Time Periods”](https://www.youtube.com/watch?v=VLviaylakAo&t=62s)'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: '[Pedro H.C. Sant’Anna — “具有多个时间周期的差分中的差分”](https://www.youtube.com/watch?v=VLviaylakAo&t=62s)'
- en: '[Andrew Goodman-Bacon “Difference-in-Differences with Variation in Treatment
    Timing”](https://www.youtube.com/watch?v=m1xSMNTKoMs)'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '[Andrew Goodman-Bacon “具有治疗时间变化的差分中的差分”](https://www.youtube.com/watch?v=m1xSMNTKoMs)'
- en: '***A nice paper that summarizes recent DiD literature:***'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '***一篇总结近期DiD文献的好论文：***'
- en: Roth, J., Sant’Anna, P. H., Bilinski, A., & Poe, J. (2022). [What’s trending
    in difference-in-differences? A synthesis of the recent econometrics literature](https://arxiv.org/abs/2201.01194).
    *arXiv preprint arXiv:2201.01194*.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: Roth, J., Sant’Anna, P. H., Bilinski, A., & Poe, J. (2022). [差分中的差分的趋势是什么？近期计量经济学文献的综述](https://arxiv.org/abs/2201.01194).
    *arXiv预印本arXiv:2201.01194*.
- en: '[***A compilation of many DiD-related resources.***](https://asjadnaqvi.github.io/DiD/docs/02_R/)'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: '[***许多与DiD相关的资源汇编。***](https://asjadnaqvi.github.io/DiD/docs/02_R/)'
- en: Thank you for reading!
  id: totrans-82
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 感谢阅读！
- en: '*If you liked the post and would like to see more of my articles consider*
    [*following me*](https://medium.com/@nalagoz13)*.*'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '*如果你喜欢这篇文章并希望看到更多我的文章，可以* [*关注我*](https://medium.com/@nalagoz13)*。*'
- en: '***Disclaimer****: I write to learn so it might be that you spot an error in
    the article or code. If you do so, please let me know.*'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: '***免责声明****：我写作是为了学习，因此你可能会发现文章或代码中的错误。如果发现，请告知我。*'
