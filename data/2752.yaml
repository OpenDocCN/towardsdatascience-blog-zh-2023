- en: 'Geospatial Data Engineering: Spatial Indexing'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: åœ°ç†ç©ºé—´æ•°æ®å·¥ç¨‹ï¼šç©ºé—´ç´¢å¼•
- en: åŸæ–‡ï¼š[https://towardsdatascience.com/geospatial-data-engineering-spatial-indexing-18200ef9160b?source=collection_archive---------0-----------------------#2023-08-31](https://towardsdatascience.com/geospatial-data-engineering-spatial-indexing-18200ef9160b?source=collection_archive---------0-----------------------#2023-08-31)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸæ–‡ï¼š[https://towardsdatascience.com/geospatial-data-engineering-spatial-indexing-18200ef9160b?source=collection_archive---------0-----------------------#2023-08-31](https://towardsdatascience.com/geospatial-data-engineering-spatial-indexing-18200ef9160b?source=collection_archive---------0-----------------------#2023-08-31)
- en: Optimizing queries, improving runtimes, and geospatial data science applications
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¼˜åŒ–æŸ¥è¯¢ã€æé«˜è¿è¡Œæ—¶é—´å’Œåœ°ç†ç©ºé—´æ•°æ®ç§‘å­¦åº”ç”¨
- en: '[](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)[![Dea
    Bardhoshi](../Images/14ce0986fc2a4a192797a52ed9908d1e.png)](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)[](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)
    [Dea Bardhoshi](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)[![Dea
    Bardhoshi](../Images/14ce0986fc2a4a192797a52ed9908d1e.png)](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)[](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)
    [Dea Bardhoshi](https://deabardhoshi.medium.com/?source=post_page-----18200ef9160b--------------------------------)'
- en: Â·
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: Â·
- en: '[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd61c58ba988e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&user=Dea+Bardhoshi&userId=d61c58ba988e&source=post_page-d61c58ba988e----18200ef9160b---------------------post_header-----------)
    Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)
    Â·6 min readÂ·Aug 31, 2023[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F18200ef9160b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&user=Dea+Bardhoshi&userId=d61c58ba988e&source=-----18200ef9160b---------------------clap_footer-----------)'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: '[å…³æ³¨](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd61c58ba988e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&user=Dea+Bardhoshi&userId=d61c58ba988e&source=post_page-d61c58ba988e----18200ef9160b---------------------post_header-----------)
    åœ¨ [Towards Data Science](https://towardsdatascience.com/?source=post_page-----18200ef9160b--------------------------------)
    Â·6åˆ†é’Ÿé˜…è¯»Â·2023å¹´8æœˆ31æ—¥[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F18200ef9160b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&user=Dea+Bardhoshi&userId=d61c58ba988e&source=-----18200ef9160b---------------------clap_footer-----------)'
- en: --
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: '[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F18200ef9160b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&source=-----18200ef9160b---------------------bookmark_footer-----------)![](../Images/29fefc0d1aca68839035e1184d404196.png)'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F18200ef9160b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgeospatial-data-engineering-spatial-indexing-18200ef9160b&source=-----18200ef9160b---------------------bookmark_footer-----------)![](../Images/29fefc0d1aca68839035e1184d404196.png)'
- en: Photo by [Tamas Tuzes-Katai](https://unsplash.com/@tamas_tuzeskatai?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾ç‰‡ç”± [Tamas Tuzes-Katai](https://unsplash.com/@tamas_tuzeskatai?utm_source=medium&utm_medium=referral)
    æä¾›ï¼Œæ¥æºäº [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
- en: '**Intro: why is a spatial index useful?**'
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '**ä»‹ç»ï¼šç©ºé—´ç´¢å¼•ä¸ºä½•æœ‰ç”¨ï¼Ÿ**'
- en: In doing geospatial data science work, it is very important to think about optimizing
    the code you are writing. How can you make datasets with hundreds of millions
    of rows aggregate or join faster? This is where concepts such as spatial indices
    come in. In this post, I will talk about how a spatial index gets implemented,
    what its benefits and limitations are, and take a look at Uberâ€™s open source H3
    indexing library for some cool spatial data science applications. Letâ€™s get started!
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿›è¡Œåœ°ç†ç©ºé—´æ•°æ®ç§‘å­¦å·¥ä½œæ—¶ï¼Œä¼˜åŒ–ä½ ç¼–å†™çš„ä»£ç æ˜¯éå¸¸é‡è¦çš„ã€‚å¦‚ä½•è®©æ‹¥æœ‰æ•°äº¿è¡Œçš„æ•°æ®åº“é›†åˆæˆ–è”æ¥æ›´å¿«ï¼Ÿè¿™å°±æ˜¯ç©ºé—´ç´¢å¼•ç­‰æ¦‚å¿µå‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®ºç©ºé—´ç´¢å¼•çš„å®ç°æ–¹å¼ï¼Œå®ƒçš„å¥½å¤„å’Œå±€é™æ€§ï¼Œå¹¶çœ‹çœ‹
    Uber çš„å¼€æº H3 ç´¢å¼•åº“åœ¨ä¸€äº›æœ‰è¶£çš„ç©ºé—´æ•°æ®ç§‘å­¦åº”ç”¨ä¸­çš„è¡¨ç°ã€‚æˆ‘ä»¬å¼€å§‹å§ï¼
- en: ğŸ—º Whatâ€™s a spatial index?
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ğŸ—º ä»€ä¹ˆæ˜¯ç©ºé—´ç´¢å¼•ï¼Ÿ
- en: 'A regular index is the kind of thing you might find at the end of a book: a
    list of words and where they have shown up in the text. This helps you quickly
    look up any reference to a word youâ€™re interested in within a certain text. Without
    this handy tool, you would need to manually look through every page of your book,
    searching for that one mention you wanted to read about.'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: å¸¸è§„ç´¢å¼•å°±åƒä½ åœ¨ä¹¦ç±æœ«å°¾æ‰¾åˆ°çš„å†…å®¹ï¼šä¸€ä¸ªå•è¯çš„åˆ—è¡¨ä»¥åŠè¿™äº›å•è¯åœ¨æ–‡æœ¬ä¸­å‡ºç°çš„ä½ç½®ã€‚è¿™å¸®åŠ©ä½ å¿«é€ŸæŸ¥æ‰¾åœ¨ç‰¹å®šæ–‡æœ¬ä¸­ä½ æ„Ÿå…´è¶£çš„å•è¯çš„ä»»ä½•å‚è€ƒã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–¹ä¾¿çš„å·¥å…·ï¼Œä½ å°†éœ€è¦æ‰‹åŠ¨ç¿»é˜…ä¹¦ä¸­çš„æ¯ä¸€é¡µï¼Œå¯»æ‰¾ä½ æƒ³é˜…è¯»çš„é‚£ä¸€ä¸ªæåŠã€‚
- en: 'In modern databases, this issue of querying and searching is also very pertinent.
    Indexing often makes looking up data faster than filtering, and you can create
    indices based on a column of interest. For geospatial data in particular, engineers
    often need to look at operations like â€œintersectionâ€ or â€œis nearby toâ€. How can
    we make a spatial index so that these operations are as fast as possible? First,
    letâ€™s take a look at some of this geospatial data:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ç°ä»£æ•°æ®åº“ä¸­ï¼ŒæŸ¥è¯¢å’Œæœç´¢çš„é—®é¢˜ä¹Ÿéå¸¸ç›¸å…³ã€‚ç´¢å¼•é€šå¸¸æ¯”è¿‡æ»¤æ›´å¿«åœ°æŸ¥æ‰¾æ•°æ®ï¼Œä½ å¯ä»¥åŸºäºæ„Ÿå…´è¶£çš„åˆ—åˆ›å»ºç´¢å¼•ã€‚å¯¹äºåœ°ç†ç©ºé—´æ•°æ®ï¼Œå·¥ç¨‹å¸ˆä»¬é€šå¸¸éœ€è¦è€ƒè™‘è¯¸å¦‚â€œäº¤é›†â€æˆ–â€œé™„è¿‘â€çš„æ“ä½œã€‚æˆ‘ä»¬å¦‚ä½•åˆ¶ä½œä¸€ä¸ªç©ºé—´ç´¢å¼•ï¼Œä½¿è¿™äº›æ“ä½œå°½å¯èƒ½å¿«é€Ÿï¼Ÿé¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸€äº›åœ°ç†ç©ºé—´æ•°æ®ï¼š
- en: '![](../Images/c982cddb36a9445d0b96d1be3fa1e2a2.png)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c982cddb36a9445d0b96d1be3fa1e2a2.png)'
- en: Two non-intersecting features (image by author)
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸¤ä¸ªä¸ç›¸äº¤çš„ç‰¹å¾ï¼ˆå›¾ç‰‡æ¥æºï¼šä½œè€…ï¼‰
- en: 'Letâ€™s say that we want to run a query to determine if these two shapes are
    intersecting. By construction, spatial databases create their index out of a bounding
    box that contains the geometry:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: å‡è®¾æˆ‘ä»¬æƒ³è¿è¡Œä¸€ä¸ªæŸ¥è¯¢æ¥ç¡®å®šè¿™ä¸¤ä¸ªå½¢çŠ¶æ˜¯å¦ç›¸äº¤ã€‚æ ¹æ®æ„é€ ï¼Œç©ºé—´æ•°æ®åº“åˆ›å»ºçš„ç´¢å¼•æ˜¯ç”±åŒ…å«å‡ ä½•å›¾å½¢çš„è¾¹ç•Œæ¡†ç»„æˆçš„ï¼š
- en: '![](../Images/44bf89146e3a9b186681beea21640257.png)'
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/44bf89146e3a9b186681beea21640257.png)'
- en: Making a large bounding box (image by author)
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: åˆ¶ä½œä¸€ä¸ªå¤§çš„è¾¹ç•Œæ¡†ï¼ˆå›¾ç‰‡æ¥æºï¼šä½œè€…ï¼‰
- en: 'For answering whether these two features intersect, the database will compare
    whether the two bounding boxes have any area in common. As you can see, this can
    quickly lead to false positives. To fix this issue, spatial databases like PostGIS
    typically partition these large bounding boxes into smaller and smaller ones:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†å›ç­”è¿™ä¸¤ä¸ªç‰¹å¾æ˜¯å¦ç›¸äº¤ï¼Œæ•°æ®åº“å°†æ¯”è¾ƒä¸¤ä¸ªè¾¹ç•Œæ¡†æ˜¯å¦æœ‰ä»»ä½•å…¬å…±åŒºåŸŸã€‚å¦‚ä½ æ‰€è§ï¼Œè¿™å¯èƒ½ä¼šè¿…é€Ÿå¯¼è‡´å‡é˜³æ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåƒ PostGIS è¿™æ ·çš„ç©ºé—´æ•°æ®åº“é€šå¸¸ä¼šå°†è¿™äº›å¤§çš„è¾¹ç•Œæ¡†åˆ’åˆ†æˆè¶Šæ¥è¶Šå°çš„éƒ¨åˆ†ï¼š
- en: '![](../Images/7ef73239cf2fb2f4667a8165ed474620.png)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/7ef73239cf2fb2f4667a8165ed474620.png)'
- en: 'Going smaller: making child bounding boxes (image by author)'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: æ›´å°çš„å°ºå¯¸ï¼šåˆ¶ä½œå­è¾¹ç•Œæ¡†ï¼ˆå›¾ç‰‡æ¥æºï¼šä½œè€…ï¼‰
- en: 'These partitions are stored in R-trees. R-trees are a hierarchical data structure:
    they keep track of the large â€œparentâ€ bounding box, its children, its childrenâ€™s
    children and so on. Every parentâ€™s bounding box contains its childrenâ€™s bounding
    boxes:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›åˆ†åŒºå­˜å‚¨åœ¨ R æ ‘ä¸­ã€‚R æ ‘æ˜¯ä¸€ç§å±‚æ¬¡æ•°æ®ç»“æ„ï¼šå®ƒè·Ÿè¸ªå¤§çš„â€œçˆ¶â€è¾¹ç•Œæ¡†ã€å®ƒçš„å­èŠ‚ç‚¹ã€å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œç­‰ç­‰ã€‚æ¯ä¸ªçˆ¶èŠ‚ç‚¹çš„è¾¹ç•Œæ¡†åŒ…å«å®ƒå­èŠ‚ç‚¹çš„è¾¹ç•Œæ¡†ï¼š
- en: '![](../Images/a1d9e21d516843ed561c8c5e9e0b2245.png)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a1d9e21d516843ed561c8c5e9e0b2245.png)'
- en: R-tree visualized (image by author)
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: R æ ‘å¯è§†åŒ–ï¼ˆå›¾ç‰‡æ¥æºï¼šä½œè€…ï¼‰
- en: The operation â€œintersectâ€ is one of the key operations that benefits from this
    structure. While querying an interesection, the database looks down this tree
    asking â€œdoes the current bounding box intersect the feature of interest?â€. If
    yes, it looks at that bounding boxâ€™s children and asks the same question. As it
    does so, it is able to quickly traverse the tree, skipping the branches that do
    not have an intersection and thus improve the queryâ€™s performance. In the end,
    it returns the intersecting geometry as desired.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: æ“ä½œâ€œäº¤é›†â€æ˜¯ä»è¿™ç§ç»“æ„ä¸­å—ç›Šçš„å…³é”®æ“ä½œä¹‹ä¸€ã€‚åœ¨æŸ¥è¯¢äº¤é›†æ—¶ï¼Œæ•°æ®åº“ä¼šæ²¿ç€è¿™æ£µæ ‘å‘ä¸‹æŸ¥è¯¢ï¼Œé—®â€œå½“å‰çš„è¾¹ç•Œæ¡†æ˜¯å¦ä¸æ„Ÿå…´è¶£çš„ç‰¹å¾ç›¸äº¤ï¼Ÿâ€ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä¼šæŸ¥çœ‹è¯¥è¾¹ç•Œæ¡†çš„å­èŠ‚ç‚¹ï¼Œå¹¶æå‡ºç›¸åŒçš„é—®é¢˜ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ƒèƒ½å¤Ÿå¿«é€Ÿéå†æ ‘ï¼Œè·³è¿‡æ²¡æœ‰äº¤é›†çš„åˆ†æ”¯ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚æœ€åï¼Œå®ƒä¼šè¿”å›æ‰€éœ€çš„äº¤é›†å‡ ä½•å›¾å½¢ã€‚
- en: 'ğŸ§° In Practice: trying out a spatial index with GeoPandas'
  id: totrans-26
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ğŸ§° å®è·µä¸­ï¼šå°è¯•ä½¿ç”¨ GeoPandas çš„ç©ºé—´ç´¢å¼•
- en: Letâ€™s now take a concrete look at what using a regular row-wise procedure vs
    a spatial index looks like. Iâ€™ll be using 2 datasets representing NYCâ€™s Census
    Tracts as well as City Facilities (both licensed through Open Data, and available
    [here](https://data.cityofnewyork.us/City-Government/2010-Census-Tracts/fxpq-c8ku)
    and [here](https://data.cityofnewyork.us/City-Government/Facilities-Database-Shapefile/2fpa-bnsx)).
    First, letâ€™s try out the â€œintersectionâ€ operation in GeoPandas on one of the Census
    Tract geometries. â€˜Intersectionâ€™ in GeoPandas is a row-wise function checking
    each row of the column of interest against our geometry and looking at whether
    they intersect or not.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨è®©æˆ‘ä»¬å…·ä½“çœ‹çœ‹ä½¿ç”¨å¸¸è§„è¡Œçº§è¿‡ç¨‹ä¸ç©ºé—´ç´¢å¼•çš„ä¸åŒã€‚æˆ‘å°†ä½¿ç”¨ä»£è¡¨çº½çº¦å¸‚äººå£æ™®æŸ¥åŒºå’Œå¸‚è®¾æ–½çš„ä¸¤ä¸ªæ•°æ®é›†ï¼ˆå‡é€šè¿‡å¼€æ”¾æ•°æ®è®¸å¯æä¾›ï¼Œå¯åœ¨[è¿™é‡Œ](https://data.cityofnewyork.us/City-Government/2010-Census-Tracts/fxpq-c8ku)å’Œ[è¿™é‡Œ](https://data.cityofnewyork.us/City-Government/Facilities-Database-Shapefile/2fpa-bnsx)è·å¾—ï¼‰ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨
    GeoPandas ä¸­å°è¯•å¯¹ä¸€ä¸ªäººå£æ™®æŸ¥åŒºå‡ ä½•å›¾å½¢è¿›è¡Œâ€œäº¤é›†â€æ“ä½œã€‚åœ¨ GeoPandas ä¸­ï¼Œâ€œäº¤é›†â€æ˜¯ä¸€ä¸ªé€è¡Œå‡½æ•°ï¼Œæ£€æŸ¥æ¯ä¸€è¡Œçš„åˆ—æ˜¯å¦ä¸æˆ‘ä»¬çš„å‡ ä½•å›¾å½¢ç›¸äº¤ã€‚
- en: 'GeoPandas also offers a spatial index operation that uses R-trees and allows
    us to perform intersections as well. Here is a runtime comparison of the two methods
    over 100 runs of the intersection operation (note: because the default intersection
    function is slow, I only selected around 100 geometries from the original dataset):'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: GeoPandas è¿˜æä¾›äº†ä¸€ç§ä½¿ç”¨ R æ ‘çš„ç©ºé—´ç´¢å¼•æ“ä½œï¼Œå…è®¸æˆ‘ä»¬æ‰§è¡Œäº¤é›†æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™ä¸¤ç§æ–¹æ³•åœ¨ 100 æ¬¡äº¤é›†æ“ä½œä¸­çš„è¿è¡Œæ—¶æ¯”è¾ƒï¼ˆæ³¨æ„ï¼šç”±äºé»˜è®¤çš„äº¤é›†å‡½æ•°è¾ƒæ…¢ï¼Œæˆ‘åªé€‰æ‹©äº†åŸå§‹æ•°æ®é›†ä¸­çš„å¤§çº¦
    100 ä¸ªå‡ ä½•å›¾å½¢ï¼‰ï¼š
- en: '![](../Images/0569dd39053e6799e0c77a2d9b3c0b72.png)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/0569dd39053e6799e0c77a2d9b3c0b72.png)'
- en: ğŸ’¨ How much faster is a spatial index? (image by author)
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: ğŸ’¨ ç©ºé—´ç´¢å¼•å¿«äº†å¤šå°‘ï¼Ÿï¼ˆå›¾ç‰‡ç”±ä½œè€…æä¾›ï¼‰
- en: 'As you can see, the spatial index approach offered much improved performance
    over the vanilla intersection method. In fact, here are the 95% confidence intervals
    for the runtimes of each:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚ä½ æ‰€è§ï¼Œç©ºé—´ç´¢å¼•æ–¹æ³•ç›¸æ¯”æ™®é€šçš„äº¤é›†æ–¹æ³•æä¾›äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚å®é™…ä¸Šï¼Œè¿™é‡Œæ˜¯æ¯ç§æ–¹æ³•è¿è¡Œæ—¶é—´çš„ 95% ç½®ä¿¡åŒºé—´ï¼š
- en: '![](../Images/c2db49b0dc45f54338391bf7ce0cb757.png)![](../Images/5376d53925f26a635b891b3d8d775adb.png)'
  id: totrans-32
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c2db49b0dc45f54338391bf7ce0cb757.png)![](../Images/5376d53925f26a635b891b3d8d775adb.png)'
- en: Great! Then, why would we ever not want to use a spatial indexing? Are there
    cases when it offers no benefits? Well, yes. Some of these limitations are due
    to the way spatial indexing stores the leaves in the data. It turns out that the
    way the raw data is distributed affects how bounding boxes are placed into the
    R-tree. Specifically, if a large chunk of the data is concentrated in the same
    geographic space, they will tend to share the same parents and thus be grouped
    together in the same branches. This can lead to skewed trees that donâ€™t offer
    much optimization when querying.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: å¤ªå¥½äº†ï¼é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰æ—¶ä¸æƒ³ä½¿ç”¨ç©ºé—´ç´¢å¼•å‘¢ï¼Ÿæ˜¯å¦æœ‰äº›æƒ…å†µä¸‹å®ƒæ²¡æœ‰ä»»ä½•å¥½å¤„ï¼Ÿç¡®å®æœ‰ã€‚è¿™äº›é™åˆ¶ä¸­çš„ä¸€äº›æ˜¯ç”±äºç©ºé—´ç´¢å¼•å­˜å‚¨æ•°æ®å¶å­çš„æ–¹å¼ã€‚ç»“æœè¡¨æ˜ï¼ŒåŸå§‹æ•°æ®çš„åˆ†å¸ƒæ–¹å¼ä¼šå½±å“è¾¹ç•Œæ¡†åœ¨
    R æ ‘ä¸­çš„ä½ç½®ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœå¤§é‡æ•°æ®é›†ä¸­åœ¨åŒä¸€åœ°ç†ç©ºé—´ï¼Œå®ƒä»¬å¾€å¾€ä¼šå…±äº«ç›¸åŒçš„çˆ¶èŠ‚ç‚¹ï¼Œä»è€Œè¢«åˆ†ç»„åœ¨åŒä¸€åˆ†æ”¯ä¸­ã€‚è¿™å¯èƒ½å¯¼è‡´æ ‘çš„ä¸å‡è¡¡ï¼Œä»è€Œåœ¨æŸ¥è¯¢æ—¶æ— æ³•æä¾›å¤ªå¤šä¼˜åŒ–ã€‚
- en: ğŸ’» What do other spatial indices look like?
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ğŸ’» å…¶ä»–ç©ºé—´ç´¢å¼•æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
- en: Other companies have also adapted their own spatial indices. Uber uses H3, a
    hexagonal hierarchical indexing system that partitions the world into equal-area
    hexagons. Hexagons have many benefits when modeling peopleâ€™s movement around a
    city or for problems like calculating a radius. Geospatial data is bucketed into
    these hexagons, which serve as the companyâ€™s main unit of analysis. The grid is
    constructed by overlaying 122 hexagonal cells onto an icosahedron-map projection,
    and it supports a wide range of functions including aggregation, joining and machine
    learning applications.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: å…¶ä»–å…¬å¸ä¹Ÿé€‚åº”äº†è‡ªå·±çš„ç©ºé—´ç´¢å¼•ã€‚Uber ä½¿ç”¨ H3ï¼Œè¿™æ˜¯ä¸€ä¸ªå°†ä¸–ç•Œåˆ’åˆ†ä¸ºç­‰é¢ç§¯å…­è¾¹å½¢çš„åˆ†å±‚ç´¢å¼•ç³»ç»Ÿã€‚å…­è¾¹å½¢åœ¨å»ºæ¨¡äººä»¬åœ¨åŸå¸‚ä¸­çš„ç§»åŠ¨æˆ–è§£å†³å¦‚è®¡ç®—åŠå¾„ç­‰é—®é¢˜æ—¶å…·æœ‰è®¸å¤šä¼˜ç‚¹ã€‚åœ°ç†ç©ºé—´æ•°æ®è¢«åˆ’åˆ†åˆ°è¿™äº›å…­è¾¹å½¢ä¸­ï¼Œä½œä¸ºå…¬å¸çš„ä¸»è¦åˆ†æå•ä½ã€‚ç½‘æ ¼æ˜¯é€šè¿‡å°†
    122 ä¸ªå…­è¾¹å½¢å•å…ƒè¦†ç›–åˆ°äºŒåé¢ä½“åœ°å›¾æŠ•å½±ä¸Šæ¥æ„å»ºçš„ï¼Œæ”¯æŒåŒ…æ‹¬èšåˆã€è¿æ¥å’Œæœºå™¨å­¦ä¹ åº”ç”¨åœ¨å†…çš„å¹¿æ³›åŠŸèƒ½ã€‚
- en: 'This system as well as a lot of its functionality is open-source and available
    on GitHub for analysis. One of the functions of the H3 API is converting latitude
    and longitude points into strings representing a unique Hexagon, according to
    the specified resolution. Letâ€™s do this operation over the entire Facilities Database
    and also convert the hexagon strings into polygons:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªç³»ç»Ÿä»¥åŠå®ƒçš„è®¸å¤šåŠŸèƒ½æ˜¯å¼€æºçš„ï¼Œå¯ä»¥åœ¨ GitHub ä¸Šè¿›è¡Œåˆ†æã€‚H3 API çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯å°†ç»çº¬åº¦ç‚¹è½¬æ¢ä¸ºè¡¨ç¤ºå”¯ä¸€å…­è¾¹å½¢çš„å­—ç¬¦ä¸²ï¼Œæ ¹æ®æŒ‡å®šçš„åˆ†è¾¨ç‡ã€‚æˆ‘ä»¬æ¥å¯¹æ•´ä¸ªè®¾æ–½æ•°æ®åº“è¿›è¡Œè¿™ä¸ªæ“ä½œï¼Œå¹¶å°†å…­è¾¹å½¢å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤šè¾¹å½¢ï¼š
- en: 'One question that often comes up in these spatial data analysis projects is
    how many projects in the hexagons are categorized by some column, say â€œagencyâ€.
    Luckily, this is very easy to calculate and visualize now that we have the data
    bucketed into H3 hexagons:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™äº›ç©ºé—´æ•°æ®åˆ†æé¡¹ç›®ä¸­ï¼Œä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å…­è¾¹å½¢ä¸­çš„é¡¹ç›®æœ‰å¤šå°‘è¢«æŸä¸ªåˆ—ï¼Œæ¯”å¦‚â€œæœºæ„â€æ‰€åˆ†ç±»ã€‚å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å°†æ•°æ®åˆ’åˆ†åˆ° H3 å…­è¾¹å½¢ä¸­ï¼Œè¿™å¾ˆå®¹æ˜“è®¡ç®—å’Œå¯è§†åŒ–ï¼š
- en: '![](../Images/a45b3cfe9d8f6df4a64ed5e9983db703.png)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a45b3cfe9d8f6df4a64ed5e9983db703.png)'
- en: Which agencies have the most facilities? (image by author)
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: å“ªäº›æœºæ„æœ‰æœ€å¤šçš„è®¾æ–½ï¼Ÿï¼ˆå›¾ç‰‡æ¥æºäºä½œè€…ï¼‰
- en: In this case, you can see the DCAS (Department of Citywide Administrative Services)
    and PARKS (Department of Parks and Recreation) are the two agencies with the most
    facilities per each hexagon. This likely makes sense as these two agencies would
    have more physical facilities (think admin buildings or recreational areas like
    parks).
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥çœ‹åˆ° DCASï¼ˆåŸå¸‚è¡Œæ”¿æœåŠ¡éƒ¨ï¼‰å’Œ PARKSï¼ˆå…¬å›­ä¸å¨±ä¹éƒ¨ï¼‰æ˜¯æ¯ä¸ªå…­è¾¹å½¢ä¸­è®¾æ–½æœ€å¤šçš„ä¸¤ä¸ªæœºæ„ã€‚è¿™å¾ˆæœ‰é“ç†ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæœºæ„é€šå¸¸ä¼šæœ‰æ›´å¤šçš„å®ä½“è®¾æ–½ï¼ˆæ¯”å¦‚è¡Œæ”¿å»ºç­‘æˆ–åƒå…¬å›­è¿™æ ·çš„ä¼‘é—²åŒºåŸŸï¼‰ã€‚
- en: Conclusion
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç»“è®º
- en: 'Spatial indices, as you saw, are very useful optimization tools for geospatial
    data science and analysis. In the case of a simple intersection query, using a
    spatial index dramatically improved the performance of the query compared to the
    standard GeoPandas intersection function. There were many nuances to how this
    index is implemented, as well as its implications, like having huge branches of
    clustered data. As we saw, companies have developed their own solutions: one example
    is Uberâ€™s H3 open-source index, which allows us to answer various spatial analysis
    questions. While I demonstrated an agency-based facilities count operation, H3
    provides a baseline for other more complex machine learning applications.'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚ä½ æ‰€è§ï¼Œç©ºé—´ç´¢å¼•æ˜¯åœ°ç†ç©ºé—´æ•°æ®ç§‘å­¦å’Œåˆ†æä¸­éå¸¸æœ‰ç”¨çš„ä¼˜åŒ–å·¥å…·ã€‚åœ¨ç®€å•çš„äº¤é›†æŸ¥è¯¢ä¸­ï¼Œä½¿ç”¨ç©ºé—´ç´¢å¼•æ˜¾è‘—æé«˜äº†æŸ¥è¯¢æ€§èƒ½ï¼Œç›¸æ¯”äºæ ‡å‡†çš„ GeoPandas äº¤é›†å‡½æ•°ã€‚è¿™ç§ç´¢å¼•çš„å®ç°å’Œå®ƒçš„å½±å“æœ‰è®¸å¤šç»†å¾®ä¹‹å¤„ï¼Œæ¯”å¦‚æ‹¥æœ‰å·¨å¤§çš„æ•°æ®é›†ç¾¤åˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå„å…¬å¸å·²ç»å¼€å‘äº†è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼šä¸€ä¸ªä¾‹å­æ˜¯
    Uber çš„ H3 å¼€æºç´¢å¼•ï¼Œå®ƒå…è®¸æˆ‘ä»¬å›ç­”å„ç§ç©ºé—´åˆ†æé—®é¢˜ã€‚è™½ç„¶æˆ‘æ¼”ç¤ºäº†åŸºäºæœºæ„çš„è®¾æ–½è®¡æ•°æ“ä½œï¼Œä½† H3 ä¸ºå…¶ä»–æ›´å¤æ‚çš„æœºå™¨å­¦ä¹ åº”ç”¨æä¾›äº†åŸºå‡†ã€‚
- en: If you like this kind of content but want to learn about urban planning tech
    more broadly, I also write a newsletter called [â€œThe Zoned Out Chroniclesâ€](https://deabardhoshi.substack.com).
    I encourage you to check it out!
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ å–œæ¬¢è¿™ç±»å†…å®¹ï¼Œä½†æƒ³è¦æ›´å¹¿æ³›åœ°äº†è§£åŸå¸‚è§„åˆ’æŠ€æœ¯ï¼Œæˆ‘ä¹Ÿå†™äº†ä¸€ä»½åä¸º[â€œThe Zoned Out Chroniclesâ€](https://deabardhoshi.substack.com)çš„é€šè®¯ã€‚æˆ‘é¼“åŠ±ä½ å»çœ‹çœ‹ï¼
- en: Thanks for reading!
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: æ„Ÿè°¢é˜…è¯»ï¼
