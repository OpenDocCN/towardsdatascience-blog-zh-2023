# Pandas ä¸­çš„æ»‘åŠ¨çª—å£

> åŸæ–‡ï¼š[`towardsdatascience.com/sliding-windows-in-pandas-40b79edefa34?source=collection_archive---------1-----------------------#2023-03-29`](https://towardsdatascience.com/sliding-windows-in-pandas-40b79edefa34?source=collection_archive---------1-----------------------#2023-03-29)

## ä½¿ç”¨é‡å çª—å£æŠ€æœ¯è¯†åˆ«æ—¶é—´åºåˆ—æ•°æ®ä¸­çš„æ¨¡å¼

[](https://avrilaysha.medium.com/?source=post_page-----40b79edefa34--------------------------------)![Avril Aysha](https://avrilaysha.medium.com/?source=post_page-----40b79edefa34--------------------------------)[](https://towardsdatascience.com/?source=post_page-----40b79edefa34--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page-----40b79edefa34--------------------------------) [Avril Aysha](https://avrilaysha.medium.com/?source=post_page-----40b79edefa34--------------------------------)

Â·

[å…³æ³¨](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fb016782a8709&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsliding-windows-in-pandas-40b79edefa34&user=Avril+Aysha&userId=b016782a8709&source=post_page-b016782a8709----40b79edefa34---------------------post_header-----------) å‘è¡¨äº [Towards Data Science](https://towardsdatascience.com/?source=post_page-----40b79edefa34--------------------------------) Â· 10 åˆ†é’Ÿé˜…è¯» Â· 2023 å¹´ 3 æœˆ 29 æ—¥[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F40b79edefa34&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsliding-windows-in-pandas-40b79edefa34&user=Avril+Aysha&userId=b016782a8709&source=-----40b79edefa34---------------------clap_footer-----------)

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F40b79edefa34&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsliding-windows-in-pandas-40b79edefa34&source=-----40b79edefa34---------------------bookmark_footer-----------)![](img/a1d1cf6d0a5270fa1d5be035f895a29c.png)

å›¾ç‰‡ç”± [å°¤é‡‘Â·èµ«æ–¯å­£äºšç§‘å¤«](https://unsplash.com/it/@eugenechystiakov?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) æä¾›ï¼Œæ¥è‡ª [Unsplash](https://unsplash.com/photos/B-h3so_5UKA?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

çª—å£æŠ€æœ¯ä½¿æ•°æ®åˆ†æå¸ˆèƒ½å¤Ÿè¯†åˆ«æ—¶é—´åºåˆ—æ•°æ®ä¸­çš„æœ‰ä»·å€¼æ¨¡å¼ã€‚æ»‘åŠ¨çª—å£ç‰¹åˆ«å¼ºå¤§ï¼Œå› ä¸ºå®ƒä»¬å…è®¸ä½ æ¯”å…¶ä»–æŠ€æœ¯æ›´æ—©åœ°å‘ç°æ¨¡å¼ã€‚åœ¨åšå‡ºå…³é”®å†³ç­–çš„å‡ åˆ†é’Ÿï¼ˆæˆ–å‡ ç§’é’Ÿï¼‰æ—©ä¸€ç‚¹å¯èƒ½ä¼šä¸ºä½ èŠ‚çœèµ„é‡‘ï¼Œè¿™æ˜¯ä¸€é¡¹é‡è¦çš„åŠŸèƒ½ã€‚

æœ¬æ–‡å°†å±•ç¤ºåœ¨`pandas`ä¸­æ‰§è¡Œçª—å£æ“ä½œçš„ä¸‰ç§æ–¹æ³•ï¼Œå¹¶è®¨è®ºæ¯ç§æ–¹æ³•çš„æƒè¡¡å’Œå¥½å¤„ã€‚åˆ°æœ€åï¼Œä½ å°†èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªç±»ä¼¼äºä¸‹é¢è¿™æ ·çš„æ»‘åŠ¨çª—å£å¯è§†åŒ–ï¼š

![](img/6b2a4896b580e0058fd59a8176824fa3.png)

ä½œè€…æä¾›çš„å›¾ç‰‡

æƒ³è±¡ä¸€ä¸‹ä½ æ˜¯ Uber æˆ– Lyft çš„å¸æœºã€‚ä½ åœ¨çº½çº¦é©¾é©¶ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªä¹˜å®¢â€¦â€¦åŒæ—¶è¿˜åœ¨çƒ§ç€æ˜‚è´µçš„æ±½æ²¹ã€‚è¿™ä¸å¤ªå¥½ã€‚ä½ éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥æœ€å¤§åŒ–è¿…é€Ÿè·å¾—æ–°ä¹˜å®¢çš„æœºä¼šã€‚ä½ è¯¥æ€ä¹ˆåšï¼Ÿ

ä½ å¯ä»¥é‡‡å–ç»éªŒé©±åŠ¨çš„æ–¹æ³•ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´æµ‹è¯•ä¸åŒç­–ç•¥æ¥æ‰¾å‡ºçº½çº¦çš„é«˜éœ€æ±‚åŒºåŸŸã€‚ä½ å¯ä»¥å°è¯•ç¬¬ä¸€å¤©ä»ä¸€ä¸ªç¤¾åŒºå¼€å§‹ï¼Œç¬¬äºŒå¤©ä»å¦ä¸€ä¸ªç¤¾åŒºå¼€å§‹ï¼Œä¾æ­¤ç±»æ¨â€¦â€¦ä½†çº½çº¦å¸‚å¾ˆå¤§ï¼Œè¿™æ ·åšéœ€è¦èŠ±è´¹*å¾ˆé•¿*æ—¶é—´æ‰èƒ½å¼€å§‹ä»¥ä»»ä½•ç¨‹åº¦çš„ä¿¡å¿ƒè¯†åˆ«å‡ºæ¨¡å¼ã€‚

é‡‡ç”¨**æ•°æ®é©±åŠ¨çš„æ–¹æ³•**ä¼šæ›´æœ‰æ•ˆã€‚è¿™æ­£æ˜¯æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­è¦åšçš„ã€‚

å¼€å§‹å§ ğŸš€

## æ•°æ®é›†

æˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ªçº½çº¦å¸‚å‡ºç§Ÿè½¦å’Œè±ªåè½¦å§”å‘˜ä¼šï¼ˆTLCï¼‰æ—…è¡Œè®°å½•*æ•°æ®é›†çš„ 1 å°æ—¶æ‹¼è½¦ï¼ˆUber/Lyftï¼‰æ•°æ®ï¼Œè¯¥æ•°æ®é›†ä» 2022 å¹´ 1 æœˆçš„å®Œæ•´æ•°æ®é›†ä¸­å­æ ·æœ¬æå–ã€‚ä½ å¯ä»¥[ä¸‹è½½å®Œæ•´çš„ Parquet æ–‡ä»¶](https://d37ci6vzurychx.cloudfront.net/trip-data/fhvhv_tripdata_2022-01.parquet)ï¼ˆ2022 å¹´ 1 æœˆï¼‰ã€‚è¿™åŒ…å«äº†è¶…è¿‡ 1450 ä¸‡æ¬¡çš„ä¹˜è½¦æ•°æ®ï¼ï¼ˆï¼‰è¦å¤åˆ¶æœ¬æ–‡ä½¿ç”¨çš„æ•°æ®é›†ï¼Œè¯·å°†æ•°æ®å­æ ·æœ¬æå–åˆ°å‰ 100K è¡Œã€‚ä½ ä¹Ÿå¯ä»¥[ç›´æ¥è®¿é—®æ•°æ®å’Œç¬”è®°æœ¬](https://github.com/rrpelgrim/sliding-windows-pandas)çš„ä¸“ç”¨ Github ä»“åº“ã€‚

```py
df = pd.read_parquet("fhvhv_tripdata_2022-01.parquet").head(100_000)
```

è®°ä½ï¼šæˆ‘ä»¬çš„ç›®æ ‡æ˜¯**è¯†åˆ«éœ€æ±‚å³°å€¼åŒºåŸŸï¼Œå®šä¹‰ä¸ºæ¯å•ä½æ—¶é—´çš„è¯·æ±‚æ•°é‡ã€‚**

# 1\. å¿«é€Ÿç²—ç•¥ï¼šå¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œ GroupBy

![](img/1174363574132195f1f9ac852f304885.png)

ä½œè€…æä¾›çš„å›¾ç‰‡

æˆ‘ä»¬å°†å¼€å§‹å¯¹æ•´ä¸ª 1 å°æ—¶æ•°æ®é›†è¿›è¡Œéå¸¸ç²—ç•¥çš„å¤„ç†ï¼Œä»¥è¯†åˆ«é«˜éœ€æ±‚åŒºåŸŸã€‚

åœ¨ä½¿ç”¨`time_mask`å°†æ•°æ®å­é›†æå–åˆ°ç‰¹å®šå°æ—¶ï¼Œå¹¶æŒ‰`request_datetime`åˆ—æ’åºå€¼ä¹‹åï¼Œè¿™åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ª groupby æ“ä½œã€‚

```py
# define time mask
time_mask = (df['request_datetime'].dt.month == 1) & \
            (df['request_datetime'].dt.day == 1) & \
            (df['request_datetime'].dt.hour == 0) 

# sort values
one_hour = df[time_mask].sort_values(by=['request_datetime'])

# perform a simple groupby with .count()
high_demand = one_hour[['PULocationID','hvfhs_license_num']].groupby(['PULocationID']).count()
```

æˆ‘ä»¬ç°åœ¨æœ‰æ¯ä¸ªå–è½¦åœ°ç‚¹çš„è¯·æ±‚æ•°é‡åˆ—è¡¨ã€‚è®©æˆ‘ä»¬æ¸…ç†åˆ—åå¹¶æ’åºå€¼ä»¥è·å–æœ‰æ„ä¹‰çš„è¾“å‡ºã€‚

```py
high_demand = high_demand.rename(columns={'hvfhs_license_num':'n_requests'})
high_demand.sort_values(by='n_requests', ascending=False, inplace=True)
high_demand.head(10)
```

![](img/98a688ed6632f2d6d12e8fecf61674a9.png)

ä½œè€…ä»[è¿™ä¸ªç¬”è®°æœ¬]ç”Ÿæˆçš„æ•°æ®è¾“å‡º

å¤ªå¥½äº†ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥è¯†åˆ«å‡ºæ•°æ®ä¸­éœ€æ±‚æœ€é«˜çš„å‰ 10 ä¸ªå–è½¦åŒºåŸŸã€‚æˆ‘ä»¬å¯ä»¥æ¯å°æ—¶æ‰¹é‡è¿è¡Œä¸€æ¬¡è¿™ä¸ªä»£ç ã€‚è¿™å¾ˆæ£’â€¦â€¦ä½†ä»…ä»…æ˜¯è¿™æ ·ã€‚

ä»¥æ¯å°æ—¶ä¸ºæ‰¹æ¬¡å¤„ç†æ•°æ®æ„å‘³ç€å¸æœºåªèƒ½åœ¨*æ¯å°æ—¶ç»“æŸæ—¶*æ”¶åˆ°é«˜éœ€æ±‚åŒºåŸŸçš„ä¿¡å·ã€‚å¦‚æœé«˜å³°å®é™…ä¸Šå‘ç”Ÿåœ¨é‚£ä¸ªå°æ—¶çš„å‰ 15 åˆ†é’Ÿç”šè‡³ 5 åˆ†é’Ÿå†…å‘¢ï¼Ÿé‚£ä¹ˆï¼Œæ€¥åŒ†åŒ†åœ°èµ¶åˆ°é‚£ä¸ªåŸåŒºåªä¼šå‘ç°é«˜å³°éœ€æ±‚æ—©å·²è¿‡å»ï¼Œæ¯«æ— ç”¨å¤„ã€‚

# 2\. Pandas ä¸­çš„æ»‘åŠ¨çª—å£

![](img/3ff46ba016b001212ea1a49c580ed6f8.png)

ä½œè€…æä¾›çš„å›¾åƒ

å¸æœºä»¬ä¸æ»¡æ„ã€‚æˆ‘ä»¬éœ€è¦åšå¾—æ›´å¥½ã€‚è®©æˆ‘ä»¬ç¼–å†™ä¸€äº›ä»£ç ï¼Œå°†æˆ‘ä»¬çš„ä¸€å°æ—¶æ•°æ®åˆ†å‰²æˆ[tumbling windows](https://pathway.com/glossary/tumbling-window) æ¯ 15 åˆ†é’Ÿä¸€ä¸ªçª—å£ã€‚è¿™æ ·æˆ‘ä»¬å°†è·å¾—æ›´å¤šçš„ç»†èŠ‚ï¼Œå¹¶èƒ½ç»™å¸æœºæä¾›æ›´æœ‰å¸®åŠ©çš„æŒ‡ç¤ºï¼Œå‘Šè¯‰ä»–ä»¬ä½•æ—¶åˆ°è¾¾åŸå¸‚çš„å“ªä¸ªéƒ¨åˆ†ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pandas çš„`pivot_table()`å’Œ`.resample()`æ–¹æ³•æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚æˆ‘ä»¬éœ€è¦å°†æ•°æ®æ¡†çš„ç´¢å¼•è®¾ç½®ä¸ºä¸€ä¸ª datetime åˆ—ã€‚ç”±äºæˆ‘ä»¬å¯¹è¯·æ±‚æ•°é‡æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`request_datetime`åˆ—ã€‚

æ³¨æ„ï¼Œæ•°æ®é›†æŒ‰è¯·æ±‚çš„é¡ºåºæœªæ­£ç¡®æ’åºï¼Œå¹¶ä¸”åŒ…æ‹¬ä¸€äº›åœ¨å‰ä¸€å¹´åˆå¤œä¹‹å‰è¯·æ±‚çš„è¡Œç¨‹ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬å…ˆæ¸…ç†è¿™äº›æ•°æ®ã€‚

```py
# subset df to requests from 2022 only
requests = df[['request_datetime', 'on_scene_datetime', 'pickup_datetime', 'dropoff_datetime', 'PULocationID', 'DOLocationID']][df.request_datetime.dt.year==2022]

# sort by request_datetime
requests.sort_values(by=['request_datetime'], inplace=True)

# set request_datetime as index
requests.set_index('request_datetime', inplace=True)

requests.head()
```

æˆ‘ä»¬çš„æ•°æ®æ¡†ç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![](img/68e0cc65d98c57006727bc7ec50dffbd.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

è®°ä½ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ•°æ®é›†åˆ†ç»„åˆ° 15 åˆ†é’Ÿçš„çª—å£ä¸­ï¼Œæ¯ä¸ªçª—å£å¯¹åº”ä¸€ä¸ªæ¥é€åŒºçš„è¯·æ±‚æ•°é‡ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¸Œæœ›è¾“å‡ºå…·æœ‰ 4 è¡Œï¼ˆ15 x 4 = 60 åˆ†é’Ÿï¼‰å’Œæ¯ä¸ª PULocationID çš„åˆ—ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€è§†è¡¨ï¼š

```py
# expand df to have a unique column for each PULocationID
pivot = pd.pivot_table(
    requests, 
    values='pickup_datetime', 
    index=requests.index,
    columns=['PULocationID'], 
    aggfunc='count'
)

pivot.head()
```

![](img/27444de101ba31efca250adc0b75f012.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

è¿™æ˜¯ä¸€ä¸ªç¨€ç–çš„æ•°æ®æ¡†ï¼Œå¯¹äºæ¯ä¸€è¡Œï¼ˆè¯·æ±‚ï¼‰ï¼Œåœ¨å¯¹åº”äºè¯¥è¯·æ±‚çš„æ¥é€åŒºçš„åˆ—ä¸­ä»…æœ‰ä¸€ä¸ªè®¡æ•°ï¼ˆ1ï¼‰ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨`.sum()`å¯¹æˆ‘ä»¬çš„æ•°æ®æ¡†è¿›è¡Œé‡é‡‡æ ·ï¼Œå°†æ•°æ®åˆ†ç»„åˆ° 15 åˆ†é’Ÿçš„çª—å£ä¸­ï¼Œå¹¶å¯¹æ¯ä¸ª PULocationID çš„è®¡æ•°è¿›è¡Œæ±‚å’Œï¼š

```py
tumbling = pivo.resample('15min').sum()
tumbling
```

![](img/2ce7b5a0dbba7ee184ed752152df987d.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

å¾ˆå¥½ï¼æˆ‘ä»¬ç°åœ¨æœ‰äº†æ¯ä¸ª 15 åˆ†é’Ÿçª—å£æ¯ä¸ªæ¥é€åŒºçš„è¯·æ±‚æ•°é‡ã€‚å‰©ä¸‹çš„å°±æ˜¯å‡†ç¡®åœ°å®šä¹‰â€œé«˜éœ€æ±‚â€çš„æ ‡å‡†â€”â€”å‡è®¾ä¸ºæ¯ 15 åˆ†é’Ÿçª—å£ 40 ä¸ªè¯·æ±‚â€”â€”ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ•°æ®æ¡†æ¥ç­›é€‰å‡ºè¶…è¿‡é«˜éœ€æ±‚é˜ˆå€¼çš„çª—å£å’Œæ¥é€åŒºã€‚

æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡å¯è§†åŒ–æ•°æ®æ¥è¯†åˆ«é«˜å³°éœ€æ±‚åŒºåŸŸï¼š

```py
res.resample('15min').sum().plot(legend=False)
```

![](img/4a9089534061e1526e24b601f7be5cf4.png)

ä½œè€…ç”Ÿæˆçš„å›¾è¡¨

è¿™å¾ˆå¥½â€¦â€¦ä½†ä»ç„¶åªæ˜¯æœ‰ç‚¹å¥½ã€‚æˆ‘ä»¬ä»ç„¶ç¼ºå°‘å¾ˆå¤šç»†èŠ‚ã€‚æˆ‘ä»¬éœ€è¦ç­‰å¾…æ¯ä¸ª 15 åˆ†é’Ÿçª—å£å®Œæˆåæ‰èƒ½èšåˆæ•°æ®ã€‚å¦‚æœå³°å€¼å‘ç”Ÿåœ¨ç¬¬ 1 åˆ†é’Ÿåˆ°ç¬¬ 16 åˆ†é’Ÿä¹‹é—´çš„ 15 åˆ†é’Ÿçª—å£ï¼ˆè€Œä¸æ˜¯ç¬¬ 0 åˆ†é’Ÿåˆ°ç¬¬ 15 åˆ†é’Ÿä¹‹é—´ï¼‰ï¼Œæˆ‘ä»¬å°†é”™è¿‡å³°å€¼ä¸€åˆ†é’Ÿï¼Œä½†éœ€è¦ç­‰åˆ° 14 åˆ†é’Ÿåæ‰èƒ½æ”¶åˆ°ä¿¡å·ã€‚åˆ°é‚£æ—¶ï¼Œå¯èƒ½å·²ç»å¤ªæ™šäº†ï¼Œæ— æ³•æŒ‡ç¤ºå¸æœºå‰å¾€é‚£ä¸ªæ¥é€åŒºã€‚

> ä¸è¦å®³æ€•ï¼Œå®Œç¾å°±åœ¨çœ¼å‰ï¼

# 3\. Pandas ä¸­çš„æ»‘åŠ¨çª—å£

![](img/d4a6f7ffa180c3168146983ddcdda1a1.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›

ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æ¯åˆ†é’Ÿéƒ½æœ‰ä¸€ä¸ªä¿¡å·ï¼Œå‘Šè¯‰æˆ‘ä»¬å“ªäº›åŒºåŸŸæ­£åœ¨ç»å†é«˜å³°éœ€æ±‚ã€‚æˆ‘ä»¬è¿˜å¸Œæœ›å‡å°‘çª—å£çš„å¤§å°ï¼Œä»¥ä½¿æˆ‘ä»¬çš„é©±åŠ¨ç¨‹åºèƒ½å¤Ÿæ›´å¿«åœ°å¯¹ incoming æ•°æ®åšå‡ºååº”ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ 5 åˆ†é’Ÿçš„çª—å£ï¼Œå¹¶å°†â€œé«˜å³°éœ€æ±‚â€å®šä¹‰ä¸º**æ¯ 5 åˆ†é’Ÿçª—å£å†…è¶…è¿‡ 50 ä¸ªè¯·æ±‚**ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pandas çš„`.rolling()`æ–¹æ³•æ¥åˆ›å»º**æ»‘åŠ¨çª—å£**ï¼š5 åˆ†é’Ÿçš„çª—å£ï¼Œé‡å  4 åˆ†é’Ÿï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ¯åˆ†é’Ÿè·Ÿè¸ª incoming è¯·æ±‚çš„é€Ÿç‡ã€‚

ä½ å¯ä»¥ä½¿ç”¨`.resample()`å’Œ`.rolling()`æ–¹æ³•åœ¨ pandas ä¸­åˆ›å»ºæ»‘åŠ¨çª—å£ã€‚ç¡®ä¿`.resample()`åˆ°**ä½ æ‰€éœ€ä¿¡å·é—´éš”çš„å¤§å°**ï¼Œè€Œä¸æ˜¯çª—å£çš„å¤§å°ï¼š

```py
# create sliding windows in pandas
res = pivot.resample(interval_size).sum()
windows = res.rolling(window_size).sum()
```

è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£ã€‚

æˆ‘ä»¬å¸Œæœ›è¾“å‡ºæ˜¯ä¸€ç³»åˆ—è¡Œï¼Œæ¯è¡Œæ˜¯ä¸€ä¸ª 5 åˆ†é’Ÿçª—å£ï¼Œåˆ—ä¸­åŒ…å«è¯¥ 5 åˆ†é’Ÿçª—å£å†…æ¯ä¸ªå–ä»¶åŒºåŸŸçš„è¯·æ±‚æ€»æ•°ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¸Œæœ›ç¬¬äºŒè¡Œä¸æ˜¯ä»ç¬¬ä¸€ä¸ª 5 åˆ†é’Ÿçª—å£ç»“æŸæ—¶å¼€å§‹ï¼Œè€Œæ˜¯ä»ç¬¬ä¸€ä¸ª 5 åˆ†é’Ÿçª—å£çš„ç¬¬ä¸€åˆ†é’Ÿç»“æŸæ—¶å¼€å§‹ã€‚

è¿˜è·Ÿå¾—ä¸Šå—ï¼Ÿå¦‚æœä¸è¡Œï¼Œä¹Ÿè®¸ä¸‹é¢çš„å›¾ç¤ºä¼šæœ‰å¸®åŠ©ï¼š

![](img/62ce4e0e63841c17874e49ac2fbd3250.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›

æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯ 56 è¡Œæ¯è¡Œ 5 åˆ†é’Ÿï¼Œæ¯è¡Œä¹‹é—´æœ‰ 4 åˆ†é’Ÿçš„é‡å ã€‚è¿™å°†ä¸ºæˆ‘ä»¬æä¾›æ¯åˆ†é’Ÿçš„ä¿¡å·ï¼Œå‘ŠçŸ¥å“ªäº›åŒºåŸŸï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æ¯ 5 åˆ†é’Ÿå†…è¯·æ±‚è¶…è¿‡ 50 ä¸ªã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆé‡é‡‡æ ·æˆ‘ä»¬çš„ DataFrameï¼Œä»¥ä¾¿æ¯åˆ†é’Ÿè·å–ä¸€è¡Œæ•°æ®ï¼š

```py
res_1m = res.resample('1min').sum()
res_1m.head(3)
```

![](img/96e8822e16bdc6daacbe56c710267db3.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

*(å¦‚æœä½ æƒ³æ¯ç§’é’Ÿè·å–ä¸€ä¸ªä¿¡å·ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå°†é‡‡æ ·é¢‘ç‡è°ƒæ•´ä¸º`*1s*`ã€‚)*

ç°åœ¨æ¯ä¸€è¡Œä»£è¡¨ä¸€åˆ†é’Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`rolling()`å’Œ`sum()`æ¥è·å¾—æ¯ 5 è¡Œï¼ˆåˆ†é’Ÿï¼‰çš„è¯·æ±‚æ€»æ•°ï¼š

```py
windows = res_1m.rolling(5).sum()
windows.head()
```

![](img/a14579fddc40d0e9f1206de9e94ea64b.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

ğŸ˜± å“å‘€ï¼Œè¿™ä¹ˆå¤š NaNsã€‚

ä½†è¿™åªæ˜¯å› ä¸º`.rolling()`é»˜è®¤å°†çª—å£æ“ä½œï¼ˆåœ¨æ­¤ä¾‹ä¸­ä¸ºæ€»å’Œï¼‰çš„è¾“å‡ºæ”¾åœ¨çª—å£çš„å³è¾¹ç¼˜ã€‚è¿™åœ¨æŠ€æœ¯ä¸Šæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæˆ‘ä»¬åªèƒ½åœ¨ç¬¬ 4 åˆ†é’Ÿæœ«è·å¾—ç¬¬ä¸€ä¸ªä¿¡å·ï¼Œå½“ç¬¬ä¸€ä¸ªçª—å£å·²å®Œæˆæ—¶ã€‚

å¦‚æœæˆ‘ä»¬æƒ³å»æ‰å‰ 4 åˆ—ï¼Œå¯ä»¥ä¸¢å¼ƒå‰ 4 è¡Œç©ºæ•°æ®ï¼ˆåˆ†é’Ÿï¼‰ï¼š

```py
windows_drop = windows.iloc[4:]
windows_drop.head()
```

![](img/4ee16f3f4aa9494c0d38517f41fb8e3f.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

## é™„æ³¨ï¼šå‰ç»æ€§çª—å£

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›å°†å€¼ç§»åŠ¨åˆ°å·¦è¾¹ç¼˜ï¼Œä»¥ä½¿å…¶æ›´æ˜“è¯»ã€‚å¦‚æœä½ è¿™æ ·åšï¼Œè¯·å°å¿ƒä¸è¦çŠ¯é”™ï¼Œè¯¯è®¤ä¸ºç¬¬ 1 åˆ†é’Ÿæ—¶çª—å£ 1 ä¸­å®é™…ä¸Šä¼šæœ‰æ•°æ® (!) â€” ä½ å®é™…ä¸Šåªæ˜¯å°†ç»“æœç§»åŠ¨åˆ°äº†ç¬¬ä¸€è¡Œã€‚

ä½ å¯ä»¥ä½¿ç”¨`FixedForwardWindowIndexer`å¯¹è±¡å°†çª—å£è¾“å‡ºæ”¾åœ¨å·¦è¾¹ç¼˜å¹¶åˆ›å»ºå‰ç»æ€§çª—å£ï¼š

```py
# create custom window indexer
indexer = pd.api.indexers.FixedForwardWindowIndexer(window_size=5)

# use indexer to create rolling window
windows_f = res_1m.rolling(window=indexer).sum()

windows_f.head()
```

![](img/b0fe34bea858226f190b4f4a9f96e445.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

æ•°æ®æ¡†çš„æœ€å 4 åˆ—ç°åœ¨ä¸ºç©ºï¼ˆå› ä¸ºåœ¨ç¬¬ 55 åˆ†é’Ÿä¹‹åæ²¡æœ‰å®Œæ•´çš„ 5 åˆ†é’Ÿçª—å£ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤è¿™äº›åˆ—ã€‚

```py
# drop the last 14 columns
windows_f_drop = windows.iloc[:45]
windows_f_drop.tail()
```

![](img/f2d7ee6641a4e6e1791c84fb532f4e40.png)

ä½œè€…ç”Ÿæˆçš„æ•°æ®è¾“å‡º

ä½¿ç”¨ `.rolling()` æ–¹æ³•çš„è¿™ç§æ–¹å¼å¹¶ä¸å¹¿ä¸ºäººçŸ¥ï¼Œä¸”åœ¨[æ–‡æ¡£ä¸­ç¨å¾®æœ‰äº›åŸ‹æ²¡](https://pandas.pydata.org/docs/user_guide/window.html#custom-window-rolling)ï¼Œä½†ä¸€æ—¦ä½ ç†è§£äº†å®ƒçš„å·¥ä½œåŸç†ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯ç›¸å½“ç®€å•çš„ã€‚

# åœ¨ Pandas ä¸­å¯è§†åŒ–æ»‘åŠ¨çª—å£

è®©æˆ‘ä»¬å¯è§†åŒ–æ•°æ®ï¼Œä»¥è¯†åˆ«ä¸€äº›æ¨¡å¼ï¼Œå¹¶æ‰¾åˆ°éœ€æ±‚å³°å€¼æœ€é«˜çš„æ¥é€åŒºåŸŸã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `windows` æ¥æ˜ç¡®æ˜¾ç¤ºå‰ 5 åˆ†é’Ÿçš„æ•°æ®ç¼ºå¤±ï¼š

```py
import matplotlib.pyplot as plt

windows.plot(kind='bar', legend=False);
```

![](img/c58d83243423d5bdafc9c1baba33bc73.png)

ä½œè€…ç”Ÿæˆçš„å›¾è¡¨

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç²—ç•¥çš„å¯è§†åŒ–ï¼Œä½†å³ä¾¿å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼š

1.  å‰ 5 åˆ†é’Ÿçš„æ•°æ®ç¼ºå¤±

1.  åœ¨ç‰¹å®šåŒºåŸŸå†…ï¼Œæ¥é€è¯·æ±‚çš„é¢‘ç‡å­˜åœ¨æ˜æ˜¾çš„å³°å€¼ã€‚

ä»è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆªæ–­å€¼/é˜ˆå€¼ï¼Œå¹¶è¯†åˆ«åœ¨ç‰¹å®šçª—å£ä¸­è¯·æ±‚è¶…è¿‡é˜ˆå€¼çš„åŒºåŸŸã€‚ç„¶åæˆ‘ä»¬å¯ä»¥é¼“åŠ±å¸æœºå»è¿™äº›åŒºåŸŸã€‚

æ¾„æ¸…å›¾è¡¨çš„ä¸€ç§æ–¹æ³•æ˜¯åˆ é™¤æ‰€æœ‰å€¼ä½äºé˜ˆå€¼çš„åˆ—ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦è¯†åˆ«æ¯ 5 åˆ†é’Ÿçª—å£å†…è¯·æ±‚è¶…è¿‡ 50 çš„åŒºåŸŸï¼š

```py
signal = windows[(windows > 50)].dropna(axis=1, how=â€allâ€)
signal.plot(figsize=(10,8))
plt.legend(bbox_to_anchor=(1.0,1.0))
plt.show()
```

![](img/a986c6f7d4b27680048e9f17eab4a725.png)

ä½œè€…ç”Ÿæˆçš„å›¾è¡¨

è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥åšçš„äº‹æƒ…ã€‚å¯ä»¥åœ¨ [è¿™ä¸ªç¬”è®°æœ¬](https://github.com/rrpelgrim/sliding-windows-pandas/blob/main/pandas-sliding-windows-nyc-uber-lyft.ipynb) ä¸­ç©ç©ä»£ç ï¼Œè¿›ä¸€æ­¥å®Œå–„å®ƒã€‚

# Pandas ä¸­çš„æ»‘åŠ¨çª—å£ï¼šç»“è®º

æœ¬æ–‡ä»‹ç»äº†åœ¨æ—¶é—´åºåˆ—æ•°æ®ä¸Šæ‰§è¡Œæ»‘åŠ¨çª—å£çš„å¼ºå¤§åŠŸèƒ½ã€‚é€šè¿‡å°†æ•°æ®é›†åˆ‡å‰²æˆå°çš„ã€é‡å çš„çª—å£ï¼Œä½ ç°åœ¨å¯ä»¥ä»¥*å¯æ“ä½œçš„é€Ÿç‡*è·å¾—æœ‰ä»·å€¼çš„æ•°æ®ä¿¡å·ã€‚

å½“ç„¶ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä½ ä¼šå®æ—¶å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œã€‚æ•¬è¯·å…³æ³¨æœ‰å…³å®æ—¶å¤„ç†çš„æ›´å¤šå†…å®¹ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼Œä½ å¯èƒ½æƒ³æŸ¥çœ‹ä¸€ä¸‹ [è¿™ä¸ªå®æ—¶ç›‘æ§æ•™ç¨‹](https://www.dataengineeringweekly.com/p/unlocking-data-stream-processing)ã€‚åšå¥½å‡†å¤‡ï¼Œä»çº½çº¦äº¤é€šè½¬åˆ°ç½‘ç«™æµé‡çš„èƒŒæ™¯å˜åŒ– ;)

å¸Œæœ›ä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©ä¸”æœ‰è¶£ã€‚ [å…³æ³¨æˆ‘çš„ LinkedIn](https://www.linkedin.com/in/avrilaysha/) ä»¥è·å–æˆ‘çš„æœ€æ–°å†…å®¹ã€‚

æ•°æ®å¤„ç†æ„‰å¿«ï¼ğŸ‘‹

**çº½çº¦å¸‚å‡ºç§Ÿè½¦å’Œè±ªåè½¿è½¦å§”å‘˜ä¼šï¼ˆTLCï¼‰è¡Œç¨‹è®°å½•æ•°æ®äº 2023 å¹´ 3 æœˆ 15 æ—¥è®¿é—®ï¼Œæ¥æºäº* [*https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page*](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page)*ã€‚è®¸å¯è¯ï¼š* [*https://www.nyc.gov/home/terms-of-use.page*](https://www.nyc.gov/home/terms-of-use.page)
