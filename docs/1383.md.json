["```py\nagrupamento_municipio<-\n    dataset_analise %>%\n      filter(\n             deslocamento ==1) %>%\n      group_by(munic_res) %>%\n      summarise(\n        numero_internacoes = n()\n      ) %>%\n      mutate(code_muni = munic_res,\n             tipo_deslocamento = \"saida\" ) %>%\n      bind_rows(\n        dataset_analise %>%\n          filter(\n                 deslocamento ==1) %>%\n          group_by(codufmun) %>%\n          summarise(\n            numero_internacoes = n()\n          ) %>%\n          mutate(code_muni = codufmun,\n                 tipo_deslocamento = \"entrada\"),\n        dataset_analise %>%\n          filter(\n                 deslocamento ==0) %>%\n          group_by(codufmun) %>%\n          summarise(\n            numero_internacoes = n()\n          ) %>%\n          mutate(code_muni = codufmun,\n                 tipo_deslocamento = \"local\")\n      ) %>%\n  group_by(code_muni, tipo_deslocamento) %>%\n  summarise(\n    total_internacoes = sum(numero_internacoes)\n  )\n\nagrupamento_municipio<-\nagrupamento_municipio %>%\n  tidyr::pivot_wider(names_from = tipo_deslocamento, values_from = total_internacoes) %>%\n  mutate(liquido = ifelse(is.na(entrada),0,entrada)+\n           ifelse(is.na(local),0,local)-\n           ifelse(is.na(saida),0,saida))\n\nagrupamento_municipio<-\nagrupamento_municipio %>%\n  mutate(local = ifelse(is.na(local),0,local),\n         saida = ifelse(is.na(saida),0,saida),\n         entrada = ifelse(is.na(entrada),0,entrada),\n         perc_saida = saida/(saida+local)*100,\n         perc_entrada = entrada/(entrada+local)*100,\n         perc_entrada = ifelse(is.nan(perc_entrada),0,perc_entrada))\n\nmunicipios_seat %>%\n  mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n  inner_join(agrupamento_municipio\n  ) %>%\n  inner_join(\n    REGIC_trabalho%>%\n      mutate(code_muni = str_sub(as.character(cod_cidade),1,6))\n  ) %>%\n  ggplot()+\n  geom_sf(data = estados_mapa, fill=NA, color=\"#808080\")+\n  geom_sf(aes( fill= perc_saida),pch=21, color=\"#444444\", size=2.9)+\n  geom_text_repel(data = mun_sel_nivel_1A,aes(x=X, y=Y, label= name_muni),fontface = \"bold\", color=\"white\")+\n  geom_text_repel(data = mun_sel_nivel_1B,aes(x=X, y=Y, label= name_muni),fontface = \"bold\", color=\"white\")+\n  geom_text_repel(data = mun_sel_nivel_1C,aes(x=X, y=Y, label= name_muni),fontface = \"bold\", color=\"white\")+\n  geom_text_repel(data = mun_sel_nivel_2A,aes(x=X, y=Y, label= name_muni),fontface = \"bold\", color=\"white\", force =2)+\n  scale_fill_continuous_sequential(palette= \"Heat 2\")+\n  labs(\n    fill= str_wrap(\"% de pacientes internados em outros municípios\",15) \n  )+\n  theme_light() +\n  theme(\n    text = element_text(size=20),\n    panel.background = element_rect(fill = \"black\"),\n    panel.grid = element_blank(),\n    axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    strip.background = element_rect(fill = \"#505050\"),\n    strip.text = element_text(color = \"white\"),\n    axis.text = element_blank(),\n    legend.key = element_rect(fill = \"#15202B\")\n\n  )+\n  facet_wrap(nome_nivel_hierarquia_ordenado~.)\n```", "```py\nordem_y<- \ndataset_analise %>%\n  filter(deslocamento==1,\n         nome_nivel_hierarquia.x == \"Centro Local\",\n         !(is.na(nome_nivel_hierarquia.y))) %>%\n  group_by(nome_nivel_hierarquia.y) %>%\n  summarise(\n    quantidade = n()\n  )  %>%\n  ungroup() %>%\n   inner_join(\n     de_para_hierarquia %>%\n       rename(nome_nivel_hierarquia.y=nome_nivel_hierarquia,\n              entrada_abreviado = nome_abreviado)) %>%\n  arrange(quantidade) %>%\n  mutate(entrada = entrada_abreviado)\n\naluvial<-\n     dataset_analise %>%\n  filter(deslocamento==1,\n         nome_nivel_hierarquia.x == \"Centro Local\",\n         !(is.na(nome_nivel_hierarquia.y))) %>%\n  mutate(saída = nome_nivel_hierarquia.x,\n         entrada =nome_nivel_hierarquia.y ) %>%\n  select(saída, entrada)\n\naluvial<- \n   aluvial %>%\n   inner_join(\n     de_para_hierarquia %>%\n       rename(saída=nome_nivel_hierarquia,\n              saida_abreviado = nome_abreviado)) %>%\n   inner_join(\n     de_para_hierarquia %>%\n       rename(entrada=nome_nivel_hierarquia,\n              entrada_abreviado = nome_abreviado)) %>%\n   select(saida_abreviado, entrada_abreviado ) %>%\n   rename(saída= saida_abreviado,\n          entrada = entrada_abreviado)\n\n aluvial$entrada <- factor(aluvial$entrada, levels = unique(ordem_y$entrada[order(ordem_y$quantidade)])) \n\n p<-\n alluvial_wide( data = aluvial, \n                max_variables = 2, \n                fill_by = 'first_variable') \n\nparcats::parcats(p, data_input = aluvial,marginal_histograms = FALSE,labelfont = list(size = 15, color = \"black\"), sortpaths= \"backwards\")\n```", "```py\nmunicipio_selecionado<-\"261160\"\nmuni_sel<- \n  dataset_analise %>%\n  filter(deslocamento ==1,\n         codufmun== municipio_selecionado) %>%\n  group_by(codufmun,nome_nivel_hierarquia_ordenado.y, uf.y) %>%\n  summarise(quantidade = n()) %>%\n  rename(code_muni= codufmun,\n         hierarquia = nome_nivel_hierarquia_ordenado.y,\n         uf = uf.y) %>%\n  mutate(tipo_deslocamento  = \"destino\",\n         distancia = 0) %>%\n  bind_rows(\n    dataset_analise %>%\n      filter(deslocamento ==1,\n             codufmun== municipio_selecionado) %>%\n      group_by(munic_res,nome_nivel_hierarquia_ordenado.x, uf.x) %>%\n      summarise(\n        quantidade = n(),\n        distancia =min(distancia)\n      ) %>%\n      ungroup() %>%\n      rename(code_muni= munic_res,\n             hierarquia = nome_nivel_hierarquia_ordenado.x,\n             uf=uf.x)%>%\n      mutate(tipo_deslocamento  = \"origem\")\n  )\n\nmuni_sel_posicao<-\ndataset_analise %>%\ndplyr::filter(deslocamento ==1,\n        codufmun==  municipio_selecionado)%>%\n  distinct(codufmun, mun_res_lat.x, mun_res_lat.y, mun_res_lon.x, mun_res_lon.y,distancia)\n\nmuni_sel_posicao<-\n  municipios_seat %>%\n  mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n  inner_join(\n    muni_sel_posicao %>%\n      rename(code_muni= codufmun)\n  )\n\nmuni_sel_repel<-\n   municipios_seat %>%\n   mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n   filter(code_muni %in% c(\"260960\", \"260790\",\"120020\")) %>% #261160-Recife,260790 -Jaboatão, 260960 - Olinda, 260410 - Caruarau, 260545 - Fernando de Noronha, 120020 - Cruzeiro do Sul-AC\n  inner_join(muni_sel)\n\nxmin<- min(min(muni_sel_posicao$mun_res_lon.x), min(muni_sel_posicao$mun_res_lon.y)) -1\nxmax <- max(max(muni_sel_posicao$mun_res_lon.x), max(muni_sel_posicao$mun_res_lon.y)) +1\n\nymin<- min(min(muni_sel_posicao$mun_res_lat.x), min(muni_sel_posicao$mun_res_lat.y)) -1\nymax <- max(max(muni_sel_posicao$mun_res_lat.x), max(muni_sel_posicao$mun_res_lat.y)) +1\n\ng1<-\nmunicipios_seat %>%\n  mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n  inner_join(\n    muni_sel\n  ) %>%\n  ggplot()+\n  geom_sf(data = estados_mapa, fill=NA, color=\"#505050\")+\n  geom_curve(data=muni_sel_posicao, aes(x=mun_res_lon.x,y=mun_res_lat.x,xend=mun_res_lon.y,yend=mun_res_lat.y, colour= distancia),\n             curvature = -.25, ncp = 800,size = 1)+\n  geom_sf(fill=\"white\",size=1.9,pch=21, color=\"#444444\")+\n  scale_fill_discrete_qualitative(palette=\"dark2\")+\n  scale_color_continuous_sequential(palette= \"Heat 2\")+\n  coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+\n  labs(\n    fill= \"\",\n    color = str_wrap(\"distância em Km\",10)\n  )+\n  theme_light() +\n  theme(\n    text = element_text(size=18),\n    panel.background = element_rect(fill = \"black\"),\n    panel.grid = element_blank(),\n    axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    strip.background = element_rect(fill = \"#505050\"),\n    strip.text = element_text(color = \"white\"),\n    axis.text = element_blank(),\n  ) \nmuni_sel_foco<-\n  municipios_seat %>%\n  mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n  inner_join(\n      muni_sel%>%\n  filter(code_muni==municipio_selecionado)\n  )\n\n muni_sel<-\n   muni_sel%>%\n   filter(code_muni!=municipio_selecionado)\n\nset.seed(1972)\ng2<-\nmunicipios_seat %>%\n  mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%\n  inner_join(\n    muni_sel\n  ) %>%\n  ggplot()+\n  geom_sf(data = estados_mapa, fill=NA, color=\"#505050\")+#505050\n  geom_sf( aes(fill=quantidade),pch=21, color=\"#444444\", size=2, show.legend = TRUE)+\n  geom_sf( data= muni_sel_foco, aes(size=quantidade),pch=21, color=\"#444444\", fill=\"white\")+\n  geom_text_repel(data = muni_sel_repel,\n                  aes(x=X, y=Y, label= str_wrap(paste(name_muni,\":\",quantidade),10)), \n                  color = \"white\", \n                  limits = c(0,2352),\n                  fontface = \"bold\", \n                  nudge_x = c(0,2,2.5), \n                  nudge_y = c(0,-3.5,2),\n                  show.legend = TRUE)+\n  geom_text_repel(data = muni_sel_foco,\n                  aes(x=X, y=Y, label= str_wrap(name_muni,20)),\n                  fontface = \"bold\", \n                  color=\"white\",\n                  nudge_x = c(3), \n                  nudge_y = c(0))+\n  scale_fill_continuous_sequential(palette= \"Heat\", trans= \"log2\" )+\n  coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+\n  labs(\n\n    fill = str_wrap(\"Quantidade de saídas\",15),\n    size= str_wrap(\"Quantidade de entradas\",15)\n  )+\n  theme_light() +\n  theme(\n    text = element_text(size=18),\n    panel.background = element_rect(fill = \"black\"),\n    panel.grid = element_blank(),\n    axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    strip.background = element_rect(fill = \"#505050\"),\n    strip.text = element_text(color = \"white\"),\n    axis.text = element_blank(),\n    legend.key = element_rect(fill = \"#15202B\")\n  )\n\nlibrary(patchwork)\ng1|g2\n```", "```py\nagrupamento_municipio_cluster<-readRDS(\"agrupamento_municipio_2021.RDS\")\n\ng1<-\ndataset_analise %>%\n  filter(deslocamento == 1,\n         perc.x>0,\n         perc.x<=50) %>% \n  distinct(nome_nivel_hierarquia.x,munic_res, perc.x) %>%\n  inner_join(\n    agrupamento_municipio_cluster %>%\n      rename(munic_res=code_muni)\n  ) %>%\n  ggplot() +\n  geom_jitter(aes(x=cluster_4_k, y=perc.x, fill=perc_saida), pch=21, color=\"#444444\",size=2)+\n  geom_boxplot(aes(x=cluster_4_k, y=perc.x),fill=NA, color= \"white\", outlier.shape = NA)+\n  scale_fill_continuous_sequential(palette= \"Red-Yellow\")+\n  theme_light() +\n  theme(\n    text = element_text(size=18),\n    panel.background = element_rect(fill = \"black\"),\n    panel.grid = element_blank(),\n    axis.title.x = element_blank(),\n    strip.background = element_rect(fill = \"#505050\"),\n    strip.text = element_text(color = \"white\"),\n    #axis.text = element_blank(),\n    axis.text.x = element_text(angle = 45, vjust = 0.5),\n    legend.key = element_rect(fill = \"#15202B\")\n  )+\n  labs(\n    fill= \"(%) saída\",\n    y = \"Gastos Hospitalares e ambulatoriais - (%) do total\"\n  )\n\ng2<-\ndataset_analise %>%\n  filter(deslocamento == 1,\n         perc.y>0,\n         perc.y<=50) %>%\n  distinct(nome_nivel_hierarquia.y,codufmun, perc.y) %>%\n  inner_join(\n    agrupamento_municipio_cluster %>%\n      rename(codufmun=code_muni)\n  ) %>%\n  ggplot() +\n  geom_jitter(aes(x=cluster_4_k, y=perc.y, fill=perc_entrada), pch=21, color=\"#444444\",size=2)+\n  geom_boxplot(aes(x=cluster_4_k, y=perc.y),fill=NA, color= \"white\", outlier.shape = NA)+\n  scale_fill_continuous_sequential(palette= \"Red-Yellow\")+\n  theme_light() +\n  theme(\n    text = element_text(size=18),\n    panel.background = element_rect(fill = \"black\"),\n    panel.grid = element_blank(),\n    axis.title.x = element_blank(),\n    strip.background = element_rect(fill = \"#505050\"),\n    strip.text = element_text(color = \"white\"),\n    axis.text.x = element_text(angle = 45, vjust = 0.5),\n    legend.key = element_rect(fill = \"#15202B\")\n  )+\n  labs(\n    fill= \"(%) entrada\",\n    y = \"Gastos Hospitalares e ambulatoriais - (%) do total\"\n  )\ng1|g2\n```"]