# 揭开 NDCG 的面纱

> 原文：[https://towardsdatascience.com/demystifying-ndcg-bee3be58cfe0?source=collection_archive---------0-----------------------#2023-01-25](https://towardsdatascience.com/demystifying-ndcg-bee3be58cfe0?source=collection_archive---------0-----------------------#2023-01-25)

![](../Images/f4b2c352ccaa5255dc3c1068bd144edf.png)

作者插图

## 如何最佳地使用这一重要指标来监控排名模型

[](https://aparnadhinak.medium.com/?source=post_page-----bee3be58cfe0--------------------------------)[![Aparna Dhinakaran](../Images/e431ee69563ecb27c86f3428ba53574c.png)](https://aparnadhinak.medium.com/?source=post_page-----bee3be58cfe0--------------------------------)[](https://towardsdatascience.com/?source=post_page-----bee3be58cfe0--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----bee3be58cfe0--------------------------------) [Aparna Dhinakaran](https://aparnadhinak.medium.com/?source=post_page-----bee3be58cfe0--------------------------------)

·

[查看](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff32f85889f3a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdemystifying-ndcg-bee3be58cfe0&user=Aparna+Dhinakaran&userId=f32f85889f3a&source=post_page-f32f85889f3a----bee3be58cfe0---------------------post_header-----------) 发表在 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----bee3be58cfe0--------------------------------) ·11 min read·2023年1月25日[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbee3be58cfe0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdemystifying-ndcg-bee3be58cfe0&user=Aparna+Dhinakaran&userId=f32f85889f3a&source=-----bee3be58cfe0---------------------clap_footer-----------)

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbee3be58cfe0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdemystifying-ndcg-bee3be58cfe0&source=-----bee3be58cfe0---------------------bookmark_footer-----------)

*这篇文章由 Arize AI 的软件工程师 Jianshu Chi 和 Arize AI 的 ML 工程师 Amber Roberts 共同撰写*

排名模型支撑着现代数字生活的许多方面，从搜索结果到音乐推荐。任何构建过推荐系统的人都理解开发和评估排名模型以服务客户所面临的种种挑战。

尽管这些挑战从数据准备和模型训练开始，并贯穿于模型开发和部署过程中，但通常给数据科学家和机器学习工程师带来最大麻烦的是在生产环境中维护他们的排名模型。维护生产中的模型 notoriously 困难，因为这些模型在适应动态环境时不断变化。

为了详细讲解如何在生产中监控**标准化折扣累积增益（NDCG）**，本文涵盖了：

+   NDCG是什么，它的用途是什么？

+   NDCG背后的直觉

+   什么是NDCG@K？

+   NDCG与其他指标相比如何？

+   NDCG在模型监控中如何使用？

在解决了这些主要问题之后，你的团队将能够使用NDCG对生产中的排名模型进行实时监控和根本原因分析。

# NDCG是什么，它的用途是什么？

**标准化折扣累积增益**是排名质量的衡量指标。机器学习团队经常使用[NDCG](https://arize.com/blog-course/ndcg/)来评估搜索引擎、推荐系统或其他信息检索系统的性能。搜索引擎在与客户直接互动的应用程序中非常流行，如Alphabet、Amazon、Etsy、Netflix和Spotify——这些仅仅是其中的一部分。

NDCG的值是通过将搜索引擎返回的项目的相关性与假设的“理想”搜索引擎返回的项目的相关性进行比较来确定的。例如，如果你在一个流行的音乐流媒体应用上搜索“Hero”，你可能会得到10多个结果，这些结果中包含了“Hero”这个词，无论是在歌曲、艺术家还是专辑中。

每首歌曲或艺术家的相关性由一个分数（也称为“等级”）表示，该分数分配给搜索查询。这些推荐的分数会根据它们在搜索结果中的位置进行折扣——它们是首先被推荐还是最后被推荐？折扣后的分数会累积起来，并除以最大可能的折扣分数，这个折扣分数是如果搜索引擎按真实相关性顺序返回文档时获得的分数。

例如，如果用户想要Foo Fighters的歌曲“My Hero”，那么这首歌在推荐中离顶部越近，对用户来说搜索效果就越好。最终，返回结果或推荐的相对顺序对于客户满意度非常重要。

# 理解排名模型背后的直觉

排名模型根据模型中的搜索查询预测一组项目的排名。每个项目的相关性分数是根据它们在搜索中的相关性进行评估的。

这里是一个用于排名模型的简单版本数据集。共有两种不同的搜索查询：**x**和**y**。在每组中，有五个不同的项目作为搜索结果显示，每个项目的排名基于它们在结果列表中的位置。最后，每个项目的*增益*代表了在搜索中的相关性。

![](../Images/d5d3744215466eef0acd2dbea8b8e577.png)

图片来源：作者

要理解NDCG背后的直觉，必须深入了解名称中每个单词的含义。所以让我们来逐一解析…

# 1.) 累积增益（CG）

累积增益是与搜索查询中项目相关的*增益*的总和。它的公式如下：

![](../Images/505e9bd6139e6de196a75444aa9807dc.png)

作者提供的图片

使用上面的数据集，我们可以计算每个组的 CG：

![](../Images/778a2467b5c1b27f68e646aa9fc87dfa.png)

作者提供的图片

在这个例子中，两个组的 CG 都是 3，因此我们仍然无法判断哪个搜索组更好。为了做到这一点，我们需要在公式中考虑排名——这引入了下一个部分：DCG。

# 2.) 折扣累计收益（DCG）

DCG 与 CG 的概念相同，但额外考虑了按排名折扣收益。以下是 DCG 的公式：

![](../Images/cd4563035a77c4398043c8903abca226.png)

作者提供的图片

使用上面的数据集，我们可以计算每个组的 DCG：

![](../Images/8e1b0f7dfee1604b59d3194e58201eab.png)

作者提供的图片

![](../Images/daa57de9d5275f2ad475d585dcec854b.png)

作者提供的图片

好消息！现在我们可以看到 ***y*** 的 DCG 优于 ***x*** 的 DCG。这也很有道理，因为组 ***y*** 中较高排名的项目对搜索组 ***y*** 更相关（收益更高）。那么我们为什么还需要 NDCG 呢？为了回答这个问题，我们引入另一个搜索组 ***z*** 作为计数示例：

![](../Images/30dd96996709ed8b957e871d3f51fbd1.png)

作者提供的图片

然后，我们再练习一次 DCG 计算：

![](../Images/73d1ab4b3f8f645248327ea80f64e8d8.png)

作者提供的图片

***z*** 的 DCG 是 1，但它在第一个排名上有最相关的项目。如果我们比较数据，它应该至少比组 ***x*** 更好。问题是组 ***x*** 有三个相关项目，而组 ***z*** 只有一个，单纯比较 DCG 不公平，因为它是累积和。这就是 NDCG 发挥作用的地方，因为它在比较之前会对 DCG 进行归一化——但问题是如何归一化以进行公平比较。为此，我们需要 IDCG。

# 3.) 理想折扣累计收益（IDCG）

IDCG 代表 **理想折扣累计收益**，它计算了基于收益的理想顺序的 DCG。它回答了这样一个问题：一个组的最佳可能 DCG 是什么？回到实际示例，当用户在线搜索某样东西时，他们总是希望最相关的项目在顶部，并在任何无关的项目之上。也就是说，所有相关的信息应该总是位于顶部，并且应该具有最佳的 DCG。让我们做更多的计算，使用上面数据集中每个搜索组的 IDCG：

![](../Images/8c89a4486d39a5b0fd96200495a03544.png)

作者提供的图片

# 4.) 归一化折扣累计收益（NDCG）

最终，我们完成了繁重的数学运算，终于可以使用 NDCG 了！NDCG 通过组的 IDCG 归一化 DCG。它可以解释为实际相关顺序与理想相关顺序的比较。NDCG 是 DCG 和 IDCG 的商；请参见下面的公式。

![](../Images/6362a34615f385263b3edaefc7565dbf.png)

作者提供的图片

![](../Images/f707f6c82ee686f7afcebccf1e024429.png)

作者提供的图片

回到上面的数据集，我们来获取每组的最终 NDCG：

![](../Images/3269024be502924bf231c91726076a20.png)

作者提供的图像

有了这些，我们可以自信地说组 ***z*** 拥有最佳的 NDCG。所有相关项都位于列表的顶部也很有意义。最后，值得注意的是 NDCG 的范围在 0 到 1 之间，1 是 NDCG 的最大值。

# 什么是 NDCG@K？

*K* 指的是列表中的前 *K* 个排名项，只有前 *K* 的相关性才会对最终计算产生影响。在计算 NDCG@K 时，我们首先计算实际相关性顺序和理想相关性顺序中的前 *K* 项的 DCG，然后得到该结果的标准化 DCG。

这里是 **NDCG@K** 的公式：

![](../Images/29b5947992f078af59388d7f4e4c4cb4.png)

作者提供的图像

现在，让我们计算组 **x** 的 NDCG@3：

![](../Images/963819be33d72252b37dd683795c3cef.png)

作者提供的图像

# NDCG 与其他排名指标相比如何？

团队用来评估搜索和排名引擎性能的三种主要指标是：目标是根据给定查询或用户的相关性对项列表进行排名。

+   **NDCG** (**标准化折扣累积增益**)：NDCG 是衡量排名系统有效性的指标，考虑了相关项在排名列表中的位置。它基于这样的思想：排名更高的项应比排名更低的项获得更多的信用。NDCG 的计算方法是将排名列表的折扣累积增益（DCG）除以理想排名列表的 DCG，理想排名列表是将相关项按照最优顺序排列的列表。*NDCG 的范围从 0 到 1，值越高表示性能越好。*

+   **MAP (均值平均精度)**： [均值平均精度](https://arize.com/blog-course/ndcg/) 是衡量排名系统精度的指标，考虑了排名列表中的相关项数量。它是通过对排名列表中每个位置的精度进行平均来计算的，其中精度定义为列表中该位置之前的相关项数量除以该位置之前的总项数。*MAP 的范围从 0 到 1，值越高表示性能越好。*

+   **MRR (均值倒数排名)**：MRR 是衡量排名列表中第一个相关项的排名的指标。它是通过取第一个相关项排名的倒数，并对所有查询或用户的这一值进行平均来计算的。例如，如果给定查询的第一个相关项的排名是 3，则该查询的 MRR 为 1/3。*MRR 的范围从 0 到 1，值越高表示性能越好。*

NDCG 通常用于信息检索，因为它考虑了搜索结果中返回项的相对顺序。这很重要，因为用户通常只查看前几个搜索结果，因此结果的相对顺序可能比任何绝对分数更重要。也就是说，NDCG 类似于排名指标 MAP，但由于它考虑了排名列表中相关项的位置，因此对排名顺序更为敏感。它基于这样一个观点：排名靠前的项应比排名靠后的项获得更多的信用。

NDCG 提供了微调哪些排名比其他排名更有价值的能力，并考虑了相关性分数的尺度（分级相关性）。虽然 NDCG 克服了 MAP 的不足之处，但它受到实际数据和部分反馈的限制，因此需要更手动的数据清理过程以确保准确计算。

每个排名指标测量排名性能的不同方面，选择使用哪个指标将取决于排名系统的具体目标以及其使用的背景。

# NDCG 在模型监控中如何使用？

总结一下，NDCG 是评估排名模型表现的有用指标，确保最相关的项按降序显示在搜索结果的顶部。

如果你是一位构建搜索引擎以推荐相关项的机器学习工程师，你会希望确保在模型开发和实验阶段所取得的结果与在生产环境中看到的结果相似。然而，排名模型以及任何信息检索系统往往会随着时间的推移而性能下降。这就是为什么模型监控和 ML 可观测性在 ML 生命周期中变得至关重要的原因。

回到帖子开头的例子，想象你在音乐流媒体应用的搜索栏中输入“Hero”。如果在生产工作流程中使用 ML 监控，音乐流媒体应用可以使用 NDCG 来评估其搜索排名模型在用户搜索时如何预测歌曲或艺术家的列表，特别是当用户的相关性为“播放”时。

其他示例也很丰富，从社交媒体公司使用 NDCG 来评估推荐帖子和视频的相关性，到零售商使用它来优化产品列表。

这些公司还可以使用NDCG@1、NDCG@5和NDCG@10来评估这些推荐的相关性以及搜索引擎的强度。使用ML可观察性平台的公司，甚至可以监控其排名模型和具有[多个相关性标签](https://docs.arize.com/arize/sending-data/examples)的搜索引擎（完全披露：我也是Arize AI的联合创始人）。这些可以用来生成增益（相关性评分），基于相关性目标（正类）是否匹配一个相关性标签。如果团队在每个搜索组中使用NDCG@K，那么你应该对所有这些结果进行平均，以获得最终的NDCG。对模型预测的所有相关搜索查询的NDCG进行平均，可以帮助团队很好地了解模型的表现。

上述***x，y***和***z***组的综合NDCG值为：

![](../Images/1b9e2e329ddadee7163c243d710980de.png)

图片由作者提供

# 如果你的模型没有相关性评分该怎么办？

计算NDCG时需要相关性评分。如果相关性评分不可用，可以使用归因模型生成二元相关性评分。如果你的预测标签、相关性标签和正类匹配，这个模型可能会产生一个*score = 1*。

如果在多标签情况下（如[‘点击’，‘收藏’，‘购买’]）没有相关性评分，并且正类是‘点击’，相关性将归因于sum([1,0,0])。因此，尽可能地归因相关性评分很重要，以便计算更精确的NDCG以进行进一步的故障排除。

# 低NDCG值在生产环境中意味着什么？

以下示例展示了当推荐系统在生产中的性能开始下降时发生了什么。在图像插图中，你可能会注意到训练和生产数据集几乎相同，仅在生产数据集中交换了第一个和最后一个推荐。这导致了两个数据集之间性能的显著差异，将NDCG从0.993降低到0.646。NDCG是对整体评分顺序最敏感的排名指标，并且在你可以获得完全的相关性反馈时非常有利。

![](../Images/f3e8b5b8a3e136988761bae18dac1405.png)

图片由作者提供

有了这些信息，我们可以说当需要向客户提供相关搜索结果时，我们的NDCG值在生产中表现不佳。现在我们知道模型开始退化，我们可以开始揭示性能问题的具体位置和原因。

# 更多资源

要了解如何通过适当的评估指标主动捕捉性能退化，然后识别表现最差的特征和切片，并轻松找出模型问题的根源，请查看我们以前关于[性能跟踪](https://arize.com/blog/machine-learning-performance-tracing/)和[监控排名模型](https://arize.com/blog/monitor-ranking-models/)的文章。
