# Julia ä¸­çš„ Metal ç¼–ç¨‹

> åŸæ–‡ï¼š[`towardsdatascience.com/metal-programming-in-julia-2db5fe8ee32c`](https://towardsdatascience.com/metal-programming-in-julia-2db5fe8ee32c)

![](img/1b0fa479f9906bf1570e41eed0082af9.png)

Little Heavy | ä½œè€…æä¾›çš„å›¾ç‰‡

## åˆ©ç”¨ macOS GPU çš„å¼ºå¤§åŠŸèƒ½ï¼Œé€šè¿‡ Metal.jl æ¡†æ¶ã€‚

[](https://lausena.medium.com/?source=post_page-----2db5fe8ee32c--------------------------------)![Gabriel Sena](https://lausena.medium.com/?source=post_page-----2db5fe8ee32c--------------------------------)[](https://towardsdatascience.com/?source=post_page-----2db5fe8ee32c--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page-----2db5fe8ee32c--------------------------------) [Gabriel Sena](https://lausena.medium.com/?source=post_page-----2db5fe8ee32c--------------------------------)

Â·å‘è¡¨äº[Towards Data Science](https://towardsdatascience.com/?source=post_page-----2db5fe8ee32c--------------------------------) Â·é˜…è¯»æ—¶é—´ 11 åˆ†é’ŸÂ·2023 å¹´ 12 æœˆ 4 æ—¥

--

## ä»‹ç»

å°±åœ¨å»å¹´ï¼Œæˆ‘ä»¬[äº†è§£åˆ°äº†](https://www.youtube.com/watch?v=IARikXzRU7s&ab_channel=TheJuliaProgrammingLanguage) [Metal.jl](https://github.com/JuliaGPU/Metal.jl)æ¡†æ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè‹¹æœç¡¬ä»¶çš„ GPU åç«¯ã€‚è¿™å¯¹å¸Œæœ›åˆ©ç”¨å…¶ macOS M ç³»åˆ—èŠ¯ç‰‡å…¨éƒ¨æ½œåŠ›çš„[Julia](https://julialang.org/)ä»ä¸šè€…æ¥è¯´æ˜¯ä»¤äººå…´å¥‹çš„æ¶ˆæ¯ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ•°æ®ç§‘å­¦å®¶å’Œæœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆå¯ä»¥é€šè¿‡åˆ©ç”¨ GPU çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›æ¥åŠ é€Ÿä»–ä»¬çš„è®¡ç®—å·¥ä½œæµç¨‹ï¼Œä»è€Œå®ç°æ›´å¿«çš„è®­ç»ƒå’Œæ¨æ–­æ—¶é—´ã€‚Metal.jl çš„å¼•å…¥æ ‡å¿—ç€å¯¹å°†è¯­è¨€çš„èƒ½åŠ›ä¸è‹¹æœå¹³å°ä¸Šä¸æ–­å‘å±•çš„ç§‘å­¦è®¡ç®—å’Œæœºå™¨å­¦ä¹ é¢†åŸŸå¯¹æ¥çš„é‡è¦æ¨åŠ¨ã€‚

> åœ¨[2020 å¹´](https://www.apple.com/newsroom/2020/06/apple-announces-mac-transition-to-apple-silicon/)æ—¶ï¼Œè‹¹æœå…¬å¸å¼€å§‹å°†å…¶ Mac ç³»åˆ—ä»åŸºäº Intel çš„å¤„ç†å™¨è¿‡æ¸¡åˆ° Apple Siliconï¼Œä» M1 èŠ¯ç‰‡å¼€å§‹ã€‚å°½ç®¡è¿™æ˜¯è‹¹æœå…¬å¸å†å²æ€§ä¸”ä»¤äººå°è±¡æ·±åˆ»çš„æˆå°±ï¼Œä½†ä¹Ÿä¼´éšç€ä¸å°‘æ‰¹è¯„å’Œé—®é¢˜ã€‚è‡ªä»æˆ‘æ‹¿åˆ° 32 æ ¸çš„ Mac Studio M1 èŠ¯ç‰‡åï¼Œæˆ‘ä¸€ç›´å¸Œæœ›å……åˆ†åˆ©ç”¨ GPU å¹¶å°è¯•æ–°çš„åº”ç”¨ç¨‹åºã€‚æˆ‘å¿…é¡»è¯´ï¼Œè¿™å¹¶éå…¨æ˜¯è½»æ¾æ„‰å¿«çš„ç»å†ã€‚ä»[ARM](https://en.wikipedia.org/wiki/ARM_architecture_family)æ¶æ„å…¼å®¹æ€§é—®é¢˜åˆ°ä¸æ”¯æŒçš„æœºå™¨å­¦ä¹ åº“â€”â€”æœ‰æ—¶è¦è·å¾—ä¸€ä¸ªå·¥ä½œç¯å¢ƒç¡®å®æ˜¯ä¸€ç§æŒ‘æˆ˜ã€‚è¿™æ˜¯ä»»ä½•é‡å¤§è¿‡æ¸¡å’Œæ“ä½œæ–¹å¼ä¸­éƒ½ä¼šé‡åˆ°çš„é¢„æœŸé—®é¢˜ã€‚æˆ‘ä»ç„¶ä¿æŒä¹è§‚ï¼Œå¹¶çœ‹åˆ°åœ¨ç¨³å®šæ€§å’ŒåŠŸèƒ½æ–¹é¢çš„å…¨é¢é‡å¤§æ”¹è¿›ã€‚

**åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é¢„è§ˆ Metal.jl æ¡†æ¶ä»¥äº†è§£å…¶èƒ½åŠ›ã€‚æˆ‘ä»¬è¿˜å°†å±•ç¤ºä¸€ä¸ªä½¿ç”¨** [**Flux**](https://fluxml.ai/)**çš„å®é™…ç¤ºä¾‹ï¼Œå®ƒæ˜¯ Julia ä¸­çš„ä¸€ä¸ªæœºå™¨å­¦ä¹ åº“ï¼Œå¹¶é…åˆ Metal åç«¯ã€‚**

*ä»¥ä¸‹æ˜¯æ¶µç›–ä¸»é¢˜çš„çº²è¦ï¼š*

**I.** **é¡¹ç›®è®¾ç½®**

i. Julia ç¯å¢ƒè®¾ç½®

ii. ä¾èµ–æ¦‚è¿°

**II.** **åˆ©ç”¨ Metal API**

i. å†…æ ¸å‡½æ•°

ii. åŸºå‡†æµ‹è¯•

iii. æ€§èƒ½åˆ†æ

**III.** **ä½¿ç”¨ Flux å’Œ Metal Backend**

i. æ•°æ®é›†æ¦‚è¿°

ii. ç®€å•ç¥ç»ç½‘ç»œ

iii. æ¨¡å‹è¯„ä¼°

å¸Œæœ›è·Ÿéšçš„è¯»è€…åº”å…·å¤‡ï¼š

1.  å¯¹ [Julia ç¼–ç¨‹è¯­è¨€](https://pub.aimind.so/getting-started-with-the-julia-programming-language-0c0d8521a381) çš„åŸºæœ¬çŸ¥è¯†ã€‚

1.  å¯¹æœºå™¨å­¦ä¹ æ¦‚å¿µçš„é«˜çº§ç†è§£ã€‚

*è®©æˆ‘ä»¬æ·±å…¥äº†è§£å§ï¼*

## **é¡¹ç›®è®¾ç½®**

> i. Julia ç¯å¢ƒè®¾ç½®

è®¾ç½®ä¸€ä¸ªç‰¹å®šäºé¡¹ç›®çš„ç¯å¢ƒè¢«è§†ä¸ºè‰¯å¥½å®è·µã€‚è¿™æ ·å¯ä»¥éš”ç¦»é¡¹ç›®æ‰€éœ€çš„ç¡®åˆ‡ç‰ˆæœ¬çš„åŒ…ï¼Œå¹¶ä¸ºè‡ªå·±å’Œå›¢é˜Ÿæˆå‘˜æä¾›ä¸€ä¸ªå®¹æ˜“å¤ç°çš„ç¯å¢ƒã€‚è¿™åœ¨ [Julia](https://pub.aimind.so/getting-started-with-the-julia-programming-language-0c0d8521a381) ä¸­å¾ˆå®¹æ˜“åšåˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

> ii. ä¾èµ–æ¦‚è¿°

[**Metal**](https://github.com/JuliaGPU/Metal.jl)**:** è¿™æ˜¯ä¸€ä¸ªä½¿åœ¨ macOS ä¸Šç¼–ç¨‹ GPU æˆä¸ºå¯èƒ½çš„æ¡†æ¶ã€‚å¦‚è´¡çŒ®è€…æ‰€è¿°ï¼Œè¯¥åŒ…æ˜¯**æ­£åœ¨å¼€å‘ä¸­**ï¼Œå­˜åœ¨é”™è¯¯ã€åŠŸèƒ½ç¼ºå¤±å’Œæ€§èƒ½å°šæœªå®Œå…¨ä¼˜åŒ–çš„æƒ…å†µã€‚**è¯·ç¡®ä¿æ‚¨è¿˜æ»¡è¶³ä»¥ä¸‹ç³»ç»Ÿè¦æ±‚ï¼š**

âœ” é…å¤‡ M ç³»åˆ—èŠ¯ç‰‡çš„ Mac è®¾å¤‡ï¸ï¸ï¸

âœ” Julia 1.8â€“1.10

âœ” macOS 13 (Ventura) æˆ– 14 (Sonoma)

[**BenchmarkTools**](https://github.com/JuliaGPU/Metal.jl)**:** æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåº“æ¥æ‰§è¡Œä¸€äº›æ“ä½œçš„åŸºå‡†æµ‹è¯•ï¼Œè¿™äº›æ“ä½œé€šè¿‡ Metal APIs å‘é€åˆ°æˆ‘ä»¬çš„ GPUã€‚è¿™ä¸ªåŒ…ä½¿é…ç½®ã€æ‰§è¡Œå’Œåˆ†æç»“æœå˜å¾—å®¹æ˜“ã€‚

[**Flux**](https://fluxml.ai/Flux.jl/stable/)**:** Flux æ˜¯ä¸€ä¸ªç›´è§‚çš„ Julia æœºå™¨å­¦ä¹ åº“ï¼›å®ƒæ—¨åœ¨æä¾›ä¸€ä¸ªé«˜çº§ä¸”ç”¨æˆ·å‹å¥½çš„ç•Œé¢æ¥æ„å»ºå’Œè®­ç»ƒç¥ç»ç½‘ç»œã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåº“ä½œä¸ºç¤ºä¾‹ï¼Œå¹¶åˆ©ç”¨ Metal Backend æ¥åˆ©ç”¨æˆ‘ä»¬çš„ GPUã€‚

ä»¥ä¸‹æ˜¯æœ¬æ–‡å‘å¸ƒæ—¶çš„ä¾èµ–ç‰ˆæœ¬ã€‚

```py
julia> # press "]" to get into the package manager
(jl_jQfFj6) pkg> status
Status `/private/var/folders/33/mcgc5pgd2ls6yp3ggq6rszvc0000gn/T/jl_jQfFj6/Project.toml`
  [6e4b80f9] BenchmarkTools v1.3.2
  [587475ba] Flux v0.14.6
  [dde4c033] Metal v0.5.1
```

é…ç½®å¥½æˆ‘ä»¬çš„ç¯å¢ƒå¹¶å¯¹æ‰€ä½¿ç”¨çš„åº“æœ‰äº†é«˜çº§ç†è§£åï¼Œè®©æˆ‘ä»¬æ¢ç´¢ Metal APIã€‚

## åˆ©ç”¨ Metal API

Metal.jl ä¸ Apple çš„ Metal å›¾å½¢ API è¿›è¡Œæ¥å£â€”â€”è¿™æ˜¯ Apple ä¸ºå…¶å„ç§å¹³å°ï¼ˆmacOSã€iPhoneã€æ‰‹è¡¨ç­‰ï¼‰å¼€å‘çš„ä½çº§ APIã€‚

è¿™ä½¿ç”¨æˆ·å¯ä»¥ç›´æ¥æ§åˆ¶ [GPU (å›¾å½¢å¤„ç†å•å…ƒ)](https://en.wikipedia.org/wiki/Graphics_processing_unit)ï¼Œç”¨äºæ¸²æŸ“å›¾å½¢å’Œå¹¶è¡Œè®¡ç®—ç­‰ä»»åŠ¡ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªåŸºæœ¬çš„ç¤ºä¾‹ã€‚

> i. å†…æ ¸å‡½æ•°

åœ¨ Apple Metal æ¡†æ¶çš„èƒŒæ™¯ä¸‹ï¼Œ**å†…æ ¸å‡½æ•°**æ˜¯ä¸€ç§åœ¨ GPU ä¸Šæ‰§è¡Œçš„ç‰¹æ®Šç±»å‹çš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°æ˜¯ç”¨ç€è‰²è¯­è¨€ç¼–å†™çš„ï¼›åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ˜¯[Metal Shading Language](https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf) (MSL)ã€‚

> â€œMSL å…è®¸ç”¨æˆ·ç¼–å†™ä¸€ä¸ª*shader ç¨‹åº*ï¼Œè¿™æ˜¯ä¸€ç§åœ¨ GPU ä¸Šè¿è¡Œçš„å›¾å½¢å’Œæ•°æ®å¹¶è¡Œè®¡ç®—ä»£ç ã€‚Shader ç¨‹åºåœ¨ GPU çš„ä¸åŒå¯ç¼–ç¨‹å•å…ƒä¸Šè¿è¡Œã€‚MSL æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„è¯­è¨€ï¼Œå…è®¸å›¾å½¢å’Œè®¡ç®—ç¨‹åºä¹‹é—´æœ‰æ›´ç´§å¯†çš„é›†æˆã€‚â€ Â³

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¡®ä¿èƒ½å¤Ÿç›‘æ§ GPU çš„è´Ÿè½½ã€‚Apple å…·æœ‰å†…ç½®çš„ GPU å†å²è®°å½•ã€‚åœ¨ Mac ä¸Šçš„æ´»åŠ¨ç›‘è§†å™¨åº”ç”¨ä¸­ï¼Œé€‰æ‹©çª—å£ > GPU å†å²è®°å½•ã€‚ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼æˆ‘çš„ç”»é¢ï¼š

![](img/046fd1e1d9cfc2121cbcc352daec59af.png)

GPU å†å²è®°å½•ã€‚é¡¶éƒ¨çš„å°–å³°è¡¨ç¤ºæœ€å¤§ GPU ä½¿ç”¨ç‡ | å›¾ç‰‡æ¥æºï¼šä½œè€…

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª*çŸ©é˜µä¹˜æ³•å†…æ ¸*ã€‚ä¸ºäº†åˆ©ç”¨ GPUï¼Œæˆ‘ä»¬å°†æ•…æ„é€šè¿‡åœ¨çŸ©é˜µæ“ä½œä¸Šè¿­ä»£*N = 100 ä¸‡*æ¬¡æ¥åˆ›å»ºè®¡ç®—å¤æ‚æ€§ã€‚

æˆ‘ä»¬å°†å®šä¹‰**A**ä¸ºä¸€ä¸ª*m x n*çŸ©é˜µï¼Œ**B**ä¸ºä¸€ä¸ª*n x p*çŸ©é˜µï¼Œ**C**ä¸ºç”±*m x p*å®šä¹‰çš„ç»“æœçŸ©é˜µã€‚**C=ABã€‚** ç»“æœçš„å†…æ ¸å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼›é™¤äº†å¯¹å†…æ ¸å‡½æ•°å’Œåº•éƒ¨å®šä¹‰çš„çŸ©é˜µå˜é‡è¿›è¡Œä¸€äº›å°çš„è°ƒæ•´å¤–ï¼Œä»£ç ä¸ä½ åœ¨ Julia ä¸­æœŸæœ›çš„ç›¸å½“ç›¸ä¼¼ã€‚

å¾®å¦™çš„å·®å¼‚æˆ–é™„åŠ å†…å®¹å¦‚ä¸‹ï¼š**thread_position_in_grid_1d()**å‡½æ•°è¿”å›å½“å‰çº¿ç¨‹åœ¨å…¶ä¸€ç»´ç½‘æ ¼ä¸­çš„ç´¢å¼•ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒä¼šçŸ¥é“ GPU åº”è¯¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸Šæ“ä½œå“ªäº›æ•°æ®ã€‚è¿™ç§ç²¾ç»†åŒ–çš„çº¿ç¨‹åˆ†é…æ§åˆ¶æ–¹æ³•ä½¿ç”¨æˆ·èƒ½å¤Ÿæœ€å¤§é™åº¦åœ°å‘æŒ¥ç³»ç»Ÿçš„è®¡ç®—èƒ½åŠ›ã€‚

å½“æˆ‘ä»¬åˆå§‹åŒ–çŸ©é˜µ**A**ã€**B**å’Œ**C**æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿åœ¨ GPU ä¸Šä½¿ç”¨ Metal åˆå§‹åŒ–å€¼ï¼›è¿™ç¡®ä¿æˆ‘ä»¬ä½¿å…¶é€‚åˆ GPU åŠ é€Ÿè®¡ç®—ã€‚æ­¤å¤–ï¼Œ**storage=Shared**å‚æ•°æŒ‡ç¤ºçŸ©é˜µæ•°æ®åº”å­˜å‚¨åœ¨[å…±äº«å†…å­˜](https://developer.apple.com/documentation/metal/mtlstoragemode/mtlstoragemodeshared?language=objc)ä¸­ï¼Œä»è€Œä½¿ CPU å’Œ GPU éƒ½èƒ½è®¿é—®ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨è®¿é—®è¯¥èµ„æºä¹‹å‰è¿›è¡ŒåŒæ­¥ï¼š

> â€œç¡®ä¿ä½ åœ¨ CPU æˆ– GPU ä¸Šä¸ºä½¿ç”¨å…±äº«å†…å­˜çš„èµ„æºå®‰æ’çš„æ‰€æœ‰æ›´æ”¹åœ¨è®¿é—®è¯¥èµ„æºçš„å¦ä¸€ä¸ªå¤„ç†å™¨ä¹‹å‰å®Œæˆã€‚â€ Â²

æœ€åè¦æåˆ°çš„æ˜¯æœ«å°¾çš„`C_cpu`å˜é‡ã€‚`unsafe_wrap`å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä¸ GPU æ•°ç»„`C`å…±äº«ç›¸åŒåº•å±‚å†…å­˜çš„ CPU æ•°ç»„`C_cpu`ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ CPU å’Œ GPU ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œä»¥ä¾¿åç»­è¿›è¡Œè®¡ç®—ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†å±•ç¤ºåœ¨æ‰€æœ‰ GPU æ“ä½œå®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹å…¶è¿›è¡Œé€†æ“ä½œæ¥ä¿®æ”¹ç»“æœçŸ©é˜µ Cï¼ˆ*inv(C_cpu))ã€‚*

å¤ªæ£’äº†ï¼ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†å†…æ ¸ï¼Œæ¥ä¸‹æ¥è¿›è¡Œè®¡ç®—å’ŒåŸºå‡†æµ‹è¯•å§ã€‚

> ii. åŸºå‡†æµ‹è¯•

**benchmark**å®ï¼ˆ*å®ä»¥â€œ@â€å¼€å¤´*ï¼‰ç”¨äºæµ‹é‡ GPU å†…æ ¸**matrix_multiplication_kernel**çš„æ€§èƒ½ã€‚

åœ¨æ‰§è¡Œæˆ‘ä»¬çš„`begin...end`å—ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Metal.@sync`ç¡®ä¿ CPU å’Œ GPU ä¹‹é—´çš„åŒæ­¥ï¼Œå¹¶ä¸”æ‰€æœ‰ GPU å‘½ä»¤åœ¨åˆ‡æ¢åˆ° CPU ä»£ç ä¹‹å‰å·²ç»å®Œæˆã€‚

åœ¨**metal**å®ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†`threads`å’Œ`groups`çš„æ•°é‡ã€‚æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ‰§è¡Œè®¡ç®—ã€‚è¿™ä¸ªæ•°é‡è¿˜å†³å®šäº†å¤šå°‘æ“ä½œå¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æŒ‡å®š 256 ä¸ªçº¿ç¨‹ï¼Œåˆ™æ¯ä¸ªçº¿ç¨‹å°†è´Ÿè´£ä¸€éƒ¨åˆ†è®¡ç®—ã€‚çº¿ç¨‹è¢«ç»„ç»‡æˆç»„ï¼›ä¸€ä¸ªçº¿ç¨‹ç»„æ˜¯å¯ä»¥ä¸€èµ·å·¥ä½œå¹¶åè°ƒçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹é›†åˆã€‚

> æ€»çš„æ¥è¯´ï¼ŒM1 GPU åŒ…å«æœ€å¤š 128 ä¸ª[æ‰§è¡Œå•å…ƒ](https://en.wikipedia.org/wiki/Execution_unit)æˆ– 1024 ä¸ª ALUï¼Œâ´ è‹¹æœè¡¨ç¤ºè¿™äº›æ‰§è¡Œå•å…ƒå¯ä»¥åŒæ—¶æ‰§è¡Œæœ€å¤š 24,576 ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”å…¶æœ€å¤§æµ®ç‚¹ï¼ˆFP32ï¼‰æ€§èƒ½ä¸º 2.6 [TFLOPs](https://en.wikipedia.org/wiki/TFLOPS)ã€‚âµ â¶

ä¸‹é¢æ˜¯å¯¹***N (100)***ã€***threads (256)***å’Œ***groups (256)***å‚æ•°è¿›è¡Œè°ƒæ•´åçš„ç»“æœã€‚

![](img/8aa87b1f71d7a814246f48f7a8e3ae48.png)

åŸºå‡†æµ‹è¯•ç»“æœ | ä½œè€…æä¾›çš„å›¾ç‰‡

> iii. æ€§èƒ½åˆ†æ

*è¦è¿›è¡Œæ€§èƒ½åˆ†æå¹¶æŸ¥çœ‹ç»“æœï¼Œæ‚¨å¿…é¡»å®‰è£…* [*XCode*](https://developer.apple.com/xcode/)ã€‚

æ€§èƒ½åˆ†æä»£ç æ˜¯ä¸€ä¸ªå¸¸è¢«å¿½è§†çš„å­¦ç§‘ï¼Œå®ƒæ˜¯è½¯ä»¶å¼€å‘å’Œæ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ–¹é¢ã€‚æ€§èƒ½åˆ†ææ¶‰åŠæµ‹é‡ç¨‹åºæ‰§è¡Œçš„å„ç§æ–¹é¢ã€‚è¿™å¯ä»¥åŒ…æ‹¬ä¸åŒå‡½æ•°æ‰€éœ€çš„æ—¶é—´ã€å‡½æ•°è°ƒç”¨çš„é¢‘ç‡ã€å†…å­˜ä½¿ç”¨æˆ–æ³„æ¼ã€‚æ€§èƒ½åˆ†æè¿˜æœ‰åŠ©äºç¡®ä¿å¯¹ä»£ç æ‰€åšçš„ä»»ä½•æ›´æ”¹é€šè¿‡æ€§èƒ½é‡åŒ–ã€‚

å¦‚æœä½ æ›¾ç»å†è¿‡ä»£ç éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒåæ„å¤–å¯¼è‡´ç³»ç»Ÿæ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼Œåæ¥å‘ç°æ˜¯å› ä¸ºåˆçº§ç¨‹åºå‘˜æ— æ„ä¸­å¼•å…¥äº†ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º O(nÂ²)çš„åµŒå¥—å¾ªç¯ï¼Œä½ å¹¶ä¸å­¤å•ã€‚è™½ç„¶åµŒå¥—çš„ for å¾ªç¯åœ¨æŸäº›æƒ…å†µä¸‹çœ‹ä¼¼å¯ä»¥æ¥å—ï¼Œä½†éšç€å€¼çš„æ•°é‡å¢åŠ ï¼Œå…¶å½±å“å˜å¾—è¶Šæ¥è¶Šéº»çƒ¦ï¼Œå¯¼è‡´æ˜¾è‘—çš„æ€§èƒ½æŒ‘æˆ˜ã€‚**åŠæ—©å‘ç°ï¼Œå€ŸåŠ©æ€§èƒ½åˆ†ææ¥æ•æ‰ï¼**

æ€§èƒ½åˆ†æå¯ä»¥é€šè¿‡ä¸¤ä¸ªæ­¥éª¤ç®€å•å®Œæˆã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨`metal`å®å‰é¢æŒ‡å®š`Metal.@profile`å®ã€‚æ¥ä¸‹æ¥ï¼Œç¡®ä¿ä½ è®¾ç½®äº†ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š**ENV[â€œMETAL_CAPTURE_ENABLEDâ€] = 1**

ç°åœ¨ä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

`Metal.@profile @metal threads=n_threads groups=n_groups matrix_multiplication_kernel(A, B, C)`

ä»é‚£é‡Œï¼Œæˆ‘ä»¬è·å¾—ä¸€ä¸ª**julia_capture_*N*.gputrace**æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨ä¸é¡¹ç›®ç›¸åŒçš„ç›®å½•ä¸­ã€‚è¦ä¸ä¹‹äº¤äº’ï¼Œè¯·åœ¨ XCode ä¸­æ‰“å¼€å®ƒå¹¶é‡æ”¾è·Ÿè¸ªã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å„ç§æœ‰ç”¨çš„æŒ‡æ ‡ï¼Œå¯ä»¥è¿›ä¸€æ­¥æŒ–æ˜ã€‚

![](img/679ccf8c1699e5581792249c64d55f66.png)

Xcode | ä½œè€…æä¾›çš„å›¾ç‰‡

åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†å¦‚ä½•é€šè¿‡ Metal.jl ä¸ Apple çš„ Metal å›¾å½¢ API äº¤äº’â€”â€”è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ§åˆ¶ GPU ä»¥è¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚æˆ‘ä»¬ä»‹ç»äº† Metal ç€è‰²è¯­è¨€ä¸­çš„å†…æ ¸å‡½æ•°ï¼Œå¹¶ä½¿ç”¨äº†ä¸€ä¸ªæ•…æ„å¢åŠ  GPU å·¥ä½œè´Ÿè½½çš„çŸ©é˜µä¹˜æ³•å†…æ ¸ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é€šè¿‡ Metal çš„å®ä»‹ç»äº†åŸºå‡†æµ‹è¯•å·¥å…·å’Œæ€§èƒ½åˆ†æèƒ½åŠ›ã€‚

*è®©æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªå®é™…çš„åœºæ™¯ï¼*

## ä½¿ç”¨ Flux å’Œ Metal åç«¯

> i. æ•°æ®é›†æ¦‚è¿°

æˆ‘ä»¬å°†ä½¿ç”¨ä»å¨æ–¯åº·æ˜Ÿå¤§å­¦åŒ»é™¢éº¦è¿ªé€Šåˆ†é™¢çš„å¨å»‰Â·HÂ·æ²ƒå°”ä¼¯æ ¼åšå£«é‚£é‡Œè·å¾—çš„ä¹³è…ºç™Œæ•°æ®åº“ã€‚Â¹â° Â¹Â¹ ***Class***ç‰¹å¾å°†ä½œä¸ºç›®æ ‡ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå¯èƒ½çš„å€¼ï¼ˆ2 è¡¨ç¤ºè‰¯æ€§ï¼Œ4 è¡¨ç¤ºæ¶æ€§ï¼‰ã€‚

ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘å°†ä¸ä¼šæ¼”ç¤ºæ•°æ®é›†æ‰€éœ€çš„é¢„å¤„ç†ï¼Œè€Œæ˜¯å°†è¯»è€…å‚è€ƒåˆ°é™„å½• Iï¼šJulia æºä»£ç ã€‚

> ii. ç®€å•çš„ç¥ç»ç½‘ç»œ

æˆ‘ä»¬å°†ä½¿ç”¨[Flux](https://fluxml.ai/Flux.jl/stable/)æ„å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œï¼Œè¯¥ç½‘ç»œåˆ©ç”¨äº†[Metal](https://developer.apple.com/documentation/metal)åç«¯ã€‚ä» v0.14 å¼€å§‹ï¼ŒFlux ä¸å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨ç‰¹å®šçš„ GPU åç«¯å’Œç›¸åº”çš„è½¯ä»¶åŒ…ä¾èµ–ã€‚â· å°½ç®¡æˆ‘ä»¬ä½¿ç”¨ Metal ä½œä¸ºåç«¯ï¼ŒFlux ä¹Ÿæ”¯æŒå…¶ä»–[åç«¯](https://fluxml.ai/Flux.jl/stable/gpu/)ï¼Œå¦‚ AMDGPU å’Œ CUDAã€‚

è®©æˆ‘ä»¬åšä¸€ä¸ªå¿«é€Ÿçš„åˆç†æ€§æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬çš„ç¯å¢ƒè®¾ç½®æ­£ç¡®ã€‚

![](img/afda8bc58b7407e04fdf3adcdc2dd4d8.png)

ä½¿ç”¨ Flux æµ‹è¯• Metal | ä½œè€…æä¾›çš„å›¾ç‰‡

ç°åœ¨æˆ‘ä»¬æœ‰äº†`device`å˜é‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒå°†æ•°æ®å’Œæ¨¡å‹ç§»åˆ° GPU ä¸Šã€‚**åœ¨è¿™é‡Œè¦å°å¿ƒï¼Œä½ å¯ä»¥åœ¨ Flux ä¸­æ‰§è¡Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸éœ€è¦å°†æ¨¡å‹å¯¼å‡ºåˆ° GPUâ€”â€”è¿™æ„å‘³ç€ä½ ä»åœ¨ä½¿ç”¨ CPUï¼ˆå“å‘€ï¼‰ï¼**

![](img/4611a46eaa8be2e2c617e2a9deba28b0.png)

æ¨¡å‹å®šä¹‰ï¼ˆå¯¹äºæˆ‘ä»¬çš„äºŒåˆ†ç±»é—®é¢˜ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªé€»è¾‘å›å½’æ¨¡å‹ï¼‰ | ä½œè€…æä¾›çš„å›¾ç‰‡

ä¸ºäº†å‡†å¤‡æˆ‘ä»¬çš„æ•°æ®è¿è¡Œï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ [Flux.DataLoader](https://fluxml.ai/Flux.jl/previews/PR1786/data/dataloader/)ã€‚è¿™ä¸ªæ¨¡å—å¤„ç†å¯¹å°æ‰¹é‡æ•°æ®çš„è¿­ä»£ã€‚ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä¿æŒç®€å•ï¼Œè®¾ç½®äº†`batchsize=1`ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘çš„æ•°æ®åŒ…å« 800 è¡Œï¼Œæ¯ä¸ªæ‰¹æ¬¡ä¸ä¸€è¡Œæ•°æ®ç›¸å…³ã€‚åœ¨æ›´é«˜æ•ˆçš„åœºæ™¯ä¸­ï¼Œä½ å¯èƒ½å¸Œæœ›å°†æ•°æ®åˆ†å¼€ï¼Œä»¥ä¾¿å°†å¤„ç†çš„æ•°æ®è¿›è¡Œåˆ†ç»„ã€‚

åœ¨è·³åˆ°ä¸‹ä¸€éƒ¨åˆ†ä¹‹å‰ï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„æˆ‘åœ¨å°† DataFrame ç›´æ¥ä¼ é€’ç»™ DataLoader æ—¶é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸€äº›æˆ‘å¿…é¡»å®ç°çš„è§£å†³æ–¹æ³•ã€‚

![](img/515646d0995f178f0a87d144b469105c.png)

æ•°æ®å‡†å¤‡ | å›¾ç‰‡æ¥æºï¼šä½œè€…

> iii. æ¨¡å‹è¯„ä¼°

ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†æ¨¡å‹è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ã€‚å½“ `x_cpu` å’Œ `y_cpu` å˜é‡ï¼ˆæˆ‘ä»¬çš„è¡Œå’Œæ ‡ç­¾ï¼‰ä» [DataLoader](https://fluxml.ai/Flux.jl/previews/PR1786/data/dataloader/) è¿”å›æ—¶ï¼Œåˆ©ç”¨ GPU æ˜¯è‡³å…³é‡è¦çš„â€”â€”å¦åˆ™ï¼Œç”±äºå…¼å®¹æ€§é—®é¢˜ï¼Œæ¨¡å‹æœŸæœ›åœ¨ GPU ä¸Šçš„æ•°æ®å°†å¯¼è‡´å´©æºƒã€‚

![](img/716e15b34c3f867abfe2b083e390b83d.png)

é¡¹ç›®è¿è¡Œæ¼”ç¤ºåŠåˆ©ç”¨ M1-Max GPUï¼ | å›¾ç‰‡æ¥æºï¼šä½œè€…

åœ¨å¯¹ Metal.jl æ¡†æ¶çš„ç®€è¦ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬æ¶µç›–äº†åœ¨ Apple ç¡¬ä»¶ä¸Šè¿›è¡Œ GPU ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ã€‚é€šè¿‡æ¢ç´¢ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µâ€”â€”*å†…æ ¸å‡½æ•°ã€åŸºå‡†æµ‹è¯•å’Œæ€§èƒ½åˆ†æ*â€”â€”è¯»è€…ç°åœ¨å¯¹å¦‚ä½•å…¥é—¨æœ‰äº†è¾ƒé«˜å±‚æ¬¡çš„ç†è§£ï¼Œå¹¶è¢«é¼“åŠ±æ·±å…¥æ¢ç´¢ API çš„åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æ¼”ç¤ºäº†ä¸€ä¸ªå®é™…ç¤ºä¾‹ï¼Œåˆ©ç”¨ Flux æ„å»ºäº†ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œä½¿ç”¨äº† [Metal åç«¯](https://fluxml.ai/Flux.jl/stable/gpu/)ã€‚å¦‚æœä½ æ˜¯æ•°æ®ç§‘å­¦å®¶æˆ– ML å·¥ç¨‹å¸ˆï¼Œæƒ³è¦åˆ©ç”¨ Apple M ç³»åˆ— GPU çš„å¼ºå¤§åŠŸèƒ½ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ä½œä¸ºåŠ é€Ÿä½ çš„è®¡ç®—å·¥ä½œæµçš„èµ·ç‚¹ã€‚ä»è¿™é‡Œï¼Œæˆ‘å°†ç•™ä¸‹æ›´å¤šèµ„æºä¾›è¯»è€…æŸ¥çœ‹ï¼š

[](https://fluxml.ai/Flux.jl/stable/?source=post_page-----2db5fe8ee32c--------------------------------) [## æ¬¢è¿ Â· Flux

### Flux æ˜¯ä¸€ä¸ªæœºå™¨å­¦ä¹ åº“ã€‚å®ƒåŒ…å«è®¸å¤šæœ‰ç”¨çš„å·¥å…·ï¼Œä½†ä¹Ÿå…è®¸â€¦

fluxml.ai](https://fluxml.ai/Flux.jl/stable/?source=post_page-----2db5fe8ee32c--------------------------------)

*å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè°¢è°¢é˜…è¯»ï¼*

ğŸ‘

**æœ€åï¼Œæˆ‘è¦å¤§åŠ›æ„Ÿè°¢ Metal.jl é¡¹ç›®çš„åˆ›ä½œè€…ã€‚æˆ‘æœŸå¾…è¯¥é¡¹ç›®ç»§ç»­æˆåŠŸã€‚å¯¹äºä»»ä½•å¸Œæœ›è´¡çŒ®çš„äººï¼Œè¯·æŸ¥çœ‹ä»–ä»¬çš„ Github é¡µé¢** [**è¿™é‡Œ**](https://github.com/JuliaGPU/Metal.jl)**ã€‚**

## é™„å½• Iï¼šJulia æºä»£ç 

> åœ¨è¿è¡Œ Github ä¸Šæ‰¾åˆ°çš„æºä»£ç ä¹‹å‰ï¼Œæˆ‘å¼ºçƒˆå»ºè®®åŒ¹é…æœ¬æ–‡ä¸­æ‰¾åˆ°çš„ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿æˆåŠŸç¼–è¯‘ã€‚æ­¤å¤–ï¼ŒMetal.jl åº“ä»åœ¨å¼€å‘ä¸­ï¼Œå¯èƒ½ä¼šæ ¹æ®æŒ‡å®šçš„ç‰ˆæœ¬ç¼ºå°‘æˆ–åŒ…å«ä¸åŒçš„åŠŸèƒ½ã€‚

ğŸ”— [`github.com/lausena/JuliaExperiments/tree/main`](https://github.com/lausena/JuliaExperiments/tree/main)

*é¢„å¤„ç†çš„è¡¥å……å†…å®¹å¯ä»¥åœ¨æ­¤* [*å¸–å­*](https://medium.com/ai-mind-labs/practical-julia-logistic-regression-4e97a3cc3df8)*ä¸­æ‰¾åˆ°*ã€‚

[](https://medium.com/subscribe/@lausena?source=post_page-----2db5fe8ee32c--------------------------------) [## æ¯å½“ Gabriel Sena å‘å¸ƒæ–°å†…å®¹æ—¶ï¼Œä½ å°†ä¼šæ”¶åˆ°ç”µå­é‚®ä»¶ã€‚

### æ¯å½“ Gabriel Sena å‘å¸ƒæ–°å†…å®¹æ—¶ï¼Œä½ å°†ä¼šæ”¶åˆ°ç”µå­é‚®ä»¶ã€‚é€šè¿‡æ³¨å†Œï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰ Medium è´¦æˆ·ï¼Œå°†ä¼šåˆ›å»ºä¸€ä¸ªâ€¦

medium.com](https://medium.com/subscribe/@lausena?source=post_page-----2db5fe8ee32c--------------------------------)

***å‚è€ƒæ–‡çŒ®***

[1] [`www.youtube.com/watch?v=IARikXzRU7s&ab_channel=TheJuliaProgrammingLanguage`](https://www.youtube.com/watch?v=IARikXzRU7s&ab_channel=TheJuliaProgrammingLanguage)

[2] [`juliagpu.org/post/2022-06-24-metal/index.html`](https://juliagpu.org/post/2022-06-24-metal/index.html)

[3] [`developer.apple.com/metal/Metal-Shading-Language-Specification.pdf`](https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf)

[4] Frumusanu, Andreiã€‚ [â€œ2020 Mac Mini å¤§æ­ç§˜ï¼šæµ‹è¯• Apple Silicon M1â€](https://www.anandtech.com/show/16252/mac-mini-apple-m1-tested)ã€‚ [*www.anandtech.com*](http://www.anandtech.com)ã€‚ [å­˜æ¡£](https://web.archive.org/web/20210201183558/https://www.anandtech.com/show/16252/mac-mini-apple-m1-tested) è‡ªåŸå§‹é¡µé¢å­˜æ¡£äº 2021 å¹´ 2 æœˆ 1 æ—¥ã€‚æ£€ç´¢æ—¥æœŸä¸º 2021 å¹´ 1 æœˆ 30 æ—¥ã€‚

[5] [â€œApple M1 èŠ¯ç‰‡â€](https://www.apple.com/mac/m1/)ã€‚ *Apple.com*ã€‚Appleã€‚ [å­˜æ¡£](https://web.archive.org/web/20201110184757/https://www.apple.com/mac/m1/) è‡ªåŸå§‹é¡µé¢å­˜æ¡£äº 2020 å¹´ 11 æœˆ 10 æ—¥ã€‚æ£€ç´¢æ—¥æœŸä¸º 2020 å¹´ 11 æœˆ 11 æ—¥ã€‚

[6] Kingsley-Hughes, Adrian (2020 å¹´ 11 æœˆ 10 æ—¥)ã€‚ [â€œApple Silicon M1 èŠ¯ç‰‡ï¼šæˆ‘ä»¬çŸ¥é“ä»€ä¹ˆâ€](https://www.zdnet.com/article/apple-silicon-m1-chip-heres-what-we-know/)ã€‚ *ZDnet*ã€‚Red Venturesã€‚ [å­˜æ¡£](https://web.archive.org/web/20210917094527/https://www.zdnet.com/article/apple-silicon-m1-chip-heres-what-we-know/) è‡ªåŸå§‹é¡µé¢å­˜æ¡£äº 2021 å¹´ 9 æœˆ 17 æ—¥ã€‚æ£€ç´¢æ—¥æœŸä¸º 2021 å¹´ 7 æœˆ 1 æ—¥ã€‚

[7] [`fluxml.ai/Flux.jl/stable/gpu/`](https://fluxml.ai/Flux.jl/stable/gpu/)

[8] [`juliagpu.org/post/2023-03-03-metal_0.2/`](https://juliagpu.org/post/2023-03-03-metal_0.2/)

[9] [`fluxml.ai/Flux.jl/stable/tutorials/logistic_regression/`](https://fluxml.ai/Flux.jl/stable/tutorials/logistic_regression/)

[10] William H. Wolberg å’Œ O.L. Mangasarian: â€œç”¨äºåŒ»ç–—è¯Šæ–­çš„æ¨¡å¼åˆ†ç¦»ï¼Œåº”ç”¨äºä¹³è…ºç»†èƒå­¦â€ã€‚

â€œç”¨äºåŒ»ç–—è¯Šæ–­çš„æ¨¡å¼åˆ†ç¦»ï¼Œåº”ç”¨äºä¹³è…ºç»†èƒå­¦â€ï¼Œ

ã€Šç¾å›½å›½å®¶ç§‘å­¦é™¢é™¢åˆŠã€‹ï¼Œç¬¬ 87 å·ï¼Œ

1990 å¹´ 12 æœˆï¼Œç¬¬ 9193â€“9196 é¡µã€‚

[11] è¯¥æ•°æ®é›†éµå¾ª [çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™…](https://creativecommons.org/licenses/by/4.0/legalcode) (CC BY 4.0) è®¸å¯åè®®ã€‚ [`archive.ics.uci.edu/ml/machine-learning-databases/breast-cancer-wisconsin/breast-cancer-wisconsin.names`](https://archive.ics.uci.edu/ml/machine-learning-databases/breast-cancer-wisconsin/breast-cancer-wisconsin.names)
