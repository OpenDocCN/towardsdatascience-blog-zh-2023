# åˆ©ç”¨ SQL ä¸­çš„åˆ†æå‡½æ•°åŠ é€Ÿæ•°æ®æå–

> åŸæ–‡ï¼š[`towardsdatascience.com/sql-window-functions-939ed24c9752`](https://towardsdatascience.com/sql-window-functions-939ed24c9752)

## åˆ†æå‡½æ•°æä¾›äº†ä¸€ç§æå…¶å¼ºå¤§ä¸”æ˜“äºå®ç°çš„æ•°æ®å¤„ç†å’Œåˆ†ææ–¹å¼ã€‚æœ¬æ–‡å°†å±•ç¤ºå¦‚ä½•åœ¨ SQL è¯­å¥ä¸­ä½¿ç”¨åˆ†æå‡½æ•°ã€‚

[](https://guenterroehrich.medium.com/?source=post_page-----939ed24c9752--------------------------------)![GÃ¼nter RÃ¶hrich](https://guenterroehrich.medium.com/?source=post_page-----939ed24c9752--------------------------------)[](https://towardsdatascience.com/?source=post_page-----939ed24c9752--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page-----939ed24c9752--------------------------------) [GÃ¼nter RÃ¶hrich](https://guenterroehrich.medium.com/?source=post_page-----939ed24c9752--------------------------------)

Â·å‘å¸ƒåœ¨ [Towards Data Science](https://towardsdatascience.com/?source=post_page-----939ed24c9752--------------------------------) Â·8 åˆ†é’Ÿé˜…è¯»Â·2023 å¹´ 7 æœˆ 18 æ—¥

--

ä½œä¸ºä¸€ååˆ†æå¸ˆï¼Œä½ å¾ˆå¯èƒ½ä¼šé‡åˆ°éœ€è¦æŸ¥è¯¢æ•°æ®ä»¥è¿›è¡Œåˆ†æçš„æƒ…æ™¯ã€‚æ•°æ®é€šå¸¸æ¥è‡ª SQL æ•°æ®åº“ï¼Œç„¶åé€šè¿‡åƒ Python è¿™æ ·çš„ç¼–ç¨‹è¯­è¨€å’Œ Pandas æˆ– NumPy ç­‰å¼ºå¤§æ¡†æ¶å¯¼å…¥ã€‚è¿™æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„å®Œå…¨æœ‰æ•ˆçš„ç®¡é“ï¼Œä½†é‡çš„è®¡ç®—ä¸»è¦ä¾èµ–äºä½ çš„æœ¬åœ°æœºå™¨ã€‚å¯¹äºå°æ•°æ®é›†ï¼Œè¿™ä¸æ˜¯é—®é¢˜ï¼Œä½†å¯¹äºè¾ƒå¤§çš„æ•°æ®é›†ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»…ä¾é  PC æœ¬åœ°å†…å­˜å¤„ç†å¤§é‡æ•°æ®çš„å›°éš¾ã€‚

*ä½ å¯èƒ½è®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ã€‚å› æ­¤ï¼Œè®©æˆ‘ç»™å‡ºä¸€ä¸ªæ—¥å¸¸çš„ä¾‹å­æ¥è¯æ˜è¿™ä¸ªå‡è®¾æ˜¯é”™è¯¯çš„ï¼š*

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åœ¨ä¸€å®¶åˆ¶é€ å…¬å¸å·¥ä½œï¼Œå¹¶ä¸”å¯¹æ”¶é›†æœºå™¨ä¼ æ„Ÿå™¨æ•°æ®æ„Ÿå…´è¶£ã€‚è¿™äº›æ•°æ®é€šå¸¸è¢«é¢‘ç¹æ”¶é›†ï¼Œè€Œä¸”å¯èƒ½éå¸¸å˜ˆæ‚ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ä½ çš„æœºå™¨çŠ¶æ€ï¼Œå¯¹å¯†é›†æ”¶é›†çš„æ•°æ®è¿›è¡Œå¹³æ»‘å’Œé¢„å¤„ç†ï¼ˆä¾‹å¦‚ï¼Œæµ‹é‡å¯èƒ½æ¯ç§’æ”¶é›†å‡ æ¬¡ï¼‰å¾ˆå¿«å°±ä¼šäº§ç”Ÿåºå¤§çš„æ•°æ®é›†ï¼å‡è®¾æˆ‘ä»¬åœ¨ä¸€å°æœºå™¨æ—è¾¹æ”¾ç½®äº† 150 ä¸ªä¼ æ„Ÿå™¨ï¼Œæ¯ä¸ªä¼ æ„Ÿå™¨æ¯ç§’è¯»å– 4 æ¬¡æ•°æ®ã€‚é‚£ä¹ˆä¸€å¤©çš„æ•°æ®å°†ä¼šäº§ç”Ÿ

4Ã—60Ã—60Ã—24x150 â‰ˆ 52 ç™¾ä¸‡æ¡è®°å½•ï¼ˆè¯»å–æ¬¡æ•° Ã— ç§’ Ã— åˆ†é’Ÿ Ã— å°æ—¶ Ã— ä¼ æ„Ÿå™¨ï¼‰

æ•°æ®ç‚¹ã€‚é€šå¸¸ï¼Œä½œä¸ºç»éªŒæ³•åˆ™ï¼Œæˆ‘ä»¬ä¼šæŸ¥çœ‹è‡³å°‘ä¸€å‘¨çš„æ•°æ®ï¼ˆä½†æˆ‘ä»¬ä¹Ÿå¯èƒ½å¢åŠ è¯»å–æ¬¡æ•°æˆ–ä¼ æ„Ÿå™¨æ•°é‡ï¼‰â€¦â€¦ä½ èƒ½ç†è§£è¿™ç‚¹ã€‚

å› æ­¤ï¼Œä½ å¯èƒ½æ›´å¥½åœ°å°†è®¡ç®—æˆæœ¬é«˜çš„èšåˆæ“ä½œè½¬ç§»åˆ°æºæ•°æ®åº“ä¸­ã€‚ç‰¹åˆ«æ˜¯ï¼Œåˆ†ææˆ–çª—å£å‡½æ•°çš„è¯­æ³•ç›´æ¥æ˜äº†ï¼Œå´æ˜¯è¯»å–ã€è½¬æ¢å’Œæå–æ•°æ®çš„å¼ºå¤§å·¥å…·ï¼Œé€‚ç”¨äºæ›´é«˜å±‚æ¬¡çš„èšåˆã€‚

> **å…³é”®è¦ç‚¹**ï¼š
> 
> æ¯å½“ä½ çœ‹åˆ°éœ€è¦æ»šåŠ¨/ç§»åŠ¨çª—å£æˆ–åœ¨é€»è¾‘åˆ†åŒºå†…è¿›è¡Œè®¡ç®—ï¼ˆä¾‹å¦‚ï¼ŒæŒç»­æ’åï¼Œä»æœ€ä½åˆ°æœ€é«˜å€¼ï¼Œåœ¨æŸäº›ä¼ æ„Ÿå™¨ç»„å†…ï¼‰ï¼Œç›´æ¥åœ¨ SQL æŸ¥è¯¢ä¸­åº”ç”¨çª—å£å‡½æ•°é€šå¸¸æ˜¯å€¼å¾—è€ƒè™‘çš„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Pandas ä¸­å®ç°çš„æ›´æ˜‚è´µçš„å‡½æ•°æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚

## è¿™ç¯‡ç®€çŸ­çš„æ–‡ç« æ˜¯å¦‚ä½•ç»“æ„åŒ–çš„ï¼Ÿ

1.  ä¸€ä¸ª ç®€çŸ­çš„ä»‹ç» ä¾‹å­å’Œçª—å£å‡½æ•°å¦‚ä½•å·¥ä½œçš„ç†è®º

1.  ä¸€ä¸ª å¿«é€ŸæŒ‡å—æ¥å®‰è£…ä¸€äº› SQL æ¼”ç¤ºæ•°æ® ä»¥åŠä¸€ä¸ªå¯ä»¥åœ¨ç”µè„‘ä¸Šç›´æ¥ä½¿ç”¨çš„æ•°æ®åº“ï¼ˆè¿™å¾ˆç®€å•ï¼ï¼‰ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è‘—åçš„ **çº½çº¦å‡ºç§Ÿè½¦** æ•°æ®ã€‚

1.  ç¤ºä¾‹ è®©ä½ ç†Ÿæ‚‰è¿™äº›å‡½æ•°

![](img/07f82d39dbfab5144ca87e8f110b152d.png)

ä¸€äº›çª—å£å‡½æ•°çš„ [Julio CÃ©sar Bosch](https://unsplash.com/@jcbossch?utm_source=medium&utm_medium=referral)

# ä»‹ç»

**ä¸ºä»€ä¹ˆä½ éœ€è¦çª—å£å‡½æ•°ï¼Ÿ**

åœ¨æ•°æ®ç§‘å­¦æ›´å…·å¸å¼•åŠ›çš„é¢†åŸŸå¼•èµ·çš„è½°åŠ¨ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸å¿½è§†äº†æ•°æ®ç§‘å­¦å®¶å¤§éƒ¨åˆ†æ—¶é—´èŠ±è´¹åœ¨è·å–ã€å¤„ç†å’Œæ¸…æ´—æ•°æ®ä¸Šã€‚æ¯å½“ä½ çœ‹åˆ°éœ€è¦è®¡ç®—æˆæœ¬é«˜çš„è¿è¡Œæ€»å’Œæˆ–ç§»åŠ¨å¹³å‡æ—¶ï¼Œä½ åº”è¯¥è€ƒè™‘å°†è¿™äº›è½¬æ¢æ“ä½œè½¬ç§»åˆ°æ•°æ®åº“ä¸­ã€‚

è¿™ç§ **å‡½æ•°æ˜¯å¯¹ä¸€ç³»åˆ—è¯­å¢ƒä¸Šç›¸å…³çš„è¡Œè¿›è¡Œæ“ä½œ**ã€‚é€šå¸¸ï¼Œå½“æ¶‰åŠæ­¤ç±»äº‹åŠ¡æ—¶ï¼Œæˆ‘ä»¬ä¼šè€ƒè™‘æ€»å’Œã€å¹³å‡å€¼ã€æœ€å°å€¼æˆ–æœ€å¤§å€¼è®¡ç®—ã€‚

**çª—å£å‡½æ•°ä¸€èˆ¬æ˜¯å¦‚ä½•ç»“æ„çš„ï¼Ÿ**

é¦–å…ˆï¼Œäº†è§£ä½¿ç”¨çª—å£å‡½æ•°çš„æŸ¥è¯¢ç»“æ„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨æ»šåŠ¨æ€»å’Œçš„ SQL è¯­å¥â€”â€”åªéœ€æŸ¥çœ‹ä»£ç å—ï¼Œä¸éœ€è¦å®Œå…¨ç†è§£æ¦‚å¿µï¼Œæš‚æ—¶æŠŠä»£ç å½“ä½œç®€å•æ¼”ç¤ºï¼š

```py
select
   VendorID,
   tpep_dropoff_datetime as dropdate,
   passenger_count,
 sum(passenger_count) over (
     partition by date(tpep_dropoff_datetime)
     order by tpep_dropoff_datetime
     rows between unbounded preceding and current row
 ) as day_running_sum
from trip_data td 
```

1.  é¦–å…ˆï¼Œæˆ‘ä»¬æŒ‡å®šæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œçš„åˆ†æç±»å‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ**æœ‰ä¸‰ç§ç±»å‹çš„å‡½æ•°** å¯ä¾›ä½¿ç”¨ï¼š

+   **èšåˆå‡½æ•°**ï¼Œå¦‚ min()ã€max()ã€count() æˆ– avg()â€”â€”è¿™åœ¨ä¸Šé¢çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­å±•ç¤ºè¿‡

+   **ç¼–å·å‡½æ•°**ï¼Œå¦‚ rank() æˆ– row_number()

+   **å¯¼èˆªå‡½æ•°** å¦‚ lead()ã€lag() [è¿”å›åç»­æˆ–å‰å€¼]

2\. åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹è€ƒè™‘ **é€»è¾‘åˆ†åŒº**ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç”¨æˆ· ID ä½œä¸ºåˆ†åŒºç¤ºä¾‹ï¼Œå› æ­¤æˆ‘ä»¬æŸ¥çœ‹ç”¨æˆ·å—ï¼Œå¹¶å¯¹æ¯ä¸ªç”¨æˆ·å­é›†æ‰§è¡Œè¿›ä¸€æ­¥æ“ä½œã€‚å¿…é¡»å°†åˆ†åŒºä¼ é€’ç»™å‡½æ•°ï¼

3\. ç±»ä¼¼äº group by è¯­å¥ï¼Œæˆ‘ä»¬è¿˜åº”åœ¨åˆ†æå‡½æ•°ä¸­è€ƒè™‘æ’åºå‚æ•°ã€‚æ’åºåº”ç”¨äºä¹‹å‰å®šä¹‰çš„é€‰å®šå­å—ã€‚æ’åºæ˜¯å¯é€‰çš„ï¼Œå¯ä»¥çœç•¥ã€‚

4. æœ€åï¼Œåˆ†æï¼ˆæˆ–çª—å£ï¼‰å‡½æ•°çš„æ ¸å¿ƒå…ƒç´ ï¼šçª—å£æ¡†æ¶å­å¥ã€‚è¿™ä¸ªå­å¥æŒ‡å®šäº†æˆ‘ä»¬å¸Œæœ›æŸ¥çœ‹çš„æ»šåŠ¨æ—¶é—´çª—å£ã€‚

è¦æ·±å…¥äº†è§£æ›´å¤šç†è®ºï¼Œè¯·è®¿é—®ä¸‹é¢çš„é“¾æ¥â€Šâ€”â€Šè¯·æ³¨æ„ï¼Œçª—å£å‡½æ•°åœ¨ä¸åŒçš„ SQL æ•°æ®åº“ä¸­å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†å®ƒä»¬çš„ä¸€èˆ¬ç»“æ„åŸºæœ¬ç›¸åŒã€‚

[## çª—å£å‡½æ•°

### çª—å£å‡½æ•°æ˜¯ SQL å‡½æ•°ï¼Œå…¶ä¸­è¾“å…¥å€¼æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªè¡Œçš„â€œçª—å£â€ä¸­çš„...

[www.sqlite.org](https://www.sqlite.org/windowfunctions.html?source=post_page-----939ed24c9752--------------------------------)

# å¿«é€Ÿå®‰è£…æŒ‡å—

ä¸ºäº†è¯´æ˜çª—å£å‡½æ•°å¦‚ä½•å·¥ä½œï¼Œæˆ‘å°†æä¾›ä¸€äº›ä½¿ç”¨è‘—åçš„çº½çº¦å‡ºç§Ÿè½¦æ•°æ®é›†çš„å­é›†çš„ç¤ºä¾‹ã€‚é€šå¸¸ï¼Œä½ éœ€è¦ä»¥ä¸‹å·¥å…·æ¥è‡ªå·±å®Œæˆè¿™äº›ç¤ºä¾‹ï¼š

+   å·²å®‰è£… Pythonï¼ˆç”¨äºæå–ï¼Œéœ€ sqlite3 å’Œ pandas åº“ï¼‰

+   ä¸€ç§ç¼–å†™æŸ¥è¯¢å’ŒæŸ¥çœ‹æ•°æ®çš„å·¥å…·ï¼ˆè°ˆåˆ° SQLï¼Œ[DBeaver](https://dbeaver.io/) æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ•°æ®æŸ¥è¯¢å·¥å…·ï¼Œä½†æ˜“äºä½¿ç”¨ä¸”å¼€æºã€‚

å°±è¿™æ ·ï¼

å¦‚æœä½ æƒ³å¤åˆ¶æ‰€å±•ç¤ºçš„æ­¥éª¤ï¼Œåªéœ€è®¿é—®ä¸‹é¢çš„é“¾æ¥å¹¶ä¸‹è½½å³å¯ï¼š

[## TLC è¡Œç¨‹è®°å½•æ•°æ®

### é»„ç»¿å‡ºç§Ÿè½¦çš„è¡Œç¨‹è®°å½•åŒ…æ‹¬æ•æ‰æ¥é€æ—¥æœŸ/æ—¶é—´çš„å­—æ®µã€æ¥é€...

[www.nyc.gov](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page?source=post_page-----939ed24c9752--------------------------------)

*æ³•å¾‹è¯´æ˜ï¼š* [***åªè¦ä½¿ç”¨ç›®çš„åˆæ³•***](https://opendata.cityofnewyork.us/faq/) *ï¼Œæ•°æ®ä½¿ç”¨æ²¡æœ‰é™åˆ¶*ï¼Œå¦‚ä½¿ç”¨æ¡æ¬¾ä¸­æ‰€è¿°ã€‚æ›´å¤šè®¸å¯è¯è¯¦ç»†ä¿¡æ¯å’Œæ•°æ®é›†å¼•ç”¨è¯·è§* ***æ–‡ç« ç»“å°¾****ã€‚

ä¸‹è½½æˆåŠŸåï¼Œæˆ‘å»ºè®®å°† parquet æ–‡ä»¶è½¬æ¢ä¸º sqlite3 æ•°æ®åº“ã€‚ä½¿ç”¨ Python ä»¥åŠ Pandas å’Œ sqlite3 åŒ…ï¼Œè¿™å¾ˆå¿«å°±èƒ½å®ç°â€”â€”åªéœ€å°†ä»£ç å¤åˆ¶ç²˜è´´åˆ°è„šæœ¬ä¸­ï¼Œä½ å°±å‡†å¤‡å¥½äº†ï¼š

```py
import pandas
import sqlite3

data = pd.read_parquet('yellow_tripdata_2023-01.parquet')

con = sqlite3.connect('taxi.db')  # creates a database "taxi.db"
data.to_sql('trip_data', con)     # name of the table
```

å®Œæˆäº†ï¼æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šçš„éå¸¸ç®€å•çš„ SQL æ•°æ®åº“ä¸­å·¥ä½œäº†ã€‚

# ç¤ºä¾‹

è®©æˆ‘ä»¬ä»è·å–æ•´ä¸ªæ•°æ®çš„è´¹ç”¨æ€»å’Œå’Œå¹³å‡å€¼è¿™ä¸€ç®€å•ä»»åŠ¡å¼€å§‹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SUM å’Œ AVG å‚æ•°ï¼Œå¹¶åœ¨ over è¯­å¥åçš„æ‹¬å·ä¸­çœç•¥åˆ†ç»„æ ‡å‡†ã€‚ç”±äºæˆ‘ä»¬åªæ˜¯å¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œèšåˆï¼Œå› æ­¤å°šæ— éœ€ä½¿ç”¨çª—å£å‡½æ•°ã€‚

```py
SELECT  
       SUM(fare_amount) AS total_fare,
       AVG(fare_amount) AS average_fare
FROM trip_data td;
```

![](img/06436db2bdcf52ed992317bb26256d77.png)

å‡è®¾æˆ‘ä»¬æƒ³äº†è§£æ¯ä¸€å¤©æ¯ä¸ªä¾›åº”å•†ï¼ˆ*VendorID*ï¼‰çš„æ€»è´¹ç”¨å’Œå¹³å‡è´¹ç”¨â€”â€”è¿™ä¸ªä»»åŠ¡ä¼šå˜å¾—ç¨å¾®æœ‰äº›æŒ‘æˆ˜ï¼š

```py
SELECT
 VendorID,
 date(tpep_dropoff_datetime) as dropdate,
 SUM(fare_amount) AS total_fare,
    AVG(fare_amount) AS average_fare
FROM trip_data td
group by VendorID, dropdate
```

![](img/549e85fece5f8d334761342f1f4ede5a.png)

å¦‚æˆ‘ä»¬æ‰€è§ï¼Œä¸ºäº†å®ç°åˆ†ç»„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ†ç»„å…³é”®å­—ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ ¹æ®*VendorId*å’Œ*dropdate*è¿›è¡Œæ±‡æ€»ã€‚è™½ç„¶åˆ†ç»„éå¸¸å¼ºå¤§ï¼Œä½†å®ƒ**ä¸èƒ½è¿›ä¸€æ­¥å°†å•ç‹¬è¡Œæ‹†åˆ†ä¸ºæ‹–å°¾æ€»å’Œæˆ–ç§»åŠ¨å¹³å‡å€¼**â€”â€”è¿™æ—¶çª—å£å‡½æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

ç°åœ¨å‡è®¾æˆ‘ä»¬æƒ³è®¡ç®—*fare_amount*çš„æ»šåŠ¨æ€»å’Œå’Œå‡å€¼ï¼Œå¹¶æŒ‰*VendorID*å’Œç›¸å…³çš„æ¯æ—¥è¡Œç¨‹è¿›è¡Œåˆ†ç±»ã€‚

æˆ‘ä»¬çš„çª—å£æ“ä½œåœ¨æˆ‘ä»¬æŒ‡å®šçš„â€œåˆ†åŒºâ€å†…ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåˆ†åŒºä¸ºæ•´å¤©ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æœŸæœ›çœ‹åˆ°æ¯ä¸€å¤©å’Œæ¯ä¸ªä¾›åº”å•†çš„æ»šåŠ¨æ€»å’Œå’Œå‡å€¼ï¼ˆæˆ–ç­‰æ•ˆåœ°ï¼Œåœ¨æ¯ä¸ªåˆ†åŒºå†…ï¼‰ã€‚

```py
select
   VendorID,
   date(tpep_dropoff_datetime) as dropdate,
   fare_amount,
   sum(fare_amount) over (
      partition by date(tpep_dropoff_datetime), VendorID 
      order by tpep_dropoff_datetime
      rows between unbounded preceding and current row
   ) as rolling_sum,
   avg(fare_amount) over (
      partition by date(tpep_dropoff_datetime), VendorID 
      order by tpep_dropoff_datetime
      rows between unbounded preceding and current row
 ) as rolling_mean
from trip_data td;
```

![](img/eac4044ad950a0b8b8737d8c29746276.png)

æ¯ä¸ªåˆ†åŒºï¼ˆdropdate + VendorIDï¼‰æ˜¾ç¤ºæ¯è¡Œçš„ç¥¨ä»·ä»¥åŠæ»šåŠ¨æ€»å’Œã€‚

æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†â€œ*unbounded preceding*â€ä½œä¸ºæ¡†æ¶å­å¥ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æŸ¥çœ‹åœ¨æˆ‘ä»¬åˆ†åŒºå†…çš„æ‰€æœ‰å‰ç½®å€¼â€”â€”å†è¯´ä¸€æ¬¡ï¼Œæˆ‘ä»¬çš„åˆ†åŒºå®šä¹‰ä¸º*Date* + *VendorID*ã€‚

å¦‚æœæˆ‘ä»¬åªæƒ³æŸ¥çœ‹ä¸€ä¸ªæ»šåŠ¨æ€»å’Œ/å‡å€¼ï¼Œè¯¥å‡å€¼è€ƒè™‘åˆ°**ä¹‹å‰å’Œå½“å‰çš„ç¥¨ä»·**ï¼ˆå†æ¬¡åœ¨*Date*+*VendorID*çš„åˆ†åŒºå†…ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¡†æ¶å­å¥è°ƒæ•´ä¸º*ä»… 1 è¡Œä¹‹å‰å’Œå½“å‰è¡Œ*ã€‚

```py
select
 VendorID,
 date(tpep_dropoff_datetime) as dropdate,
 fare_amount,
 round(sum(fare_amount) over (
  partition by date(tpep_dropoff_datetime), VendorID 
  order by tpep_dropoff_datetime
  rows between 1 preceding and current row --> NOW 1 Preceding row only
 ),2) as rolling_sum,
 round(avg(fare_amount) over (
  partition by date(tpep_dropoff_datetime), VendorID 
  order by tpep_dropoff_datetime
  rows between 1 preceding and current row --> NOW 1 Preceding row only
 ),2) as rolling_mean
from trip_data td 
```

![](img/ff00522d98c3c7c3e385011179813d0d.png)

â€œ1 Precedingâ€ç»“æœæ˜¯ä¸€ä¸ªç§»åŠ¨æ€»å’Œ/å‡å€¼ï¼Œä»…æŸ¥çœ‹å½“å‰å’Œä¹‹å‰çš„è¡Œç¨‹ç¥¨ä»·â€”â€”å†è¯´ä¸€æ¬¡ï¼Œè¿™å§‹ç»ˆåœ¨åˆ†åŒºå†…ã€‚

åœ¨æœ€åä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ç»“åˆæ‰€æœ‰ä¹‹å‰çš„æ­¥éª¤ï¼Œå±•ç¤ºå¦‚ä½•ä¼˜é›…åœ°æŸ¥è¯¢ç®€å•çš„æ±‡æ€»æ•°æ®ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ•°æ®æ‰§è¡Œ rank()è¯­å¥â€”â€”è¿™æ˜¯ä¸€ç§åˆ†æç¼–å·å‡½æ•°ã€‚

æˆ‘ä»¬å¸Œæœ›æŒ‰æ¯ä¸ªä¾›åº”å•†æ”¶å–çš„æ€»ç¥¨ä»·çš„æœ€é«˜å€¼å¯¹å¤©æ•°è¿›è¡Œæ’åã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†è¿™åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1.  é€šè¿‡ç®€å•çš„â€œ*group by*â€æŒ‰å¤©å’Œä¾›åº”å•†æ±‡æ€»ç¥¨ä»·

1.  ä½¿ç”¨åˆ†æå‡½æ•°å¯¹â€œ*VendorID*â€åˆ†åŒºå†…çš„å¤©æ•°è¿›è¡Œæ’å

```py
with aggregated as (
 select
    VendorID,
    date(tpep_dropoff_datetime) as dropdate,
    round(sum(fare_amount),2) as total
 from trip_data td 
 where dropdate like '2023%' -- this to remove wrong 2020 data in the dataset
 group by VendorID, dropdate
 order by dropdate asc
) -- here our "aggregated" data subset is created
select 
  VendorID,
  dropdate,
  total,
  rank() over (
      partition by VendorID
      order by total desc
  ) as best_days
from aggregated -- we rank() based on "aggregated"
```

![](img/36e5e85ac50aae1644d0bf97f7dc1e0f.png)

ä»*VendorID=1*å¼€å§‹ï¼Œ1 æœˆä»½æœ€å¥½çš„æ—¥å­æ˜¯ 26 å·ï¼Œå®ƒæ’åç¬¬ä¸€ï¼ˆæ”¶å…¥æœ€é«˜ï¼‰ã€‚

# ç»“è®º

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»æŒæ¡äº†åˆ†æå‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠå®ƒä»¬å¦‚ä½•çµæ´»åœ°å®ç°ç›¸å½“å¤æ‚çš„æŸ¥è¯¢ç»“æœã€‚

è™½ç„¶æ•°æ®ç°åœ¨é€šå¸¸åœ¨æœ¬åœ°æœºå™¨æˆ–äº‘å®ä¾‹ä¸Šè½¬æ¢ï¼Œä½†åœ¨å®é™…å¯¼å…¥åˆ°åç»­è½¯ä»¶ä¹‹å‰ä¿®æ”¹æ•°æ®é€šå¸¸æ˜¯æ›´å¥½çš„é€‰æ‹©â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼ŒSQL æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„è¯­è¨€æ¥å®Œæˆè¿™é¡¹ä»»åŠ¡ï¼

**å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæˆ‘ä¼šå¾ˆæ„Ÿæ¿€ä½ çš„â€œå…³æ³¨â€ğŸ«€ï¼Œç›´åˆ°é‚£æ—¶ï¼š**

*{ç…§é¡¾å¥½è‡ªå·±ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œä¹Ÿç…§é¡¾å¥½åˆ«äºº}*

*â€”â€” å€Ÿç”¨è‡ªæ–¯è’‚èŠ¬Â·æœå¸ƒçº³*

## **æ•°æ®é›†å¼•ç”¨**å’Œä½¿ç”¨æ¡æ¬¾ï¼š

çº½çº¦å¸‚å‡ºç§Ÿè½¦å’Œè±ªåè½¿è½¦å§”å‘˜ä¼šï¼ˆTLCï¼‰çš„è¡Œç¨‹è®°å½•æ•°æ®äº 7 æœˆ 13 æ—¥ä»[`www.nyc.gov/site/tlc/about/tlc-trip-record-data.page`](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page)è®¿é—®ã€‚

å®Œæ•´çš„ä½¿ç”¨æ¡æ¬¾å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š

[](https://www.nyc.gov/home/terms-of-use.page?source=post_page-----939ed24c9752--------------------------------) [## ä½¿ç”¨æ¡æ¬¾

### æ¬¢è¿è®¿é—®çº½çº¦å¸‚å®˜æ–¹ç½‘ç«™ã€‚åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œè¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹ä½¿ç”¨æ¡æ¬¾ï¼ˆâ€œæ¡æ¬¾â€ï¼‰â€¦

www.nyc.gov](https://www.nyc.gov/home/terms-of-use.page?source=post_page-----939ed24c9752--------------------------------)
