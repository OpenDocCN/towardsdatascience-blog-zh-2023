- en: Modeling Variable Seasonal Features with the Fourier Transform
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用傅里叶变换对可变季节特征进行建模
- en: 原文：[https://towardsdatascience.com/modeling-variable-seasonal-features-with-the-fourier-transform-18c792102047?source=collection_archive---------2-----------------------#2023-10-12](https://towardsdatascience.com/modeling-variable-seasonal-features-with-the-fourier-transform-18c792102047?source=collection_archive---------2-----------------------#2023-10-12)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://towardsdatascience.com/modeling-variable-seasonal-features-with-the-fourier-transform-18c792102047?source=collection_archive---------2-----------------------#2023-10-12](https://towardsdatascience.com/modeling-variable-seasonal-features-with-the-fourier-transform-18c792102047?source=collection_archive---------2-----------------------#2023-10-12)
- en: Improve time series forecast performance with a technique from signal processing
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用信号处理技术改进时间序列预测性能
- en: '[](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)[![Florin
    Andrei](../Images/372ac3e80dbc03cbd20295ec1df5fa6f.png)](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)[](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)
    [Florin Andrei](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)[![Florin
    Andrei](../Images/372ac3e80dbc03cbd20295ec1df5fa6f.png)](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)[](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)
    [Florin Andrei](https://florin-andrei.medium.com/?source=post_page-----18c792102047--------------------------------)'
- en: ·
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: ·
- en: '[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faeaeb9d7d248&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&user=Florin+Andrei&userId=aeaeb9d7d248&source=post_page-aeaeb9d7d248----18c792102047---------------------post_header-----------)
    Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)
    ·21 min read·Oct 12, 2023[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F18c792102047&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&user=Florin+Andrei&userId=aeaeb9d7d248&source=-----18c792102047---------------------clap_footer-----------)'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: '[关注](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faeaeb9d7d248&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&user=Florin+Andrei&userId=aeaeb9d7d248&source=post_page-aeaeb9d7d248----18c792102047---------------------post_header-----------)
    发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----18c792102047--------------------------------)
    ·21 分钟阅读·2023 年 10 月 12 日[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F18c792102047&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&user=Florin+Andrei&userId=aeaeb9d7d248&source=-----18c792102047---------------------clap_footer-----------)'
- en: --
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: '[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F18c792102047&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&source=-----18c792102047---------------------bookmark_footer-----------)'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F18c792102047&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmodeling-variable-seasonal-features-with-the-fourier-transform-18c792102047&source=-----18c792102047---------------------bookmark_footer-----------)'
- en: Modeling time series data and forecasting it are complex topics. There are many
    techniques that could be used to improve model performance for a forecasting job.
    We will discuss here a technique that may improve the way ML forecasting models
    learn from time features, and generalize from them. The main focus will be the
    creation of the seasonal features that feed the time series forecasting model
    in training — there are easy gains to be made here if you include the Fourier
    transform in the feature creation process. I took inspiration from work I’ve done
    in the past with digital electronics and signal processing, and applied some of
    those concepts to feature engineering for time series forecasting.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 建模时间序列数据和预测是复杂的主题。可以使用许多技术来改善预测工作的模型性能。我们将讨论一种可能改善 ML 预测模型从时间特征中学习并从中概括的技术。主要关注点是创建季节性特征，以便在训练中为时间序列预测模型提供输入——如果在特征创建过程中包括傅里叶变换，可能会有明显的收益。我从过去在数字电子和信号处理方面的工作中获得了灵感，并将这些概念应用于时间序列预测的特征工程。
- en: This article assumes you are familiar with the basic aspects of time series
    forecasting — we will not discuss this topic in general, but only a refinement
    of one aspect of it. This is not about time series analysis or modeling. This
    is not about financial time series (stock prices). This is about machine learning
    forecasting of general time series. For an introduction to ML time series forecasting,
    see [the Kaggle course](https://www.kaggle.com/learn/time-series) on this topic
    — the technique discussed here builds on top of their lesson on seasonality.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 本文假设你对时间序列预测的基本方面比较熟悉——我们不会讨论这一主题的一般性内容，只会讨论其中某个方面的细化。这不是关于时间序列分析或建模，也不是关于金融时间序列（股票价格）。这关于机器学习对一般时间序列的预测。有关
    ML 时间序列预测的介绍，请参见 [Kaggle 课程](https://www.kaggle.com/learn/time-series)——这里讨论的技术建立在他们关于季节性的课程之上。
- en: We will also compare some prominent time series models like Facebook Prophet
    and ARIMA, and learn from the techniques they use, which can definitely be used
    in a custom ML forecasting model.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将比较一些显著的时间序列模型，如 Facebook Prophet 和 ARIMA，并学习它们使用的技术，这些技术绝对可以用于自定义的 ML 预测模型。
- en: ETS methods and autoregressive models
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ETS 方法和自回归模型
- en: 'ETS methods (error, trend, seasonality) decompose the time series signal in
    several components:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: ETS 方法（误差、趋势、季节性）将时间序列信号分解为几个组件：
- en: '![](../Images/1447c8cb87b11303d6c4a94edfc26642.png)'
  id: totrans-13
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/1447c8cb87b11303d6c4a94edfc26642.png)'
- en: ETS model
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: ETS 模型
- en: y(t) is the signal (time series) you’re trying to predict
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: y(t) 是你试图预测的信号（时间序列）
- en: g(t) is the trend, a function that captures the non-periodic changes
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: g(t) 是趋势，一个捕捉非周期性变化的函数
- en: s(t) is the seasonality, or the changes with strict periodicity
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: s(t) 是季节性，或具有严格周期性的变化
- en: epsilon is the noise that cannot be predicted by the model
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: epsilon 是模型无法预测的噪声
- en: By correctly learning y(t) and g(t), the model should be able to make predictions,
    except for the random variations represented by epsilon (which are not actually
    part of the model). Facebook Prophet takes a similar approach, while adding other
    features as well (holidays, exogenous features).
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 通过正确学习 y(t) 和 g(t)，模型应该能够进行预测，除了由 epsilon 表示的随机变化（这些实际上不属于模型）。Facebook Prophet
    采取了类似的方法，同时还添加了其他特征（假期、外生特征）。
- en: 'Autoregressive models essentially do linear regression, where the features
    are past data points in the series (the lags of the time series). One example
    is the AR(p) model, or the autoregressive part of ARIMA (which is essentially
    just a GLM — generalized linear model with only linear terms):'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 自回归模型本质上做线性回归，其中特征是序列中的过去数据点（时间序列的滞后）。一个例子是 AR(p) 模型，或 ARIMA 的自回归部分（本质上只是一个
    GLM——仅具有线性项的广义线性模型）：
- en: '![](../Images/57a2f1f80fbaa75ddc9044b57daf7792.png)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/57a2f1f80fbaa75ddc9044b57daf7792.png)'
- en: AR(p) model
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: AR(p) 模型
- en: y(t) is the future value of the signal you’re trying to predict
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: y(t) 是你试图预测的信号的未来值
- en: b is the bias term
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: b 是偏置项
- en: y(t-1) is the last known value (lag 1)
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: y(t-1) 是最后已知的值（滞后 1）
- en: y(t-2) is the value before that (lag 2), etc.
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: y(t-2) 是之前的值（滞后 2），依此类推。
- en: the phi coefficients are the model weights
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: phi 系数是模型权重
- en: the noise term (epsilon) is not actually part of the AR(p) model, since it cannot
    be predicted
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 噪声项（epsilon）实际上不属于 AR(p) 模型，因为它无法被预测
- en: So the AR(p) model tries to predict future values from multiple lags of the
    past values.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，AR(p) 模型试图通过多个过去值的滞后预测未来值。
- en: Various blends of ETS and autoregressive models are possible in machine learning
    forecasting. Exogenous variables can also be included — variables that are not
    part of the time series, but have an influence over it (like promotions may influence
    sales). SARIMAX is an example of a model that uses seasonal components, auto-regressive
    components, moving average components (of the error term), and exogenous features.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在机器学习预测中，可以使用各种 ETS 和自回归模型的组合。也可以包含外生变量——这些变量不属于时间序列的一部分，但对其有影响（例如促销可能会影响销售）。SARIMAX
    是一个例子，它使用了季节性成分、自回归成分、移动平均成分（误差项的）和外生特征。
- en: If you’re modeling a general time series (e.g. store sales), the random walk
    hypothesis is not dominant, you do not care much about building a rigorous mathematical
    model, and the main focus is strictly the RMSE performance of the time series
    value forecast, you could build a model using a general-purpose machine learning
    model (it could be some variation on the random forest concept, it could be as
    simple as linear regression, or as complex as an ensemble of various ML models,
    or even neural networks), and then you could engineer all the features you need,
    and provide them to the model in training.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你正在建模一个一般的时间序列（例如商店销售），随机游走假设并不占主导地位，你并不在意建立一个严谨的数学模型，主要关注的是时间序列值预测的 RMSE
    性能，你可以使用通用机器学习模型（可以是随机森林概念的某种变体，可以像线性回归一样简单，也可以是各种机器学习模型的集合，甚至是神经网络）来建立模型，然后你可以工程化所有你需要的特征，并在训练中提供给模型。
- en: 'Think of a data frame containing the Xtrain features that will be used to fit
    the model. The target Ytrain is the time series itself, perhaps transformed in
    some ways (scaled, log, etc). The Xtrain data frame may have columns including:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一个包含将用于拟合模型的 Xtrain 特征的数据框。目标 Ytrain 是时间序列本身，可能以某种方式变换（缩放、对数等）。Xtrain 数据框可能包括：
- en: 'trend features, representing the broad variations of the time series; these
    could be: a constant term (the value 1 repeated for each row), a function linear
    in time (literally the enumeration: 0, 1, 2, 3, …), a quadratic function (0, 1,
    4, 9, …), a cubic, or may have other shapes. Prophet uses linear trend with inflection
    points computed from data.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 趋势特征，表示时间序列的广泛变化；这些可能包括：常数项（每一行的值为 1）、线性时间函数（字面上是枚举：0、1、2、3、……）、二次函数（0、1、4、9、……）、三次函数，或可能有其他形状。Prophet
    使用线性趋势，并从数据中计算拐点。
- en: seasonality, representing up-and-down variations that maintain the same shape
    and happen on a strict time schedule
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 季节性，表示维持相同形状并在严格的时间表上发生的上下波动
- en: autoregressive features, or the lags of the time series itself (the time series
    column from the target Ytrain, but shifted 1 or more rows down)
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自回归特征，即时间序列本身的滞后（目标 Ytrain 中的时间序列列，但向下移动 1 行或更多行）
- en: exogenous features, such as promotions, holidays, geolocation grouping, etc.
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 外生特征，如促销、节假日、地理位置分组等。
- en: When you run `model.fit(Xtrain, Ytrain)` the model will then learn from these
    features, with the target Ytrain being the time series itself. This is a fairly
    general form of time series forecasting with machine learning models.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 当你运行 `model.fit(Xtrain, Ytrain)` 时，模型将从这些特征中学习，目标 Ytrain 就是时间序列本身。这是一种相当通用的时间序列预测形式，使用机器学习模型。
- en: Seasonal features in detail
  id: totrans-38
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 详细的季节性特征
- en: 'Facebook Prophet represents seasonal features as a Fourier series. In general,
    a periodic function can be represented as a series of sine/cosine pairs, where
    the period of each sine/cosine is a submultiple of some base period:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: Facebook Prophet 将季节性特征表示为傅里叶级数。一般来说，一个周期函数可以表示为一系列正弦/余弦对，其中每个正弦/余弦的周期是某个基周期的倍数：
- en: '![](../Images/b5725cfbea7e99562f2ae55cc9b7498b.png)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/b5725cfbea7e99562f2ae55cc9b7498b.png)'
- en: Fourier series
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 傅里叶级数
- en: t is time
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: t 是时间
- en: P is the base period of a seasonal feature — the period of the sine/cosine pair
    with the largest period
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: P 是季节性特征的基周期——具有最大周期的正弦/余弦对的周期
- en: n, the index in the series, is a period demultiplier (frequency multiplier)
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: n，序列中的索引，是一个周期去倍数（频率倍数）
- en: sine and cosine terms are weighted by the a(n) and b(n) parameters
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 正弦和余弦项由 a(n) 和 b(n) 参数加权
- en: 'In Pandas form, here are two sine/cosine pairs, the second pair has twice the
    frequency of the first pair:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Pandas 形式中，这里有两个正弦/余弦对，第二对的频率是第一对的两倍：
- en: '[PRE0]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The Fourier theorem states that (loosely speaking) when representing a well-behaved
    periodic function this way, by adjusting the weights a(n) and b(n), the series
    can be made to converge to the function. So a finite Fourier sum might be a good
    way to approximate periodic signals (seasonal components of time series) — we’re
    only looking for an approximation, not full convergence, so we use a finite sum.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 傅里叶定理指出（粗略来说），通过调整权重 a(n) 和 b(n)，当以这种方式表示一个表现良好的周期性函数时，级数可以使其收敛到该函数。因此，有限的傅里叶和可能是一个很好的方式来逼近周期信号（时间序列的季节性分量）——我们只是在寻找一种近似，而不是完全收敛，因此使用有限的和。
- en: 'Another way to model seasonality is via one-hot-encoded variables. If P is
    the base period of a seasonal feature, then P columns in a data frame, each containing
    either 0 or 1, with 1 occurring only once in each column for the entire period
    P, and the values 1 never overlapping in any row between the P columns, could
    be learned by a linear model as:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 建模季节性的一种方法是使用 one-hot 编码变量。如果 P 是季节性特征的基期，那么数据框中 P 列，每列包含 0 或 1，每列在整个周期 P 内只出现一次
    1，并且 P 列之间的行中 1 的值从不重叠，可以被线性模型学习为：
- en: '![](../Images/bb890a27c7b861ec53cc752183289540.png)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/bb890a27c7b861ec53cc752183289540.png)'
- en: one-hot encoding
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: one-hot 编码
- en: Cp is each column that encodes time
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Cp 是每一列编码时间
- en: the beta parameters are the weights applied to each column — their relative
    values literally model the shape of the wave
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: beta 参数是应用于每一列的权重——它们的相对值实际上建模了波形的形状。
- en: 'In Pandas form, here is a seasonal feature one-hot encoded with a period of
    4 observations:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Pandas 形式中，以下是一个周期为 4 个观测的季节性特征 one-hot 编码：
- en: '[PRE1]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: If the model you use is pure linear regression (no penalty), and there is a
    bias term, one-hot encoding may run into the so-called dummy variable trap. You
    may also hear the term collinearity problem. In a nutshell, the Cp columns can
    be linearly combined to generate a constant “trend” for the bias term.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用的模型是纯线性回归（没有惩罚），并且存在偏置项，那么 one-hot 编码可能会遇到所谓的虚拟变量陷阱。你也可能听到“共线性问题”这个术语。简而言之，Cp
    列可以线性组合生成一个常量“趋势”来解释偏置项。
- en: 'If that’s the case, dummy encoding (K-1 encoding) is the solution — it is literally
    the same thing as one-hot encoding, but with P-1 columns instead (drop one column):'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 如果是这种情况，虚拟编码（K-1 编码）是解决方案——它实际上与 one-hot 编码相同，但使用 P-1 列（去掉一列）：
- en: '![](../Images/72e313f8e517ee2faf054b38cc877c45.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/72e313f8e517ee2faf054b38cc877c45.png)'
- en: dummy encoding
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟编码
- en: You could also try to remove the bias term, or use a regularized model, or use
    gradient descent. In practice, test the model’s performance and make the right
    decision.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以尝试去除偏置项，或使用正则化模型，或使用梯度下降。在实践中，测试模型的性能并做出正确的决定。
- en: Fourier series vs one-hot/dummy encoding
  id: totrans-61
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 傅里叶级数与 one-hot/虚拟编码
- en: One-hot/dummy encoding
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: one-hot/虚拟编码
- en: Let’s say you create a group of one-hot encoded columns, with P columns in the
    group. This group will be able to model any seasonality with a period of P. It
    will also be able to model seasonalities with submultiple periods of P, such as
    P/2, etc, so you do not need to explicitly model them.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 假设你创建了一组 one-hot 编码列，组中有 P 列。这组将能够建模周期为 P 的任何季节性。它还能够建模周期为 P 的子倍数的季节性，如 P/2
    等，因此你不需要显式建模它们。
- en: This succession (P, P/2, P/4, etc.) is simply another way of describing Fourier
    series, which model any complex periodic signal as a sum of a base component and
    all its frequency-multiples / period-submultiples. This is key to understanding
    why **the one-hot/dummy encoded time features perform the same task as Fourier
    series time features**. They are different implementations of the same basic idea.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 这一连续周期（P, P/2, P/4 等）仅仅是另一种描述傅里叶级数的方法，它将任何复杂的周期信号建模为基组件及其所有频率倍数/周期子倍数的和。这是理解**one-hot/虚拟编码时间特征与傅里叶级数时间特征执行相同任务**的关键。它们是相同基本思想的不同实现。
- en: 'The low limit for the periods modeled by one-hot/dummy time features is twice
    the sampling period of your time series: if the time series has daily observations,
    the shortest period modeled by your time dummies will be 2 days. This is literally
    [the Nyquist-Shannon theorem](https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem)
    stated in time series terms.'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: one-hot/虚拟时间特征建模的周期的下限是时间序列的采样周期的两倍：如果时间序列有每日观测，那么你的时间虚拟特征建模的最短周期将是 2 天。这实际上是[奈奎斯特-香农定理](https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem)在时间序列中的表述。
- en: What one-hot/dummy encoding really does is — it models the waveform of the P-days
    component, like a scatterplot with P points. In doing so, because of how the Fourier
    transform works, it also captures all the P-submultiple components (P/2, etc).
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 一热编码/虚拟变量编码真正做的是——它建模了P天组件的波形，就像一个具有P点的散点图。这样做是因为傅里叶变换的工作原理，它还捕捉了所有P的子倍频组件（P/2等）。
- en: One-hot encoded time features can learn arbitrarily complex waveforms very well.
    On the other hand, if P is large then the number of one-hot encoded columns is
    also large, and then you run into the curse of dimensionality problem. It’s best
    to use one-hot/dummy encoding for short periods of time, but this is not a strict
    rule — if you don’t have many features to begin with, then a large group of time
    dummies will be fine.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 一热编码的时间特征可以很好地学习任意复杂的波形。另一方面，如果P很大，那么一热编码的列数也会很大，这会遇到维度灾难问题。最好在短时间周期内使用一热/虚拟编码，但这不是严格的规则——如果你一开始没有很多特征，那么一大组时间虚拟变量也会很好。
- en: Fourier series encoding
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 傅里叶级数编码
- en: Fourier series are concise and can express arbitrarily large periods P — they
    are well-suited for large-period seasonality. On the other hand, if the waveform
    is very complex, it may not be learned well without creating many sine/cosine
    pairs.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 傅里叶级数简洁，可以表达任意大的周期P——它们非常适合大周期的季节性。另一方面，如果波形非常复杂，可能需要创建许多正弦/余弦对才能很好地学习。
- en: The clue that you should probably use Fourier series is in the periodogram (described
    below). If you notice your series has a strong and sharp P days seasonal component,
    along with a strong and sharp P/2 component, and not much else in terms of a clear
    pattern, that indicates that two sine/cosine pairs, one with a period of P, the
    other with a period of P/2, may work well.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能应该使用傅里叶级数的线索在周期图中（下面描述）。如果你注意到你的系列有一个强烈且尖锐的P天季节性组件，以及一个强烈且尖锐的P/2组件，而在明显模式方面没有其他内容，这表明一个周期为P、另一个周期为P/2的正弦/余弦对可能会很好地工作。
- en: 'Keep in mind that the P/2 component and the P component model the same phenomenon:
    it’s not two different phenomena, but the same thing, with a base period of P.
    The P/2, P/4, etc components are just its Fourier harmonics scattered across the
    spectrum. This is simply because the base P seasonality does not have a perfect
    sine shape — if it did, then only the P component would show in the periodogram.'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，P/2组件和P组件建模的是同一现象：这不是两个不同的现象，而是同一个现象，其基周期为P。P/2、P/4等组件只是其傅里叶谐波在频谱中散布。这是因为基周期P的季节性没有完美的正弦形状——如果有，周期图中只会显示P组件。
- en: Never create Fourier components with a period shorter than twice the sampling
    period of your time series. If your time series has a daily sampling period, then
    the shortest seasonality you will ever be able to model is 2 days. The Nyquist-Shannon
    theorem places a hard limit there, like a brick wall. That’s all the data you
    have.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 永远不要创建周期短于时间序列采样周期两倍的傅里叶组件。如果你的时间序列采样周期为每日，则你能建模的最短季节性是2天。奈奎斯特-香农定理在这里设置了一个硬限制，就像一面砖墙。这就是你所有的数据。
- en: Perhaps even leave some safety margin to the [Nyquist limit](https://en.wikipedia.org/wiki/Nyquist_frequency).
    The music you listen to in audio CD format has signal frequencies up to 20 kHz.
    The sampling frequency of audio CD is 44.1 kHz, so the Nyquist limit is 22.05
    kHz, a little higher than the maximum recorded frequency.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 也许甚至留出一些安全边际给[奈奎斯特限制](https://en.wikipedia.org/wiki/Nyquist_frequency)。你在音频CD格式中听到的音乐信号频率高达20
    kHz。音频CD的采样频率是44.1 kHz，因此奈奎斯特限制是22.05 kHz，比最大记录频率稍高。
- en: Additive vs. multiplicative seasonality
  id: totrans-74
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 加法性与乘法性季节性
- en: Consider [the Quarterly Australian Portland Cement production dataset](https://www.key2stats.com/data-set/view/776),
    showing the total quarterly production of Portland cement in Australia (in millions
    of tonnes) from 1956:Q1 to 2014:Q1.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑[季度澳大利亚波特兰水泥生产数据集](https://www.key2stats.com/data-set/view/776)，显示了1956年第一季度到2014年第一季度澳大利亚波特兰水泥的季度总生产量（以百万吨计）。
- en: '[PRE2]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '[PRE3]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '![](../Images/a8aa12d72e5434504be90ed92245e8a5.png)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a8aa12d72e5434504be90ed92245e8a5.png)'
- en: This is time series data with a trend, seasonal components, and other attributes.
    The observations are made quarterly, spanning an interval of several decades.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 这是具有趋势、季节性组件和其他属性的时间序列数据。观察数据是季度性的，跨度数十年。
- en: The trend g(t) is nearly linear, with a few inflection points. The seasonal
    component s(t) has a simple waveform, repeated over and over to the end.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 趋势 g(t) 几乎是线性的，只有少数几个拐点。季节成分 s(t) 有一个简单的波形，一直重复到结束。
- en: 'A linear model trying to represent this dataset only from trend and seasonality
    may combine these two groups of features additively (we ignore all other components
    in the model). This is called additive seasonality:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 一个试图仅通过趋势和季节性来表示该数据集的线性模型可能会将这两个特征组加性组合在一起（我们忽略模型中的所有其他成分）。这被称为加性季节性：
- en: '![](../Images/5f458c4466636ecd4ac810729c775164.png)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/5f458c4466636ecd4ac810729c775164.png)'
- en: additive seasonality
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 加性季节性
- en: 'I will anticipate a result obtained later, and I will show you here the output
    of combining a quadratic trend (which happens to look nearly linear here) with
    an additive seasonality model, applied to the dataset:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 我将预期一个稍后的结果，并在这里展示将一个二次趋势（在这里几乎看起来是线性的）与一个加性季节性模型结合的输出，应用于数据集：
- en: '![](../Images/c9f30673cf9dd7deb5ac4d7a12219b7b.png)'
  id: totrans-85
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c9f30673cf9dd7deb5ac4d7a12219b7b.png)'
- en: trend with additive seasonality
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 带有加性季节性的趋势
- en: 'The problem with additive seasonality here is obvious: the model has learned
    a fixed-amplitude seasonality, and it’s simply adding it to the trend. The model
    generates a pattern of waves with fixed amplitude, dictated by the weights of
    the time features.'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 加性季节性在这里的问题很明显：模型已经学会了一个固定幅度的季节性，并且只是将其添加到趋势中。模型生成了一个由时间特征的权重决定的固定幅度波浪模式。
- en: 'One improvement is multiplicative seasonality. This is an option in Facebook
    Prophet. The assumption is that the amplitude of the seasonality is proportional
    to the trend. No doubt this is close to true for some datasets. The multiplicative
    trend formula is:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 一种改进是乘性季节性。这是 Facebook Prophet 中的一个选项。假设季节性的幅度与趋势成正比。毫无疑问，对于某些数据集，这接近真实。乘性趋势公式是：
- en: '![](../Images/f0af5c6d9b85acf3e0c281aacef7e5ba.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/f0af5c6d9b85acf3e0c281aacef7e5ba.png)'
- en: multiplicative seasonality
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 乘性季节性
- en: That would model seasonality well, as long as the seasonal amplitude is indeed
    proportional to the overall trend. In that case, the trend itself models the envelope
    of the seasonal component. We will not demo that case here, but we will show later
    that this is not a great fit either.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 这将很好地建模季节性，只要季节幅度确实与整体趋势成正比。在这种情况下，趋势本身建模季节成分的包络线。我们在这里不会演示这种情况，但稍后会显示这也不是一个很好的拟合。
- en: But what if all that is not the case? Can we do better than simple addition
    or multiplication, when neither is a great fit? Can we have a model that learns
    a more general variation of the seasonal features, one that’s not constant, and
    is not bound by strict proportionality to the trend?
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 但如果情况并非如此呢？当简单的加法或乘法都不是很好的拟合时，我们能做得更好吗？我们是否能有一个模型，学习季节特征的更一般的变化，这种变化不是恒定的，也不受限于与趋势的严格比例关系？
- en: Fourier analysis
  id: totrans-93
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 傅里叶分析
- en: Let’s take a look at the seasonal components in the Australian Portland cement
    dataset, using the periodogram plot. This involves using the `periodogram()`function
    from `scipy.signal` (all code is included in the companion notebook, linked at
    the end).
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看澳大利亚波特兰水泥数据集中的季节成分，使用周期图绘图。这涉及使用 `scipy.signal` 中的 `periodogram()` 函数（所有代码都包含在附录笔记本中，链接在最后）。
- en: What `scipy.signal.periodogram()` does is — it looks at a periodic signal, and
    it tries to estimate the coefficients in a Fourier series (one somewhat more complex
    than the series formula shown above) that would approximate the signal well. It
    then returns the weights in the series, which can be visualized in a plot.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: '`scipy.signal.periodogram()` 的作用是 —— 它查看一个周期性信号，并尝试估计一个傅里叶级数中的系数（比上面显示的级数公式更复杂一些），以便很好地逼近该信号。然后返回级数中的权重，可以在图中可视化。'
- en: 'This is the result of plotting the output of `scipy.signal.periodogram()` applied
    to the dataset:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 这是应用于数据集的 `scipy.signal.periodogram()` 输出的绘图结果：
- en: '![](../Images/146c755adc1f2e874cd3ea1d62d5ab2f.png)'
  id: totrans-97
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/146c755adc1f2e874cd3ea1d62d5ab2f.png)'
- en: periodogram
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 周期图
- en: The periodogram shows the power density of spectral components (seasonal components).
    The strongest seasonal component in the dataset is the one with a period equal
    to 4 quarters, or 1 year. This confirms the visual impression that the strongest
    up-and-down variations in the graph happen about 10 times per decade. There is
    also a component with a period of 2 quarters — that’s the same seasonal phenomenon,
    and it simply means the 4-quarter periodicity is not a simple sine wave, but has
    a more complex shape. There are other components, too, with periods of 10 or more
    quarters, but we will ignore them.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: The Fourier spectrogram
  id: totrans-100
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The periodogram will highlight all spectral components in the signal (all seasonal
    components in the data), and will provide an overview of their overall “strength”,
    but it’s an aggregate of the “strength” of any component over the whole time interval.
    It says nothing about how the “strength” of each seasonal component may vary in
    time across the dataset.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: To capture that variation, you have to use the Fourier spectrogram instead.
    It’s like the periodogram, but performed repeatedly over many time windows across
    the entire data set. The spectrogram is also available as a method in the scipy
    library.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: Let’s plot the spectrogram for the seasonal components with periods of 2 and
    4 quarters, mentioned above. As always, the full code is in the companion notebook
    linked at the end.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '![](../Images/8e0e35905302dd64188aef1190298448.png)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
- en: spectrogram
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: What this diagram shows is the “strength” of the 2-quarter and 4-quarter components
    over time, the maximum amplitude of their variation at different moments in time
    (in sound synthesis for digital music instruments this is called the **envelope**).
    They are pretty weak initially, but become very strong around 2010, which matches
    the variations you can see in the data set plot at the top of this article.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: Beyond multiplicative seasonality
  id: totrans-108
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The envelope, as we will see below, will model the amplitude of seasonal components
    in a way that’s definitely better than simply adding a fixed-amplitude seasonality
    to the trend. It can also be more general than simply tying the amplitude of seasonality
    to the overall trend (like with multiplicative seasonality) — **it fully decouples
    seasonality from trend**.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: In other words, with the envelope you can keep using the basic additive seasonality
    model, but the seasonal component itself has changed. It is no longer a linear
    combination of fixed-amplitude components. Instead, it follows the trends (the
    envelopes) of the various seasonal components detected in the signal. The overall
    model is additive w.r.t. seasonality, but seasonality is multiplied by the various
    envelopes.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s say you take the envelopes F of the seasonal components from the Fourier
    spectrogram, and you smooth them — the smoothed versions are denoted by F-tilde.
    Then one-hot encoding, dummy encoding, and Fourier encoding for the seasonal component
    become:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/bac6e75545bc7ef7ac32a0a8f9cb0277.png)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/bac6e75545bc7ef7ac32a0a8f9cb0277.png)'
- en: one-hot encoding with component envelopes
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 带有组件包络的独热编码
- en: '![](../Images/cb25cba86fc13f3b43b4be85d223873f.png)'
  id: totrans-114
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/cb25cba86fc13f3b43b4be85d223873f.png)'
- en: dummy encoding with component envelopes
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 带有组件包络的虚拟编码
- en: '![](../Images/32b6aee543ea5efb5f9bf9982f5f685a.png)'
  id: totrans-116
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/32b6aee543ea5efb5f9bf9982f5f685a.png)'
- en: Fourier series with component envelopes
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 带有组件包络的傅里叶级数
- en: The beta(p), a(n) and b(n) will be the weights that your model will learn while
    fitting the time features. The F-tilde coefficients (which themselves are time
    series) are the component envelopes, and they will be multiplied into the time
    features before model training, as shown below.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: beta(p)、a(n)和b(n)将是你的模型在拟合时间特征时学习的权重。F-tilde系数（本身是时间序列）是组件包络，它们将在模型训练前与时间特征相乘，如下所示。
- en: For one-hot and dummy encoding, the formulae shown above use a single envelope
    — that of the base component with period P. For the Fourier sum, the formula suggests
    extracting a separate envelope for each component. There may be deviations from
    this pattern in practice, but that’s a separate discussion.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 对于独热和虚拟编码，上述公式使用单一包络——基组件的周期P。对于傅里叶和式，公式建议为每个组件提取一个单独的包络。实际中可能会有偏差，但这是另一个话题。
- en: 'If the overall model that learns from all the features is linear, then you
    can still say that you’re using a form of “additive seasonality” (adjusted with
    the envelope):'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 如果从所有特征中学习的总体模型是线性的，那么你仍然可以说你使用的是一种“加法季节性”（通过包络调整）：
- en: '![](../Images/5f458c4466636ecd4ac810729c775164.png)'
  id: totrans-121
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/5f458c4466636ecd4ac810729c775164.png)'
- en: additive seasonality
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 加法季节性
- en: If the overall model is a random forest, or some other non-linear model, then
    the simple formula shown above does not apply.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 如果总体模型是随机森林或其他非线性模型，则上述简单公式不适用。
- en: Seasonal features in code
  id: totrans-124
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 代码中的季节特征
- en: Let’s create a few sample data frames containing seasonal features that could
    be used to model seasonality in a dataset, using methods from `statsmodels.tsa.deterministic`.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 我们来创建一些示例数据框，其中包含可以用于建模数据集季节性的季节特征，使用`statsmodels.tsa.deterministic`中的方法。
- en: 'One-hot encoded features, one for each quarter, with a period of 1 year:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 独热编码特征，每个季度一个，周期为1年：
- en: '[PRE5]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '[PRE6]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: If you want to use dummy encoding instead, simply drop one column. Also explore
    the `drop=True` option in `DeterministicProcess()`, which will check for perfect
    collinearity and will try to make the right decision (drop / no drop).
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想使用虚拟编码，只需删除一列。还可以探索`DeterministicProcess()`中的`drop=True`选项，该选项将检查完全共线性并尝试做出正确的决定（删除/不删除）。
- en: 'Yearly sine-cosine pairs of features:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 年度正弦-余弦特征对：
- en: '[PRE7]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[PRE8]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: For the rest of this article, we will use one-hot encoding, despite the fact
    that the model we fit is `LinearRegression()`. For this data set, `statsmodels`
    checks the collinearity of the time series target with `DeterministicProcess(drop=True)`,
    and does not deem it necessary to drop one column (does not switch to dummy encoding).
    Of course, feel free and compare one-hot encoding with dummy encoding for your
    data set and model.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 在本文其余部分，我们将使用独热编码，尽管我们拟合的模型是`LinearRegression()`。对于这个数据集，`statsmodels`检查了时间序列目标与`DeterministicProcess(drop=True)`的共线性，并认为没有必要删除一列（不切换到虚拟编码）。当然，你可以自由比较独热编码和虚拟编码在你的数据集和模型中的效果。
- en: Let’s see what happens when we fit a linear model on these seasonal features.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看在这些季节特征上拟合线性模型会发生什么。
- en: Fit a linear model
  id: totrans-135
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 拟合线性模型
- en: 'Let’s create trend features (the columns called const, trend, and trend_squared)
    and then join them with the `seasonal_year` features generated above:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 我们来创建趋势特征（称为const、trend和trend_squared的列），然后将它们与上述生成的`seasonal_year`特征连接起来：
- en: '[PRE9]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '[PRE10]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This is the X data frame (features) that will be used to train/validate the
    model. We’re modeling the data with quadratic trend features, plus the 4 time
    features needed for the yearly seasonality. The y data frame (target) will be
    just the cement production numbers.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 这是用于训练/验证模型的X数据框（特征）。我们用二次趋势特征对数据进行建模，加上需要的4个时间特征以捕捉年度季节性。y数据框（目标）将仅为水泥生产数字。
- en: Let’s carve a validation set out of the data, containing the year 2010 observations.
    We will fit a linear model on the X features shown above and the y target represented
    by cement production (the train portion of the dataset, what remains after carving
    out the validation data), and then we will evaluate model performance in validation.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从数据中划分出一个包含2010年观察值的验证集。我们将在上述X特征和由水泥生产表示的y目标（训练数据集的那部分，即划分出验证数据后剩下的部分）上拟合一个线性模型，然后评估模型在验证中的表现。
- en: We will also do all of the above with another, trend-only model, that will only
    fit the trend features but will ignore seasonality — just to show what the overall
    trend is.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将用另一个仅趋势模型进行上述所有操作，该模型只会拟合趋势特征而忽略季节性——只是为了展示整体趋势是什么。
- en: '[PRE11]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '[PRE12]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '![](../Images/c9f30673cf9dd7deb5ac4d7a12219b7b.png)'
  id: totrans-144
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c9f30673cf9dd7deb5ac4d7a12219b7b.png)'
- en: model validation
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 模型验证
- en: We’ve seen this before. Blue is train, red is validation. The full model is
    the sharp, thin line. The trend-only model is the wide, fuzzy line.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前见过这种情况。蓝色是训练数据，红色是验证数据。完整模型是锐利、细的线。仅趋势模型是宽而模糊的线。
- en: 'This is not bad for a trivial model, but there is one glaring issue: the model
    has learned a constant-amplitude yearly seasonality. Even though the yearly variation
    actually increases in time, the model can only stick to fixed-amplitude variations.
    Obviously, this is because we gave the model only fixed-amplitude seasonal features,
    and there are no other features (target lags, etc) to help it overcome this issue
    (this is by design, to highlight the importance of the technique described here).
    Additive seasonality with a fixed amplitude does not work well here.'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 对于一个简单的模型来说，这并不差，但有一个明显的问题：模型学到了一个恒定振幅的年度季节性。尽管年度变化实际上随着时间的推移而增加，模型只能保持固定振幅的变化。显然，这是因为我们只给了模型固定振幅的季节性特征，并且没有其他特征（目标滞后等）来帮助它克服这个问题（这是故意为之，以突出这里描述的技术的重要性）。固定振幅的加法季节性在这里效果不佳。
- en: Perhaps information about the amplitude of seasonal components obtained via
    Fourier analysis (envelopes) would improve performance?
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 也许通过傅里叶分析获得的季节性组件的振幅信息（包络）会改善性能？
- en: Adjust the seasonal components
  id: totrans-149
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 调整季节性组件
- en: 'Let’s pick the 4-quarter seasonal component. As seen in the spectrogram above,
    its envelope is very noisy, so we could fit a linear model (let’s call it the
    envelope model) on the order=2 trend of the envelope, on the train data with `model.fit()`,
    to smooth the envelope, and then we will extend that trend into validation / testing
    with `model.predict()`:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们选择四季度季节性组件。如上面的频谱图所示，其包络非常嘈杂，因此我们可以在包络的`order=2`趋势上拟合一个线性模型（我们称之为包络模型），在训练数据上使用`model.fit()`来平滑包络，然后我们将使用`model.predict()`将该趋势扩展到验证/测试数据中：
- en: '[PRE13]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: '![](../Images/8b3b8f7be82c7ca1ccd8c084117683aa.png)'
  id: totrans-152
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/8b3b8f7be82c7ca1ccd8c084117683aa.png)'
- en: envelope fit
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 包络拟合
- en: The gray line is the envelope itself — it’s very noisy. The blue line is the
    envelope, the strength of the variation of the 4-quarter seasonal component in
    the train data, fitted (smoothed) as a quadratic trend (order=2). The red line
    is the same thing, extended (predicted) over the validation data. This is smoothing
    via regression.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 灰色线是包络本身——它非常嘈杂。蓝色线是包络，是训练数据中四季度季节性组件的变化强度，拟合（平滑）为二次趋势（`order=2`）。红色线是相同的内容，在验证数据上延展（预测）。这就是通过回归进行平滑。
- en: You may notice that, while the general trend was modeled as being nearly linear
    by a quadratic model, this envelope is clearly non-linear. Multiplicative seasonality
    will likely not be the best fit for this data.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会注意到，虽然整体趋势被二次模型建模为接近线性，这个包络明显是非线性的。乘法季节性可能不适合这些数据。
- en: 'We have modeled the variation in time of the 4-quarter seasonal component.
    Let’s take the output from the envelope model (F-tilde in the envelope-adjusted
    Fourier series formula) and multiply it by the time features corresponding to
    the 4-quarter seasonal component:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经建模了四季度季节性组件随时间的变化。让我们从包络模型（包络调整的傅里叶级数公式中的F-tilde）中取出输出，并将其乘以对应于四季度季节性组件的时间特征：
- en: '[PRE14]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '[PRE15]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The four time features are not either 0 or 1 anymore. They’ve been multiplied
    by the component envelope (F-tilde in the formula), and now their amplitude varies
    in time, just like the envelope.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 四个时间特征不再是0或1了。它们已经被乘以组件包络（公式中的F-tilde），现在它们的振幅随时间变化，就像包络一样。
- en: Retrain the model
  id: totrans-160
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 重新训练模型
- en: Let’s train the main model again, now using the modified time features.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们重新训练主模型，现在使用修改后的时间特征。
- en: '[PRE16]'
  id: totrans-162
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '[PRE17]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: '![](../Images/33b99d03366714606c52d8a6bc062063.png)'
  id: totrans-164
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/33b99d03366714606c52d8a6bc062063.png)'
- en: model validation, adjusted time dummies
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 模型验证，调整时间虚拟变量
- en: We’re not aiming for a perfect fit here, since this is just a toy model built
    to demo a technique, but it’s obvious the model performs better, it is more closely
    following the 4-quarter variations in the target. The performance metric has improved
    also, by 51%, which is not bad at all.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 我们并不追求完美拟合，因为这只是一个用于演示技术的玩具模型，但显然模型表现更好，更接近目标的四个季度变化。性能指标也提高了 51%，这还不错。
- en: Clearly the overall trend is not modeled well. Higher order trends may work
    better. Or adding inflection points, a la Facebook Prophet, may work better. Feel
    free to try it.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 显然，整体趋势建模效果不佳。高阶趋势可能效果更好。或者像 Facebook Prophet 那样添加拐点也可能效果更好。可以随意尝试。
- en: Even further improvements are definitely possible (e.g. an autoregressive model
    with plenty of time lags would fit much better) but that’s not the topic of this
    article — we’re only focusing here on one aspect of seasonality.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 进一步的改进绝对是可能的（例如，具有大量时间滞后的自回归模型拟合效果会更好），但这不是本文的主题——我们这里只关注季节性方面。
- en: Final comments
  id: totrans-169
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 最终评论
- en: Improving forecasting performance is a vast topic. The behavior of any model
    does not depend on a single feature, or on a single technique. However, if you’re
    looking to extract all you can out of a given model, you should probably feed
    it meaningful features. One-hot encoding or dummy encoding, or sine/cosine Fourier
    pairs, are more meaningful when they reflect the variation in time of the seasonality
    they are modeling.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 提高预测性能是一个广泛的话题。任何模型的行为都不依赖于单一特征或单一技术。然而，如果你希望从给定模型中提取所有可能的信息，应该提供有意义的特征。独热编码或虚拟编码，或正弦/余弦傅里叶对，当它们反映了季节性随时间的变化时，更具意义。
- en: Adjusting the seasonal feature’s envelope via the Fourier transform is particularly
    effective for linear models. Boosted trees do not benefit as much, but you can
    still see improvements almost no matter what model you use. If you’re using ensemble
    models, you may have a simpler model such as linear regression at the bottom of
    the stack, and you probably want to improve its performance before other models
    learn from its residuals (assuming the ensemble is configured that way).
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 通过傅里叶变换调整季节性特征的包络对线性模型特别有效。提升树的效果不如线性模型明显，但无论使用什么模型，你几乎都可以看到改进。如果你使用集成模型，你可能会在堆栈底部有一个简单的模型，如线性回归，你可能希望在其他模型从其残差中学习之前提升其性能（假设集成模型是这样配置的）。
- en: It is also important that the envelope models you use to adjust seasonal features
    are only trained on the train data, and they do not see any testing data while
    in training, just like any other model. Once you adjust the envelope, the time
    features contain information from the target — they are not purely deterministic
    features anymore, that can be computed ahead of time over any arbitrary forecast
    horizon. So at this point information could leak from validation/testing back
    into training data via time features if you’re not careful (purely deterministic
    time features do not suffer from this issue).
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 同样重要的是，你用来调整季节性特征的包络模型只能在训练数据上训练，在训练期间不能看到任何测试数据，就像其他模型一样。一旦你调整了包络，时间特征就包含了来自目标的信息——它们不再是可以在任何任意预测范围内预先计算的纯确定性特征。因此，如果你不小心，信息可能会通过时间特征从验证/测试阶段泄漏回训练数据（纯确定性时间特征不会有这个问题）。
- en: Finally, the envelopes themselves are time series which might be subject to
    forecasting, since they model a real-world process or phenomenon. That’s a separate
    discussion.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，包络本身是时间序列，可能需要进行预测，因为它们建模的是现实世界的过程或现象。这是一个独立的讨论。
- en: Links
  id: totrans-174
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 链接
- en: 'The data set used in this article is available here under the Public Domain
    (CC0) license:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 本文使用的数据集可以在这里以公共领域（CC0）许可证获取：
- en: '[## KEY2STATS'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: '[## KEY2STATS'
- en: © 2023 KEY2STATS - RStudio® is a registered trademark of RStudio, Inc. AP® is
    a registered trademark of the College…
  id: totrans-177
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: © 2023 KEY2STATS - RStudio® 是 RStudio, Inc. 的注册商标。AP® 是 College 的注册商标…
- en: www.key2stats.com](https://www.key2stats.com/data-set/view/776?source=post_page-----18c792102047--------------------------------)
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: www.key2stats.com](https://www.key2stats.com/data-set/view/776?source=post_page-----18c792102047--------------------------------)
- en: 'The code used in this article can be found here:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 本文中使用的代码可以在这里找到：
- en: '[](https://github.com/FlorinAndrei/misc/blob/master/seasonal_features_fourier_article/cement.ipynb?source=post_page-----18c792102047--------------------------------)
    [## misc/seasonal_features_fourier_article/cement.ipynb at master · FlorinAndrei/misc'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://github.com/FlorinAndrei/misc/blob/master/seasonal_features_fourier_article/cement.ipynb?source=post_page-----18c792102047--------------------------------)
    [## misc/seasonal_features_fourier_article/cement.ipynb at master · FlorinAndrei/misc'
- en: random stuff. Contribute to FlorinAndrei/misc development by creating an account
    on GitHub.
  id: totrans-181
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 随机杂项。通过在GitHub上创建帐户贡献给FlorinAndrei/misc。
- en: github.com](https://github.com/FlorinAndrei/misc/blob/master/seasonal_features_fourier_article/cement.ipynb?source=post_page-----18c792102047--------------------------------)
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: '[github.com](https://github.com/FlorinAndrei/misc/blob/master/seasonal_features_fourier_article/cement.ipynb?source=post_page-----18c792102047--------------------------------)'
- en: 'A notebook submitted to the Store Sales — Time Series Forecasting competition
    on Kaggle, using ideas described in this article:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在Kaggle上提交给Store Sales — 时间序列预测竞赛的笔记本，使用了本文中描述的想法：
- en: '[](https://www.kaggle.com/code/florinandrei/fourier-spectrogram-ensemble-models?source=post_page-----18c792102047--------------------------------)
    [## Fourier spectrogram, ensemble models'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://www.kaggle.com/code/florinandrei/fourier-spectrogram-ensemble-models?source=post_page-----18c792102047--------------------------------)
    [## 傅里叶谱图，集成模型'
- en: Explore and run machine learning code with Kaggle Notebooks | Using data from
    Store Sales - Time Series Forecasting
  id: totrans-185
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用Kaggle Notebooks探索并运行机器学习代码 | 使用Store Sales数据进行时间序列预测
- en: www.kaggle.com](https://www.kaggle.com/code/florinandrei/fourier-spectrogram-ensemble-models?source=post_page-----18c792102047--------------------------------)
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: '[www.kaggle.com](https://www.kaggle.com/code/florinandrei/fourier-spectrogram-ensemble-models?source=post_page-----18c792102047--------------------------------)'
- en: 'A GitHub repo containing the development version of the notebook submitted
    to Kaggle is here:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是一个GitHub仓库，包含提交给Kaggle的笔记本的开发版本：
- en: '[](https://github.com/FlorinAndrei/timeseries-forecasting-fourier-time-dummies?source=post_page-----18c792102047--------------------------------)
    [## GitHub - FlorinAndrei/timeseries-forecasting-fourier-time-dummies: Time series
    forecasting with…'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://github.com/FlorinAndrei/timeseries-forecasting-fourier-time-dummies?source=post_page-----18c792102047--------------------------------)
    [## GitHub - FlorinAndrei/timeseries-forecasting-fourier-time-dummies: 带有傅里叶...'
- en: Time series forecasting with Fourier-adjusted time dummies - GitHub …
  id: totrans-189
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 带有傅里叶调整时间虚拟变量的时间序列预测 - GitHub...
- en: github.com](https://github.com/FlorinAndrei/timeseries-forecasting-fourier-time-dummies?source=post_page-----18c792102047--------------------------------)
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: '[github.com](https://github.com/FlorinAndrei/timeseries-forecasting-fourier-time-dummies?source=post_page-----18c792102047--------------------------------)'
- en: 'The Facebook Prophet paper — Forecasting at Scale:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: Facebook Prophet论文 — 大规模预测：
- en: '[https://peerj.com/preprints/3190.pdf](https://peerj.com/preprints/3190.pdf)'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://peerj.com/preprints/3190.pdf](https://peerj.com/preprints/3190.pdf)'
- en: All images and code used in this article are created by the author.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 本文中使用的所有图片和代码均由作者创建。
