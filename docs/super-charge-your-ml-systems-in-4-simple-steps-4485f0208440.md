# 4个简单步骤让你的机器学习系统超充电

> 原文：[https://towardsdatascience.com/super-charge-your-ml-systems-in-4-simple-steps-4485f0208440?source=collection_archive---------6-----------------------#2023-10-27](https://towardsdatascience.com/super-charge-your-ml-systems-in-4-simple-steps-4485f0208440?source=collection_archive---------6-----------------------#2023-10-27)

![](../Images/f57a9771668a09508fbbd608c1e742be.png)

使用 DALL.E-3 生成的图像

[](https://medium.com/@donaljbyrne?source=post_page-----4485f0208440--------------------------------)[![Donal Byrne](../Images/4695fec999da472bbd5116de6ed7cc5d.png)](https://medium.com/@donaljbyrne?source=post_page-----4485f0208440--------------------------------)[](https://towardsdatascience.com/?source=post_page-----4485f0208440--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----4485f0208440--------------------------------) [Donal Byrne](https://medium.com/@donaljbyrne?source=post_page-----4485f0208440--------------------------------)

·

[关注](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fdbf9e722f39d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsuper-charge-your-ml-systems-in-4-simple-steps-4485f0208440&user=Donal+Byrne&userId=dbf9e722f39d&source=post_page-dbf9e722f39d----4485f0208440---------------------post_header-----------) 发表在 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----4485f0208440--------------------------------) · 8 分钟阅读 · 2023年10月27日 [](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4485f0208440&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsuper-charge-your-ml-systems-in-4-simple-steps-4485f0208440&user=Donal+Byrne&userId=dbf9e722f39d&source=-----4485f0208440---------------------clap_footer-----------)

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4485f0208440&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsuper-charge-your-ml-systems-in-4-simple-steps-4485f0208440&source=-----4485f0208440---------------------bookmark_footer-----------)

欢迎来到机器学习优化的过山车之旅！这篇文章将带你了解我的优化任何机器学习系统以实现闪电般快速训练和推理的4个简单步骤。

想象一下：你终于被分配到一个酷炫的新机器学习项目中，你正在训练你的智能体来统计照片中的热狗数量，其成功可能为你的公司带来数十美元的收入！

你在你最喜欢的框架中实现了最新的炙手可热的物体检测模型，该模型有很多 GitHub 星标，运行一些玩具示例，经过一个小时左右，它就像一个在大学第3年重修的穷学生一样准确地识别热狗，生活美好。

下一步显而易见，我们想将其扩展到更困难的问题，这意味着更多的数据、更大的模型，当然，还有更长的训练时间。现在你需要面对几天的训练时间，而不是几个小时。不过没关系，你已经忽视你的团队3周了，可能应该花一天时间处理积压的代码审查和被动攻击的电子邮件。

你在为你在同事的MR上留下的有见地且绝对必要的细节而感到满意的一天后回来，结果发现你的性能崩溃了，在经历了15小时的训练后（因果报应来得很快）。

接下来的几天变成了试验、测试和实验的旋风，每个潜在的想法都需要超过一天的运行时间。这些迅速开始积累数百美元的计算成本，所有这些都导致了一个大问题：我们如何才能让这一切变得更快、更便宜？

欢迎来到机器学习优化的情感过山车！这里有一个简单的4步流程，可以使局势对你有利：

1.  基准测试

1.  简化

1.  优化

1.  重复

这是一个迭代过程，很多时候你会在进行下一步之前重复某些步骤，所以这不只是一个4步系统，更像是一个工具箱，但4步听起来更好。

# 1 — 基准测试

> “测量两次，切割一次”*—某位智者*。

你应该始终做的第一件（可能也是第二件）事是对系统进行性能分析。这可以是简单地计时特定代码块运行所需的时间，也可以是复杂的全程性能跟踪。重要的是你有足够的信息来识别系统中的瓶颈。我根据我们在过程中所处的阶段进行多次基准测试，并通常将其分为两种类型：高层次和低层次基准测试。

## 高层次

这就是你会在每周“我们到底有多糟糕？”会议上向老板展示的内容，并希望这些指标成为每次运行的一部分。这些将给你一个关于系统性能的高层次感受。

**Batches Per Second**——我们每秒处理多少批次？这应该尽可能高。

**Steps Per Second**——（特指强化学习）我们在环境中生成数据的速度是多少，应该尽可能高。这里有一些复杂的步伐时间与训练批次之间的相互作用，我在这里不详细讨论。

**GPU Util**——在训练过程中你的GPU使用了多少？这应该始终接近100%，如果不是，那么你有可以优化的空闲时间。

**CPU Util**——在训练过程中你的CPU使用了多少？同样，这应该尽可能接近100%。

**FLOPS**——每秒浮点运算次数，这能让你了解你是如何有效利用总硬件的。

## 低层次

使用上述指标后，你可以进一步深入查看瓶颈可能出现在何处。一旦有了这些信息，你需要开始查看更细粒度的指标和分析。

**时间分析** — 这是最简单且通常最有用的实验。像[cprofiler](https://docs.python.org/3/library/profile.html)这样的分析工具可以帮助你从整体上了解每个组件的时间消耗，或者查看特定组件的时间。

**内存分析** — 另一个优化工具箱中的常见工具。大型系统需要大量内存，所以我们必须确保没有浪费内存！像[memory-profiler](https://pypi.org/project/memory-profiler/)这样的工具将帮助你缩小系统消耗RAM的范围。

**模型分析** — 像[Tensorboard](https://www.tensorflow.org/tensorboard/get_started#:~:text=TensorBoard%20is%20a%20tool%20for,dimensional%20space%2C%20and%20much%20more.)这样的工具提供了优秀的分析工具，用于查看你的模型中哪些部分正在消耗性能。

**网络分析** — 网络负载是导致系统瓶颈的常见原因。像[wireshark](https://www.wireshark.org/)这样的工具可以帮助你进行网络分析，但说实话，我从未使用过。相反，我更倾向于对我的组件进行时间分析，测量组件内部所需的总时间，然后隔离网络I/O本身所花费的时间。

确保查看这篇关于Python性能分析的优秀文章，[RealPython](https://realpython.com/python-profiling/)，以获取更多信息！

# 2 — 简化

一旦你在性能分析中确定了需要优化的区域，就要进行简化。去除除该部分之外的所有内容。继续将系统简化为更小的部分，直到找到瓶颈。不要害怕在简化过程中进行性能分析，这将确保你在迭代过程中走在正确的方向上。继续重复这个过程，直到找到你的瓶颈。

## 提示

+   用存根和模拟函数替换其他组件，这些存根和模拟函数仅提供预期的数据。

+   使用`sleep`函数或虚拟计算来模拟重负载函数。

+   使用虚拟数据以去除数据生成和处理的开销。

+   从本地、单进程版本的系统开始，然后再转到分布式系统。

+   在单台机器上模拟多个节点和演员，以去除网络开销。

+   找出系统每个部分的理论最大性能。如果系统中所有其他瓶颈都消除了，除了这个组件，我们的预期性能是什么？

+   再次进行性能分析！每次简化系统时，重新运行你的性能分析。

## 问题

一旦我们锁定了瓶颈，就有一些关键问题需要回答。

**这个组件的理论最大性能是多少？**

如果我们已经充分隔离了瓶颈组件，那么应该能够回答这些问题。

**我们距离最大性能还有多远？**

这个最优性差距将告诉我们系统的优化程度。现在，可能会出现其他硬性约束，一旦我们将组件重新引入系统中，这也是可以接受的，但至少要意识到这个差距。

**是否存在更深层的瓶颈？**

总是问自己这个问题，也许问题比你最初想到的更深层次，在这种情况下，我们需要重复基准测试和简化的过程。

# 3 — 优化

好的，我们已经识别出了最大的瓶颈，现在进入有趣的部分，我们怎么改进？通常我们应该关注 3 个可能的改进领域。

1.  **计算**

1.  **通信**

1.  **内存**

## 计算

为了减少计算瓶颈，我们需要尽可能高效地使用数据和算法。这显然是项目特定的，有很多可以做的事情，但让我们来看一些好的经验法则。

**并行化** — 确保尽可能多地进行并行工作。这是设计系统时第一个显著的胜利，可以大幅度提升性能。考虑使用向量化、批处理、多线程和多进程等方法。

**缓存** — 尽可能地预计算和重用计算结果。许多算法可以利用预计算的值，从而节省每一步训练中的关键计算。

**卸载** — 我们都知道 Python 速度不快。幸运的是，我们可以将关键计算卸载到低级语言如 C/C++。

**硬件扩展** — 这有点偷懒，但当一切都失败时，我们总可以增加更多的计算机来解决问题！

## 通信

任何经验丰富的工程师都会告诉你，沟通是成功交付项目的关键，我们当然是指系统内部的沟通（天哪，我们希望不要跟同事交流）。一些好的经验法则包括：

**无闲置时间** — 你所有可用的硬件必须始终被利用，否则你将错失性能提升。这通常是由于系统间通信的复杂性和开销所致。

**保持本地化** — 在迁移到分布式系统之前，尽可能长时间地将所有内容保留在单台机器上。这使你的系统保持简单，同时避免了分布式系统的通信开销。

**异步 > 同步** — 识别任何可以异步完成的任务，这将有助于通过在数据移动的同时保持工作进行，从而减轻通信的成本。

**避免数据移动** — 将数据从 CPU 移动到 GPU 或从一个进程移动到另一个进程是昂贵的！尽量减少这种操作，或者通过异步方式减少其影响。

## 内存

最后但同样重要的是内存。上述许多领域可以帮助缓解瓶颈，但如果没有足够的内存，这可能是不可能的！让我们来看一些需要考虑的事项。

**数据类型** — 保持这些尽可能小，有助于减少通信和内存成本，并且与现代加速器一起，它还会减少计算。

**缓存** — 类似于减少计算，聪明的缓存可以帮助节省内存。然而，确保你的缓存数据使用频率足够高，以证明缓存的合理性。

**预分配** — 在 Python 中我们不太习惯这样做，但严格进行内存预分配可以让你准确知道所需内存量，减少碎片化的风险，并且如果你能够写入共享内存，你将减少进程之间的通信！

**垃圾回收** — 幸运的是，Python 处理了大部分这方面的工作，但重要的是确保你没有在作用域中保留不必要的大值，或者更糟的是，存在可能导致内存泄漏的循环依赖。

**懒惰** — 仅在必要时评估表达式。在 Python 中，你可以使用生成器表达式代替列表推导式，以便进行惰性计算的操作。

# 4 — 重复

那么，我们什么时候才算完成呢？这真的取决于你的项目、需求是什么，以及在你渐渐崩溃之前需要多久！

随着你消除瓶颈，你在优化系统时投入的时间和精力将会得到递减的回报。在这个过程中，你需要决定何时“足够好”。记住，速度是实现目标的一种手段，不要陷入为优化而优化的陷阱。如果对用户没有影响，那么可能是时候继续前进了。

# 结论

构建大规模 ML 系统是困难的。这就像玩一个扭曲的“沃尔多在哪里”游戏，混合了《黑暗之魂》的元素。如果你真的找到问题，你必须进行多次尝试才能解决，而且你会花费大部分时间被虐待，问自己“我为什么要在周五晚上做这些？”。有一个简单且有原则的方法可以帮助你通过最终 boss 战，并品尝到那些甜美的理论最大 FLOPs。

[## ML in Action | Donal Byrne | Substack](https://donalbyrne.substack.com/?utm_source=navbar&utm_medium=web&r=hk3pr&source=post_page-----4485f0208440--------------------------------)

### 提供未经请求的建议、实用见解和在快速发展的领域中学到的经验的机器学习通讯…

[donalbyrne.substack.com](https://donalbyrne.substack.com/?utm_source=navbar&utm_medium=web&r=hk3pr&source=post_page-----4485f0208440--------------------------------)
