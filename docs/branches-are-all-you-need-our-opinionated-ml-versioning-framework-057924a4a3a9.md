# Branches Are All You Need: Our Opinionated ML Versioning Framework

> 原文：[https://towardsdatascience.com/branches-are-all-you-need-our-opinionated-ml-versioning-framework-057924a4a3a9?source=collection_archive---------3-----------------------#2023-10-10](https://towardsdatascience.com/branches-are-all-you-need-our-opinionated-ml-versioning-framework-057924a4a3a9?source=collection_archive---------3-----------------------#2023-10-10)

## 一个实用的机器学习项目版本控制方法，使用Git分支简化工作流程，组织数据和模型

[](https://medium.com/@xdss?source=post_page-----057924a4a3a9--------------------------------)[![乔纳森（约纳坦）·亚历山大](../Images/7b2182b7048b5baffc642f8926d7a11b.png)](https://medium.com/@xdss?source=post_page-----057924a4a3a9--------------------------------)[](https://towardsdatascience.com/?source=post_page-----057924a4a3a9--------------------------------)[![走向数据科学](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----057924a4a3a9--------------------------------) [乔纳森（约纳坦）·亚历山大](https://medium.com/@xdss?source=post_page-----057924a4a3a9--------------------------------)

·

[关注](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Feba261287b37&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbranches-are-all-you-need-our-opinionated-ml-versioning-framework-057924a4a3a9&user=Jonathan+%28Yonatan%29+Alexander&userId=eba261287b37&source=post_page-eba261287b37----057924a4a3a9---------------------post_header-----------) 发表在 [走向数据科学](https://towardsdatascience.com/?source=post_page-----057924a4a3a9--------------------------------) ·10 分钟阅读·2023年10月10日[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F057924a4a3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbranches-are-all-you-need-our-opinionated-ml-versioning-framework-057924a4a3a9&user=Jonathan+%28Yonatan%29+Alexander&userId=eba261287b37&source=-----057924a4a3a9---------------------clap_footer-----------)

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F057924a4a3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbranches-are-all-you-need-our-opinionated-ml-versioning-framework-057924a4a3a9&source=-----057924a4a3a9---------------------bookmark_footer-----------)

# 简而言之

一个简单的机器学习项目版本控制方法，使用Git分支简化工作流程，组织数据和模型，并将项目相关部分紧密联系在一起。

# 介绍

在管理机器学习解决方案时，解决方案的各个方面通常分布在多个平台和位置，如GitHub用于代码，HuggingFace用于模型，Weights and Biases用于追踪，S3用于一切的备份等等。

在数据方面，我们有训练数据、处理过的数据、训练跟踪数据和模型监控数据。我们保存用于推理的模型，包括旧版本和用于在线测试的实验模型。我们还有用于预处理、训练、推理、实验、数据科学分析和监控警报的代码。

这很容易失控。

![](../Images/5b381eb0161c9606fe03f632ac0bde0b.png)

作者提供的图像

使用各种工具、环境和资产地址来跟踪 ML 生命周期的不同部分，可能导致状态分散和协调不足。这可能导致数据丢失、安全漏洞和需要仔细管理的配置错误。

> 在一个之前的项目中，我们在本地解决方案中使用 SageMaker 进行日常训练。这要求客户每天下载一个模型，并使用各种客户数据集的组合进行训练。
> 
> 我们必须管理哪个二进制模型是用哪个训练代码在哪个客户的数据上训练的，哪个模型在哪个客户运行，使用哪个推理代码等等。

在这篇文章中，我们将展示如何利用数据版本控制工具，通过 Git 解决这些问题。

数据版本控制工具允许你与代码一起提交数据和模型文件，无论其大小如何。通过这种方式对所有文件进行版本控制，你可以绕过管理数据和模型资产的不便。

在理想情况下，你只会拥有与当前任务相关的代码、数据和模型。无论你是在开发还是运行 ML 训练、跟踪实验、监控生产中的模型，还是进行在线实验。

想象一下，不用手动（甚至自动）连接正确的部分 — 在正确的代码中加载正确的数据，将它们连接到 HuggingFace 中正确的模型，并在正确的环境中运行 — 每次你检出一个分支时，所有部分都已经就位。

在本文中，我将展示一个框架，利用 Git 代替处理工具复杂性的难题，Git 是几乎所有 ML 团队已经在使用的系统。

目标是通过将所有内容集中在一个地方，由 Git 管理，简化并消除启动 ML 工作流每个阶段的障碍。

**我们的要求**

1.  **一个简单的工作流**，易于暂停、恢复和调整以适应不断变化的业务和开发需求。它还应支持可重现性，并允许事后查询，例如“我的模型是用什么数据训练的？”

1.  **高效使用数据和代码**，重点关注凝聚力、治理和审计。— 旨在尽可能多地重用数据和代码，并利用 git 的功能，如提交、问题和标签。

1.  **整合** ML 解决方案的各个方面非常重要。通常，实验跟踪、生产中的模型监控以及在线和离线实验与训练和推理部分是分开的。在这里，我们旨在将它们统一在一个平台下，使其在各部分之间过渡变得容易。

1.  遵循**Git 和 ML 最佳实践**，例如早期和可共享的数据拆分、测试以及简单的协作，以适应不同的 ML 工程师。

# 关键概念

**每个更改都是一个 Git** **提交**：这包括数据上传、特征工程、模型覆盖、合并实验指标结果、模型监控，以及自然的代码更改。

**活动分支**：将不同的分支用于开发和生产是常见的做法。然而，我们可以在这里更进一步。这意味着你可以签出一个分支，并在一个地方拥有所有必要的数据、代码、模型、文档、readmes 和带有指标的模型卡。

> 🤯 你的代码库**就是**你的 blob 存储！你的分支像一个桶一样在你的 blob 存储中运行，允许你上传、下载和存储数据和模型。

这允许你为不同的开发、实验和生产需求使用不同的分支，而不是依赖于不同的平台和工具。

**合并作为工作流程**：它们用于合并分支。代码通常被合并，而模型通常会覆盖现有模型。当数据被合并时，通常是追加的。要接收新数据，可以从另一个分支“拉取”数据进行复制。

> 合并数据可以像文件复制或追加到 JSON 列表一样简单。在更复杂的情况下，你可以合并 sqlite 数据库。

**去重**，这是数据版本控制工具中常用的功能，防止即使在多个分支中包含相同文件时，也会创建多个文件副本。

# 分支类型

![](../Images/3798c98ea6ed53167fd70c7c61003eaa.png)

图片来自作者

# 主分支

首先，我们使用项目的*main*分支来存储问题定义、文档、数据描述和项目结构。这作为协作和讨论的空间。

> **提示**：通过明确定义业务问题、确定期望的结果、识别目标值或标签及其获取方式，并建立评估指标和要求，我们可以确保项目的成功启动，并提供一个入门和协作的地方。

我们也可以用它来**跟踪**实验，将实验结果进行合并。例如，[MLflow](http://mlflow.org/)的 mlruns 文件夹可以在此处进行合并。任何协作者都可以签出这个分支并运行 UI。

另外，跟踪可以在另一个分支中完成。

以这种方式开始非常简单，随着需求的变化，可以以最少的更改升级到 MLflow 服务器或类似 Weights and Biases 的跟踪平台。

# 数据分支

这些是项目的分支，主要包括数据文件、文档和转换脚本，并且它们**保持活动状态**。你可以把它们想象成 S3 桶，但不是上传和下载，而是签出一个分支，你的文件就在那里。

推荐始终提交（上传）到***原始***分支。这些分支创建了一个真实的来源，一个从不被编辑或删除的地方，因此我们可以始终追踪数据的来源和经过过程。它还使得创建新流程、审核和治理变得容易。

> 💡 如果你添加一个关于数据来源的提交信息，你可以获得对数据更细致的观察。

你可以使用另一个仅包含干净数据的*清理*分支。例如，上传到*原始分支*的损坏图片或空文本文件不会出现在*清理*分支中。

一个*分割*分支，其中数据被划分用于训练、验证和测试，可以确保所有团队和协作者在相同的条件下工作。

这种方法有助于防止数据泄漏，并实现更稳健的特征工程和协作。最小化测试集样本被包含在训练阶段的机会减少了引入偏差的风险。此外，所有协作者使用相同的分割可以确保实验结果的一致性和无偏。

> 在之前的分类项目中，我是一个由个体贡献者组成的团队的一员，每个人从头开始运行整个管道；我们每个人使用了不同的数据拆分百分比和种子，这导致了在生产中因错误和数据偏见而产生较弱的模型。

![](../Images/9e919b0d26f2d300c17892580d9ba93d.png)

作者提供的图片

> 💡 **机器学习提示：三阶段模型开发最佳实践** 我们使用“训练”和“验证”数据集来训练和优化模型的超参数。然后，我们将训练加验证数据集作为训练集来训练调整后的模型，并**仅一次**使用测试数据集进行评估。最后，我们在所有数据上训练模型并将其保存为我们的模型。

# 稳定分支

这些分支是**活跃的**分支，用于**训练和推断**。在这里，你可以运行训练，保存模型、检查点和模型卡，运行测试，构建和测试Docker镜像，在训练周期结束时提交所有内容，然后**标记**。它们应能处理新数据的检索和重新训练。这是自动化发生的地方。

> ⚠️ **这些分支中不编写代码。**

这确保模型与其训练所用的数据、用于训练和在生产中运行的代码（包括特征工程）以及结果指标相关联。所有这些组件被合并成一个统一的“快照”。每当你检出一个标签时，所有必要的模型组件都存在。

> 💡 **提示**：通过提前选择标签名称，你可以在训练过程中将其作为参数添加到跟踪信息中。这确保你可以通过任何跟踪工具根据跟踪数据随时检索模型-数据-代码的“快照”。

训练后，只有跟踪数据被合并（复制）到你的*主*分支用于跟踪。

在最简单的情况下，它可以是一个包含超参数和评估结果的 JSON 文本文件。然后将该文件附加到 *main* 分支中的列表中。在 MLflow 的情况下，它涉及将实验从 [mlruns 文件夹](https://mlflow.org/docs/latest/tracking.html#where-runs-are-recorded) 复制到 *main* 分支。

# 代码分支

这些分支用于 **代码开发和** **数据探索**，在抽样或小数据上进行训练，直到你拥有一个有效的程序。在开发过程中，欢迎使用所有 Git 最佳实践。然而，只有在 **不再需要进一步更改代码** 的情况下才创建 *stable* 分支，即使额外的数据被拉取。这些分支 **应该包括** 推断代码、服务器、Dockerfile 和测试。

**始终至少有一个开发分支保持活动状态**，所有新功能、错误修复和其他更改都在此分支中合并。

> 💡 ML 和 MLOps 工程师可以在训练和推断方面进行协作。

例如，你可以创建一个 ***dev/model*** 分支，在其中开发一个 **基线** 模型。这可以是分类中最流行的类别或回归中的均值/中位数。重点是设置代码，同时彻底理解你的数据。

当它稳定并且测试通过后，我们会分支到 ***stable/model***，在这里我们训练并提交模型、代码和数据到远程，并 **标记** 该提交。这种方式快速且易于分享，能够使 DevOps、后台和前端团队启动开发并交换反馈。它还将促进尽早在真实环境中验证新发现的需求。

接下来，我们在 *dev/model* 分支上开发一个 **简单模型**，比如线性回归，当它准备好并且测试通过后，我们可以将其合并到 *stable/model* 分支，在那里我们训练、提交，并为 *prod* 打上标签。

这种方法让你可以逐步改进模型，同时保留稳定分支中之前模型的完整上下文。

![](../Images/849e4c8126f79385b6641dc638a6e122.png)

图片由作者提供

从这一点开始，我们有三种选择：

+   当更多数据到达时，我们可以通过将数据拉取到稳定分支来 **重新训练** 模型。

+   我们可以开始在 *dev/linear-regression* 分支上使用特征工程进行 **实验**。

+   我们可以为更复杂的模型创建一个 **新的** *dev/new-approach* 分支。

# 监控分支

在模型监控中，我们关注数据分布、异常值和预测分布。

在 *monitoring* 分支中，我们将查询到的数据、提交标签和来自 prod 的模型预测保存为文件。

> 💡 你可以为每个环境（开发、稳定和生产）使用多个监控分支。

我们可以在数据提交上设置警报，以测试任何特征分布的[漂移](/drift-in-machine-learning-e49df46803a)、异常值、[校准](https://machinelearningmastery.com/probability-calibration-for-imbalanced-classification/)的合理性测试，并保存警报代码；这使得我们可以实现更高级的解决方案，比如异常值检测模型，因为我们也可以在这个分支中保存模型。

![](../Images/5a51b65d89c5a4d83317f23c3ad83ba9.png)

作者提供的图片

这个分支通常可以属于一个与生成监控日志的代码、数据和模型解耦的其他项目。

# 分析分支

数据科学和分析是项目的另一个方面，通常被分离到不同的项目中。这是数据科学家的分析代码和非训练数据汇聚的地方。

数据科学家可以从*monitoring*分支中检查和提取数据，以进行分析、A/B测试和其他在线与离线实验。他们也可以使用*raw*分支中的数据进行这些目的。

在线示例更简单，因为每个实验组对应一个分支。

> 💡 **提示：常见的在线实验：**
> 
> **前向测试** - 比较当前模型的99%与候选模型的1%。
> 
> **回测** - 在合并新模型后，保留1%在旧模型上以验证预期效果的反向。

将模型标签作为监控数据中的参数，有助于你精确定位度量潜在原因的每一变化。

# 总结

![](../Images/d22900bc55d5305f480797d7cc00fed0.png)

作者提供的图片

本文介绍了使用Git分支对机器学习项目进行版本控制的框架。该框架简化了工作流程，组织了数据和模型，并将项目的相关部分耦合在一起。它强调了将分支用作环境的使用，每个分支包含特定任务所需的数据、代码、模型和文档。文章还讨论了如使用不同的活跃分支类别等关键概念。总体而言，该框架旨在提高机器学习项目的工作流程效率、治理和协作。

如果你想聊天或了解更多信息，加入我们的[discord](https://discord.gg/KCzmjDaDdC)或关注我们的[博客](https://about.xethub.com/blog)。

# 结语

关于我的本地挑战，我们为每个相关的训练代码和数据集组合维护了一个“稳定”的分支。训练完成后，我们会用一个合适的标签（<*client-id>-<incremental version*>）标记提交。客户可以像其他发布版本一样拉取最新的标签。

![](../Images/3a43492def7f6cbed15d8d3ef8520784.png)

在“调试”客户端时，我们会参考特定时刻的标签来审查代码和相应的数据。我们还可以使用相同的标签匹配监控数据，这个标签也添加到监控数据中。分析笔记本可以在我们的*ds/client-id*分支中找到。
