# æ—¶é—´åºåˆ—é¢„æµ‹ä¸­çš„ä¿å½¢é¢„æµ‹

> åŸæ–‡ï¼š[`towardsdatascience.com/conformal-predictions-in-time-series-forecasting-32d3243d7479`](https://towardsdatascience.com/conformal-predictions-in-time-series-forecasting-32d3243d7479)

## æ¢è®¨åº”ç”¨äºæ—¶é—´åºåˆ—é¢„æµ‹é¢†åŸŸçš„**ä¿å½¢é¢„æµ‹**æ¦‚å¿µï¼Œå¹¶åœ¨ Python ä¸­å®ç°å®ƒ

[](https://medium.com/@marcopeixeiro?source=post_page-----32d3243d7479--------------------------------)![Marco Peixeiro](https://medium.com/@marcopeixeiro?source=post_page-----32d3243d7479--------------------------------)[](https://towardsdatascience.com/?source=post_page-----32d3243d7479--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page-----32d3243d7479--------------------------------) [Marco Peixeiro](https://medium.com/@marcopeixeiro?source=post_page-----32d3243d7479--------------------------------)

Â·å‘è¡¨äº [Towards Data Science](https://towardsdatascience.com/?source=post_page-----32d3243d7479--------------------------------) Â·10 min é˜…è¯»Â·2023 å¹´ 12 æœˆ 12 æ—¥

--

![](img/c4815b8031d5f2b1e038b0ee4a966ea6.png)

ç”± [Keith Markilie](https://unsplash.com/@rhino007?utm_source=medium&utm_medium=referral) åœ¨ [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral) æä¾›çš„ç…§ç‰‡

è€ƒè™‘é¢„æµ‹å‘¼å«ä¸­å¿ƒçš„å‘¼å«é‡è¿™ä¸€ä»»åŠ¡ã€‚è¿™äº›é¢„æµ‹åœ¨é¢„ç®—åˆ†é…å’Œå‘˜å·¥è§„åˆ’ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ï¼ˆå¦‚æœé¢„è®¡ä¼šæœ‰æ›´å¤šçš„å‘¼å«ï¼Œå°±éœ€è¦æ›´å¤šçš„ä»£ç†æ¥æ¥å¬ï¼‰ã€‚

æ‰€ä»¥æˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªé¢„æµ‹æ¨¡å‹ï¼Œå¹¶æŠ¥å‘Šä¸‹å‘¨ä¸­å¿ƒå°†æ¥åˆ° 2451 ä¸ªç”µè¯ã€‚

å½“ç„¶ï¼Œä»»ä½•æœªæ¥çš„é¢„æµ‹éƒ½ä¼šå¸¦æ¥ä¸€äº›è¯¯å·®å’Œä¸ç¡®å®šæ€§ã€‚ä½†æˆ‘ä»¬å¦‚ä½•é‡åŒ–è¿™äº›å‘¢ï¼Ÿ

åˆç†çš„ç­”æ¡ˆæ˜¯ä½¿ç”¨**é¢„æµ‹åŒºé—´**ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ä¸€å®šçš„ç½®ä¿¡æ°´å¹³æŠ¥å‘Šä¸€ç³»åˆ—å¯èƒ½çš„æœªæ¥å€¼ã€‚

è™½ç„¶æœ‰å¾ˆå¤šè®¡ç®—é¢„æµ‹åŒºé—´çš„æ–¹æ³•ï¼Œä½†å®ƒä»¬å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰æ¨¡å‹ï¼Œå¹¶ä¸”é€šå¸¸ä¾èµ–äºç‰¹å®šçš„åˆ†å¸ƒã€‚

è¿™å¸¦æ¥äº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ã€‚é¦–å…ˆï¼ŒæŸäº›æƒ…å†µä¸‹åˆ†å¸ƒå‡è®¾å¯èƒ½ä¸æˆç«‹ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬åœ¨å»ºæ¨¡æŠ€æœ¯çš„é€‰æ‹©ä¸Šå¯èƒ½å—åˆ°é™åˆ¶ã€‚

ä¾‹å¦‚ï¼Œç›®å‰æ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥æµ‹é‡ç¥ç»ç½‘ç»œçš„é¢„æµ‹åŒºé—´ï¼Œä½†è¿™äº›æ¨¡å‹å¯èƒ½ç”Ÿæˆæ›´å¥½çš„é¢„æµ‹ã€‚

è¿™å°±æ˜¯**ä¿å½¢é¢„æµ‹**æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚å®ƒä»¬ä»£è¡¨äº†ä¸€ç§é‡åŒ–é¢„æµ‹ä¸ç¡®å®šæ€§çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ—¢ä¸ä¾èµ–äºæ¨¡å‹ï¼Œä¹Ÿä¸ä¾èµ–äºåˆ†å¸ƒã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ¢è®¨äº†ä¿å½¢é¢„æµ‹èƒŒåçš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶å‘ç°äº†ç”¨äºæ—¶é—´åºåˆ—é¢„æµ‹çš„**EnbPI**æ–¹æ³•ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå°çš„é¢„æµ‹ç»ƒä¹ ä¸­åº”ç”¨å®ƒã€‚

> ***é€šè¿‡æˆ‘çš„*** [***å…è´¹æ—¶é—´åºåˆ—å¤‡å¿˜å•***](https://www.datasciencewithmarco.com/pl/2147608294) ***åœ¨ Python ä¸­å­¦ä¹ æœ€æ–°çš„æ—¶é—´åºåˆ—åˆ†ææŠ€æœ¯ï¼è·å–ç»Ÿè®¡å’Œæ·±åº¦å­¦ä¹ æŠ€æœ¯çš„å®ç°ï¼Œå…¨éƒ¨ä½¿ç”¨ Python å’Œ TensorFlowï¼***

è®©æˆ‘ä»¬å¼€å§‹å§ï¼

# ä¸€è‡´æ€§é¢„æµ‹çš„å¿«é€Ÿæ¦‚è¿°

ä¸€è‡´æ€§é¢„æµ‹ä»£è¡¨äº†ä¸€ä¸ªç ”ç©¶é¢†åŸŸï¼Œç”¨äºé‡åŒ–é¢„æµ‹çš„ä¸ç¡®å®šæ€§ã€‚

å®ƒä»¬åº”ç”¨äºå›å½’ã€äºŒå…ƒåˆ†ç±»ã€å¤šæ ‡ç­¾åˆ†ç±»å’Œæ—¶é—´åºåˆ—é¢„æµ‹ç­‰å„ç§ä»»åŠ¡ã€‚

ä¸€è‡´æ€§é¢„æµ‹çš„åŸºæœ¬æ€æƒ³æ˜¯åœ¨ç»™å®šçš„ç½®ä¿¡æ°´å¹³ä¸‹ç”Ÿæˆä¸€ä¸ªæ ¡å‡†çš„é¢„æµ‹åŒºé—´ï¼Œä¿è¯ä¸€ä¸ªç‚¹å°†ä½äºå…¶ä¸­ã€‚

æ¢å¥è¯è¯´ï¼Œä½¿ç”¨ä¸€è‡´æ€§é¢„æµ‹ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª 80% çš„ç½®ä¿¡åŒºé—´ï¼Œä¿è¯æœªæ¥çš„çœŸå®å€¼æœ‰ 80% çš„æ¦‚ç‡è½åœ¨è¿™ä¸ªåŒºé—´å†…ã€‚

ä¸å…¶ä»–é¢„æµ‹åŒºé—´ä¼°è®¡æ–¹æ³•ä¸åŒï¼Œä¸€è‡´æ€§é¢„æµ‹å¯ä»¥ä¸ä»»ä½•å»ºæ¨¡æŠ€æœ¯ä¸€èµ·ä½¿ç”¨ã€‚è€Œä¸”ï¼Œå®ƒä»¬ä¸å‡è®¾æ­£æ€åˆ†å¸ƒï¼Œè¿™é€šå¸¸æ˜¯ç»Ÿè®¡æ–¹æ³•çš„æƒ…å†µã€‚

## æ—¶é—´åºåˆ—é¢„æµ‹çš„ä¸€è‡´æ€§é¢„æµ‹

ç°åœ¨ï¼Œå¤§å¤šæ•°ä¸€è‡´æ€§é¢„æµ‹æ–¹æ³•ç”¨äºå›å½’ä»»åŠ¡ä¾èµ–äº *äº¤æ¢æ€§å‡è®¾*ã€‚

è¿™æ„å‘³ç€æ•°æ®åˆ°è¾¾çš„é¡ºåºä¸ä¼šå½±å“æ¨æ–­ã€‚

å°½ç®¡è¿™ä¸€ç‚¹åœ¨è®¸å¤šå›å½’åœºæ™¯ä¸­æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¾ç„¶åœ¨æ—¶é—´åºåˆ—é¢„æµ‹çš„èƒŒæ™¯ä¸‹å¹¶ä¸é€‚ç”¨ã€‚

æˆ‘ä»¬çŸ¥é“æ—¶é—´åºåˆ—æ˜¯æŒ‰æ—¶é—´æ’åºçš„ç‚¹ï¼Œè¿™ä¸€é¡ºåºå¿…é¡»ä¿æŒä¸å˜ã€‚æ¢å¥è¯è¯´ï¼Œæ˜ŸæœŸä¸€å¿…é¡»æ€»æ˜¯å‡ºç°åœ¨æ˜ŸæœŸå¤©ä¹‹åï¼Œæ˜ŸæœŸäºŒä¹‹å‰ã€‚

å› æ­¤ï¼Œéœ€è¦ä¸€ç§ä¸“é—¨çš„æ–¹æ³•æ¥ç”Ÿæˆæ—¶é—´åºåˆ—çš„ä¸€è‡´æ€§é¢„æµ‹ã€‚

åœ¨ 2020 å¹´ï¼Œç ”ç©¶äººå‘˜é™ˆæ—­å’Œè‚–è€€åœ¨ä»–ä»¬çš„æ–‡ç«  [æ—¶é—´åºåˆ—çš„ä¸€è‡´æ€§é¢„æµ‹](https://arxiv.org/pdf/2010.09107.pdf) ä¸­ä»‹ç»äº† **En**semble **b**atch **P**rediction **I**ntervals (**EnbPI**) æ–¹æ³•ã€‚

è¯¥æ–¹æ³•å–æ¶ˆäº†æ•°æ®å¯äº¤æ¢æ€§çš„è¦æ±‚ï¼Œå› æ­¤å¯ä»¥åº”ç”¨äºæ—¶é—´åºåˆ—é¢„æµ‹ã€‚

# æ¢ç´¢ EnbPI æ–¹æ³•

EnbPI ç®—æ³•æ˜¯ä¸€ä¸ªç”¨äºæ—¶é—´åºåˆ—çš„é€šç”¨ä¸€è‡´æ€§é¢„æµ‹æ¡†æ¶ã€‚

ä»é«˜å±‚æ¬¡æ¥çœ‹ï¼ŒEnbPI æ–¹æ³•ç”±è®­ç»ƒé˜¶æ®µå’Œé¢„æµ‹é˜¶æ®µç»„æˆã€‚è®­ç»ƒé˜¶æ®µåœ¨ä¸‹é¢çš„å›¾ä¸­ç”¨è“è‰²è¡¨ç¤ºï¼Œè€Œé¢„æµ‹é˜¶æ®µç”¨ç»¿è‰²è¡¨ç¤ºã€‚

![](img/949d09f06dad7c5ad47d0172fe4ded23.png)

EnbPI æ–¹æ³•çš„é«˜çº§æ¦‚è¿°ã€‚å›¾åƒç”±ä½œè€…æä¾›ã€‚

åœ¨è®­ç»ƒé˜¶æ®µï¼Œæˆ‘ä»¬åœ¨æ•°æ®çš„éé‡å å­é›†ä¸Šæ‹Ÿåˆå›ºå®šæ•°é‡çš„*B*è‡ªåŠ©æ¨¡å‹ã€‚é€šå¸¸ï¼Œ*B* è®¾ç½®åœ¨ 20 åˆ° 50 ä¹‹é—´ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‹Ÿåˆçš„æ¨¡å‹æ•°é‡å–å†³äºå¯ç”¨çš„æ•°æ®é‡ï¼Œå°¤å…¶æ˜¯å› ä¸ºå­é›†ä¸èƒ½é‡å ã€‚

ç„¶åï¼Œæ¯ä¸ª *B* æ¨¡å‹çš„é¢„æµ‹ä»¥ç•™ä¸€æ³• (LOO) èšåˆï¼Œ resulting in both LOO residuals and LOO models for predictions.

åœ¨é¢„æµ‹é˜¶æ®µï¼ŒEnbPI ä½¿ç”¨æ¯ä¸ªé¢„æµ‹å™¨å¯¹æ¯ä¸€ä¸ªæµ‹è¯•æ•°æ®ç‚¹è¿›è¡Œé¢„æµ‹ã€‚è¿™äº›é¢„æµ‹è¢«æ±‡æ€»ä»¥è®¡ç®—é¢„æµ‹åŒºé—´çš„ä¸­å¿ƒã€‚ç„¶åï¼Œä½¿ç”¨æ®‹å·®æ„å»ºé¢„æµ‹åŒºé—´ï¼Œå¹¶ä½¿ç”¨æ®‹å·®çš„åˆ†ä½æ•°è¿›è¡Œæ„å»ºã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå®½åº¦ä¹Ÿä¼šè¢«ä¼˜åŒ–ï¼Œä»¥ä¾¿åœ¨ç‰¹å®šç½®ä¿¡æ°´å¹³ä¸‹è·å¾—å°½å¯èƒ½æœ€çª„çš„å®½åº¦ã€‚

è¯·æ³¨æ„ï¼Œåœ¨é¢„æµ‹é˜¶æ®µï¼Œéšç€æ–°å€¼çš„è§‚å¯Ÿï¼ŒåŒºé—´ä¼šè¢«æ›´æ–°ä»¥ç¡®ä¿å…¶é€‚åº”æ€§ã€‚

ç°åœ¨æˆ‘ä»¬äº†è§£äº† EnbPI æ–¹æ³•å¦‚ä½•ä¸ºä»»ä½•é¢„æµ‹æ¨¡å‹ç”Ÿæˆé¢„æµ‹åŒºé—´ï¼Œè®©æˆ‘ä»¬åœ¨ä¸€ä¸ªå°çš„é¢„æµ‹é¡¹ç›®ä¸­ä½¿ç”¨ Python åº”ç”¨å®ƒã€‚

# åº”ç”¨ EnbPI è¿›è¡Œé¢„æµ‹

æˆ‘ä»¬ç°åœ¨å‡†å¤‡ä½¿ç”¨ EnbPI æ–¹æ³•ä¸ºæˆ‘ä»¬çš„é¢„æµ‹æ¨¡å‹ç”Ÿæˆé¢„æµ‹åŒºé—´ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒEnbPI ç®—æ³•å·²ç»é€šè¿‡[MAPIE åº“](https://mapie.readthedocs.io/en/latest/)å®ç°å¹¶å‡†å¤‡ä½¿ç”¨ï¼Œè¯¥åº“ä»£è¡¨**M**odel **A**gnostic **P**rediction **I**nterval **E**stimatorã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªè®°å½•ç½‘ç«™åšå®¢æ¯æ—¥è®¿é—®é‡çš„æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/marcopeix/time-series-analysis/blob/master/data/medium_views_published_holidays.csv)å…¬å¼€è·å–ã€‚

ä¸€å¦‚æ—¢å¾€ï¼Œæ•´ä¸ªé¡¹ç›®çš„æºä»£ç å¯ä»¥åœ¨[GitHub](https://github.com/marcopeix/time-series-analysis/blob/master/data/medium_views_published_holidays.csv)ä¸Šæ‰¾åˆ°ã€‚

è‡ªç„¶çš„ç¬¬ä¸€æ­¥æ˜¯è¿›è¡Œå¿…è¦çš„å¯¼å…¥å’Œè¯»å–æˆ‘ä»¬çš„æ•°æ®ã€‚

```py
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

from sklearn.ensemble import HistGradientBoostingRegressor

df = pd.read_csv('data/medium_views_published_holidays.csv')
df = df.drop(['unique_id'], axis=1)

df.head()
```

![](img/2ec997fc130ee11aa1619f43de9cfbed.png)

æ•°æ®é›†çš„å‰äº”è¡Œã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æ•°æ®é›†åŒ…å«æ—¶é—´æˆ³ã€å”¯ä¸€è®¿é—®è€…æ•°é‡ã€ä¸€ä¸ªæ ‡å¿—æ¥æŒ‡ç¤ºæ˜¯å¦å‘å¸ƒäº†æ–°æ–‡ç« ï¼Œä»¥åŠä¸€ä¸ªæ ‡å¿—æ¥æŒ‡ç¤ºæ˜¯å¦ä¸ºå›½å®¶å‡æ—¥ã€‚

ç”±äºæˆ‘ä»¬å°†åº”ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€äº›ç‰¹å¾ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä»æ—¥æœŸä¸­æå–å¹´ä»½ã€æœˆä»½å’Œæ—¥æœŸã€‚æˆ‘ä»¬è¿˜æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥æŒ‡ç¤ºæ˜¯å¦ä¸ºå‘¨æœ«ï¼Œå¹¶æ·»åŠ è¿‡å»ä¸ƒä¸ªæ»åå€¼ã€‚

```py
df['ds'] = pd.to_datetime(df['ds'])

# Extract year, month and day
df['year'] = df['ds'].dt.year
df['month'] = df['ds'].dt.month
df['day'] = df['ds'].dt.day

# Add a flag for weekend days
df['is_weekend'] = (df['ds'].dt.dayofweek >= 5).astype(int)

# Add lagged values for the past 7 days
for day in range(1, 8):
    df[f'lag_{day}'] = df['y'].shift(day)

# Assign the date to the index
df.index = df['ds']
df = df.drop(['ds'], axis=1)

df.head()
```

![](img/fb9e34451685241862b53446ae0a330b.png)

åŒ…å«å·¥ç¨‹ç‰¹å¾çš„æ•°æ®é›†ã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å­˜åœ¨ç¼ºå¤±å€¼ã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæ•°æ®é›†çš„å‰ä¸ƒä¸ªæ¡ç›®æ²¡æœ‰å®Œæ•´çš„ä¸ƒä¸ªè¿‡å»å€¼åˆ—è¡¨ã€‚

æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸¢å¼ƒå‰ä¸ƒè¡Œæ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªå¯ä»¥åŸç”Ÿå¤„ç†ç¼ºå¤±æ•°æ®çš„æ¨¡å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å†³å®šä½¿ç”¨ä¸€ä¸ª[åŸºäºç›´æ–¹å›¾çš„æ¢¯åº¦æå‡å›å½’å™¨](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.HistGradientBoostingRegressor.html)ï¼Œå®ƒåŸç”Ÿæ”¯æŒç¼ºå¤±å€¼çš„æ•°æ®ã€‚

æœ€åï¼Œæˆ‘ä»¬å°†æ•°æ®æ‹†åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å†³å®šä¸ºæµ‹è¯•é›†ä¿ç•™ 112 ä¸ªæ—¶é—´æ­¥ã€‚

```py
test_size = 4 * 28

X_cols = df.columns.drop(['y'])

split_date = df.index[-test_size]

X_train = df[df.index < split_date][X_cols]
y_train = df[df.index < split_date]['y']

X_test = df[df.index >= split_date][X_cols]
y_test = df[df.index >= split_date]['y']

print(X_train.shape, y_train.shape, X_test.shape, y_test.shape)
```

å¯é€‰åœ°ï¼Œæˆ‘ä»¬å¯ä»¥å¯è§†åŒ–æ•°æ®çš„åˆ†å‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

```py
fig, ax = plt.subplots(figsize=(14, 8))

ax.plot(y_train)
ax.plot(y_test)
ax.set_xlabel('Date')
ax.set_ylabel('Views')

plt.tight_layout()
```

![](img/d05e53bc8728cd7ed0e430053fd2308e.png)

å¯è§†åŒ–è®­ç»ƒ/æµ‹è¯•æ‹†åˆ†ã€‚æœ€å 112 ä¸ªæ—¶é—´æ­¥è¢«ä¿ç•™ä¸ºæµ‹è¯•é›†ã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

## è®­ç»ƒæ¨¡å‹

ä¸€æ—¦æ•°æ®ç»è¿‡é¢„å¤„ç†å’Œåˆ†å‰²ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“æ³¨äºè®­ç»ƒé¢„æµ‹æ¨¡å‹ã€‚

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå®ç°äº†åŸºäºç›´æ–¹å›¾çš„æ¢¯åº¦æå‡å›å½’å™¨ã€‚æˆ‘ä»¬è¿˜é€šè¿‡éšæœºæœç´¢è¿›è¡Œè¶…å‚æ•°è°ƒä¼˜ï¼Œä»¥è·å¾—æœ€ä½³æ¨¡å‹ã€‚

```py
from sklearn.model_selection import RandomizedSearchCV, TimeSeriesSplit

hgbr = HistGradientBoostingRegressor(random_state=42)

params = {
    "learning_rate":  ["squared_error", "absolute_error", "gamma"],
    "learning_rate": [0.1, 0.05, 0.001],
    "max_iter": [100, 150, 200],
    "min_samples_leaf": [1, 2, 3],
}

rand_search_cv = RandomizedSearchCV(
    hgbr,
    param_distributions=params,
    cv=TimeSeriesSplit(n_splits=5),
    scoring="neg_root_mean_squared_error",
    random_state=42,
    n_jobs=-1
)

rand_search_cv.fit(X_train, y_train)

model = rand_search_cv.best_estimator_
```

è¯·æ³¨æ„ï¼Œæœ€ä½³æ¨¡å‹ä¼šä½¿ç”¨`best_estimator_`å±æ€§è¿›è¡Œä¿å­˜ã€‚

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¼˜åŒ–åçš„æ¨¡å‹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ EnbPI æ–¹æ³•æ„å»ºé¢„æµ‹åŒºé—´ã€‚

## ä¼°è®¡é¢„æµ‹åŒºé—´

é¦–å…ˆï¼Œæˆ‘ä»¬è¿›è¡Œè¿™ä¸€æ­¥æ‰€éœ€çš„å¿…è¦å¯¼å…¥ã€‚

```py
from mapie.metrics import regression_coverage_score, regression_mean_width_score
from mapie.subsample import BlockBootstrap
from mapie.regression import MapieTimeSeriesRegressor
```

è¦åº”ç”¨ EnbPI ç®—æ³•ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨`MapieTimeSeriesRegressor`å¯¹è±¡ä¸`BlockBootstrap`ã€‚è¯·è®°ä½ï¼ŒEnbPI åœ¨ä¸é‡å çš„å—ä¸Šæ‹Ÿåˆå›ºå®šæ•°é‡çš„æ¨¡å‹ï¼Œè€Œ`BlockBootstrap`ä¼šä¸ºæˆ‘ä»¬å¤„ç†è¿™ä¸€ç‚¹ã€‚

ç„¶åï¼Œä¸ºäº†è¯„ä¼°æˆ‘ä»¬é¢„æµ‹åŒºé—´çš„è´¨é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨è¦†ç›–ç‡å’Œå¹³å‡å®½åº¦è¯„åˆ†ã€‚è¦†ç›–ç‡æŠ¥å‘Šå®é™…å€¼åœ¨åŒºé—´å†…çš„ç™¾åˆ†æ¯”ã€‚å¹³å‡å®½åº¦è¯„åˆ†åˆ™æŠ¥å‘Šç½®ä¿¡åŒºé—´çš„å¹³å‡å®½åº¦ã€‚

åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—å°½å¯èƒ½ç‹­çª„çš„åŒºé—´ï¼Œä»è€Œå®ç°æœ€é«˜çš„è¦†ç›–ç‡ã€‚

è€ƒè™‘åˆ°è¿™äº›ï¼Œè®©æˆ‘ä»¬å®Œæˆè®¾ç½®ä»¥ç”ŸæˆåŒºé—´ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ 95%çš„ç½®ä¿¡åŒºé—´ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ¨¡å‹å°†å¯¹ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥è¿›è¡Œé¢„æµ‹ã€‚

```py
# For a 95% confidence interval, use alpha=0.05
alpha = 0.05

# Set the horizon to 1
h = 1

cv_mapie_ts = BlockBootstrap(
    n_resamplings=9,
    n_blocks=9,
    overlapping=False,
    random_state=42
)

mapie_enbpi = MapieTimeSeriesRegressor(
    model,
    method='enbpi',
    cv=cv_mapie_ts,
    agg_function='mean',
    n_jobs=-1
)
```

åœ¨ä¸Šé¢çš„ä»£ç å—ä¸­ï¼Œè¯·æ³¨æ„æˆ‘ä»¬ä½¿ç”¨äº†`n_blocks=9`ï¼Œå› ä¸ºè®­ç»ƒé›†å¯ä»¥è¢« 9 æ•´é™¤ã€‚å¦å¤–ï¼Œè¯·ç¡®ä¿è®¾ç½®`overlapping=False`ï¼Œå› ä¸º EnbPI æ–¹æ³•è¦æ±‚å—ä¸èƒ½é‡å ã€‚

ç„¶åï¼Œå°†å›å½’æ¨¡å‹ç®€å•åœ°å°è£…åœ¨`MapieTimeSeriesRegressor`å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œæ‹Ÿåˆå¹¶ç”¨æ¥è¿›è¡Œé¢„æµ‹ã€‚

```py
mapie_enbpi = mapie_enbpi.fit(X_train, y_train)

y_pred, y_pred_int = mapie_enbpi.predict(
    X_test,
    alpha=alpha,
    ensemble=True,
    optimize_beta=True
)
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®æ¨¡å‹çš„é¢„æµ‹ç»“æœå’Œç½®ä¿¡åŒºé—´ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç å—è¿›è¡Œå¯è§†åŒ–ã€‚

```py
fig, ax = plt.subplots(figsize=(14, 8))

ax.plot(y_test, label='Actual')
ax.plot(y_test.index, y_pred, label='Predicted', ls='--')
ax.fill_between(
    y_test.index,
    y_pred_int[:, 0, 0],
    y_pred_int[:, 1, 0],
    color='green',
    alpha=0.2
)
ax.set_xlabel('Date')
ax.set_ylabel('Views')
ax.legend(loc='best')

plt.tight_layout()
```

![](img/a76e4dd6ee638d14360ccd44801151ef.png)

ä½¿ç”¨ EnbPI æ–¹æ³•è¿›è¡Œ 95%ç½®ä¿¡åŒºé—´çš„é¢„æµ‹ã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¨¡å‹æœªèƒ½é¢„æµ‹å‡ºè®¿å®¢çš„å³°å€¼ã€‚ç„¶è€Œï¼Œé¢„æµ‹åŒºé—´ä¼¼ä¹åŒ…å«äº†å¤§å¤šæ•°å®é™…å€¼ã€‚

ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—è¦†ç›–ç‡å’Œå¹³å‡åŒºé—´å®½åº¦ã€‚

```py
coverage = regression_coverage_score(
    y_test, y_pred_int[:, 0, 0], y_pred_int[:, 1, 0]
)
width_interval = regression_mean_width_score(
    y_pred_int[:, 0, 0], y_pred_int[:, 1, 0]
)
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¾—åˆ° 58%çš„è¦†ç›–ç‡å’Œ 432 çš„å¹³å‡åŒºé—´å®½åº¦ã€‚

å†æ¬¡å¼ºè°ƒï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œè¦†ç›–ç‡åº”è¯¥æ¥è¿‘ 95%çš„å€¼ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬ä¹‹å‰è®¾å®šçš„æ¦‚ç‡ã€‚ç„¶è€Œï¼Œç”±äºæ¨¡å‹æ— æ³•é¢„æµ‹è¿™äº›å³°å€¼ï¼Œè¦†ç›–ç‡æ˜¾ç„¶å—åˆ°äº†å½±å“ã€‚

ä¸ºäº†æ½œåœ¨æé«˜è¦†ç›–ç‡ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨éƒ¨åˆ†æ‹Ÿåˆå®ç° EnbPI æ–¹æ³•ï¼Œä»¥ä¾¿éšç€æ–°å€¼çš„è§‚å¯Ÿï¼ŒåŒºé—´å¯ä»¥è‡ªé€‚åº”ã€‚

## åº”ç”¨ EnbPI ä¸éƒ¨åˆ†æ‹Ÿåˆ

æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€å­¦ï¼ŒEnbPI æ–¹æ³•å¯ä»¥ä»æ–°çš„è§‚å¯Ÿå€¼ä¸­å—ç›Šï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ç½®ä¿¡åŒºé—´ã€‚

è¿™å¯ä»¥é€šè¿‡åœ¨æ•°æ®çš„éƒ¨åˆ†ä¸Šæ‹Ÿåˆæ¨¡å‹å¹¶åœ¨æ¯ä¸€æ­¥è®¡ç®—é¢„æµ‹åŒºé—´æ¥æ¨¡æ‹Ÿã€‚

```py
y_pred_pfit = np.zeros(y_pred.shape)
y_pred_int_pfit = np.zeros(y_pred_int.shape)

y_pred_pfit[:h], y_pred_int_pfit[:h, :, :] = mapie_enbpi.predict(X_test.iloc[:h, :],
                                                                 alpha=alpha,
                                                                 ensemble=True,
                                                                 optimize_beta=True)

for step in range(h, len(X_test), h):
    mapie_enbpi.partial_fit(X_test.iloc[(step-h): step, :],
                             y_test.iloc[(step-h):step])

    y_pred_pfit[step:step + h], y_pred_int_pfit[step:step + h, :, :] = mapie_enbpi.predict(X_test.iloc[step:(step+h), :],
                                                                                           alpha=alpha,
                                                                                           ensemble=True,
                                                                                           optimize_beta=True)
```

åœ¨ä¸Šé¢çš„ä»£ç å—ä¸­ï¼Œé€»è¾‘ä¿æŒä¸å˜ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬åªæ˜¯åšä¸€ä¸ª for å¾ªç¯ï¼Œé€æ¸å°†æ¨¡å‹æ‹Ÿåˆåˆ°æ›´å¤šæ•°æ®ä¸Šï¼Œæ¨¡æ‹Ÿæ–°æ•°æ®çš„è§‚æµ‹ï¼Œå¹¶ç”Ÿæˆæ–°çš„é¢„æµ‹ã€‚

åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¯è§†åŒ–é¢„æµ‹åŠå…¶ç½®ä¿¡åŒºé—´ã€‚

```py
fig, ax = plt.subplots(figsize=(14, 8))

ax.plot(y_test, label='Actual')
ax.plot(y_test.index, y_pred_pfit, label='Predicted', ls='--')
ax.fill_between(
    y_test.index,
    y_pred_int_pfit[:, 0, 0],
    y_pred_int_pfit[:, 1, 0],
    color='green',
    alpha=0.2
)
ax.set_xlabel('Date')
ax.set_ylabel('Views')
ax.legend(loc='best')

plt.tight_layout()
```

![](img/c425bbf7fcbdaccee49f1f2030bac12c.png)

ä½¿ç”¨éƒ¨åˆ†æ‹Ÿåˆçš„ç¬¦åˆæ€§é¢„æµ‹åŒºé—´ã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

ä»ä¸Šé¢çš„å›¾ä¸­å¯ä»¥ç›´è§‚åœ°çœ‹å‡ºï¼Œä½¿ç”¨éƒ¨åˆ†æ‹Ÿåˆå¹¶æ²¡æœ‰æ˜¾è‘—çš„å·®å¼‚ã€‚

å› æ­¤ï¼Œè®©æˆ‘ä»¬è®¡ç®—éƒ¨åˆ†æ‹Ÿåˆåè®®çš„è¦†ç›–ç‡å’Œå¹³å‡åŒºé—´å®½åº¦ã€‚

```py
coverage_pfit = regression_coverage_score(
    y_test, y_pred_int_pfit[:, 0, 0], y_pred_int_pfit[:, 1, 0]
)
width_interval_pfit = regression_mean_width_score(
    y_pred_int_pfit[:, 0, 0], y_pred_int_pfit[:, 1, 0]
)
```

è¿™ç»™æˆ‘ä»¬å¸¦æ¥äº† 63%çš„è¦†ç›–ç‡å’Œ 436 çš„å¹³å‡åŒºé—´å®½åº¦ã€‚

![](img/49f74b39cc090af0fd46607d2abdc8f9.png)

æ¯”è¾ƒæ¯ä¸ªåè®®çš„è¦†ç›–ç‡å’Œå¹³å‡åŒºé—´å®½åº¦ã€‚å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨éƒ¨åˆ†æ‹Ÿåˆå…è®¸æˆ‘ä»¬åœ¨ä¿æŒå¹³å‡åŒºé—´å®½åº¦ç›¸å¯¹æ’å®šçš„åŒæ—¶å¢åŠ è¦†ç›–ç‡ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨éƒ¨åˆ†æ‹Ÿåˆæ˜¯æœ‰ä¼˜åŠ¿çš„ã€‚

# ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œç¬¦åˆæ€§é¢„æµ‹æ–¹æ³•ç”¨äºä¼°è®¡é¢„æµ‹çš„ä¸ç¡®å®šæ€§ã€‚è¿™äº›æ–¹æ³•å¯ä»¥åº”ç”¨äºåˆ†ç±»å’Œå›å½’ç®—æ³•ã€‚

åœ¨æ—¶é—´åºåˆ—çš„æƒ…å†µä¸‹ï¼Œé›†æˆé¢„æµ‹åŒºé—´æ–¹æ³•é€šè¿‡åœ¨ä¸é‡å çš„æ•°æ®å—ä¸Šæ‹Ÿåˆå›ºå®šæ•°é‡çš„æ¨¡å‹æ¥è·å¾—æ®‹å·®ï¼Œå¹¶ä»å…¶åˆ†å¸ƒä¸­ä¼°è®¡ç½®ä¿¡ç•Œé™ã€‚

ä¸ºäº†è¯„ä¼°æˆ‘ä»¬åŒºé—´çš„è´¨é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨è¦†ç›–ç‡å’Œå¹³å‡åŒºé—´å®½åº¦ã€‚è¦†ç›–ç‡è¡¨ç¤ºçœŸå®å€¼è½åœ¨åŒºé—´å†…çš„ç™¾åˆ†æ¯”ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼åº”è¯¥æ¥è¿‘ç”¨æˆ·è®¾å®šçš„ç½®ä¿¡åº¦ï¼ŒåŒæ—¶æœ€å°åŒ–åŒºé—´å®½åº¦ã€‚

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œè¿™ç§æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ï¼Œå› ä¸ºå®ƒè¿˜å–å†³äºæ¨¡å‹é¢„æµ‹çš„è´¨é‡ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œæ„Ÿè°¢ MAPIEï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå‡ ä¹ä»»ä½•æ¨¡å‹ç”Ÿæˆç¬¦åˆæ€§é¢„æµ‹åŒºé—´ã€‚

æ„Ÿè°¢é˜…è¯»ï¼å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œå¹¶ä¸”å­¦åˆ°äº†æ–°ä¸œè¥¿ï¼

æƒ³è¦æŒæ¡æ—¶é—´åºåˆ—é¢„æµ‹å—ï¼Ÿé‚£ä¹ˆè¯·æŸ¥çœ‹æˆ‘çš„è¯¾ç¨‹ [Python ä¸­çš„åº”ç”¨æ—¶é—´åºåˆ—é¢„æµ‹](https://www.datasciencewithmarco.com/offers/zTAs2hi6/checkout?coupon_code=ATSFP10)ã€‚è¿™æ˜¯å”¯ä¸€ä¸€é—¨ä½¿ç”¨ Python åœ¨ 16 ä¸ªæŒ‡å¯¼æ€§å®è·µé¡¹ç›®ä¸­å®ç°ç»Ÿè®¡ã€æ·±åº¦å­¦ä¹ å’Œæœ€å…ˆè¿›æ¨¡å‹çš„è¯¾ç¨‹ã€‚

å¹²æ¯ ğŸ»

# æ”¯æŒæˆ‘

å–œæ¬¢æˆ‘çš„å·¥ä½œå—ï¼Ÿé€šè¿‡ [ä¹°æˆ‘ä¸€æ¯å’–å•¡](http://buymeacoffee.com/dswm) æ”¯æŒæˆ‘ï¼Œè¿™æ˜¯ä½ é¼“åŠ±æˆ‘çš„ç®€å•æ–¹å¼ï¼ŒåŒæ—¶æˆ‘å¯ä»¥äº«å—ä¸€æ¯å’–å•¡ï¼å¦‚æœä½ æ„¿æ„ï¼Œåªéœ€ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’® ğŸ‘‡

![](https://www.buymeacoffee.com/dswm)

# å‚è€ƒæ–‡çŒ®

é™ˆæ—­ï¼Œè‚–å§š â€” [æ—¶é—´åºåˆ—çš„ç¬¦åˆæ€§é¢„æµ‹](https://arxiv.org/pdf/2010.09107.pdf)

MAPIE: [å®˜æ–¹æ–‡æ¡£](https://mapie.readthedocs.io/en/latest/)
