# 模拟主题公园：用R理解队列时间

> 原文：[https://towardsdatascience.com/simulating-a-theme-park-understanding-queue-times-with-r-100b12d97cd3?source=collection_archive---------4-----------------------#2023-08-21](https://towardsdatascience.com/simulating-a-theme-park-understanding-queue-times-with-r-100b12d97cd3?source=collection_archive---------4-----------------------#2023-08-21)

## 模拟主题公园以理解队列时间，并学习如何用R优化业务流程。

[](https://medium.com/@josephgeorgelewis2000?source=post_page-----100b12d97cd3--------------------------------)[![Joseph George Lewis](../Images/2d7c47bd9a323dd0f4a6b610e7fb08fd.png)](https://medium.com/@josephgeorgelewis2000?source=post_page-----100b12d97cd3--------------------------------)[](https://towardsdatascience.com/?source=post_page-----100b12d97cd3--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----100b12d97cd3--------------------------------) [Joseph George Lewis](https://medium.com/@josephgeorgelewis2000?source=post_page-----100b12d97cd3--------------------------------)

·

[关注](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2aace34e9883&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimulating-a-theme-park-understanding-queue-times-with-r-100b12d97cd3&user=Joseph+George+Lewis&userId=2aace34e9883&source=post_page-2aace34e9883----100b12d97cd3---------------------post_header-----------) 发表在 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----100b12d97cd3--------------------------------) ·11分钟阅读·2023年8月21日

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F100b12d97cd3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimulating-a-theme-park-understanding-queue-times-with-r-100b12d97cd3&source=-----100b12d97cd3---------------------bookmark_footer-----------)![](../Images/563602d6c9dd4c86d027fb9ad129e321.png)

图片由 [Thomas Kelley](https://unsplash.com/@thkelley?utm_source=medium&utm_medium=referral) 提供，来源于 [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

长时间排队总是让人不快，特别是当你在等待飞向太空或航行大堡礁时。随着暑假继续，我相信几乎每个人都会排队等候，希望你能幸运地直接前往魔法王国。也许你在阅读这个博客时正处于某个队列中！

一些代码用于支持示例，但完整的代码可以在我的GitHub上找到，链接在文章末尾。该项目使用R语言和*simmer*包进行离散事件模拟。请享受！

## 概念回顾——离散事件模拟

那么在我的笔记本电脑上模拟一个主题公园需要什么？它会像《无敌破坏王》中的游戏中心站那样吗？

恐怕不会……用R语言编写的代码将使用离散事件模拟（DES），它实际上展示了一个过程随时间的发展情况。DES的主要用途是优化过程，这也是它在运筹学中常被使用的原因。模拟允许决策者在多次迭代后查看典型过程，并观察如何改进。例如，增加额外的机器是否会减少生产产品的瓶颈？

本文将离散事件模拟应用于一个假设的迪士尼世界。这个版本的公园会简单一些，并且有一些额外的假设以简化建模。

由于这个博客更侧重于应用，因此将有很多代码示例，而非理论，但对所涉及组件的概念回顾应该有助于我们跟上进度。

## 组件

离散事件模拟需要一些基本组件。每个组件都是我们将使用*simmer*创建的，但在编码开始之前，让我们在这里回顾一下：

+   **轨迹**：轨迹是来宾在模拟中将要走的路径。例如，当来宾到达时，他们可能会排队等候游乐设施，乘坐游乐设施后离开。这将是他们的轨迹。

+   **资源**：资源是在轨迹中使用的事物。在上面的示例中，游乐设施就是一个资源。

+   **生成器**：生成器是我们用来生成来宾的工具，生成器通常会在模拟过程中生成许多来宾。生成器还需要一个轨迹来知道生成的来宾应该去哪里。

+   **环境**：环境是整个模拟运行的地方，在我们的案例中就是主题公园本身。它封装了所有资源、生成器和轨迹。使用*simmer*，环境还有一个额外的优点，它将跟踪和报告我们的资源使用情况，使得模拟分析更为简单。

在完成审查后，来动手实践吧！下面的模拟是逐步构建的，复杂性逐渐增加。为了说明问题，代码在最后的模拟中才进行重构，利用了一些额外的R函数和特性来清理模拟。

## 模拟一：遇见莉萝和史迪奇

第一个模拟将作为引言。在这个模拟中，客人到达并开始排队等待见到莉萝和史迪奇。在编码之前，回顾一下组件将会是什么是很有帮助的。

+   **轨迹**：到达公园，排队，使用角色资源（莉萝或史迪奇），释放角色资源并离开公园。

+   **资源**：客人可以遇到的角色。可以是莉萝或史迪奇，因此，这个资源的容量设置为2，这意味着它可以被两个客人同时占用。

+   **生成器**：将定期生成到达公园的客人。

+   **环境**：公园本身。

现在让我们考虑一下每个元素的代码。R语言允许我们利用其他包，如 *dplyr*，来组织我们编写的代码。这使得轨迹构建变得更加简单：

首先，客人占用一个角色，锁定该角色以防其他客人使用。然后，他们在这个资源上超时。超时仅意味着他们不能做其他任何事情。在大多数模拟中，超时时间长度将基于真实过程。然而，在这个虚构的场景中，超时时间长度是从正态分布中取样的。最后，客人释放资源，其他排队的客人可以再次使用它。

轨迹是最复杂的概念。环境、资源和生成器都在一个代码块中一起定义：

这一组组件仍然非常基础。重要的注意事项是，资源的容量为2，符合规格。客人根据指数函数到达，并获得上述定义的轨迹。客人的到达通常也会模拟真实事件，但为了示例的目的，指数函数就足够了！

最后的步骤是运行模拟并进行一些分析。运行模拟非常简单，只需输入 `run` 并提供要运行的时间步数。在这种情况下，公园将开放15小时。对于分析，我们将使用 *simmer.plot*，这是simmer库的一个扩展，用于构建一些简单的可视化图表：

下面的第一个图显示了资源利用率。在此模拟中，我们的利用率仅为20%。这个百分比表示资源在模拟时间中被使用的比例。

![](../Images/893eda34b1511dec2aeebf9ec67a21bb.png)

图片由作者提供

20%的利用率相当低，理想情况下，我们希望有更高的利用率，因为这意味着更多快乐的客人！下一个可视化图表示等待时间，没有客人等待超过5个时间步。这是有道理的，因为我们的资源超时时间基于从正常分布中取样的5步左右。然而，平均等待时间要低得多，由蓝线表示。

![](../Images/11ca144d771872d87a82a17965ba6eff.png)

图片由作者提供

## 模拟二：使用快速通行证遇见莉萝和史迪奇

现在让我们逐步增加一些复杂性。模拟将保持与上述相同。然而，我们将添加优先级顾客。这些顾客将模拟迪士尼乐园的“快速通行”系统。实际上，我们只需生成一个具有优先级的新顾客：

请注意，这位顾客的优先级为1，而默认顾客的优先级为0。较高的优先级值意味着这位顾客将跳过队伍，并在所有低优先级顾客之前乘坐。另一个补充是这些顾客每50个时间步骤到达一次。在现实中，他们会为某个均匀间隔的时间预定一个通行证。

![](../Images/70608c7d4a3c8d70a7f4003f29a8ec67.png)![](../Images/571092c188af444e0c440441b2751bd4.png)

由作者提供的图片

请注意资源利用率已经大幅增加！这是因为现在有一个保证到达的顾客，他们会在固定间隔内优先于所有其他顾客。相反，等待时间也增加了，这也是合乎逻辑的，因为不仅有更多的客人，还有更多的快速通行证顾客，这增加了原始顾客组的等待时间。

## 模拟三：带有违约的会面莉萝与史迪奇

排队等候可能会令人沮丧，人们经常选择放弃。这可以通过违约的概念用数学方法来解释。如果一个顾客在排队等候很长时间，我们可以模拟他们简单放弃的概率。这是通过在轨迹中添加来实现的：

顾客违约所需的时间再次从正态分布中抽样，这次的值约为2（通常情况下，这将被估计为更高，但在这个例子中，我们有非常没有耐心的顾客来帮助理解违约）。重要的是一旦顾客获得了资源，我们必须中止违约。顾客不会在等待期结束时立即离开！

![](../Images/2be7f0d2fb56a6e300f529e89a6452d9.png)![](../Images/13ce11831cac78b4e296d8afdf49e891.png)

由作者提供的图片

这种违约行为最终减少了资源的利用率，因为更多的客人离开了，因此没有使用这些资源。然而，它也减少了等待时间，因为许多客人会放弃，所以他们的等待时间不被计入。客人离开的另一个效果是其他客人经历了更短的排队，这也减少了等待时间。在剩下的模拟中，我们将增加客人违约所需的时间。

## 模拟四：使用批处理的太空山一车游乐设施

现在让我们进入有趣的部分：游乐设施。主题公园中的游乐设施将利用*simmer*中的批处理功能。例如，批处理允许我们将客人分组到一个太空山车厢中：

参数*n*表示可以将多少客人分批到这个组中，所以在这种情况下，每个车厢可以容纳6个客人。*timeout*参数表示一个批次在转到轨迹的下一部分之前应该等待多长时间才能填满。所以，批次可以达到其6人的容量，或者在该批次占用车厢资源之前，可能会经过10个时间步。

![](../Images/b3e8701adcf0b1b910209fdbb3e4e609.png)![](../Images/8abc3bd17fc9a99ee56b3594a4b9b3e5.png)

图片由作者提供

由于这个例子增加了复杂性，并且需要将客人分批处理，或者至少在没有完整批次之前等待适当的时间，资源利用率下降。这些条件还导致了等待时间的问题，这与角色等待时间相比有很大的变化。一个客人可能会立即到达并离开，或者需要等待整整10个时间步才能等到一个新批次离开。为了解决这个问题，在实际应用中会增加车厢的大小或数量。

## 模拟五：具有分支的太空山或飞溅山

让我们让事情变得更加现实；没有任何一个游乐园只靠一个游乐设施是不够的。通过添加像飞溅山这样的新游乐设施，我们可以模拟客人的偏好，并使用分支轨迹来查看他们将选择哪个游乐设施。这有点复杂，在完整脚本中，可以看到轨迹的游乐设施元素已被添加到各自的函数中。为了简化，这里展示了一个更简洁的版本，仅用来演示分支逻辑：

在上述情况下，客人根据掷硬币来选择，因此客人选择太空山或飞溅山的可能性相等。这可以从实际偏好中建模，在更实际的应用中，模拟也会有所变化：

在这个例子中，有两个不同的资源。这与上面提到的《莉萝与史迪奇》的例子不同，因为莉萝和史迪奇都被建模为具有两个容量的“角色”资源。然而，这里飞溅山与太空山相比，是一个独立的资源。

![](../Images/0a811971a80a98f5f83435a05a205f3f.png)![](../Images/f37387b59e5a98be72c3485ad362ddb2.png)

图片由作者提供

这两个游乐设施的利用率差异很大，主要是由于两条轨迹之间的游乐时间差异。乘坐太空山所需的时间更长，客人更有可能取消。增加的复杂性也导致了更为多样的等待时间，但从优化的角度来看，我们成功地通过减少新开设的更快游乐设施的平均等待时间来改善了客人的体验。

## **模拟六：通过时间表和排队偏好来开放公园**

最后的模拟是将我们创建的一切整合起来，并为公园添加一个时间表。到目前为止，我们一直使用固定值来定义资源容量。还有一种替代方法：使用时间表。时间表允许我们根据时间间隔来控制资源的容量。

公园时间表将由一个门控控制，门在50时间步后打开，并在模拟结束前50时间步关闭。下面的代码使用了很多重构的函数，这些函数再次链接在下面的GitHub仓库中。门控时间表是这里最重要的审查内容：

这一次我们的轨迹结合了游乐设施和角色。添加了一些代码，让客人在回合轮换政策中选择他们访问的角色。现在也生成了更多的客人，因为事情变得更多。

![](../Images/4397d3a3e3db5e45183f04662afafc68.png)![](../Images/0cd175c36519fc222f7be8753955fbfb.png)

作者提供的图片

这个模拟看到所有资源的利用率更为现实。顾客有更多的事情可做，因此每个资源的使用时间减少。还有一个额外的规定是顾客必须等待才能进入公园。注意，门的存在导致了大量的利用率减少，但实际使用率很低，因为顾客会立即开启和关闭它。等待时间在这里也达到了峰值，客人们在等待公园开门以及在公园内等候游乐设施时，但这是一个更为现实的模拟。第一批客人一开门就被释放到公园，选择他们想要乘坐的设施和遇见的人。

## 结论和最终想法

离散事件模拟给分析师和决策者提供了探索业务流程的机会。在上面的示例中，复杂性可以从一个客人到达、进行活动并离开，扩展到考虑偏好和人类行为（如失信行为）。

通过这个过程做出的一些决策，比如增加更多的游乐设施，展示了如何利用DES来优化流程。另一方面，增加更复杂的行为，如失信行为，展示了如果资源没有正确设置，可能会被低效利用。

希望你喜欢这篇文章！如果喜欢，请考虑关注我的页面，以获取更多数据科学内容。

## 资源

代码：

[## GitHub - josephlewisjgl/DESR: 存放博客文章《模拟主题公园…》的代码库](https://github.com/josephlewisjgl/DESR?source=post_page-----100b12d97cd3--------------------------------)

### 存放博客文章《模拟主题公园：用R理解排队时间》的代码库 - GitHub …

[github.com](https://github.com/josephlewisjgl/DESR?source=post_page-----100b12d97cd3--------------------------------)

Simmer 文档：

[## 6.1 甜甜圈店 | 模拟与建模以理解变化](https://bookdown.org/manuele_leonelli/SimBook/the-donut-shop.html?source=post_page-----100b12d97cd3--------------------------------)

### 这些是人类学部提供的《模拟与建模以理解变化》模块的讲义……

[bookdown.org](https://bookdown.org/manuele_leonelli/SimBook/the-donut-shop.html?source=post_page-----100b12d97cd3--------------------------------)
