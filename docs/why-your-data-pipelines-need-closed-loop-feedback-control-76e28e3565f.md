# 为什么你的数据管道需要闭环反馈控制

> 原文：[https://towardsdatascience.com/why-your-data-pipelines-need-closed-loop-feedback-control-76e28e3565f?source=collection_archive---------3-----------------------#2023-09-10](https://towardsdatascience.com/why-your-data-pipelines-need-closed-loop-feedback-control-76e28e3565f?source=collection_archive---------3-----------------------#2023-09-10)

## 公司和云的复杂性现实要求新的控制和自主水平，以在规模上实现业务目标

[](https://medium.com/@jeff.b.chou?source=post_page-----76e28e3565f--------------------------------)[![Jeff Chou](../Images/4b5b7a7f880209faf1e81806a0f9dfba.png)](https://medium.com/@jeff.b.chou?source=post_page-----76e28e3565f--------------------------------)[](https://towardsdatascience.com/?source=post_page-----76e28e3565f--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----76e28e3565f--------------------------------) [Jeff Chou](https://medium.com/@jeff.b.chou?source=post_page-----76e28e3565f--------------------------------)

·

[关注](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F124878bdd082&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-your-data-pipelines-need-closed-loop-feedback-control-76e28e3565f&user=Jeff+Chou&userId=124878bdd082&source=post_page-124878bdd082----76e28e3565f---------------------post_header-----------) 发表在[Towards Data Science](https://towardsdatascience.com/?source=post_page-----76e28e3565f--------------------------------) ·9分钟阅读·2023年9月10日[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F76e28e3565f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-your-data-pipelines-need-closed-loop-feedback-control-76e28e3565f&user=Jeff+Chou&userId=124878bdd082&source=-----76e28e3565f---------------------clap_footer-----------)

--

[](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F76e28e3565f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-your-data-pipelines-need-closed-loop-feedback-control-76e28e3565f&source=-----76e28e3565f---------------------bookmark_footer-----------)![](../Images/68dd4aa14a8847d5996f295619aad536.png)

图片由[**Cosmin Paduraru**](https://www.pexels.com/@padurarul/)提供

*随着数据团队在云上规模化，数据平台团队需要确保他们负责的工作负载达到业务目标，* [*这是我们Sync的主要任务*](https://www.synccomputing.com)*。在拥有数十名数据工程师和数百个生产作业的大规模环境下，由于技术和人为因素的种种原因，控制其性能变得不可行。*

今天缺失的环节是建立一个 [闭环反馈系统](https://en.wikipedia.org/wiki/Closed-loop_controller)，它可以自动驱动管道基础设施向业务目标前进。这句话有些冗长，所以让我们深入探讨一下这个问题。

**今天数据平台团队面临的问题**

数据平台团队必须管理从管理层到工程师的基本不同的利益相关者。这两组团队往往有相互对立的目标，平台经理可能会受到双方的挤压。

我们与平台经理和数据工程师的许多实际对话通常是这样的：

> *“我们的CEO希望我降低云成本，并确保我们的服务水平协议得到满足，以保持客户满意。”*

好的，那么问题是什么？

> *“问题是我实际上不能直接更改任何东西，我需要其他人帮助，这就是瓶颈。”*

所以基本上，平台团队在实际实施改进时感到束手无策，面临巨大的摩擦。让我们深入探讨一下原因。

## **是什么阻碍了平台团队？**

+   **数据团队超出了技术范围 —** 调整集群或复杂配置（Databricks、Snowflake）是一项耗时的任务，数据团队更愿意集中精力在实际管道和SQL代码上。许多工程师没有相应的技能、支持结构，甚至不了解他们工作的成本。识别和解决根本原因问题也是一项令人生畏的任务，这阻碍了建立一个功能正常的管道。

+   **过多的抽象层 —** 让我们聚焦于一个堆栈：Databricks运行其自己版本的Apache Spark，该Spark运行在云提供商的虚拟计算上（AWS、Azure、GCP），配有不同的网络选项和不同的存储选项（DBFS、S3、Blob），而且所有这些都可以在一年中的任何时候独立和随机更新。选项的数量令人不堪重负，平台人员难以确保一切都是最新和最优的。

+   **遗留代码 —** 一个不幸的现实就是遗留代码。公司内部的团队往往会发生变化，人来人往，随着时间的推移，任何一个特定工作所需的知识可能会逐渐消失。这种现象使得调整或优化特定工作变得更加困难。

+   **变化令人恐惧 —** 变革本能上是令人害怕的。如果一个生产任务正在进行，我们是否愿意冒险进行调整？老话说得好：“如果它没坏，就不要修。”这种恐惧往往是现实的，如果一个任务不是幂等的或存在其他下游影响，任务失败会带来真正的麻烦。这种心理障碍阻碍了对任务性能的改善尝试。

+   **在规模上，有太多作业 —** 通常平台经理负责监督数百甚至数千个生产作业。未来公司的增长确保这个数字只会增加。鉴于上述所有情况，即使你有一个本地专家，逐个调整作业也是不切实际的。虽然这对少数几个高优先级的作业可能有效，但它使公司的大部分工作负载或多或少被忽视了。

显然，对于数据平台团队来说，要快速提高系统在规模上的效率是一场艰难的战斗。我们相信解决方案在于管道构建方式的范式转变。管道需要一个闭环控制系统，它不断推动管道朝着业务目标前进，而无需人工干预。让我们深入探讨一下。

## **闭环反馈控制对于管道意味着什么？**

当前的管道属于“开环”系统，即作业只是运行而没有任何反馈。为了说明我说的内容，下面的图片展示了“作业1”每天运行，每次运行的成本为$50。假设业务目标是将该作业的成本降至$30。那么，除非有人实际采取行动，否则成本将会在可预见的未来保持在$50，如成本与时间的图表所示。

![](../Images/5afa5613ac0347d3e68e56e2ec2b2ac3.png)

作者提供的图片

如果我们有一个系统，实际反馈作业的输出统计数据，以便第二天的部署可以得到改进，会是什么样的呢？它可能会像这样：

![](../Images/56cb4fb26f7528c2ac4365daf93ad6a6.png)

作者提供的图片

你看到的是一个[经典反馈循环](https://en.wikipedia.org/wiki/Control_loop#Open-loop_and_closed-loop)，在这种情况下，期望的“设定点”是$30的成本。由于这个任务每天运行，我们可以将实际成本的反馈发送到一个“更新配置”模块，该模块接收成本差异（在此例中为$20），从而对“作业1”的配置进行更改。例如，“更新配置”模块可能会减少Databricks集群中的节点数量。

## **这在生产环境中看起来是什么样的？**

实际上，这并不是一蹴而就的。“更新配置”模型现在负责调整基础设施，尝试将成本降低到$30。正如你所想的，随着时间的推移，系统将会改进，并最终达到期望的$30成本，如下图所示。

![](../Images/1c8481d46b6ab156e9f3f1a16d6625d1.png)

作者提供的图片

这一切听起来可能很美好，但你可能会疑惑，“这个神奇的‘更新配置’模块是什么？”这就是问题的关键。这个模块是一个数学模型，它可以输入一个数值目标差异，并输出一个基础设施配置或代码更改。

这不是一件容易的事情，并且会根据目标（例如成本 vs. 运行时间 vs. 利用率）而有所不同。这个模型必须基本预测基础设施变更对业务目标的影响 —— 这并不容易。

## **没有人可以预测未来**

一个微妙的事情是，“更新配置”模型并不是100%准确的。在第四个蓝点中，您实际上可以看到成本在某一点上上升。这是因为模型试图预测一次配置变更将降低成本，但由于没有什么能够100%准确预测，有时它在局部上可能是错误的，因此成本可能在单次运行中上升，而系统正在“训练”。

但是，随着时间的推移，我们可以看到总成本实际上是在下降的。您可以将其视为一个智能的试错过程，因为以100%准确度预测配置变更的影响是完全不可能的。

## **“那么，有什么关系？” — 设定任何目标并行动**

上述方法是一种通用策略，而不仅仅是节省成本。上述的“设定点”只是数据平台人员设定的一个目标。它可以是任何可测量的目标，例如运行时间就是一个很好的例子。

假设我们希望一个工作在1小时（或SLA）内完成。我们可以让上述系统调整配置，直到达到SLA。或者更复杂一点，同时考虑成本和SLA目标？完全没有问题，系统可以优化以达到您在多个参数上的目标。除了成本和运行时间外，其他业务用例目标还包括：

+   **资源利用率：** 独立于成本和运行时间，我是否正确地利用了我的资源？

+   **能源效率：** 我是否尽可能少地消耗资源，以减少碳足迹？

+   **容错性：** 我的工作实际上是否对故障具有弹性？这意味着我是否需要过度规格化它，以防我被抢占，或者以防没有可用的SPOT实例？

+   **可扩展性：** 我的工作是否具备可扩展性？如果输入数据增加10倍，我的工作会崩溃吗？

+   **延迟：** 我的工作是否达到了延迟目标？响应时间目标？

理论上，一个数据平台的人只需设定目标，然后一个自动系统可以迭代地改进基础设施，直到达到目标。没有人参与其中，没有工程师需要上手。平台团队只需设定他们从利益相关者那里收到的目标。听起来像是一个梦想。

到目前为止，我们一直比较抽象。让我们深入探讨一些具体的使用案例，希望能够引起人们的兴趣：

## **示例功能 #1：按业务目标对作业进行分组**

假设您是一个数据平台经理，负责监督数百个生产作业的运行。目前，它们都有自己的成本和运行时间。下面的简单图表显示了一个卡通示例，基本上所有作业都随机分布在成本和运行时间图表上。

如果你想在大规模上降低成本怎么办？如果你想一次性改变许多作业的运行时间（或SLA）怎么办？现在，你可能得请求工程师帮助你修改所有作业（祝好运）。

![](../Images/64ae8b41dd93b68a2d7171661a4fce0e.png)

作者提供的图片

现在假设你对所有作业实施了上述闭环控制系统。你只需设定作业的高级业务目标（在此案例中为SLA运行时间要求），反馈控制系统将尽力找到实现这些目标的基础设施。最终状态将是这样的：

![](../Images/5b18e5f4f29997498e0f77b64bfe4b77.png)

作者提供的图片

在这里，我们看到每个作业的颜色代表了不同的业务目标，依据SLA定义。幕后闭环反馈控制系统改变了集群/仓库的大小、各种配置，甚至调整了整个管道，以尽可能低的成本达到SLA运行时间目标。通常，较长的作业运行时间会导致更低的成本机会。

## **示例功能 #2：自愈作业**

大多数数据平台的工作人员可以确认，他们的数据管道总是在变化。两个非常流行的场景是：数据规模随时间增长和代码变更。这两者都会导致成本和运行时间出现不稳定的行为。

以下插图展示了基本概念。我们从左到右走一遍示例：

+   **开始：** 假设你有一个作业，并且随着时间的推移数据规模增长。通常情况下，你的集群保持不变，因此成本和运行时间都会增加。

+   **开始反馈：** 随着时间的推移，运行时间接近SLA要求，反馈控制系统在绿色箭头处介入。此时，控制系统会调整集群，以保持在红色虚线下，同时最小化成本。

+   **代码变更：** 在某个时点，开发者推送了一个新的代码更新，导致成本和运行时间的激增。反馈控制系统介入，并调整集群以更好地适应新的代码变更。

![](../Images/b629a0c1e46d551d765d95cabbfe864a.png)

作者提供的图片

希望这两个示例说明了闭环控制管道的潜在好处。当然，实际上还有许多细节被省略了，一些设计原则公司必须遵循。

一个重要的方面是配置能够在出现问题时恢复到之前的状态。此时，一个幂等的管道将非常理想，以防需要许多迭代。

## **结论**

数据管道是复杂的系统，像其他复杂系统一样，它们需要反馈和控制来确保稳定的性能。这不仅有助于解决技术或业务问题，还能显著释放数据平台和工程团队的精力，使他们能专注于实际构建管道。

正如我们之前提到的，这在很大程度上依赖于“更新配置”模块的性能。这是反馈循环成功所需的关键情报。构建这个模块并非易事，也是目前主要的技术障碍。它可以是一个算法或机器学习模型，并利用历史数据。这是我们过去几年中一直在致力于的主要技术组件。

在我们下一篇文章中，我们将展示该系统在 Databricks Jobs 中的实际应用，让你相信我们讨论的内容是真实的！

*对了解更多关于 Databricks 流水线的闭环控制感兴趣？请联系* [*Jeff Chou*](https://www.linkedin.com/in/jeffchoumit/) *和其他* [*Sync Team*](https://synccomputing.com/)*成员。*

## 相关内容

+   [Databricks 的 Photon 和 Graviton 实例值得投资吗？](https://synccomputing.com/databricks-photon-and-graviton-instances-worth-it/)

+   [Databricks 的自动扩展是否具备成本效益？](https://synccomputing.com/is-databrickss-autoscaling-cost-efficient/)

+   [介绍 Gradient — 简化 Databricks 优化](https://synccomputing.com/introducing-gradient-for-databricks/)
