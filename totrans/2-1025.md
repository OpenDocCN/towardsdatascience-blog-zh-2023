# 使用 Delta 表处理缓慢变化的维度（SCD）

> 原文：[https://towardsdatascience.com/handling-slowly-changing-dimensions-scd-using-delta-tables-511122022e45](https://towardsdatascience.com/handling-slowly-changing-dimensions-scd-using-delta-tables-511122022e45)

## 使用 Delta 框架处理缓慢变化维度的挑战

[](https://mkukreja1.medium.com/?source=post_page-----511122022e45--------------------------------)[![Manoj Kukreja](../Images/de7c954b505e9749bad47975a3bee80b.png)](https://mkukreja1.medium.com/?source=post_page-----511122022e45--------------------------------)[](https://towardsdatascience.com/?source=post_page-----511122022e45--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----511122022e45--------------------------------) [Manoj Kukreja](https://mkukreja1.medium.com/?source=post_page-----511122022e45--------------------------------)

·发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----511122022e45--------------------------------) ·10 分钟阅读·2023 年 1 月 23 日

--

长期以来，Kimball 方法一直是维度数据建模技术的标准。根据 Kimball 的说法“*时间的概念渗透到数据仓库的每一个角落*”。在数据分析的背景下，这意味着什么？从高层次来看，现代分析可以被视为随着时间的推移对不断变化的数据的聚合。问题在于，不断变化的数据不仅包括新的添加，还包括对以前数据集的更改。

整体维度数据建模将数据分为两大类：

**事实** — 这些数据表示*无限*的数据集，存储实体的测量信息。它包含对定量分析和决策制定至关重要的数据。事实表通常具有与其他表（维度）连接的列，以供参考。

**维度** — 这些数据表示相对*有限*的数据集，提供关于在事实表中进行的测量的描述性信息。与事实表相比，维度的变化速度要慢得多。这就是为什么它们通常被称为“*缓慢变化的维度*”。

Kimball 的方法涉及基于事实和维度创建星型模式。由于其非规范化的结构，星型模式非常适合分析用例……不需要复杂的连接条件。因此，多年来，星型模式一直是传统数据仓库建模的事实标准。

![](../Images/45cbf90d8239b735cbe35fd12a284f26.png)

图片由作者提供

多年来，数据处理人员面临着处理缓慢变化维度的挑战，同时保持其之前的历史记录并保留与事实表的关系参考。Kimball 方法提出了几种有效处理缓慢变化维度的方法。现实情况是，一旦选择了特定的 SCD 方法，在数据仓库中实施它相对容易。对 SQL 和 ACID 事务的支持使其处理起来变得简单。

不幸的是，在数据湖中实现相同的操作是另一回事。有几个原因：

+   第一个问题是 **不变性**。根据最佳实践，数据湖中的数据不应更改。

+   其次，多年来在数据湖中无法进行原子写入。这意味着即使你只做了小的编辑，也需要重写整个表。

[Delta Lake](https://delta.io/) 框架解决了上述问题。对 ACID（原子性、一致性、隔离性和持久性）事务的支持现在使得在数据湖中实现 SCD 与在数据仓库中一样轻松。在本文中，我们将学习如何使用 Delta Lake 框架实施处理缓慢变化维度的最常见方法。

下面是一个示例案例：

> “一家公司希望跟踪*客户*维度随时间发生的变化。他们要求数据工程团队提供几种替代方案。经过仔细考虑，数据工程提出了三种管理缓慢变化维度的选项：SCD 类型 1、SCD 类型 2 和 SCD 类型 3。”

在我们深入探讨每个选项之前，让我们尝试理解客户维度的数据结构。在本文中，我们将使用下面的示例数据集。下面的数据集显示了一些示例客户记录。为了说明处理缓慢变化维度的不同选项，我们将重点关注用红色框标出的客户记录（客户名称 = **Magee Cash**）。

![](../Images/5a48e735e13b0ac803dd6c6eed69f3a0.png)

作者提供的图片

**Magee Cash** 最近更改了她的地址。更改记录以 [CDC](https://en.wikipedia.org/wiki/Change_data_capture) 记录的形式传送到 **OLAP** 系统。在数据工程的背景下，CDC 过程旨在从源头捕获增量数据集，并将其合并到企业数据湖中。以下是 **Magee Cash** 的更改记录，注意地址与上述原始记录不同。

![](../Images/141265ab2660807488168394b0d3205a.png)

作者提供的图片

Delta Lake 的核心能力使其成为构建现代数据[湖仓架构](http://cidrdb.org/cidr2021/papers/cidr2021_paper17.pdf)的极其合适的平台。在湖仓架构中，[Delta Lake](https://delta.io/) 可用于将变更记录合并到公共数据层（银层）。一旦创建，银层就会作为分析工作负载的基础数据层，包括 BI、数据科学、机器学习和人工智能。因此，银层通常被称为“***单一事实来源***”。

让我们回到本文的核心目标。现在我们对数据集有了清晰的理解，我们可以开始探索第一个 SCD 方法。

# SCD 类型 1

这种类型通常被称为“**覆盖**”方法。在这种方法中，任何对维度数据的更改都会用相同键的先前数据状态进行覆盖。虽然这种方法实现起来非常简单，但它有一个主要缺点。由于覆盖机制，你不仅会丢失维度的先前历史记录，还会丢失它所附加的事实表的状态。下图展示了使用 SCD 类型 1 方法的客户维度的前后图像。

![](../Images/90ae4c316b621475e5fbad8b223f609c.png)

图片由作者提供

请注意，新的住址是**覆盖**了之前的地址，之前地址的历史记录丢失了。在维度发生变化时，失去历史记录的后果可能非常严重。如果事实表的聚合受到维度变化的影响，那么没有历史记录的情况下，很难追溯聚合值变化的原因。

我们现在将学习如何使用 Delta 框架实现 SCD 类型 1。从使用湖仓的铜层原始客户数据集创建银层客户维度表（***customer_silver_scd1***）开始。

![](../Images/29c1bb1a22abeabbe1eec76fd294a781.png)

图片由作者提供

使用**Magee Cash**的变更记录创建一个新的数据框架。

![](../Images/52c45cf45a3a01ca1fd3d156f63a2182.png)

图片由作者提供

最后，将地址变更记录合并到***customer_silver_scd1***银层维度表中。

![](../Images/ac5d4cdc744e6321809167fb1e2e0145.png)

图片由作者提供

在对银层维度表执行查询后，你会注意到地址变更已经覆盖了其先前的状态。问题在于，这条记录的先前状态无法找到。

> 考虑一种情况，**Magee Cash**可能使用旧版本的地址下了电子商务订单。产品尚未发货，但地址在此期间已发生变化。那么，产品应该发往哪里？旧地址还是新地址？

![](../Images/88debfaef69f487c6818021ed1a496b8.png)

图片由作者提供

让我向你介绍Delta Lake框架中一个非常有用的功能。Delta Lake维护了更改的时间顺序历史，包括插入、更新和删除。在上面的示例中，**版本 0**的表是在创建***customer_silver_scd1***银层表时生成的。同样，**版本 1**的表是在我们为地址变更记录执行数据合并时创建的。此外，Delta Lake表可以轻松恢复到任何所需的先前版本。

![](../Images/71516c5b7bc2be675a12b3b06f87e7bf.png)

图片由作者提供

由于上述缺陷，现代数据平台中很少使用SCD 类型 1。因此，我们需要一种更好的方法，能够在进行维度更改时保留**先前**的引用以供活动使用。总的来说，如果你的计算*不*关心数据的先前状态或其可能引发的后果，可以简单地使用SCD 类型 1。

# SCD 类型 2

也称为“**添加新记录**”方法。在这种方法中，更改记录作为新记录添加到维度表中，并标记为“***当前***”或“***活动***”。此外，记录的先前版本被标记为“***过期***”或“***非活动***”。记录的不同版本（当前和历史）通过**替代**键关联起来。在表级别，SCD 类型 2通过为维度表中的每一行添加***开始日期***和*结束日期*时间戳列来实现。此外，添加了一个***状态***列，以标记记录的***当前***或***过期***状态。下面展示了使用SCD 类型 2方法的客户维度的前后图像。

![](../Images/f3dbf275b0967c450b5eebddc4621901.png)

图片由作者提供

我们现在将学习如何使用delta框架实现SCD 类型 2。从使用Lakehouse原始客户数据集创建银层客户维度表（***customer_silver_scd2***）开始。

![](../Images/33e8e077d10805e83380e4cff16acb64.png)

图片由作者提供

现在将地址更改记录合并到***customer_silver_scd2***银层维度表中。

![](../Images/94a3136f35d0ea6bc27baca37a8c69f6.png)

图片由作者提供

请注意，之前的记录被标记为***过期***，并且更新了***结束日期***。同时，插入了一条新记录，包含最新地址，其***开始日期***与之前记录的***结束日期***相同。使用这种方法，**Magee Cash**将确保她的电子商务订单被送到正确的地址。

![](../Images/308f0c07589a5670279b6a626b53c94c.png)

图片由作者提供

使用SCD 类型 2方法，你可以按时间顺序跟踪更改历史，并以时间顺序的方式维护对事实表的引用。我必须承认，与SCD 类型 1相比，这种实现有些复杂。

> 作为一个警告，维护维度表的应用程序需要以这样的方式编码，即将带有*当前*版本的新记录和先前版本的*过期*合并为一个事务。此外，所有针对维度表的查询都需要过滤*status=**Current***。

还有一种更简单的替代方案，我们进一步探讨另一种方法，这在某些方面仅仅是 SCD 类型 1 方法的扩展。

# SCD 类型 3

也称为“**添加新字段**”方法。对于每次更改，先前版本和当前版本作为两个不同的列存储在同一行的维度表中。与 SCD 类型 2 相比，SCD 类型 3 相对更易于实现，历史记录仅包括当前和先前的版本。

![](../Images/9efd1f5832c6277db80b8de34b01f534.png)

作者提供的图片

我们现在将学习如何使用 Delta 框架实现 SCD 类型 3。首先使用湖库中铜层的原始客户数据集创建银层客户维度表 (***customer_silver_scd3***)。

![](../Images/14b74ad31ac2a4047f3e779dc4de5f9d.png)

作者提供的图片

请注意，维度表中的每一列都维护**当前**和**先前**状态。在创建维度表时，列的当前状态填充了最新的数据，而列的先前状态则留空。

现在将地址变更记录合并到***customer_silver_scd3***银层维度表中。

![](../Images/6324b016844ac3dc76823465ed0edb90.png)

作者提供的图片

继续查看在 Delta Lake 合并后记录的状态。

![](../Images/f8ff0e04eb9e23642b3228d1930f206e.png)

作者提供的图片

请注意，***address*** 字段现在已填充了更改后的记录，地址的先前版本已移动到 ***previous_address*** 字段。同样，***modifieddate*** 字段已更新以维护更改的时间顺序。

由于仅有有限的历史记录可用，SCD 类型 3 的使用案例略显有限。但实现的简便性使其具有一定的吸引力。如果您厌恶 SCD 类型 1 的局限性，并且发现 SCD 类型 2 难以实现和管理，那么这是一个不错的折衷方案。

本文中使用的所有代码可以在下面的链接中找到：

[](https://github.com/mkukreja1/blogs/tree/master/scd?source=post_page-----511122022e45--------------------------------) [## blogs/scd at master · mkukreja1/blogs

### 目前无法执行该操作。您在另一个标签页或窗口中已登录。您在另一个标签页或…

[github.com](https://github.com/mkukreja1/blogs/tree/master/scd?source=post_page-----511122022e45--------------------------------)

在许多方面，SCD 类型 2 通常被认为是实施缓慢变化维度的主要技术。需要明确的是，SCD 的主要目标不是存储记录的历史，而是保持与事实表的准确关联。此外，在许多方面，缓慢变化维度要求你更新记录，这在一般情况下与数据湖/仓库的不可变性原则相悖。然而，像 Delta Lake 这样的框架的新进展使得以**简单**和**轻松**的方式实现 SCD 场景成为可能。

希望这篇文章对你有帮助。**SCD** 作为 [Datafence Cloud Academy](http://www.datafence.com) 提供的 AWS 大数据分析课程的一部分进行了讲解。课程由我在周末在线授课。
