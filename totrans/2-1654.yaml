- en: Pivot away from spreadsheets
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/pivot-away-from-spreadsheets-e2c1639f4e2b](https://towardsdatascience.com/pivot-away-from-spreadsheets-e2c1639f4e2b)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Excel isn’t the only pivot table joint in town
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://bradley-stephen-shaw.medium.com/?source=post_page-----e2c1639f4e2b--------------------------------)[![Bradley
    Stephen Shaw](../Images/b3ef5e6e292083ff0f8523ec5ffe89f0.png)](https://bradley-stephen-shaw.medium.com/?source=post_page-----e2c1639f4e2b--------------------------------)[](https://towardsdatascience.com/?source=post_page-----e2c1639f4e2b--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----e2c1639f4e2b--------------------------------)
    [Bradley Stephen Shaw](https://bradley-stephen-shaw.medium.com/?source=post_page-----e2c1639f4e2b--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----e2c1639f4e2b--------------------------------)
    ·8 min read·Apr 13, 2023
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
- en: --
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/25b9c5f30107ac892acc25c53fe0b677.png)'
  id: totrans-6
  prefs: []
  type: TYPE_IMG
- en: Photo by [DDP](https://unsplash.com/fr/@moino007?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: '“But pivot tables!”: a common response from many Excel fans on hearing me sing
    the praises of `pandas` (and the inevitable suggestion that they forget about
    spreadsheets for data analysis).'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: The belief that pivot tables are the sole property of spreadsheets is probably
    holding many people back from fully transitioning to using Python for data analysis.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: 'Of course, this isn’t true at all — as we’ll see today as we dive into:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Basic pivot tables in `pandas`
  id: totrans-11
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Using bespoke functions and calculated fields in pivot tables
  id: totrans-12
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let’s get cracking — we’ll start by simulating some data.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: The data
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We’ll start by simulating some data. Nothing too strenuous here as we simulate
    some sales data about two different products:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '… which gives:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/21d8af9703d06969508bb365069b6f9f.png)'
  id: totrans-18
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: That looks fair enough. Let’s start with the basics of a pivot table.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: Basic pivot tables
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The premise behind a pivot table is quite simple: some quantity is tabulated
    (or calculated) across various segments of data. The results of this can be represented
    in a table, where the value in the appropriate row and column intersection is
    the segment result.'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: As an example, let’s take a look at the total number of quotes per store per
    product.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: 'In Excel, we’d probably create the pivot table query as follows:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/2d3163a40f029c4ab9ba9fda0ee3869e.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: '… and that would give us a basic table which looks something like this:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/0be95a06dccdead8ffe63629b5873314.png)'
  id: totrans-28
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: Blank entries here indicate that there is no data for a specific segment — e.g.
    there were no quotes in the Central store for product C.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: 'This is quite straightforward to replicate in `pandas` , using the `pivot_table`¹
    function:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The output is presented slightly differently, with the missing data more prominent:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/93460d0b752c770656e003ce726ceaf9.png)'
  id: totrans-34
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
- en: Let’s take a look at the code in more detail.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: The `index` , `columns` , and `values` arguments are analogous to the “Columns”,
    “Rows” and “Values” fields in the Excel pivot table query. That is, the columns
    that we provide to `index` will form the **rows** of our pivot table. Likewise,
    the columns we provide through `columns` will form the **columns** in our pivot
    table. And last but not least, whatever we provide via `values` will be the quantities
    which we calculate and tabulate and will populate the table **cells**.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: Slightly different is how we define the function to be applied to the tabulated
    data. In Excel, we’d normally click through each quantity in the “Values” pane,
    choosing an appropriate function from the “Values Field Settings” window.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/f5dbc7224c4cf6f8f527518cb0b817cf.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: In Python, it’s a bit simpler, as we can just refer to functions by their names
    (more on this later).
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: 'What about extending the table to cover more quantities? If, for instance,
    we wanted to calculate the minimum number of quotes and sales for each product
    and store combination, this would do:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '![](../Images/8cfd0dd0d5de8677f8c37a999f72c25f.png)'
  id: totrans-44
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: Ah, but something looks different here — we’ve included statistics for each
    row and column (and named it “Combined”). That’s easily achieved as `margins`
    controls whether or not to include these totals, and `margins_name` allows us
    to give a meaningful name to these table entries.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: Bespoke functions and calculated fields
  id: totrans-47
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'A lot of analysis — including exploratory analysis — can be done using the
    same simple functions: sums, averages, minimums, maximums (standard deviations
    and variances at a push). These functions are so ubiquitous that they are built
    into `pandas` and we can refer to them by name in our call to `pivot_table` .'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: However there are instances where we might need to use a custom function. For
    instance, calculating the coefficient of variation is by no means a “standard”
    function but we can get to it quite easily by first defining what it is, and then
    feeding it into the pivot table call via `aggfunc` .
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'gives:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/d53150afd2fbcf4ec8dbdd80acb7163d.png)'
  id: totrans-52
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: One of the more useful features of an Excel pivot table is the ability to create
    what’s called a calculated field — a field in the pivot table which is derived
    from other fields in the pivot table. The `pandas` implementation of the pivot
    table can still provide these but it takes a little more work, and a return to
    first principles.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: 'As a working example, let’s imagine we are interested in the conversion rate
    of each product across each store. This is quite simple mathematically:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: Calculate the total number of actual sales (“Numbers” in our data) for each
    product and store.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Calculate the total number of sales quotes (“Quotes”) for each product and store.
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The conversion rate is then (1) / (2).
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To get this as a pivot table, we code this as follows:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'which yields:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/d426f97aae837ea6080a6ff3d2870713.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: Of course, this is fine as a standalone exhibit but for completeness we can
    also join this back to a pivot table containing the “raw” figures too.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: Tips and tricks
  id: totrans-65
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As a bonus, a few tips and tricks before we wrap up.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: Getting creative with custom functions
  id: totrans-67
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We talked a little about using bespoke functions. I demonstrated a case where
    we needed a custom function for the analysis, but you can use custom functions
    in more creative ways.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: 'As an example, let’s use the built in `sum` function to calculate total quotes
    and sales. Something like this, say:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/0becca8ad8a39ab1ec613dcc6e209a68.png)'
  id: totrans-70
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: Now, as much as I believe in function before form, I don’t like the way that
    the “sum” is floating around as a pseudo-title. If I was to present this table,
    I would consider writing a new function with a name appropriate for presentation
    — e.g. “Total” — which does the exact same thing as `sum` but gives a more descriptive
    table result.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: 'So define the new function and pass it in:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'gives us:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/a405df1d3c0d83d6d5015da9306d52fb.png)'
  id: totrans-76
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: And whilst the table isn’t exactly presentation-ready, it does look better.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: Formatting pivot tables
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'I used the p-word quite a bit there: oftentimes, simple pivot tables make their
    way into slide packs.'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: Before we do that, we might want to do a bit of formatting to the table — perhaps
    treat the missing values in an appropriate fashion and make the numbers easier
    to read.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: 'That’s quite simple to do with some DataFrame styling. Here’s one I made earlier:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/0afa4369e95ed36310998e65496f369c.png)'
  id: totrans-83
  prefs: []
  type: TYPE_IMG
- en: Image by author
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: That’s done by adding a little `.style.format(’{:,.0f}’,na_rep=’-’)` to the
    end of the call to `pivot_table` .
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: 'There’s tons of customisation available for the presentation of a DataFrame.
    So much so that I’ve actually written an article about it:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '[](/make-your-tables-look-glorious-2a5ddbfcc0e5?source=post_page-----e2c1639f4e2b--------------------------------)
    [## Make Your Tables Look Glorious'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: Simple formatting tricks to make your pandas DataFrames presentation-ready
  id: totrans-88
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/make-your-tables-look-glorious-2a5ddbfcc0e5?source=post_page-----e2c1639f4e2b--------------------------------)
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: Wrapping up
  id: totrans-90
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We’ve covered a fair bit of ground quite quickly. We’ve gone through the basics
    of pivot tables in `pandas` , stretched our arm at using bespoke functions, and
    taken a swing at a worked example of a calculated field.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: Before we call it a day, a few thoughts.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: Excel still has a few things going for it. One is the familiarity; no matter
    how simple, trying something completely new can be challenging.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: Two is the ease-of-use that click and drag actions give users — there’s simply
    none of that in Python.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 用户使用的**点击和拖拽操作**是一个优势——在 Python 中没有这样的操作。
- en: 'However, the advantage of clicking and dragging can be outweighed in the long
    term if the action has to be repeated many times over: converting the actions
    into hard code will save time and effort.'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，如果这个操作必须重复多次，点击和拖拽的优势可能会在长期内被抵消：将这些操作转化为硬编码会节省时间和精力。
- en: Yes, this can be done in VBA or by recording a macro, but let’s be honest —
    no matter how big and helpful the VBA community is, it’s still a difficult (and
    not very popular) language to learn.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 是的，这可以通过 VBA 或录制宏来完成，但说实话——无论 VBA 社区多么庞大和有帮助，它仍然是一个难以学习（且不太受欢迎）的语言。
- en: There are also more subtle functions and actions that Excel does better than
    `pandas` . I’m not saying that you can’t do these in `pandas` , but Excel can
    make your life a little easier when you’re handling dates, filtering pivot tables
    and creating calculated fields.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: Excel 在某些更微妙的功能和操作方面比 `pandas` 更为出色。我不是说在 `pandas` 中无法做到这些，但当你处理日期、过滤数据透视表和创建计算字段时，Excel
    可以让你的生活变得更轻松。
- en: If you find yourself repeatedly creating the same pivot table on a regular basis,
    maybe you should consider switching over to Python. I have, and I haven’t looked
    back — in this case, the grass really is greener on this side.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你发现自己经常重复创建相同的数据透视表，也许你应该考虑转向 Python。我已经这样做了，并且没有回头——在这种情况下，草地真的更绿。
- en: If you’ve made it this far — **thank you for reading!** If you’ve enjoyed my
    ramblings and would like more, take a look at my other stories. I write about
    all sorts of things from [charts and graphs](https://medium.com/towards-data-science/make-your-charts-look-glorious-9ce3fa310b70)
    to [neural networks](https://medium.com/towards-data-science/lets-do-neural-networks-d849d80fd012).
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你读到了这里——**感谢你的阅读！** 如果你喜欢我的闲谈并希望查看更多内容，请查看我的其他故事。我写的内容涵盖了从[图表和图形](https://medium.com/towards-data-science/make-your-charts-look-glorious-9ce3fa310b70)到[神经网络](https://medium.com/towards-data-science/lets-do-neural-networks-d849d80fd012)的各种主题。
- en: References and resources
  id: totrans-100
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参考资料
- en: '[pandas.pivot_table — pandas 2.0.0 documentation (pydata.org)](https://pandas.pydata.org/docs/reference/api/pandas.pivot_table.html)'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[pandas.pivot_table — pandas 2.0.0 文档 (pydata.org)](https://pandas.pydata.org/docs/reference/api/pandas.pivot_table.html)'
- en: '[Coefficient of variation — Wikipedia](https://en.wikipedia.org/wiki/Coefficient_of_variation)'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[变异系数 — 维基百科](https://en.wikipedia.org/wiki/Coefficient_of_variation)'
