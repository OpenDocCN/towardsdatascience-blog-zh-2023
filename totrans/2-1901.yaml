- en: SQL Riddles to Test Your Wits
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æµ‹è¯•ä½ çš„æ™ºæ…§çš„ SQL è°œé¢˜
- en: åŸæ–‡ï¼š[https://towardsdatascience.com/sql-riddles-to-test-your-wits-8ce31202ae7f](https://towardsdatascience.com/sql-riddles-to-test-your-wits-8ce31202ae7f)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸæ–‡ï¼š[https://towardsdatascience.com/sql-riddles-to-test-your-wits-8ce31202ae7f](https://towardsdatascience.com/sql-riddles-to-test-your-wits-8ce31202ae7f)
- en: Timestamps, dependent filters, and misbehaving left joins
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æ—¶é—´æˆ³ã€ä¾èµ–è¿‡æ»¤å™¨å’Œè¡¨ç°å¼‚å¸¸çš„å·¦è¿æ¥
- en: '[](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)[![Matt
    Sosna](../Images/c3175c0dc62b795a8d0fa57532fb669b.png)](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)[](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)
    [Matt Sosna](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)[![Matt
    Sosna](../Images/c3175c0dc62b795a8d0fa57532fb669b.png)](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)[](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)
    [Matt Sosna](https://mgsosna.medium.com/?source=post_page-----8ce31202ae7f--------------------------------)'
- en: Â·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)
    Â·8 min readÂ·Feb 22, 2023
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: Â·å‘å¸ƒäº [Towards Data Science](https://towardsdatascience.com/?source=post_page-----8ce31202ae7f--------------------------------)
    Â·é˜…è¯»æ—¶é•¿ 8 åˆ†é’ŸÂ·2023å¹´2æœˆ22æ—¥
- en: --
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: '![](../Images/e1fc7bf3a6b50e65020f31e0892a018c.png)'
  id: totrans-6
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/e1fc7bf3a6b50e65020f31e0892a018c.png)'
- en: Photo by [Saffu](https://unsplash.com/@saffu?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾ç‰‡ç”± [Saffu](https://unsplash.com/@saffu?utm_source=medium&utm_medium=referral)
    æä¾›ï¼Œæ¥æºäº [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
- en: SQL is a deceptively simple language. Across its many dialects, users can query
    databases in a syntax similar to English. **What you see is what you getâ€¦ until
    you donâ€™t.**
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: SQL æ˜¯ä¸€ç§çœ‹ä¼¼ç®€å•çš„è¯­è¨€ã€‚é€šè¿‡å…¶å¤šç§æ–¹è¨€ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç±»ä¼¼è‹±è¯­çš„è¯­æ³•æŸ¥è¯¢æ•°æ®åº“ã€‚**ä½ çœ‹åˆ°çš„å°±æ˜¯ä½ å¾—åˆ°çš„â€¦â€¦ç›´åˆ°ä½ å‘ç°ä¸æ˜¯ã€‚**
- en: Every now and then I come across a query that produces a result completely different
    from what I expected, teaching me little nuances about the language. Iâ€™ve compiled
    three recent head-scratchers in this post, and Iâ€™ve arranged them as riddles to
    make them more interesting. Try to figure out the answer before reading the end
    of each section!
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘æ—¶ä¸æ—¶ä¼šé‡åˆ°ä¸€äº›æŸ¥è¯¢ï¼Œå®ƒä»¬çš„ç»“æœä¸æˆ‘é¢„æœŸçš„å®Œå…¨ä¸åŒï¼Œè¿™æ•™ä¼šäº†æˆ‘ä¸€äº›è¯­è¨€ä¸­çš„ç»†å¾®å·®åˆ«ã€‚æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­æ±‡ç¼–äº†ä¸‰ä¸ªæœ€è¿‘çš„éš¾é¢˜ï¼Œå¹¶å°†å®ƒä»¬ä»¥è°œé¢˜çš„å½¢å¼æ’åˆ—ï¼Œä½¿å…¶æ›´æœ‰è¶£ã€‚å°è¯•åœ¨é˜…è¯»æ¯ä¸ªéƒ¨åˆ†çš„ç»“å°¾ä¹‹å‰æ‰¾å‡ºç­”æ¡ˆï¼
- en: Iâ€™ve also included quick [**common table expressions (CTEs)**](https://learnsql.com/blog/what-is-common-table-expression/)
    to generate the tables in each example, so you donâ€™t need to try querying your
    companyâ€™s production tables! But to get really comfortable with SQL, I actually
    recommend creating your own database and tables to play with. Check out [this
    post](https://medium.com/towards-data-science/intermediate-sql-for-everyone-fe35c541147a)
    to learn how.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘è¿˜åŒ…å«äº†å¿«é€Ÿçš„ [**å…¬å…±è¡¨è¡¨è¾¾å¼ï¼ˆCTEsï¼‰**](https://learnsql.com/blog/what-is-common-table-expression/)
    æ¥ç”Ÿæˆæ¯ä¸ªç¤ºä¾‹ä¸­çš„è¡¨æ ¼ï¼Œå› æ­¤ä½ ä¸éœ€è¦å°è¯•æŸ¥è¯¢ä½ å…¬å¸çš„ç”Ÿäº§è¡¨æ ¼ï¼ä½†è¦çœŸæ­£ç†Ÿç»ƒæŒæ¡ SQLï¼Œæˆ‘å®é™…ä¸Šå»ºè®®ä½ åˆ›å»ºè‡ªå·±çš„æ•°æ®åº“å’Œè¡¨æ ¼è¿›è¡Œç»ƒä¹ ã€‚æŸ¥çœ‹ [è¿™ç¯‡æ–‡ç« ](https://medium.com/towards-data-science/intermediate-sql-for-everyone-fe35c541147a)
    äº†è§£å¦‚ä½•æ“ä½œã€‚
- en: Note that all queries are in Postgres â€” you may get different results in a different
    dialect. Finally, an obligatory note that the actual data and topics in each query
    are just illustrative examples. ğŸ™‚
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: è¯·æ³¨æ„ï¼Œæ‰€æœ‰æŸ¥è¯¢å‡ä¸º Postgres è¯­æ³• â€”â€” åœ¨å…¶ä»–æ–¹è¨€ä¸­ä½ å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœã€‚æœ€åï¼Œå¿…é¡»è¯´æ˜çš„æ˜¯ï¼Œæ¯ä¸ªæŸ¥è¯¢ä¸­çš„å®é™…æ•°æ®å’Œä¸»é¢˜ä»…ä¸ºç¤ºä¾‹ã€‚ ğŸ™‚
- en: '![](../Images/a6561e629797d06859c10d601195dcd0.png)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a6561e629797d06859c10d601195dcd0.png)'
- en: Photo by [Akram Huseyn](https://unsplash.com/@akramhuseyn?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾ç‰‡ç”± [Akram Huseyn](https://unsplash.com/@akramhuseyn?utm_source=medium&utm_medium=referral)
    æä¾›ï¼Œæ¥æºäº [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
- en: 'Riddle 1: Timestamp Specificity'
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: è°œé¢˜ 1ï¼šæ—¶é—´æˆ³çš„å…·ä½“æ€§
- en: 'Imagine we have a table called `purchases` with purchase IDs, amounts, and
    times the purchase were made. Letâ€™s say it looks like this:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º `purchases` çš„è¡¨ï¼Œå…¶ä¸­åŒ…å«è´­ä¹° IDã€é‡‘é¢ä»¥åŠè´­ä¹°æ—¶é—´ã€‚å‡è®¾å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
- en: '![](../Images/e841213f41d988b969e1bf43b3a2f006.png)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/e841213f41d988b969e1bf43b3a2f006.png)'
- en: Image by author
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾ç‰‡ç”±ä½œè€…æä¾›
- en: As a CTE, this would look something like this. Note that we need to specify
    that the `dt` column is a timestamp so it isnâ€™t interpreted as a string. We also
    only need to specify the data types for one of the rows; the rest are inferred.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œä¸ºCTEï¼Œå®ƒå¤§è‡´çœ‹èµ·æ¥åƒè¿™æ ·ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®š`dt`åˆ—æ˜¯æ—¶é—´æˆ³ï¼Œä»¥å…è¢«è§£é‡Šä¸ºå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬åªéœ€è¦ä¸ºå…¶ä¸­ä¸€è¡ŒæŒ‡å®šæ•°æ®ç±»å‹ï¼›å…¶ä½™çš„ä¼šè¢«æ¨æ–­ã€‚
- en: '[PRE0]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Now letâ€™s calculate the sum of purchases made on Feb 15\. We can write a query
    like the one below:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨è®©æˆ‘ä»¬è®¡ç®—2æœˆ15æ—¥çš„è´­ä¹°æ€»é¢ã€‚æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå¦‚ä¸‹çš„æŸ¥è¯¢ï¼š
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We mysteriously receive the following response.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç¥ç§˜åœ°æ”¶åˆ°ä»¥ä¸‹å“åº”ã€‚
- en: '![](../Images/f08b7fac27108cd6b6875f91a1d0851e.png)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/f08b7fac27108cd6b6875f91a1d0851e.png)'
- en: Image by author
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: 'What happened? There were three purchases made on Feb 15: IDs 1, 2, and 3\.
    The sum should therefore be $26.97\. Instead, only the first purchase was counted.'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ2æœˆ15æ—¥æœ‰ä¸‰ç¬”è´­ä¹°ï¼šID 1ã€2å’Œ3ã€‚æ€»å’Œåº”è¯¥æ˜¯$26.97ã€‚ç„¶è€Œï¼Œåªè®¡ç®—äº†ç¬¬ä¸€ç¬”è´­ä¹°ã€‚
- en: Hint
  id: totrans-26
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æç¤º
- en: If you change the filter to `2023-02-16`, no rows are returned.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ å°†è¿‡æ»¤å™¨æ›´æ”¹ä¸º`2023-02-16`ï¼Œåˆ™æ²¡æœ‰è¡Œè¿”å›ã€‚
- en: Answer
  id: totrans-28
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç­”æ¡ˆ
- en: The `dt` column format is a timestamp that includes both date and time. Our
    `WHERE` filter only specifies the date. Rather than rejecting this query, Postgres
    automatically reformats the date string to `2023-02-15 00:00:00`. This matches
    only the first transaction in the table, so weâ€™re therefore taking only the sum
    of one row.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: '`dt`åˆ—æ ¼å¼æ˜¯åŒ…å«æ—¥æœŸå’Œæ—¶é—´çš„æ—¶é—´æˆ³ã€‚æˆ‘ä»¬çš„`WHERE`è¿‡æ»¤å™¨åªæŒ‡å®šäº†æ—¥æœŸã€‚Postgresä¸ä¼šæ‹’ç»æ­¤æŸ¥è¯¢ï¼Œè€Œæ˜¯è‡ªåŠ¨å°†æ—¥æœŸå­—ç¬¦ä¸²é‡æ–°æ ¼å¼åŒ–ä¸º`2023-02-15
    00:00:00`ã€‚è¿™ä»…åŒ¹é…è¡¨ä¸­çš„ç¬¬ä¸€ç¬”äº¤æ˜“ï¼Œå› æ­¤æˆ‘ä»¬åªè®¡ç®—äº†ä¸€è¡Œçš„æ€»å’Œã€‚'
- en: If we wanted to select all rows corresponding to Feb 15, we should first cast
    the timestamp to date.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæˆ‘ä»¬æƒ³é€‰æ‹©å¯¹åº”äº2æœˆ15æ—¥çš„æ‰€æœ‰è¡Œï¼Œæˆ‘ä»¬åº”è¯¥é¦–å…ˆå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸã€‚
- en: '[PRE2]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: We now get the expected result.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç°åœ¨å¾—åˆ°äº†é¢„æœŸçš„ç»“æœã€‚
- en: '![](../Images/277c9dfd7a79e6c3539c7dcc37eb6ea4.png)'
  id: totrans-33
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/277c9dfd7a79e6c3539c7dcc37eb6ea4.png)'
- en: Image by author
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: '![](../Images/1bcdb45db73942c600750ed2a31e8721.png)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/1bcdb45db73942c600750ed2a31e8721.png)'
- en: Photo by [Womanizer Toys](https://unsplash.com/es/@womanizer?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: ç…§ç‰‡ç”±[Womanizer Toys](https://unsplash.com/es/@womanizer?utm_source=medium&utm_medium=referral)æä¾›ï¼Œæ¥æºäº[Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
- en: 'Riddle 2: Dependent vs. independent filters'
  id: totrans-37
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: è°œé¢˜ 2ï¼šä¾èµ–è¿‡æ»¤å™¨ä¸ç‹¬ç«‹è¿‡æ»¤å™¨
- en: Alright, next riddle. We have a table called `users`, and our goal is to **remove
    all rows that meet *any one* of three conditions.** In the table below, for example,
    letâ€™s say that we want to only return tenured and active users, i.e., ones who
    *have* logged in during the last 28 days, *have* posted before, and are *not*
    a new account.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: å¥½çš„ï¼Œä¸‹ä¸€ä¸ªè°œé¢˜ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º`users`çš„è¡¨ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯**åˆ é™¤ç¬¦åˆ*ä»»æ„ä¸€ä¸ª*ä¸‰ç§æ¡ä»¶çš„æ‰€æœ‰è¡Œ**ã€‚åœ¨ä¸‹è¡¨ä¸­ï¼Œä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬åªæƒ³è¿”å›æœ‰èŒä½å¹¶ä¸”æ´»è·ƒçš„ç”¨æˆ·ï¼Œå³é‚£äº›*åœ¨è¿‡å»28å¤©å†…*ç™»å½•è¿‡ï¼Œ*æ›¾ç»*å‘è¿‡å¸–ï¼Œå¹¶ä¸”*ä¸æ˜¯*æ–°è´¦æˆ·ã€‚
- en: '![](../Images/b300a25500f94c581ecc23ad3a84da85.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/b300a25500f94c581ecc23ad3a84da85.png)'
- en: Image by author
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: In other words, we want our query to only user 8, who has False values for `no_login_l28`,
    `has_never_posted`, and `is_new_account`.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„æŸ¥è¯¢ä»…ä½¿ç”¨8å·ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·åœ¨`no_login_l28`ã€`has_never_posted`å’Œ`is_new_account`ä¸Šéƒ½æœ‰Falseå€¼ã€‚
- en: Letâ€™s start with the top of our query.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬ä»æŸ¥è¯¢çš„é¡¶éƒ¨å¼€å§‹ã€‚
- en: '[PRE3]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: How should we structure the `WHERE` clause of our query? Think for a minute
    â€“ **we need to be careful not to return rows where *any* of the columns is** `**False**`**.**
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ„å»ºæŸ¥è¯¢çš„`WHERE`å­å¥ï¼Ÿè€ƒè™‘ä¸€ä¸‹â€”â€”**æˆ‘ä»¬éœ€è¦å°å¿ƒä¸è¦è¿”å›*ä»»ä½•*åˆ—ä¸º** `**False**`**çš„è¡Œ**ã€‚
- en: When youâ€™re ready, take a look at the options below. **Two are correct and two
    are wrong.**
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: å½“ä½ å‡†å¤‡å¥½æ—¶ï¼ŒæŸ¥çœ‹ä¸‹é¢çš„é€‰é¡¹ã€‚**ä¸¤ä¸ªæ˜¯æ­£ç¡®çš„ï¼Œä¸¤ä¸ªæ˜¯é”™è¯¯çš„ã€‚**
- en: '**Option 1: Multiple** `**AND NOT**`'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 1ï¼šå¤šä¸ª** `**AND NOT**`'
- en: '[PRE4]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '**Option 2: Multiple** `**OR NOT**`'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 2ï¼šå¤šä¸ª** `**OR NOT**`'
- en: '[PRE5]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '**Option 3:** `**NOT**` **+ grouped** `**OR**`'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 3ï¼š** `**NOT**` **+ åˆ†ç»„** `**OR**`'
- en: '[PRE6]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '**Option 4:** `**NOT**` **+ grouped** `**AND**`'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 4ï¼š** `**NOT**` **+ åˆ†ç»„** `**AND**`'
- en: '[PRE7]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Hint
  id: totrans-54
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æç¤º
- en: When are conditions in a filter evaluated separately versus together? If theyâ€™re
    evaluated together, can we condense all conditions down to one `True` or `False`
    value?
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: æ¡ä»¶åœ¨è¿‡æ»¤å™¨ä¸­æ˜¯åˆ†åˆ«è¯„ä¼°è¿˜æ˜¯ä¸€èµ·è¯„ä¼°ï¼Ÿå¦‚æœå®ƒä»¬ä¸€èµ·è¯„ä¼°ï¼Œæˆ‘ä»¬èƒ½å¦å°†æ‰€æœ‰æ¡ä»¶æµ“ç¼©ä¸ºä¸€ä¸ª`True`æˆ–`False`å€¼ï¼Ÿ
- en: Answer
  id: totrans-56
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç­”æ¡ˆ
- en: '**Option 1.** This one tripped me up a bit. A data scientist on my team submitted
    a PR with this filter, which I was convinced would pull in rows 2â€“7 because the
    query would only remove users with `False` values for all three columns. But to
    my surprise, Option 1 actually works **because the three filters are evaluated
    independently.** âœ…'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 1.** è¿™ä¸ªè®©æˆ‘æœ‰ç‚¹å›°æƒ‘ã€‚æˆ‘çš„å›¢é˜Ÿä¸­çš„ä¸€ä½æ•°æ®ç§‘å­¦å®¶æäº¤äº†ä¸€ä¸ªåŒ…å«è¿™ä¸ªè¿‡æ»¤å™¨çš„ PRï¼Œæˆ‘ç¡®ä¿¡å®ƒä¼šæå–è¡Œ 2â€“7ï¼Œå› ä¸ºæŸ¥è¯¢åªä¼šç§»é™¤æ‰€æœ‰ä¸‰ä¸ªåˆ—çš„å€¼ä¸º
    `False` çš„ç”¨æˆ·ã€‚ä½†ä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼Œé€‰é¡¹ 1 å®é™…ä¸Šæœ‰æ•ˆ **å› ä¸ºä¸‰ä¸ªè¿‡æ»¤å™¨æ˜¯ç‹¬ç«‹è¯„ä¼°çš„ã€‚** âœ…'
- en: '**Option 2.** This was the filter I initially thought was correct, since I
    didnâ€™t realize the filters would be evaluated independently. But this filter will
    actually return users 2â€“8, since anyone who has at least one `True` for `no_login_l28`,
    `has_never_posted`, and `is_new_account` will be allowed through. âŒ'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 2.** è¿™æ˜¯æˆ‘æœ€åˆè®¤ä¸ºæ­£ç¡®çš„è¿‡æ»¤å™¨ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰æ„è¯†åˆ°è¿™äº›è¿‡æ»¤å™¨ä¼šè¢«ç‹¬ç«‹è¯„ä¼°ã€‚ä½†å®é™…ä¸Šè¿™ä¸ªè¿‡æ»¤å™¨ä¼šè¿”å›ç”¨æˆ· 2â€“8ï¼Œå› ä¸ºä»»ä½•åœ¨ `no_login_l28`ã€`has_never_posted`
    å’Œ `is_new_account` ä¸­è‡³å°‘æœ‰ä¸€ä¸ª `True` çš„ç”¨æˆ·éƒ½ä¼šè¢«å…è®¸é€šè¿‡ã€‚ âŒ'
- en: '**Option 3.** This was how I initially thought the filter needed to be worded.
    If a user has `True` for *any* of `no_login_l28`, `has_never_posted`, or `is_new_account`,
    then lines 3-5 evaluate to `True`, the `NOT` flips this to `False`, and those
    rows are ultimately excluded. This indeed works, and I find this easier to understand
    than Option 1, but both are valid. âœ…'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 3.** è¿™æ˜¯æˆ‘æœ€åˆè®¤ä¸ºè¿‡æ»¤å™¨éœ€è¦è¿™æ ·è¡¨è¾¾çš„æ–¹å¼ã€‚å¦‚æœç”¨æˆ·åœ¨ `no_login_l28`ã€`has_never_posted` æˆ– `is_new_account`
    ä¸­æœ‰ *ä»»ä½•* ä¸€ä¸ª `True`ï¼Œé‚£ä¹ˆç¬¬ 3 è¡Œåˆ°ç¬¬ 5 è¡Œè¯„ä¼°ä¸º `True`ï¼Œ`NOT` å°†å…¶ç¿»è½¬ä¸º `False`ï¼Œè¿™äº›è¡Œæœ€ç»ˆä¼šè¢«æ’é™¤ã€‚è¿™ç¡®å®æœ‰æ•ˆï¼Œæˆ‘å‘ç°è¿™æ¯”é€‰é¡¹
    1 æ›´å®¹æ˜“ç†è§£ï¼Œä½†ä¸¤è€…éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ âœ…'
- en: '**Option 4.** This returns the same incorrect result as Option 2\. Lines 3â€“5
    evaluate to `True` only for user 1, meaning that when we flip the boolean with
    `NOT`, all remaining users are pulled through. âŒ'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '**é€‰é¡¹ 4.** è¿™ä¼šè¿”å›ä¸é€‰é¡¹ 2 ç›¸åŒçš„é”™è¯¯ç»“æœã€‚ç¬¬ 3 è¡Œåˆ°ç¬¬ 5 è¡Œä»…å¯¹ç”¨æˆ· 1 è¯„ä¼°ä¸º `True`ï¼Œè¿™æ„å‘³ç€å½“æˆ‘ä»¬ç”¨ `NOT` å–åæ—¶ï¼Œæ‰€æœ‰å‰©ä½™ç”¨æˆ·éƒ½ä¼šè¢«æå–å‡ºæ¥ã€‚
    âŒ'
- en: '![](../Images/0cf6fb60d6ba852509c672abe8c1bed8.png)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/0cf6fb60d6ba852509c672abe8c1bed8.png)'
- en: Photo by [Nick Fewings](https://unsplash.com/@jannerboy62?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: '[Nick Fewings](https://unsplash.com/@jannerboy62?utm_source=medium&utm_medium=referral)
    åœ¨ [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡'
- en: 'Riddle 3: Left joins acting like inner joins'
  id: totrans-63
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: è°œé¢˜ 3ï¼šå·¦è¿æ¥åƒå†…è¿æ¥ä¸€æ ·å·¥ä½œ
- en: Take a look at the query below. We have two tables, `customers` and `reviews`.
    `customers` contains customer IDs and their lifetime dollars spent on the platform.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: çœ‹ä¸€ä¸‹ä¸‹é¢çš„æŸ¥è¯¢ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¡¨ï¼Œ`customers` å’Œ `reviews`ã€‚`customers` åŒ…å«å®¢æˆ· ID åŠå…¶åœ¨å¹³å°ä¸ŠèŠ±è´¹çš„ç»ˆèº«é‡‘é¢ã€‚
- en: '![](../Images/a85750c1c18e374de1a3ddd382f83bb6.png)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a85750c1c18e374de1a3ddd382f83bb6.png)'
- en: Image by author
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: '`reviews` contains information about reviews left by customers: the review
    ID, customer ID, and whether the review was reported as spam.'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: '`reviews` åŒ…å«å®¢æˆ·ç•™ä¸‹çš„è¯„è®ºä¿¡æ¯ï¼šè¯„è®º IDã€å®¢æˆ· ID å’Œè¯„è®ºæ˜¯å¦è¢«æŠ¥å‘Šä¸ºåƒåœ¾è¯„è®ºã€‚'
- en: '![](../Images/a0d8514acf7b406b7693089521e1ddda.png)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a0d8514acf7b406b7693089521e1ddda.png)'
- en: Image by author
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: 'Hereâ€™s the subquery to generate the two CTEs:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ˜¯ç”Ÿæˆä¸¤ä¸ª CTE çš„å­æŸ¥è¯¢ï¼š
- en: '[PRE8]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Now letâ€™s say weâ€™re curious about the relationship between a customerâ€™s total
    spend and the number of non-spam reviews they write. Since not each customer has
    left a review, weâ€™ll want to left join `reviews` to `customers`. We can structure
    our query like this:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨å‡è®¾æˆ‘ä»¬å¯¹å®¢æˆ·çš„æ€»æ¶ˆè´¹ä¸ä»–ä»¬å†™çš„éåƒåœ¾è¯„è®ºæ•°é‡ä¹‹é—´çš„å…³ç³»æ„Ÿåˆ°å¥½å¥‡ã€‚ç”±äºä¸æ˜¯æ¯ä¸ªå®¢æˆ·éƒ½ç•™ä¸‹äº†è¯„è®ºï¼Œæˆ‘ä»¬å¸Œæœ›å°† `reviews` å·¦è¿æ¥åˆ° `customers`ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·æ„å»ºæˆ‘ä»¬çš„æŸ¥è¯¢ï¼š
- en: '[PRE9]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Ready? Hereâ€™s what comes out.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: å‡†å¤‡å¥½äº†å—ï¼Ÿçœ‹çœ‹ç»“æœå§ã€‚
- en: '![](../Images/23213b592479c359fab0bb3cb77f951d.png)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/23213b592479c359fab0bb3cb77f951d.png)'
- en: Image by author
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾ç‰‡
- en: Wait a minute. Where did users 200, 300, and 400 go? Why were they removed,
    and how can we bring them back in?
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: ç­‰ä¸€ä¸‹ã€‚ç”¨æˆ· 200ã€300 å’Œ 400 å»å“ªé‡Œäº†ï¼Ÿä¸ºä»€ä¹ˆå®ƒä»¬è¢«ç§»é™¤äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆèƒ½æŠŠå®ƒä»¬æ‰¾å›æ¥å‘¢ï¼Ÿ
- en: Hint
  id: totrans-78
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æç¤º
- en: If you create a CTE for `reviews` with spam reviews filtered out, *then* join
    on this CTE, do we get the same result?
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ åˆ›å»ºä¸€ä¸ªè¿‡æ»¤æ‰åƒåœ¾è¯„è®ºçš„ `reviews` CTEï¼Œç„¶ååœ¨è¿™ä¸ª CTE ä¸Šè¿›è¡Œè¿æ¥ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœå—ï¼Ÿ
- en: Answer
  id: totrans-80
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç­”æ¡ˆ
- en: Looking closely, we can see that users 200 and 300 have never left any reviews.
    400 only has spam reviews, but they were completely removed as well. Since we
    did a left join, these users should still be in the table and have a 0 for `n_reviews`.
    Instead, our left join [behaved like an inner join](https://trevorscode.com/why-is-my-left-join-behaving-like-an-inner-join-and-filtering-out-all-the-right-side-rows/).
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: ä»”ç»†æŸ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”¨æˆ· 200 å’Œ 300 ä»æœªç•™ä¸‹ä»»ä½•è¯„è®ºã€‚400 åªæœ‰åƒåœ¾è¯„è®ºï¼Œä½†å®ƒä»¬ä¹Ÿè¢«å®Œå…¨ç§»é™¤ã€‚ç”±äºæˆ‘ä»¬è¿›è¡Œäº†å·¦è¿æ¥ï¼Œè¿™äº›ç”¨æˆ·ä»åº”å­˜åœ¨äºè¡¨ä¸­ï¼Œå¹¶ä¸”
    `n_reviews` åº”ä¸º 0ã€‚ç›¸åï¼Œæˆ‘ä»¬çš„å·¦è¿æ¥ [è¡¨ç°å¾—åƒå†…è¿æ¥](https://trevorscode.com/why-is-my-left-join-behaving-like-an-inner-join-and-filtering-out-all-the-right-side-rows/)ã€‚
- en: The issue, it turns out, is that `**WHERE**` **clauses are evaluated *after*
    joins.** Our left join brings in null values for `reported_as_spam` for users
    200 and 300\. The `WHERE` filter then removes all rows where `reported_as_spam`
    is True, which removes user 400\. However, this filter also removes null values,
    so users 200 and 300 are also removed.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: é—®é¢˜æ˜¯ï¼Œ`**WHERE**` **å­å¥æ˜¯åœ¨è¿æ¥æ“ä½œ*ä¹‹å*è¿›è¡Œè¯„ä¼°çš„**ã€‚æˆ‘ä»¬çš„å·¦è¿æ¥å¸¦æ¥äº†ç”¨æˆ·200å’Œ300çš„`reported_as_spam`çš„ç©ºå€¼ã€‚ç„¶åï¼Œ`WHERE`è¿‡æ»¤å™¨ç§»é™¤æ‰€æœ‰`reported_as_spam`ä¸ºTrueçš„è¡Œï¼Œè¿™æ ·ç”¨æˆ·400å°±è¢«ç§»é™¤ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¹Ÿä¼šç§»é™¤ç©ºå€¼ï¼Œå› æ­¤ç”¨æˆ·200å’Œ300ä¹Ÿè¢«ç§»é™¤ã€‚
- en: To do this properly, we need to pre-filter `reviews` before joining with `customers`.
    As the hint states, we can create a CTE for `reviews` and perform the filtering
    there. But more efficiently, [letâ€™s perform the filtering *within* the join](https://mode.com/sql-tutorial/sql-joins-where-vs-on/).
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†æ­£ç¡®å®Œæˆè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸`customers`è¿æ¥ä¹‹å‰é¢„å…ˆè¿‡æ»¤`reviews`ã€‚æ­£å¦‚æç¤ºæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º`reviews`åˆ›å»ºä¸€ä¸ªCTEï¼Œå¹¶åœ¨é‚£é‡Œè¿›è¡Œè¿‡æ»¤ã€‚ä½†æ›´æœ‰æ•ˆçš„æ˜¯ï¼Œ[æˆ‘ä»¬å¯ä»¥åœ¨è¿æ¥*å†…éƒ¨*è¿›è¡Œè¿‡æ»¤](https://mode.com/sql-tutorial/sql-joins-where-vs-on/)ã€‚
- en: 'We can do this by adding `AND NOT r.reported_as_spam` to the `LEFT JOIN` block.
    See below:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨`LEFT JOIN`å—ä¸­æ·»åŠ `AND NOT r.reported_as_spam`æ¥å®ç°ã€‚è§ä¸‹æ–‡ï¼š
- en: '[PRE10]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Now we get the expected result.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†é¢„æœŸçš„ç»“æœã€‚
- en: '![](../Images/5ded0c2dd29a48a3a2fa22f53527f5eb.png)'
  id: totrans-87
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/5ded0c2dd29a48a3a2fa22f53527f5eb.png)'
- en: Image by author
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„å›¾åƒ
- en: '![](../Images/26ff34d90559419122b8dd79bb8cf443.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/26ff34d90559419122b8dd79bb8cf443.png)'
- en: Photo by [Laura Chouette](https://unsplash.com/@laurachouette?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±[Laura Chouette](https://unsplash.com/@laurachouette?utm_source=medium&utm_medium=referral)æ‹æ‘„ï¼Œæ¥æºäº[Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
- en: Conclusions
  id: totrans-91
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç»“è®º
- en: 'This post shared three SQL wrinkles that can lead to unexpected results: timestamp
    specificity, dependent versus independent filters, and left joins acting like
    inner joins. I specifically provided simple examples to keep the focus on the
    syntax, but youâ€™ll likely encounter SQL nuances like these nestled within large,
    complex queries.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æ–‡åˆ†äº«äº†ä¸‰ç§å¯èƒ½å¯¼è‡´æ„å¤–ç»“æœçš„SQLéš¾ç‚¹ï¼šæ—¶é—´æˆ³çš„å…·ä½“æ€§ã€ä¾èµ–æ€§ä¸ç‹¬ç«‹æ€§è¿‡æ»¤å™¨ï¼Œä»¥åŠå·¦è¿æ¥è¡¨ç°å¾—åƒå†…è¿æ¥ã€‚æˆ‘ç‰¹åˆ«æä¾›äº†ç®€å•çš„ç¤ºä¾‹ï¼Œä»¥ä¿æŒå¯¹è¯­æ³•çš„å…³æ³¨ï¼Œä½†ä½ å¯èƒ½ä¼šåœ¨å¤§å‹å¤æ‚æŸ¥è¯¢ä¸­é‡åˆ°ç±»ä¼¼çš„SQLç»†å¾®å·®åˆ«ã€‚
- en: These bugs can be incredibly challenging to identify, especially for queries
    with many components. Whenever Iâ€™m confused by a result, I try to break the query
    into its pieces and verify each componentâ€™s result. But when in doubt, write some
    simple CTEs with test data and confirm the results do what you expect.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›é”™è¯¯å¯èƒ½éå¸¸éš¾ä»¥è¯†åˆ«ï¼Œå°¤å…¶æ˜¯å¯¹äºåŒ…å«å¤šä¸ªç»„ä»¶çš„æŸ¥è¯¢ã€‚å½“æˆ‘å¯¹ç»“æœæ„Ÿåˆ°å›°æƒ‘æ—¶ï¼Œæˆ‘ä¼šå°è¯•å°†æŸ¥è¯¢æ‹†åˆ†æˆå„ä¸ªéƒ¨åˆ†ï¼Œå¹¶éªŒè¯æ¯ä¸ªç»„ä»¶çš„ç»“æœã€‚ä½†æ˜¯å¦‚æœæœ‰ç–‘é—®ï¼Œå†™ä¸€äº›ç®€å•çš„CTEå¹¶ç”¨æµ‹è¯•æ•°æ®è¿›è¡ŒéªŒè¯ï¼Œç¡®è®¤ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚
- en: Happy querying!
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: ç¥æŸ¥è¯¢æ„‰å¿«ï¼
- en: Matt
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: Matt
