["```py\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(tidybayes)\nlibrary(readxl)\ndf <- read_excel(\"DestinationData2022.xlsx\", \n    sheet = \"SCHOOL PUBLICATION TABLE 2022\", \n    skip = 3)\ncolnames(df) <- c('vcaa_code', 'school_name', 'sector', 'locality', 'total_completed_year12', 'on_track_consenters', 'respondants', 'bachelors', 'deferred', 'tafe', 'apprentice_trainee', 'employed', 'looking_for_work', 'other') \n\ndf <- drop_na(df)\n\ndf2 <- df |> \n  mutate(across(5:14, ~ as.numeric(.x)), #convert all numeric fields captured as characters\n         across(8:14, ~ .x/100 * respondants), #calculate counts from proportions\n         across(8:14, ~ round(.x, 0)), #round to whole integers\n         respondants = bachelors + deferred + tafe + apprentice_trainee + employed + looking_for_work + other, #recalculate total respondents\n         filter(sector != 'A') #remove A schools (low volume)\n\ndf_long <- df2 |>\n  select(sector, school_name, 7:14) |> \n  pivot_longer(c(-1, -2, -3), names_to = 'outcome', values_to = 'proportion') |> \n  mutate(proportion = proportion/respondants)\n\nprofile <- read_excel(\"school-profile-2022.xlsx\", \n    sheet = \"SchoolProfile 2022\") |> #From ACARA\n  filter(State == 'VIC' & `School Type` %in% c('Secondary', 'Combined')) |> \n  select(`School Sector`, `School Name`, ICSEA, `ICSEA Percentile`) |> \n  drop_na() |> \n  mutate(`School Sector` = substr(`School Sector`, 1, 1),\n         ICSEA_s = ((ICSEA - min(ICSEA-1)) / (max(ICSEA+1) - min(ICSEA-1))))\n\ncolnames(profile) <- c('sector', 'school_name', 'ICSEA', 'Percentile', 'ICSEA_s', 'percentile_d', 'percentile_c')\n\ndf_longb <-\n  df_long |> \n  mutate(school_name = str_to_upper(school_name)) |> \n  left_join(profile |> mutate(school_name = str_to_upper(school_name))) |> \n  drop_na()\n```", "```py\nprofile |> \n  ggplot(aes(y = sector, x = ICSEA, fill = sector)) +\n    stat_halfeye(alpha = 0.5) +\n    theme_ggdist() +\n    scale_fill_viridis_d(begin = 0.4, end = 0.8) +\n    labs(title = 'Distribution of ICSEA Values By Sector', y = 'Sector')\n```", "```py\nm4e <- \n  brm(bf(ICSEA_s ~ sector + 0,\n         phi ~ sector + 0),\n      family = Beta,\n      data = profile,\n      prior = c(prior(normal(-1, 2), class = 'b'),\n                prior(gamma(6, 2), class = b, dpar = phi, lb = 1)),\n      seed = 246, warmup = 1000, iter = 6000, cores = 4, chains = 4, save_pars = save_pars(all = T)) |> \n  add_criterion(c('waic', 'loo'), moment_match = T)\n\nsummary(m4e)\n```", "```py\nalt_df <- profile |> \n  select(sector, ICSEA) |> \n  mutate(y = 'y', \n         draw = 99)\n\nsim_df <- tibble(sector = c('C', 'I', 'G')) |> \n  add_predicted_draws(m4e, ndraws = 1200, seed = 246) |> #generates 1200 posterior draws for each sector\n  mutate(ICSEA = (.prediction * (1211 - 808) + 808)) |> #rescale ICSEA back\n  ungroup() |> \n  mutate(y = 'y_rep',\n         draw = rep(seq(from = 1, to = 20, length.out = 20), times = 180)) |> #draws \n  select(sector, ICSEA, draw, y) |> \n  bind_rows(alt_df)\n\nsim_df |> \n  ggplot(aes(ICSEA, group = draw)) +\n    geom_density(aes(color = y)) +\n    facet_grid(~ sector) +\n    scale_color_manual(name = '', \n                       values = c('y' = \"darkblue\",\n                                  'y_rep' = \"grey\")) +\n    theme_ggdist() +\n    labs(y = 'Density', x = 'y', title = 'Distribution of Observed and Replicated Proportions by Sector', subtitle = 'Model = m4e - Non-Pooled Phi')\n```", "```py\nnew_df <- tibble(sector = c('I', 'G', 'C'))\n\nepred_draws(m4d, newdata = new_df) |> \n  mutate(ICSEA = .epred * (1211 - 808) + 808) |> \n  compare_levels(ICSEA, by = sector, comparison = rlang::exprs(C - G, I - G, C - I)) |> \n    mutate(sector = fct_inorder(sector),\n         sector = fct_shift(sector, -1), \n         sector = fct_rev(sector)) |> \n  ggplot(aes(x = ICSEA, y = sector, fill = sector)) +\n      stat_halfeye() +\n      geom_vline(xintercept = 0, lty = 2) + \n      theme_ggdist() +\n      theme(legend.position = 'bottom') +\n      scale_fill_viridis_d(begin = 0.4, end = 0.8) + \n      labs(x = 'Difference in Mean Posterior ICSEAS', y = 'Sector Comparison', title = 'Sector Comparison of Posterior Distributions of Mean ICSEAS')\n```", "```py\nm5d <- \n  brm(bf(proportion ~ 1 + (ICSEA_s|sector:outcome),\n         phi ~ 1 + (ICSEA_s|sector:outcome)),\n      family = Beta, \n      data = df_longb |> mutate(proportion = proportion + 0.01), \n      prior = c(prior(cauchy(0, 2), class = sd),\n                prior(cauchy(0, 2), class = Intercept)),\n      seed = 246, chains = 4, cores = 4, iter = 8000, warmup = 1000, save_pars = save_pars(all = T),\n  control = list(adapt_delta = 0.99, max_treedepth = 15), threads = threading(2)) |> \n  add_criterion(c('waic', 'loo'), moment_match = T)\n\nsummary(m5d)\n```", "```py\nnew_df <- expand_grid(sector = c('C', 'I', 'G'),\n            outcome = unique(df_long$outcome),\n            ICSEA_s = seq(from = 0, to = 1, by = 0.05))\n\nm5d |> \nepred_draws(new_df, ndraws = 200) |> \n  filter(outcome != 'other') |> \n  mutate(ICSEA = ICSEA_s * ((max(df_longb$ICSEA) + 1) - (min(df_longb$ICSEA) - 1)) + min(df_longb$ICSEA) - 1) |> \n  ggplot(aes(ICSEA, .epred, color = sector)) +\n    stat_lineribbon() +\n    geom_point(data = df_longb |> filter(outcome != 'other'), aes(y = proportion, x = ICSEA), alpha = 0.3) +\n    facet_grid(sector ~ outcome) + \n    theme_ggdist() +\n    theme(legend.position = 'bottom') +\n    scale_color_viridis_d(begin = 0.2, end = 0.8) + \n    scale_fill_brewer(palette = \"Greys\") +\n    labs(y = 'Proportion', x = 'ICSEA', title = 'Beta Regression Curve Fits of Proportion & ICSEA by Sector and Outcome', subtitle = 'm5d Non-Pooled Phi Term')\n```", "```py\nnew_df <- expand_grid(sector = c('C', 'I', 'G'),\n            outcome = c('apprentice_trainee', 'bachelors', 'deferred', 'employed', 'looking_for_work', 'tafe'),\n            ICSEA_s = seq(from = 0, to = 1, by = 0.05))\n\nm5d |> \nepred_draws(new_df, ndraws = 2000, seed = 246) |> \n  compare_levels(variable = .epred, by = sector, comparison = rlang::exprs(C - G, I - G, C - I)) |> \n  mutate(ICSEA = ICSEA_s * ((max(df_longb$ICSEA) + 1) - (min(df_longb$ICSEA) - 1)) + min(df_longb$ICSEA) - 1,\n         sector = fct_inorder(sector),\n         sector = fct_shift(sector, -1), \n         sector = fct_rev(sector))  |> \n  ggplot(aes(y = .epred, x = ICSEA, color = sector)) +\n    stat_lineribbon() +\n    geom_hline(yintercept = c(0, -0.05, 0.05), lty = c(2)) +\n    scale_fill_brewer(palette = \"Greys\") +\n    scale_color_viridis_d(begin = 0.2, end = 0.8) + \n    facet_grid(outcome ~ sector, scales = 'free_y') +\n    theme_ggdist() +\n    theme(legend.position = 'bottom') +\n    scale_y_continuous(labels = scales::label_percent()) +\n    labs(x = 'ICSEA', y = 'Difference in Posterior Means', title = 'Sector Comparison of Outcomes by ICSEA')\n```"]