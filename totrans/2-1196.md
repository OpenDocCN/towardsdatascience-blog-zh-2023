# 如何使用Python实现学习排序模型

> 原文：[https://towardsdatascience.com/how-to-implement-learning-to-rank-model-using-python-569cd9c49b08](https://towardsdatascience.com/how-to-implement-learning-to-rank-model-using-python-569cd9c49b08)

## 使用Python和LightGBM实现lambdarank算法的逐步指南

[![Ransaka Ravihara](../Images/ac09746938c10ad8f157d46ea0de27ca.png)](https://ransakaravihara.medium.com/?source=post_page-----569cd9c49b08--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----569cd9c49b08--------------------------------) [Ransaka Ravihara](https://ransakaravihara.medium.com/?source=post_page-----569cd9c49b08--------------------------------)

·发表于[数据科学前沿](https://towardsdatascience.com/?source=post_page-----569cd9c49b08--------------------------------) ·阅读时间9分钟·2023年1月18日

--

![](../Images/a1226b3e93be13fec3c422a5220459bf.png)

图片来源：[安德里克·兰菲尔德](https://unsplash.com/@andriklangfield?utm_source=medium&utm_medium=referral) 在[Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

在我之前的两篇文章中，我讨论了学习排序模型的基本概念以及评估LTR模型的广泛使用的评估指标。你可以通过下面列出的链接访问这些文章。

[## 什么是学习排序：学习排序方法的初学者指南](/what-is-learning-to-rank-a-beginners-guide-to-learning-to-rank-methods-23bbb99ef38c?source=post_page-----569cd9c49b08--------------------------------) 

### 关于如何处理机器学习中的LTR问题的指南

[## 如何评估学习排序模型](/how-to-evaluate-learning-to-rank-models-d12cadb99d47?source=post_page-----569cd9c49b08--------------------------------)

### 关于如何在机器学习中评估LTR模型的实用指南

[如何评估学习排序模型](/how-to-evaluate-learning-to-rank-models-d12cadb99d47?source=post_page-----569cd9c49b08--------------------------------)

在本文中，我们将构建一个用于动漫推荐的lambdarank算法。LambdaRank最初由一个研究小组在微软介绍，现在它已经在微软的LightGBM库中提供，并配有易于使用的sklearn包装器。让我们开始吧。

## 从搜索引擎到产品推荐

如上所述，排名在搜索引擎中被广泛使用。但它不仅限于搜索引擎；我们可以采用这一概念，并在适用时构建解决方案。假设我们想为搜索引擎开发一个排名模型，我们应该从一个包含查询、其相关文档（URLs）以及每个查询文档对的相关性评分的数据集开始，如下所示。

![](../Images/0daaef87cb000cb9dc59e195a4456018.png)

图片来源：作者

最后，我们可以基于每个查询和文档对推导特征。

![](../Images/548d9e099ae03770a1bddafffabac0da.png)

图片来源：作者

这是著名的学习排名研究论文和数据集的数据集格式。好吧，这些是关于搜索引擎的内容。让我们讨论一下如何将这些概念适用于传统的产品推荐任务。有多种方法可以向用户推荐产品。你可以在用户购买物品时展示推荐，或在用户浏览页面时展示推荐等。但为了简单起见，我们将其缩小到一个具体场景。

本文将建立一个用于用户主页定制的动漫推荐模型。当用户登录账户时，我们需要根据排名模型预测的相关性评分来展示动漫。这里我将使用Anime Recommendation LTR Dataset，它在公共许可下提供。你可以通过[这个kaggle链接](https://www.kaggle.com/datasets/ransakaravihara/anime-recommendation-ltr-dataset)访问它。

让我们读取数据集并快速检查其列。

[PRE0]

好的，让我解释一下我将在这里使用的方法。与搜索引擎数据不同，在这个用例中我们没有查询和文档对。因此，我们将用户视为查询，将他们感兴趣的动漫视为文档。一个搜索查询可以与多个文档关联；用户可以与许多动漫互动。你明白了，对吧 :)

我们在这里预测的目标标签是*relevance_score*，存储在*relevance_scores*数据集中。当我们建立排名模型时，它将学习一个函数，将这些动漫按最优顺序排序，使每个用户的相关性最高的动漫排在最前面。

接下来，我们需要通过合并上述三个数据集来创建一个新数据集。我还会基于动漫和用户特征创建新的特征。让我们开始创建数据集。

[PRE1]

让我们快速查看一下数据集的一些统计信息。数据集中总共有4.8百万条用户-动漫互动记录，15K用户，和16K动漫。

这是用户和动漫互动分布情况。

![](../Images/c5e62050e6c3c69368136027a119b174.png)![](../Images/dba0f5f2e2da5ddd60c7271f41ce87ac.png)

图片来源：作者

下图显示了相关性评分的分布情况。

![](../Images/4076e507b91eed9f8d5c55c6d4681c51.png)

图片来源：作者

现在我们已经创建了用于模型训练的数据集。但学习排名模型的一个主要困惑点是*group*参数。因为*group*对我们来说是一个陌生的参数，因为它在其他机器学习算法中并不常见。*group*参数的思想是对每个查询和文档对的 数据集进行分区。它使模型能够学习每个组内不同特征的相对重要性，从而提高模型的整体性能。拥有十对用户-动漫意味着我们在 LTR 模型中有十个组。每个组的大小可以不同。但组的总和应该是我们拥有的样本数量。简单来说，我们必须使用*group*参数提供组边界。然后模型可以单独识别每个用户-动漫实例。

例如，如果你有一个包含 6 部动漫的数据集，`group = [3, 2, 1]`，这意味着你有三个组，其中前三条记录在第一个组中，记录 4–5 在第二个组中，记录 6 在第三个组中。

![](../Images/fbb8930d2c949a0b90e38c37ed935f9f.png)

作者提供的图片

**因此，在创建组参数之前，按 *user_id(query_id)* 排序数据集是至关重要的。**

[PRE2]

在上述代码片段中，我执行了以下步骤，

1.  丢弃了所有空值超过 50% 的列。

1.  根据 *user_id* 排序的数据集。否则，*group* 参数将在各处产生不一致的组。

1.  排序数据集后，我将最后 100,000 行声明为验证数据，其余的作为训练数据。

1.  由于 LightGBM 模型期望目标值为整数，我已将目标值缩放到 1–10 之间并转换为整数。 （如果你愿意，可以根据阈值尝试将其转换为 0 或 1。）

让我们定义组参数，并迅速拟合模型，如下所示。

[PRE3]

好了，我们完成了训练。现在是对特定客户进行预测的时候了。

这里还有一个关键点需要注意。即模型预测是如何计算的。我感到困惑，因为调用 `.predict` 方法时，它不需要额外的参数，例如*group*。所以我从 GitHub 问题中找到了以下信息。根据 LightGBM 的创建者在 [这个问题](https://github.com/microsoft/LightGBM/issues/3326)中提到的，LightGBM 的 lambdarank 使用逐点方法生成预测。这意味着我们不需要提供额外的参数，如*group*。我们可以使用正确的特征向量调用 `.predict()` 方法。

然而，由于我们正在开发LTR模型，必须有一些候选产品，并根据预测的相关性评分对其进行排序。为了生成候选动漫，我将在这里使用一种简单的方法。即，选择未向给定用户展示的动漫。从未展示的动漫中选择一个N的随机子集。基于用户和选择的N部动漫子集生成特征。最后，使用生成的特征向量获取相关性评分，并根据相关性评分对动漫进行排序。但在实际应用中，我们应该使用一些有意义的方法。例如，你可以如下生成候选项，

+   选择用户最喜欢的*N*个类别。

+   对于上面选择的每个类别，选择评分最高的*m*部动漫。现在你有*M* N*部动漫需要为该用户排序。只需创建用户基础和动漫基础特征。最后，使用创建的特征向量调用`.predict()`方法。

[PRE4]

![](../Images/b98b6a5dfbfdd5cb97d730eea3e21d37.png)

此外，我们可以使用shap来解释模型的预测结果。

[PRE5]

![](../Images/7bea7248bb0c60a3a4f301c298a0e1bb.png)![](../Images/fa10cc03b1fce53c20773110d75a055d.png)

作者提供的图片

## 结论

本文旨在为读者的特定用例提供一个良好的起点。因为当我开始为我的项目构建LTR模型时，没有好的初学者指南。然而，对于某些用例，训练LTR模型可能不是必要的。你可以使用简单的方法，如回归、多分类/标签分类或聚类。所以不要过度设计你的解决方案；明智地选择工具吧 ; )

感谢阅读！本文的笔记本可以在我的[GitHub repo](https://github.com/Ransaka/LTR-with-LIghtGBM)中找到。

参考文献：

+   [LightGBM文档](https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMRanker.html#lightgbm.LGBMRanker)

+   [微软学习排序数据集](https://www.microsoft.com/en-us/research/project/mslr/)
