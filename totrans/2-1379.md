# 爵士和弦解析与变压器  

> 原文：[https://towardsdatascience.com/jazz-chords-parsing-with-transformers-d75031a976f2](https://towardsdatascience.com/jazz-chords-parsing-with-transformers-d75031a976f2)  

## 基于数据的树形音乐分析方法  

[](https://medium.com/@foscarin.francesco?source=post_page-----d75031a976f2--------------------------------)[![Francesco Foscarin](../Images/f4d238b54771adc6d03c9a62f28d3152.png)](https://medium.com/@foscarin.francesco?source=post_page-----d75031a976f2--------------------------------)[](https://towardsdatascience.com/?source=post_page-----d75031a976f2--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----d75031a976f2--------------------------------) [Francesco Foscarin](https://medium.com/@foscarin.francesco?source=post_page-----d75031a976f2--------------------------------)  

·发布在 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----d75031a976f2--------------------------------) ·阅读时间11分钟·2023年8月1日  

--  

![](../Images/12225dc1bc607140dfc63b87d3353462.png)  

在这篇文章中，我总结了我的研究论文[“使用基于图的神经解码器预测音乐层级”](https://arxiv.org/abs/2306.16955)的一部分，该论文提出了一种能够解析爵士和弦序列的数据驱动系统。  

这项研究是**由于我对基于语法的解析**系统感到挫败而激发的（这些系统是处理音乐数据的唯一选择）：  

+   语法构建阶段需要大量的领域知识  

+   解析器在面对一些未见过的配置或嘈杂数据时会失败  

+   在单一语法规则中考虑多个音乐维度是具有挑战性的。  

+   目前没有一个得到广泛支持的活跃Python框架来帮助开发  

**我的方法**（受自然语言处理领域类似工作的启发），**不依赖于任何语法**，**对嘈杂输入产生部分结果**，**可以轻松处理多个音乐维度，并且在PyTorch中实现**。  

如果你不熟悉解析和语法，或者只是需要刷新你的知识，我现在会退后一步。  

*什么是“解析”？*

*解析*一词指的是预测/推断出一棵树（数学结构），其叶子节点是序列中的元素。  

![](../Images/ec15d890b913a95826badedfa7d9c999.png)  

*好吧，但我们为什么需要树呢？*  

让我们从以下的爵士和弦序列（《Take the A Train》的A部分）开始。  

![](../Images/ec20411eb5d32ae7ca6e775f9a00cc66.png)  

在爵士音乐中，和弦通过复杂的感知关系系统连接。例如，Dm7是对主和弦G7的预备。这意味着Dm7的作用不如G7重要，它可以在不同的和声重构中被省略。类似地，D7是一个次级主和弦（主和弦的主和弦），也指向G7。  

这种和声关系**可以用树来表达**，并且**对音乐分析或执行诸如再和声等任务非常有用**。然而，由于音乐作品中的和弦大多以序列形式存在，我们希望一个**能够自动构建这种树结构的系统**。

# 组成树与依赖树

在继续之前，我们需要区分两种类型的树。

音乐学家倾向于使用所谓的*组成树*，你可以在下面的图片中看到。组成树包含叶子（蓝色和弦——输入序列的元素），以及内部节点（橙色和弦——子叶的简化）。

![](../Images/003a5e6db70993604e1955e2f26622f7.png)

而在这项工作中，我们考虑另一种树，称为*依赖树*。这种树没有内部节点，只有连接序列元素的有向弧。

![](../Images/3e9e922b40dbb3dd581e9eb468a47f12.png)

我们可以通过一些稍后讨论的算法从组成树生成依赖树。

# 数据集

由于这是数据驱动的方法，我们需要一个和弦序列的数据集（输入数据），以及一个树的数据集（真实标签）用于训练和测试。我们使用的是Jazz Treebank¹，公开在[这个](https://github.com/DCMLab/JazzHarmonyTreebank) GitHub 仓库中（它可以自由用于非商业应用，并且我获得了作者的许可在本文中使用它）。特别是，他们提供了一个包含所有和弦和注释的JSON文件。

我们将输入到系统中的每个和弦建模为三个特征：

1.  根节点，是[0..11]中的一个整数，其中C -> 0，C# ->1，依此类推……

1.  基本形式是[0..5]中的一个整数，用于选择大调、小调、增和弦、半减和弦、减和弦和挂留和弦（sus）。

1.  扩展，是[0,1,2]中的一个整数，用于选择6、次要7或大调7。

要从和弦标签（一个字符串）中生成**和弦特征**，我们可以使用如下的正则表达式（注意，这段代码适用于这个数据集，因为在其他和弦数据集中格式可能会有所不同）。

[PRE0]

最后，我们需要生成依赖树。JHT数据集只包含组成树，以嵌套字典形式编码。我们导入它们，并通过递归函数将它们转换为依赖树。我们函数的机制可以描述如下。

我们从一个完全形成的组成树和一个没有任何依赖弧的依赖树开始，这个依赖树仅由标记为序列元素的节点组成。算法将所有内部树节点与其主要子节点（它们都具有相同的标签）进行分组，并使用每个组中所有次要子节点关系来创建组标签和次要子节点标签之间的依赖弧。

[PRE1]

# 依赖解析模型

我们的解析模型的工作机制相当简单：我们考虑所有可能的弧，并使用*弧预测器*（一个简单的二分类器）来预测该弧是否应该成为树的一部分。

然而，仅根据我们试图连接的两个和弦来做出这个选择是相当困难的。我们需要一些*上下文*。我们通过构建一个变换器编码器来提供这样的上下文。

总结而言，我们的解析模型分为两个步骤：

1.  输入序列通过变换器编码器传递，以丰富其上下文信息；

1.  一个二分类器评估所有可能的依赖弧图，以过滤掉不需要的弧。

![](../Images/796be2efed7a8dacf7ca36559f18f340.png)

变换器编码器遵循标准架构。我们使用可学习的嵌入层将每个分类输入特征映射到一个连续的多维空间中的点。然后将所有嵌入加在一起，因此网络可以“决定”每个特征使用的维度。

[PRE2]

弧预测器只是一个线性层，它的输入是两个和弦的隐藏特征的连接。由于矩阵乘法的强大功能，所有弧的分类步骤都是并行完成的。

[PRE3]

我们可以将变换器编码器和弧预测器放在一个单独的 PyTorch 模块中，以简化其使用。

[PRE4]

# 损失函数

作为损失函数，我们使用两个损失的和：

+   二元交叉熵损失：这个思想是将我们的问题视为一个二分类问题，每个弧都可以被预测或不被预测。

+   交叉熵损失：这个思想是将我们的问题视为一个多分类问题，在一个头 → 依赖弧中，我们需要预测所有其他和弦中哪个是正确的依赖。

[PRE5]

# 后处理

有一个问题我们仍然需要解决。在训练过程中，并没有强制要求预测的弧必须形成树结构。因此，我们可能会遇到像弧循环这样的无效配置。幸运的是，我们可以使用一种算法来确保这种情况不会发生：Eisner 算法。²

我们不再只是简单地假设弧存在的概率大于 0.5，而是将所有预测结果保存在一个大小为（和弦数，和弦数）的方形矩阵（*邻接矩阵*）中，然后在该矩阵上运行 Eisner 算法。

[PRE6]

# 结论

我提出了一种用于和弦序列依赖解析的系统，该系统使用变换器构建上下文和弦隐藏表示，并使用分类器来选择两个和弦是否应该通过弧连接。

相较于竞争系统，主要的优点在于该方法**不依赖于任何特定的符号语法**，因此它可以同时考虑多种音乐特征，利用序列上下文信息，并对噪声输入产生部分结果。

为了保持文章的适当长度，解释和代码都集中在系统中最有趣的部分。你可以在[这篇科学文章](https://arxiv.org/abs/2306.16955)中找到更完整的解释，所有代码都可以在[这个GitHub仓库](https://github.com/fosfrancesco/musicparser)中找到。

*(所有图片均由作者提供。)*

**参考文献**

1.  D. Harasim, C. Finkensiep, P. Ericson, T. J. O’Donnell, 和 M. Rohrmeier，“爵士和声树库”，载于国际音乐信息检索会议（ISMIR）论文集，2020年，第207–215页。

1.  J. M. Eisner，“依存解析的三种新概率模型：一种探索”，载于国际计算语言学大会（COLING）论文集，1996年。
