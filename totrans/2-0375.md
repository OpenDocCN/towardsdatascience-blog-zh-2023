# 大规模生产自主驾驶中的BEV感知

> 原文：[https://towardsdatascience.com/bev-perception-in-mass-production-autonomous-driving-c6e3f1e46ae0](https://towardsdatascience.com/bev-perception-in-mass-production-autonomous-driving-c6e3f1e46ae0)

## 小鹏汽车的XNet配方

[](https://medium.com/@patrickllgc?source=post_page-----c6e3f1e46ae0--------------------------------)[![Patrick Langechuan Liu](../Images/fecbf85146a9bde21e6b2251538ddd65.png)](https://medium.com/@patrickllgc?source=post_page-----c6e3f1e46ae0--------------------------------)[](https://towardsdatascience.com/?source=post_page-----c6e3f1e46ae0--------------------------------)[![数据科学前沿](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----c6e3f1e46ae0--------------------------------) [Patrick Langechuan Liu](https://medium.com/@patrickllgc?source=post_page-----c6e3f1e46ae0--------------------------------)

·发表于[数据科学前沿](https://towardsdatascience.com/?source=post_page-----c6e3f1e46ae0--------------------------------) ·阅读时间9分钟·2023年6月19日

--

> 本博客文章基于在2023年CVPR于温哥华举行的*端到端自主驾驶研讨会*上的邀请演讲，演讲题为“中国大规模生产自主驾驶的实践”。主旨演讲的录音可以在[这里](https://www.youtube.com/watch?v=d6ucRgDDUWQ&t=162s)找到。

BEV（鸟瞰视角）感知在过去几年中取得了巨大进展。它直接感知自主驾驶车辆周围的环境。**BEV感知**可以被看作是一个**端到端感知**系统，也是实现端到端自主驾驶系统的重要一步。我们将端到端自主驾驶系统定义为完全可微分的管道，这些管道以原始传感器数据作为输入，输出高层次的驾驶计划或低层次的控制动作。

[](https://opendrivelab.com/e2ead/cvpr23.html?source=post_page-----c6e3f1e46ae0--------------------------------) [## CVPR 2023 自主驾驶研讨会 | OpenDriveLab

### 我们很自豪地宣布今年与我们的合作伙伴共同推出四个全新挑战 - 以视觉为中心…

[opendrivelab.com](https://opendrivelab.com/e2ead/cvpr23.html?source=post_page-----c6e3f1e46ae0--------------------------------)

自主驾驶社区见证了采用端到端算法框架的方法的快速增长。我们将从基本原理讨论端到端方法的必要性。然后，我们将回顾将BEV感知算法部署到大规模生产车辆的努力，以小鹏的BEV感知架构XNet为例。最后，我们将对BEV感知的未来进行头脑风暴，以实现完全端到端的自主驾驶。

# 端到端系统的必要性

在解决任何工程问题时，通常需要使用分而治之的方法来快速找到实际解决方案。这种策略涉及将大问题拆解成较小的、相对明确的组件，这些组件可以独立解决。虽然这种方法有助于快速交付完整产品，但也增加了被困在局部最优解的风险。为了达到全局最优解，所有组件必须以端到端的方式一起优化。

![](../Images/cd46416c815dae75d45c756ea2ca7334.png)

分而治之与端到端的性能增长曲线（图表由作者制作）

80-20法则强化了这样一个概念：80%的期望性能可以通过仅20%的总努力来实现。使用分而治之的方法的优势在于它允许开发者用最小的努力快速工作。然而，这种方法的缺点是它通常会在80%的标记处导致性能天花板。为了克服性能限制并摆脱局部最优，开发者必须将某些组件一起优化，这也是开发端到端解决方案的第一步。这个过程必须重复几次，不断打破性能天花板，直到实现一个完整的端到端解决方案。最终形成的曲线可能会呈现为一系列的S形曲线，直到接近全局最优解。一个朝着端到端解决方案努力的例子是BEV感知算法的开发。

# 感知2.0：端到端感知

在传统的自动驾驶堆栈中，2D图像被送入感知模块以生成2D结果。然后使用传感器融合来推理来自多个摄像头的2D结果，并将这些结果提升为3D。生成的3D对象随后被发送到下游组件，如预测和规划。

![](../Images/ef5c86c32ddd46d2be8ea1b5510384d8.png)

BEV感知本质上是端到端感知（图像由作者制作）

然而，传感器融合步骤需要大量的手工规则来融合来自多个摄像头流的感知结果。每个摄像头只能感知要观察对象的一部分，因此结合获得的信息需要仔细调整融合逻辑。我们本质上是在通过工程师的头脑进行反向传播。此外，开发和维护这些规则会造成一系列复杂问题，导致在复杂的城市环境中出现许多问题。

为了克服这个挑战，我们可以应用鸟瞰图（BEV）感知模型，它允许我们在BEV空间中直接感知环境。BEV感知堆栈将两个独立的组件结合成一个单一的解决方案，从而消除了脆弱的人为制定逻辑。BEV感知本质上是一个**端到端感知**解决方案。这标志着朝着端到端自动驾驶系统迈出的关键一步。

# XNet: Xpeng Motors 的 BEV 感知堆栈

Xpeng 的 BEV 感知架构代号为 XNet。它首次公开介绍是在 [2022年 Xpeng 1024 科技日](https://www.youtube.com/watch?v=0dEoctcK09Q) 上。下方的可视化图展示了车载 XNet 感知架构的实际运行情况。中间的红色车辆代表自动驾驶车辆在环形交叉路口导航。周围的静态环境完全由车载感知系统检测，无需使用高清地图。我们可以观察到 XNet 精确地检测了车辆周围的各种动态和静态物体。

Xpeng AI 团队在两年前（2021年初）开始对 XNet 架构进行实验，并经过多次迭代后达到了现在的形式。我们利用卷积神经网络（CNN）主干生成图像特征，同时通过变换器结构将多摄像头特征转置到 BEV 空间。具体而言，使用了交叉注意力模块。来自多个过去帧的 BEV 特征随后与自我姿态——在空间和时间上——融合，以解码融合特征中的动态和静态元素。

![](../Images/9b842cb903eed4b72c7a424e035210b9.png)

XNet 结果与架构

以视觉为中心的 BEV 感知架构提高了大规模部署自动驾驶解决方案的性价比，减少了对更昂贵硬件组件的需求。准确的 3D 检测和速度展现了冗余的新维度，减少了对激光雷达和雷达的依赖。此外，实时 3D 可感知环境减少了对高清地图的依赖。这两种能力都显著地有助于更可靠且具有成本效益的自动驾驶解决方案。

## **XNet 的挑战**

将这样的神经网络部署到生产车辆上存在多个挑战。首先，训练 XNet 需要数百万个多摄像头视频片段。这些片段涉及约十亿个需要标注的物体。根据当前的标注效率，大约需要**2,000 人年**来完成标注。不幸的是，这意味着对于 Xpeng 约1000人的内部标注团队来说，这项任务需要大约两年才能完成，这是不可接受的。从模型训练的角度来看，使用一台机器训练这样的网络将需要**接近一年**。此外，在 NVIDIA Orin 平台上未经优化地部署这样的网络将消耗**一个芯片的122%计算能力**。

所有这些问题都对成功训练和部署如此复杂且庞大的模型提出了挑战。

## 自动标注

为了提高标注效率，我们开发了一个高效的自动标注系统。这个离线传感器融合堆栈将效率提升了多达45,000倍，使我们能够在17天内完成原本需要200人年才能完成的标注任务。

![](../Images/4450b96601971cbf724e35a9ab4663a0.png)

自动标注系统显著提升标注效率

以上是基于激光雷达的自动标注系统，我们还开发了一个完全依赖视觉传感器的系统。这使我们能够标注没有激光雷达的客户车队获得的片段。这是数据闭环的关键部分，并增强了自我进化感知系统的发展。

## 大规模训练

我们从两个角度优化了XNet的训练管道。首先，我们应用了混合精度训练和操作优化技术，以简化单节点上的训练过程，将训练时间缩短了10倍。接下来，我们与阿里云合作，建立了一个计算能力为600 PFLOPS的GPU集群，使我们能够将训练从单机扩展到多机。虽然这一过程并不简单，因为我们需要仔细调整训练程序以实现接近线性的性能扩展，但它进一步减少了训练时间。总体而言，我们将XNet的训练时间从276天减少到仅11小时。请注意，随着我们将更多数据加入训练过程，训练时间自然会增加，这需要额外的优化。因此，扩展优化仍然是一个持续而关键的工作。

![](../Images/606d40ee55dd1bbd67a487868b4e68e6.png)

XNet大规模并行训练管道的优化

## 在Orin上的高效部署

我们注意到，如果没有任何优化，在Nvidia Orin芯片上运行XNet需要使用芯片计算能力的122%。通过分析开头展示的分析图，我们观察到变换器模块消耗了大部分的运行时间。这是可以理解的，因为在Orin芯片的初始设计阶段，变换器模块并没有得到足够的关注。因此，我们需要重新设计变换器模块和注意力机制以支持Orin平台，从而实现了3倍的加速。

![](../Images/0ba6e350f5231816c60474732c6b9cb1.png)

在Orin平台上对基于变换器的XNet进行极致优化

为了进一步优化，我们通过剪枝优化了网络，结果实现了额外的2.6倍加速。最后，通过在GPU和DLA之间进行负载均衡，我们实现了进一步的1.7倍加速。

通过这些优化技术，我们将XNet的GPU利用率从122%降低到仅9%。这使我们能够在Orin平台上探索新的架构可能性。

## 自我进化数据引擎

通过实施XNet架构，我们现在可以启动数据驱动的迭代以提升模型性能。为此，我们首先在汽车上识别角落案例，然后向客户车队部署可配置触发器以收集相关图像。随后，我们根据自然语言的简短描述或图像本身从收集的数据中检索图像。在此过程中，我们利用大型语言模型的最新进展来提高数据集策划和注释的效率。

![](../Images/391d72a6b66e90910e8d16230089d311.png)

数据引擎有助于提高XNet性能

通过XNet架构和数据引擎，我们创建了一个可扩展且自我演化的感知系统。

# 未来展望

最新发布的Xpeng Highway NGP 2.0统一了高速公路和城市驾驶解决方案，让用户可以在不同城市放置一个定位点，从头到尾享受流畅的体验。这种统一是通过XNet实现的，XNet为所有场景的统一堆栈提供了坚实的基础。最终目标是实现点对点用户体验的端到端自动驾驶。

为了使自动驾驶系统具备端到端可微分性，另一个关键缺失的部分是基于机器学习的规划堆栈。基于学习的规划解决方案大致可以分为模仿学习或强化学习方法。大型语言模型（LLMs）的最新进展也为这一重要主题的发展带来了巨大潜力。以下的[Github repo](https://github.com/OpenDriveLab/End-to-end-Autonomous-Driving)是端到端自动驾驶新兴领域相关工作的实时集合。

[](https://github.com/OpenDriveLab/End-to-end-Autonomous-Driving?source=post_page-----c6e3f1e46ae0--------------------------------) [## GitHub - OpenDriveLab/End-to-end-Autonomous-Driving: 所有你需要的端到端自动驾驶资源

### 所有你需要的端到端自动驾驶资源。通过贡献于OpenDriveLab/End-to-end-Autonomous-Driving的发展…

github.com](https://github.com/OpenDriveLab/End-to-end-Autonomous-Driving?source=post_page-----c6e3f1e46ae0--------------------------------)

# 重点总结

+   分而治之能够以20%的努力达到80%的性能。端到端方法旨在突破80%的性能上限，但可能需要更大的成本。

+   XNet是一个端到端的感知系统，是迈向端到端全栈解决方案的重要一步。根据80-20法则，它需要显著的工程投入（80%）。

+   XNet所需的大量注释需要自动注释，因为人工注释不可行。自动标签系统可以提高45000倍的效率。

+   大规模训练需要优化单机训练，并从一台机器扩展到多台机器。

+   在Nvidia Orin平台上部署XNet需要重构变压器模块。

# 参考资料

+   针对在中国部署大规模生产自动驾驶所面临的独特挑战，请参阅以下链接。这也是在 CVPR 2023 上的邀请讲座的一部分。

[](https://medium.com/@patrickllgc/challenges-of-mass-production-autonomous-driving-in-china-407c7e2dc5d8?source=post_page-----c6e3f1e46ae0--------------------------------) [## 中国大规模生产自动驾驶面临的挑战

### 以及 Xpeng 对这些问题的回答

medium.com](https://medium.com/@patrickllgc/challenges-of-mass-production-autonomous-driving-in-china-407c7e2dc5d8?source=post_page-----c6e3f1e46ae0--------------------------------)

+   一项关于基于 Transformer 的 BEV 感知算法的学术研究回顾。

[https://medium.com/towards-data-science/monocular-bev-perception-with-transformers-in-autonomous-driving-c41e4a893944](https://medium.com/towards-data-science/monocular-bev-perception-with-transformers-in-autonomous-driving-c41e4a893944)

+   Xpeng 1024 科技日 2022: [https://www.youtube.com/watch?v=0dEoctcK09Q](https://www.youtube.com/watch?v=0dEoctcK09Q)
