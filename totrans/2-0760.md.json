["```py\nWITH statistics AS (\n  SELECT\n    CEIL(average_value + (std_dev*3)) AS upper_limit\n  FROM (\n    SELECT\n      AVG(metric) AS average_value,\n      STDDEV_SAMP(metric) AS std_dev\n    FROM data\n  )\n)\n\nSELECT\n  id,\n  IF(metric > s.upper_limit, s.upper_limit, metric) AS metric_count\nFROM data us\nCROSS JOIN statistics s\nORDER BY 2 DESC\n```", "```py\nSELECT * \nFROM data \nWHERE metric_count <= \n(SELECT \n  DISTINCT PERCENTILE_DISC(metric_count, 0.997) OVER() AS percentile_99th -- 3 standard deviation above the mean to remove outliers\n  FROM data)\nORDER BY 2 DESC\n```"]