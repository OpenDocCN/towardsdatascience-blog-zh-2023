- en: Create MySQL and Postgres instances using AWS Cloudformation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: ÂéüÊñáÔºö[https://towardsdatascience.com/create-mysql-and-postgres-instances-using-aws-cloudformation-d3af3c46c22a](https://towardsdatascience.com/create-mysql-and-postgres-instances-using-aws-cloudformation-d3af3c46c22a)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Infrastructure as Code for database practitioners
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://mshakhomirov.medium.com/?source=post_page-----d3af3c46c22a--------------------------------)[![üí°Mike
    Shakhomirov](../Images/bc6895c7face3244d488feb97ba0f68e.png)](https://mshakhomirov.medium.com/?source=post_page-----d3af3c46c22a--------------------------------)[](https://towardsdatascience.com/?source=post_page-----d3af3c46c22a--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----d3af3c46c22a--------------------------------)
    [üí°Mike Shakhomirov](https://mshakhomirov.medium.com/?source=post_page-----d3af3c46c22a--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ¬∑Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----d3af3c46c22a--------------------------------)
    ¬∑7 min read¬∑Mar 20, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/21d6c29d19d4d9e6c31365437e7443f2.png)'
  prefs: []
  type: TYPE_IMG
- en: Photo by [Yunqing Leo](https://unsplash.com/@leoo0oo?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  prefs: []
  type: TYPE_NORMAL
- en: With these two simple **Cloudformation templates**, we will learn how to deploy
    Postgres and MySQL Aurora database instances with just one command CLI command.
    I have optimised template files reducing the number of properties to a minimum
    so it‚Äôs easier to comprehend.
  prefs: []
  type: TYPE_NORMAL
- en: I know that Infrastructure as Code might seem a little bit hard for intermediate
    users who are not familiar with that concept but believe me this is the right
    way to go. Career-wise it will bring a lot of benefits.
  prefs: []
  type: TYPE_NORMAL
- en: Who is this tutorial for?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This story is for beginner and intermediate-level data and software engineers
    who would like to get into data engineering and learn a few advanced things, such
    as **infrastructure as code.**
  prefs: []
  type: TYPE_NORMAL
- en: I hope this tutorial will be useful for everyone involved in software engineering
    where a cloud database is required to store your application data.
  prefs: []
  type: TYPE_NORMAL
- en: '**Prerequisites**'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Basic knowledge **of Bash** scripting
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Bash/Shell scripting might seem a bit advanced for beginners but it is necessary
    to deploy AWS services, i.e. RDS.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: AWS Command line tool installed (AWS CLI).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'All shell commands provided in this article can be run either from the command
    line or as a `.sh` script, i.e. simply run a file from your command line like
    so: `$ ./deploy.sh`'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: AWS account.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: This is free to register and there is a free tier so it shouldn‚Äôt have any significant
    charges unless you deploy a really big database and forget to delete it.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Why Infrastructure as code (IAC)?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'IAC is gaining popularity very quickly as it helps to manage cloud platform
    resources using **template files (JSON or yaml code)** consistently in a reproducible
    way. We can apply CI/CD pipelines and use Github integration to create production
    and staging environments for example. Infrastructure as code is a deployment and
    resource management standard these days and I previously wrote about it here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://levelup.gitconnected.com/infrastructure-as-code-for-beginners-a4e36c805316?source=post_page-----d3af3c46c22a--------------------------------)
    [## Infrastructure as Code for Beginners'
  prefs: []
  type: TYPE_NORMAL
- en: Deploy Data Pipelines like a pro with these templates
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: levelup.gitconnected.com](https://levelup.gitconnected.com/infrastructure-as-code-for-beginners-a4e36c805316?source=post_page-----d3af3c46c22a--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: That story explained how to deploy and provision AWS resources for our data
    lake, i.e. AWS S3 and AWS Lambda.
  prefs: []
  type: TYPE_NORMAL
- en: Data-wise, Infrastructure as code is a brilliant way to separate data environments
    and provision data pipeline resources. Using it we can create any data pipeline
    we need.
  prefs: []
  type: TYPE_NORMAL
- en: Why and when do we use Relational databases in data pipelines?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Typically, relational databases consist of row-based tables with columns that
    connect related data pieces using normalised schema.
  prefs: []
  type: TYPE_NORMAL
- en: This **data architecture type aims to** capture the data quickly and optimise
    the system to swiftly retrieve the most recent of it required by the application.
  prefs: []
  type: TYPE_NORMAL
- en: Because RDS database tables and joins are ‚Äúnormalised,‚Äù they are more complex
    compared to a typical data warehouse design. However, this is a trade-off required
    by functional requirements.
  prefs: []
  type: TYPE_NORMAL
- en: 'Hence, the main difference between a ‚Äúconventional database‚Äù and a ‚Äúdata warehouse‚Äù
    is that the former is created and optimised to ‚Äúrecord‚Äù data, whilst the latter
    is created and built to ‚Äúreact to analytics‚Äù. I previously wrote about it here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/data-platform-architecture-types-f255ac6e0b7?source=post_page-----d3af3c46c22a--------------------------------)
    [## Data Platform Architecture Types'
  prefs: []
  type: TYPE_NORMAL
- en: How well does it answer your business needs? Dilemma of a choice.
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/data-platform-architecture-types-f255ac6e0b7?source=post_page-----d3af3c46c22a--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Popular relational databases are MySQL, Microsoft SQL Server, Oracle and PostgreSQL.
  prefs: []
  type: TYPE_NORMAL
- en: Create MySQL Aurora instance
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To create an Aurora-engined database instance we would need a cluster first.
    The thing is that Aurora instances have to be associated with a **AWS::RDS::DBCluster**
    via **DBClusterIdentifier.** If we have no cluster in our stack file we will be
    getting some generic Cloudfomation errors that don‚Äôt make much sense.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can use this Cloudformation template file:'
  prefs: []
  type: TYPE_NORMAL
- en: 'If everything is correct then in AWS Console you will see something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/5885f152c3638e461fed34b03b85ab66.png)'
  prefs: []
  type: TYPE_IMG
- en: Cloudformation events. Image by author
  prefs: []
  type: TYPE_NORMAL
- en: Create a Postgres database instance in AWS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To create a simple Postges instance we can use this command and the template
    below:'
  prefs: []
  type: TYPE_NORMAL
- en: 'And the template would be this:'
  prefs: []
  type: TYPE_NORMAL
- en: So as you can see, Postges is a bit easier as it doesn‚Äôt require a cluster.
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: '![](../Images/4ab43d6bfdec947abd4883e8b4004cc9.png)'
  prefs: []
  type: TYPE_IMG
- en: Postgres instance created. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: What if something goes wrong?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We can always take a look at the **events** section. Then Google it. I know,
    I know‚Ä¶ AWS Cloudformation documentation is not perfect. This is life and we have
    to comply. Unfortunately.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, if something goes wrong and you bump into an error like:'
  prefs: []
  type: TYPE_NORMAL
- en: '‚ÄúDS does not support creating a DB instance with the following combination:
    DBInstanceClass=db.t2.micro, Engine=postgres, EngineVersion=13.3‚Ä¶‚Äù'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'You will have to find the supported engine and version 13.3 for your region.
    To do so you can use this bash command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Best practices to deploy RDS instances
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The templates we used above are very simple. This is intentional so we can deploy
    them successfully with ease and start adding new features from there.
  prefs: []
  type: TYPE_NORMAL
- en: What else can we do?
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Keep passwords in Secrets Manager
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'This is a really good idea so we would probably want to change our password
    property in the template to this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'And then we can use it in our template like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'We can do the same thing with database password:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'And then refer to it from the template:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: What is RDSDBClusterParameterGroup?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'It has a Type: ‚ÄòAWS::RDS::DBClusterParameterGroup‚Äô'
  prefs: []
  type: TYPE_NORMAL
- en: In this attribute, we specify the name of the parameter group for the database
    cluster that will be connected to it. By doing so we associate our database instances
    and the Aurora database cluster.
  prefs: []
  type: TYPE_NORMAL
- en: 'We then reference it in **AWS::RDS::DBCluster** resource, i.e.:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: This is important because every time you need to update a parameter in the future,
    you must build a new parameter group and link it to the cluster.
  prefs: []
  type: TYPE_NORMAL
- en: To implement the modification, the primary database instance in the cluster
    has to be restarted.
  prefs: []
  type: TYPE_NORMAL
- en: Deletion protection
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'It‚Äôs always a good idea to set our database cluster DeletionProtection: true'
  prefs: []
  type: TYPE_NORMAL
- en: This prevents the accedental deletion of an RDS instance. It also prevents any
    instance replacements if we change some template file properties that would normally
    require resource replacements.
  prefs: []
  type: TYPE_NORMAL
- en: DBInstanceClass
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'This is an important one as it has a direct impact on costs related to our
    database. It goes under Type: ‚ÄòAWS::RDS::DBInstance‚Äô in the template.'
  prefs: []
  type: TYPE_NORMAL
- en: Always choose the smallest one for testing purposes. Search for`db.r6g.large`in
    your template and change to `db.t2.small` or `db.t3.micro`
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Also if we don‚Äôt need a big storage for the database in `staging` is always
    a good idea to provision only the required minimum:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: Provision VPC resources in a separate stack template
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We probably would want to deploy our database cluster in the Virtual Private
    Cloud (VPC). It‚Äôs a good idea to create a separate stack for these types of resources
    and then use it in our database stack like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: DBInstanceIdentifier
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The database instance is identified by this **name**.
  prefs: []
  type: TYPE_NORMAL
- en: Amazon CloudFormation will create a special default physical ID and uses it
    as the name if you don‚Äôt provide one.
  prefs: []
  type: TYPE_NORMAL
- en: '**AWS::RDS::DBParameterGroup**'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We should create this resource type for the same reason we created it for `'AWS::RDS::DBClusterParameterGroup'`
  prefs: []
  type: TYPE_NORMAL
- en: It might be problematic for a production database to associate a new database
    parameter group later since doing so requires a database restart.
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: We also might want to create a different AWS::RDS::DBParameterGroup for write
    and replica instances, i.e.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Database monitoring
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It is highly recommended to set up database monitoring during the initial setup.
    Many [metrics,](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.AuroraMySQL.Monitoring.Metrics.html)
    both at the cluster and database levels, are sent by default by **Aurora to CloudWatch**.
    So we can subscribe to RDS events by using [AWS::RDS::EventSubscription](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-rds-eventsubscription.html)
    resource.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'After that we can create Cloudwatch metric filter and set Cloudwatch alarms
    like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: EnablePerformanceInsights
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It‚Äôs a helpful tool for gaining an understanding about database performance.
  prefs: []
  type: TYPE_NORMAL
- en: It has no extra charges if enabled to keep data for 7 days only.
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: This feature has to be enabled separately on both primary and replica instances.
  prefs: []
  type: TYPE_NORMAL
- en: Conclusion
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this story, you can find two simplified Cloudformation templates to deploy
    Postgres and MySQL database instances in the cloud. I hope you will find best
    practices covered in this article useful and it will help you to develop those
    templates into something bigger that suits your needs.
  prefs: []
  type: TYPE_NORMAL
- en: 'RDS databases are crucial for any data platform design and it is important
    to understand how they are being created. They are used in many data pipeline
    design patterns, i.e. batch and change data capture:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/data-pipeline-design-patterns-100afa4b93e3?source=post_page-----d3af3c46c22a--------------------------------)
    [## Data pipeline design patterns'
  prefs: []
  type: TYPE_NORMAL
- en: Choosing the right architecture with examples
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/data-pipeline-design-patterns-100afa4b93e3?source=post_page-----d3af3c46c22a--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Applying some of the features mentioned in best practices might be useful to
    gain database performance insights as well.
  prefs: []
  type: TYPE_NORMAL
- en: 'Recommended read:'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](/data-pipeline-design-patterns-100afa4b93e3?source=post_page-----d3af3c46c22a--------------------------------)
    [## Data pipeline design patterns'
  prefs: []
  type: TYPE_NORMAL
- en: Choosing the right architecture with examples
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/data-pipeline-design-patterns-100afa4b93e3?source=post_page-----d3af3c46c22a--------------------------------)  [##
    AWS::SecretsManager::Secret
  prefs: []
  type: TYPE_NORMAL
- en: Creates a new secret. A secret can be a password, a set of credentials such
    as a user name and password, an OAuth‚Ä¶
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: docs.aws.amazon.com](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-secretsmanager-secret.html?source=post_page-----d3af3c46c22a--------------------------------)  [##
    Working with parameter groups
  prefs: []
  type: TYPE_NORMAL
- en: Database parameters specify how the database is configured. For example, database
    parameters can specify the amount of‚Ä¶
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: docs.aws.amazon.com](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html?source=post_page-----d3af3c46c22a--------------------------------)  [##
    AWS::RDS::EventSubscription
  prefs: []
  type: TYPE_NORMAL
- en: The AWS::RDS::EventSubscription resource allows you to receive notifications
    for Amazon Relational Database Service‚Ä¶
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: docs.aws.amazon.com](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-rds-eventsubscription.html?source=post_page-----d3af3c46c22a--------------------------------)
    [](https://aws.amazon.com/rds/performance-insights/?source=post_page-----d3af3c46c22a--------------------------------)
    [## Amazon RDS Performance Insights | Cloud Relational Database | Amazon Web Services
  prefs: []
  type: TYPE_NORMAL
- en: Analyze and tune Amazon RDS database performance Amazon RDS Performance Insights
    is a database performance tuning and‚Ä¶
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: aws.amazon.com](https://aws.amazon.com/rds/performance-insights/?source=post_page-----d3af3c46c22a--------------------------------)
  prefs: []
  type: TYPE_NORMAL
