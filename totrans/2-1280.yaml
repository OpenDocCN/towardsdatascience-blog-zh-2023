- en: Hugging Face Diffusers can correctly load LoRA
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/hugging-face-diffusers-can-correctly-load-lora-now-a332501342a3](https://towardsdatascience.com/hugging-face-diffusers-can-correctly-load-lora-now-a332501342a3)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Using the Latest Diffusers Monkey Patching function to load LoRA produces exactly
    the same result compare with A1111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)[![Andrew
    Zhu (Shudong Zhu)](../Images/46f07a875a42bcc4e0c262aea5e2a504.png)](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)[](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------)
    [Andrew Zhu (Shudong Zhu)](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------)
    ·5 min read·Jul 28, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: Pull the latest code from Hugging Face’s Diffusers code repository, and found
    that the newest code updated related to LoRA loading is updated and can do Monkey-Patching
    LoRA loading now.
  prefs: []
  type: TYPE_NORMAL
- en: 'To install the latest Diffusers:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The LoRA loading function was generating slightly faulty results yesterday,
    according to my test. This article discusses how to use the latest LoRA loader
    from the Diffusers package.
  prefs: []
  type: TYPE_NORMAL
- en: Load LoRA and update the Stable Diffusion model weight
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It has been a while since programmers using Diffusers can’t have the LoRA loaded
    in an easy way. To load LoRA to a checkpoint model and output the same result
    as A1111’s Stable Diffusion Webui did, we need to use additional custom code to
    load the weights as I provided in this article.
  prefs: []
  type: TYPE_NORMAL
- en: '[](/improving-diffusers-package-for-high-quality-image-generation-a50fff04bdd4?source=post_page-----a332501342a3--------------------------------)
    [## Improving Diffusers Package for High-Quality Image Generation'
  prefs: []
  type: TYPE_NORMAL
- en: Overcoming token size limitations, custom model loading, LoRa support, textual
    inversion support, and more
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/improving-diffusers-package-for-high-quality-image-generation-a50fff04bdd4?source=post_page-----a332501342a3--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: The solution provided in this article works well and fast, while it requires
    additional management on the LoRA alpha weight, we need to create a variable to
    remember the current LoRA weight α. Because the load LoRA code simply adds put
    the A and B matrix from LoRA together.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/154a503a4e388678150c2d06d0f17b5f.png)'
  prefs: []
  type: TYPE_IMG
- en: Weight from LoRA
  prefs: []
  type: TYPE_NORMAL
- en: And then merge with the main checkpoint model weight W.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/9ebd02b5d43e5e91b4d0aabbc96abf39.png)'
  prefs: []
  type: TYPE_IMG
- en: Merge LoRA weight with checkpoint weight
  prefs: []
  type: TYPE_NORMAL
- en: To remove the LoRA weights, we will need a negative -α to remove the LoRA weights,
    or recreate the pipeline.
  prefs: []
  type: TYPE_NORMAL
- en: The Monkey-Patching way to load LoRA
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Another way to use LoRA is patching the code that executes the module forward
    process, and bringing the LoRA weights during the time of calculating text embedding
    and attention score.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/98b8861a423a8e3ee63462bd4f1b8aab.png)'
  prefs: []
  type: TYPE_IMG
- en: Monkey patching model with LoRA
  prefs: []
  type: TYPE_NORMAL
- en: And this is how Diffusers LoraLoaderMixin’s approach to LoRA loading. The good
    part of this approach is that no model weight is updated, we can easily reset
    the LoRA and provide a new α to define the LoRA weight.
  prefs: []
  type: TYPE_NORMAL
- en: However, before today(July 26, 2023), Diffusers’ LoraLoaderMixin load LoRA and
    generate results somewhat different compared with A1111\. And today’s code fixed
    the issue. “fixed” I mean, you can use Diffusers to load a checkpoint model together
    with LoRA and generate exactly the same result using A1111 SD webui.
  prefs: []
  type: TYPE_NORMAL
- en: Load LoRA using Diffusers LoraLoaderMixin
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Assume we have the LoRA file in `safetensor` file format, to load LoRA using
    Diffusers is as easy as this.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Just one line code: `text2img_pipe.load_lora_weights(lora_path)`. Test with
    one of the famous LoRA — [LowRA](https://civitai.com/models/48139/lowra) , this
    LoRA can turn the image to dark mode.'
  prefs: []
  type: TYPE_NORMAL
- en: Let’s test it with and without LoRA loaded.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Here are the result, the left is the one has no LoRA loaded, and the right one
    is the generated image with LoRA loaded using `text2img_pipe.load_lora_weights(lora_path).`
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/ba0440c6896e91461b8a805ee43c0fd5.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 1\. LowRA LoRA can generate dark mode image, generated by Andrew Zhu
    using Diffusers
  prefs: []
  type: TYPE_NORMAL
- en: Load LoRA using Diffusers with a weight
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Even though we can now load LoRA with just one line code, we still don’t see
    any support for the LoRA weight parameter. For example, we want less dark from
    the result and say add LoRA weight as 0.5\. In A1111 Stable Diffusion Webui, we
    can give the LoRA weight as: `<lora:LowRA:0.5>`'
  prefs: []
  type: TYPE_NORMAL
- en: 'How can we add this 0.5 to the Diffusers package? seems there is no way, but
    we can hack into the process and add our value in the middle of the LoRA loading
    like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'The left one is the result from A1111 SD Webui, and the right one from Diffusers,
    both using the same LoRA with 0.5 weight, Euler scheduler, and seed: 3135098381'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/86c3959685bb676e3c09f93e645a2aa6.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 2\. Diffusers with LoRA can generate the same image compared with A1111\.
    Image generated by Andrew Zhu using A1111 SD WebUi(left) and Diffusers(right)
  prefs: []
  type: TYPE_NORMAL
- en: Can you tell the difference?
  prefs: []
  type: TYPE_NORMAL
- en: 'To reset the LoRA, simply call the `unload_lora_weights` function :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Summary
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This article discussed the most recent code update from Diffusers, an open-source
    Stable Diffusion package that can enable us to generate AI images using Python.
    Besides, we can freely add and change code according to specific needs.
  prefs: []
  type: TYPE_NORMAL
- en: For a long time, only A1111 Stable Diffusion WebUI can fully support LoRA, And
    now, we can use Python to control Diffusers to load thousands of community-shared
    LoRA and fully automate image generation, this opens a new door to GAI image generation.
  prefs: []
  type: TYPE_NORMAL
- en: 'In summary, the article’s contributions are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Introduced the most simple way (one line code) to load LoRA safetensors file
    into Diffusers Stable Diffusion pipeline.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Provide a simple hacky way to feed LoRA weights during the LoRA loading stage.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: References
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[1] Hugging Face, Low-Rank Adaptation of Large Language Models (LoRA), [https://huggingface.co/docs/diffusers/training/lora](https://huggingface.co/docs/diffusers/training/lora)'
  prefs: []
  type: TYPE_NORMAL
- en: '[2] LowRA, [https://civitai.com/models/48139/lowra](https://civitai.com/models/48139/lowra)'
  prefs: []
  type: TYPE_NORMAL
- en: '[3] Load Kohya-ss style LoRAs with auxiliary states, [https://github.com/huggingface/diffusers/pull/4147](https://github.com/huggingface/diffusers/pull/4147)'
  prefs: []
  type: TYPE_NORMAL
- en: '[4] Simo Ryu(cloneofsimo), lora, [https://github.com/cloneofsimo/lora](https://github.com/cloneofsimo/lora)'
  prefs: []
  type: TYPE_NORMAL
