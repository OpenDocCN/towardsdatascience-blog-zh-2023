- en: Time Series Forecasting with Facebook’s Prophet in 10 Minutes — Part 2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/time-series-forecasting-with-facebooks-prophet-in-10-minutes-part-2-1f558ccc3e83](https://towardsdatascience.com/time-series-forecasting-with-facebooks-prophet-in-10-minutes-part-2-1f558ccc3e83)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Model performance and hyperparameters fine tuning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://guillaume-weingertner.medium.com/?source=post_page-----1f558ccc3e83--------------------------------)[![Guillaume
    Weingertner](../Images/fbfb34af986a7788394b6033c6954d57.png)](https://guillaume-weingertner.medium.com/?source=post_page-----1f558ccc3e83--------------------------------)[](https://towardsdatascience.com/?source=post_page-----1f558ccc3e83--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----1f558ccc3e83--------------------------------)
    [Guillaume Weingertner](https://guillaume-weingertner.medium.com/?source=post_page-----1f558ccc3e83--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----1f558ccc3e83--------------------------------)
    ·9 min read·Apr 25, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/5229e96a7d81abdd74c0b1b14ccefc02.png)'
  prefs: []
  type: TYPE_IMG
- en: Prophet’s output — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: '#1 In the Previous Episode…'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In part 1 we saw how to quickly set up a first working model — in just 6 lines
    of code. See link below:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/time-series-forecasting-with-facebooks-prophet-in-10-minutes-958bd1caff3f?source=post_page-----1f558ccc3e83--------------------------------)
    [## Time Series Forecasting with Facebook’s Prophet in 10 Minutes — Part 1'
  prefs: []
  type: TYPE_NORMAL
- en: Build a working model with 6 lines of code
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/time-series-forecasting-with-facebooks-prophet-in-10-minutes-958bd1caff3f?source=post_page-----1f558ccc3e83--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: But can we really trust what this model spits out?
  prefs: []
  type: TYPE_NORMAL
- en: If so, how good is it? And can we make it better?
  prefs: []
  type: TYPE_NORMAL
- en: Let’s see how to assess the model’s performance, add holidays / special events
    (which can be an important part of a time series) to it and refine its hyper-parameters
    to make it more accurate and trustworthy.
  prefs: []
  type: TYPE_NORMAL
- en: '#2 Train-Test Split'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In order to assess the performance of our model we can either wait for future
    values to happen and compare them to what the model predicted or we can use a
    very common model validation approach which consists of splitting our historical
    data into 2 different datasets:'
  prefs: []
  type: TYPE_NORMAL
- en: A **training set** which is used to fit the model
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A **test set** on which the model will be assessed
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let’s set aside the months of November and December of 2023 as test data and
    train the model on the rest of it (i.e. the training set).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/8fe919db71887506a39dc8e65d219e65.png)'
  prefs: []
  type: TYPE_IMG
- en: Train-Test Split — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: '#3 Perfomance Metrics'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, let’s quickly introduce the metrics we will use to assess the
    performance of our model.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s start with a few quick definitions:'
  prefs: []
  type: TYPE_NORMAL
- en: yᵢ are the actual data points in the test set
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: ŷᵢ are the points which are estimated by the model
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: ȳ is the mean of the test set of the time series
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The combination of the 3 following metrics (MAE, MSE and R-squared) should give
    us a good enough estimation of the model’s performance.
  prefs: []
  type: TYPE_NORMAL
- en: '**1/ Mean Absolute Error (MAE):**'
  prefs: []
  type: TYPE_NORMAL
- en: We calculate the average absolute difference between observed values and predicted
    values of the test data.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/4593cb47069417a5308fd0b598d574f6.png)'
  prefs: []
  type: TYPE_IMG
- en: Mean Absolute Error — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: The MAE is very simple to interpret and tells you that “on average the model
    is off by x amount”.
  prefs: []
  type: TYPE_NORMAL
- en: The MAE is less sensitive to outliers compared to other error metrics, meaning
    that outliers are less penalized.
  prefs: []
  type: TYPE_NORMAL
- en: '**2/ Mean Squared Error (MSE):**'
  prefs: []
  type: TYPE_NORMAL
- en: We calculate the average squared difference between observed values and predicted
    values of the test data.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/1c440070e08141dbb913d3ed1f6b0e1b.png)'
  prefs: []
  type: TYPE_IMG
- en: Mean Squared Error — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: The MSE is not expressed in the same units as the data being predicted, as it
    involves squaring the errors which makes it less easily interpretable than the
    MAE.
  prefs: []
  type: TYPE_NORMAL
- en: However it penalizes larger errors more heavily (due to the squaring operation)
    making it more sensitive to outliers or predictions that deviate significantly
    from actual values.
  prefs: []
  type: TYPE_NORMAL
- en: '**3/ R-squared**'
  prefs: []
  type: TYPE_NORMAL
- en: The coefficient of determination is performance metric rather than an error
    metric. It measures the proportion of the response variable’s variance that is
    accounted for by the predictor variables in the regression model.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/80f437ef6fcb6ed5a8a8100765ab647b.png)'
  prefs: []
  type: TYPE_IMG
- en: R-squared — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: R-squared values range from 0 to 1, with higher values indicating a better fit
    of the model to the data. A value of 1 indicates that the regression model explains
    all of the variability in the response variable, while a value of 0 indicates
    that the model does not explain any of the variability.
  prefs: []
  type: TYPE_NORMAL
- en: '#4 Model’s Performance Out Of The Box'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As we did in Part 1, let’s create a basic, out of the box model. However this
    time, we will fit it on the training set and test its performance on unseen data
    (i.e. the test set).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Let’s plot the basic model and the actual values of the test set on a same
    graph to get a feel for what’s going on:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/d728060cc209ad78107dc8c8fc7e45d1.png)'
  prefs: []
  type: TYPE_IMG
- en: Basic model (in orange) vs actual values (in blue) — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: For a 6-line model, it visually does not look too bad! However, we can clearly
    see that some points are not well captured by the model (outliers / peaks on the
    graph).
  prefs: []
  type: TYPE_NORMAL
- en: To compute the MAE, MSE and R-squared in order to assess the performance of
    the model, we can simply import these metrics from the scikit-learn library. An
    alternative would be to calculate them from scratch, but let’s be lazy here.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'And this is what the metrics of this first basic model look like:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/8635c18c19a409323e004015f7a579a6.png)'
  prefs: []
  type: TYPE_IMG
- en: Basic model performance — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: We can tell that this first model is off, on average, by $123 at each prediction
    (as shown by the MAE) and that the R2 score is at 0.52.
  prefs: []
  type: TYPE_NORMAL
- en: The MSE is hard to interpret for now, but will come into play when compared
    to other models.
  prefs: []
  type: TYPE_NORMAL
- en: '#5 Adding Holidays'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Depending on the business case, adding holidays into the model might be relevant.
    In our case of a fictitious company, we can assume that holidays might have an
    impact on sales.
  prefs: []
  type: TYPE_NORMAL
- en: The Prophet documentation explains quite clearly how to input special holidays
    for the model to take into account.
  prefs: []
  type: TYPE_NORMAL
- en: Let’s add Black Friday and Xmas Eve as special events…
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: …And the regular US holidays into our model.
  prefs: []
  type: TYPE_NORMAL
- en: And do the same training stage as before on this second model.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Let’s plot both models to get an idea of what’s going on:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/3a847f6454c69b7775984a874bb62d5c.png)'
  prefs: []
  type: TYPE_IMG
- en: Model comparisons — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: Visually we can already tell that including the holidays in the model made a
    positive impact as the outliers are taken into account. Let’s check.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/9784a61b25447f68f82445f9c6920a1b.png)'
  prefs: []
  type: TYPE_IMG
- en: Basic model + holidays performance — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: Taking holidays into account in our model was a massive improvement.
  prefs: []
  type: TYPE_NORMAL
- en: The R2 score is up from 0.52 to 0.69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The MAE is down from $123 to $109, meaning the each prediction is wrong by an
    average of $109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The MSE is down significantly as some outliers were likely holidays which are
    now modeled more accurately
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '#6 Fine Tuning the Model’s Hyper-parameters'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Prophet’s documentation is really helpful in explaining which parameters we
    should tune and which ones should stay untouched.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s focus on the 5 most important ones according to the Prophet’s developers
    [1]:'
  prefs: []
  type: TYPE_NORMAL
- en: 1/ **changepoint_prior_scale** — default 0.05
  prefs: []
  type: TYPE_NORMAL
- en: “It determines the flexibility of the trend, and in particular how much the
    trend changes at the trend changepoints”
  prefs: []
  type: TYPE_NORMAL
- en: 2/ **seasonality_prior_scale** — default 10
  prefs: []
  type: TYPE_NORMAL
- en: “This parameter controls the flexibility of the seasonality”
  prefs: []
  type: TYPE_NORMAL
- en: 3/ **holidays_prior_scale** — default 10
  prefs: []
  type: TYPE_NORMAL
- en: “This controls flexibility to fit holiday effects”
  prefs: []
  type: TYPE_NORMAL
- en: 4/ **seasonality_mode** — default ‘additive’
  prefs: []
  type: TYPE_NORMAL
- en: “Options are ‘additive or ‘multiplicative’. Default is ‘additive’ but many business
    time series will have multiplicative seasonality.”
  prefs: []
  type: TYPE_NORMAL
- en: 5/ **changepoint_range** — default 0.8
  prefs: []
  type: TYPE_NORMAL
- en: “This is the proportion of the history in which the trend is allowed to change.”
  prefs: []
  type: TYPE_NORMAL
- en: These parameters have a huge influence on the model’s output. The question is,
    are they set to their optimal values — the values that would yield the lowest
    MAE or MSE and R-squared closest to 1?
  prefs: []
  type: TYPE_NORMAL
- en: The most interesting thing in this section is how we’re tuning these parameters.
    We’ll use Grid Search, which is a very common technique in Machine Learning to
    fine tune the hyper-parameters of a model.
  prefs: []
  type: TYPE_NORMAL
- en: 'The idea is simple: we create a “grid” of a wide range of combinations of hyper-parameters,
    train a model for each combination and test each one to see which model performs
    best.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: When this is done running all we need to do is select the model with either
    the lowest MAE, the lowest MSE or the R-squared closest to 1, depending on which
    criteria is best suited for our business problem.
  prefs: []
  type: TYPE_NORMAL
- en: In my case, the most important thing is not to be off by a large amount at any
    given day, whereas being off by a small amount every day is acceptable. That’s
    why I’m selecting the model with the lowest MSE.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/3e5c79550bb366dff916a12129a71e52.png)'
  prefs: []
  type: TYPE_IMG
- en: Hyper-parameters selection — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: 'So now, let’s use these parameters to build our last, optimized model:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'The green line in the graph below showing the optimized model confirms what
    the table right above highlighted: the predictions of the test data are more accurate
    with this latest model.'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/4bb2e14f3a7fd93f2d06958ae553efb3.png)'
  prefs: []
  type: TYPE_IMG
- en: Comparison of all the models — Image by Author
  prefs: []
  type: TYPE_NORMAL
- en: '#7 Conclusion'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'This methodology (train-test split, adding special events, fine tuning the
    hyper-parameters) provides a basic framework for enhancing our model’s accuracy
    as shown in the table below:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/1325f8a7bab0ee44ba023a2fb18c7aab.png)'
  prefs: []
  type: TYPE_IMG
- en: Summary of the improvements of each model on the 3 metrics we checked
  prefs: []
  type: TYPE_NORMAL
- en: For simplicity’s sake we didn’t do any cross validation, meaning that we assessed
    our model on one test dataset only. One next step would be to integrate cross
    validation in our model assessment process.
  prefs: []
  type: TYPE_NORMAL
- en: Another interesting thing to look at is the possibility to add an extra regressor
    to Prophet — an additional variable that the model could take into account to
    make its forecast.
  prefs: []
  type: TYPE_NORMAL
- en: Useful Resources
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[1] Official Prophet documentation: [https://facebook.github.io/prophet/](https://facebook.github.io/prophet/)'
  prefs: []
  type: TYPE_NORMAL
- en: '[2] Advanced Forecasting with Python: With State-of-the-Art-Models Including
    LSTMs, Facebook’s Prophet, and Amazon’s DeepAR by Joos Korstanje'
  prefs: []
  type: TYPE_NORMAL
- en: '[3] Practical Time Series Analysis: Prediction with Statistics and Machine
    Learning by Aileen Nielsen'
  prefs: []
  type: TYPE_NORMAL
- en: '[4] A useful website explaining Time Series Forecasting and give a quick look
    at Prophet’s equation: [https://otexts.com/fpp3/prophet.html](https://otexts.com/fpp3/prophet.html)'
  prefs: []
  type: TYPE_NORMAL
- en: '*Thanks for reading all the way to the end of the article.'
  prefs: []
  type: TYPE_NORMAL
- en: Follow for more!
  prefs: []
  type: TYPE_NORMAL
- en: Feel free to leave a message below, or reach out to me through* [*LinkedIn*](https://www.linkedin.com/in/guillaume-weingertner-a4a27972/)
    *if you have any questions / remarks!*
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://guillaume-weingertner.medium.com/membership?source=post_page-----1f558ccc3e83--------------------------------)
    [## Join Medium with my referral link - Guillaume Weingertner'
  prefs: []
  type: TYPE_NORMAL
- en: Read every story from Guillaume Weingertner (and thousands of other writers
    on Medium). Your membership fee directly…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: guillaume-weingertner.medium.com](https://guillaume-weingertner.medium.com/membership?source=post_page-----1f558ccc3e83--------------------------------)
  prefs: []
  type: TYPE_NORMAL
