# SQL 查询优化的世界

> 原文：[https://towardsdatascience.com/the-world-of-sql-query-optimization-e1d5b5fef20d](https://towardsdatascience.com/the-world-of-sql-query-optimization-e1d5b5fef20d)

![](../Images/83a4adc3c26c7145297a344045db80f7.png)

照片由[Jake Blucker](https://unsplash.com/@jakeblucker?utm_source=medium&utm_medium=referral)拍摄，发布在[Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)上。

## 数据工程

## 一窥不同的查询优化器及其工作原理

[](https://kovidrathee.medium.com/?source=post_page-----e1d5b5fef20d--------------------------------)[![Kovid Rathee](../Images/2bad5143febe95d28d0cf19698c5c976.png)](https://kovidrathee.medium.com/?source=post_page-----e1d5b5fef20d--------------------------------)[](https://towardsdatascience.com/?source=post_page-----e1d5b5fef20d--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----e1d5b5fef20d--------------------------------) [Kovid Rathee](https://kovidrathee.medium.com/?source=post_page-----e1d5b5fef20d--------------------------------)

·发布于[Towards Data Science](https://towardsdatascience.com/?source=post_page-----e1d5b5fef20d--------------------------------) ·6分钟阅读·2023年3月27日

--

SQL 是一种简单的语言，规则非常少，这使得它如此受欢迎。它还具有大量的关键字和功能，让你以各种方式与数据进行交互。随着这种灵活性，查询编写风格和选择也会有很大的差异。

一旦你向数据库发出查询，它必须解析你的查询以理解其流程，但这并不是数据库工作的结束。数据库引擎还有一个组件用于查看你的查询，并在不改变其功能的情况下，进行重写，以实现更好的性能和响应时间。这个强大的组件，毫不意外，被称为**查询优化器**。

但是优化器如何重写查询呢？它有哪些额外的信息来源来处理查询？这些问题的答案可以将不同类型的查询优化器进行分类。广义上说，以下提到的有**四种查询优化技术**：

+   **基于启发式的优化**根据数据库中预定义的规则进行操作，例如，优先使用聚集索引。

+   **基于成本的优化**根据查询成本估算来工作，包括估算查询可能使用的资源成本。

+   **混合优化**结合了基于启发式的方法和基于成本的方法。*大多数关系数据库使用这种技术*。

+   **自适应优化**与上述所有技术不同，它在查询执行过程中改变查询执行计划。这在分布式系统中非常有用。

在2008年计算机科学学位的第二年，当我在学习数据库管理系统时，尽管我对数据库有一定的兴趣，但直到后来我才真正意识到查询优化和数据库性能调优技术在我的工作中将会有多么重要。我可以证明，理解特定数据库的查询优化器是[编写高效SQL查询](/how-to-avoid-writing-sloppy-sql-43647a160025)的最有趣和最有用的技能。这会带来巨大的差别。

让我们更详细地了解一下不同类型的查询优化器。

# 基于启发式的优化

基于启发式的查询优化，也称为基于规则的查询优化，使用一组*经验法则*和*核心原则*来确定执行查询的最有效方式，通过重新排列构成查询树的关系代数操作（查询的内部表示）。

我相信你一定听说过在SQL工程师中流行的讨论：*我连接表的顺序是否重要？* 这个问题的简短回答是既重要又不重要。重要，因为顺序确实很重要，但不重要，因为优化器在解析后会修正查询。

让我们以优化查询的最常见示例为例——使用`WHERE`子句。现在，*经验法则*是你应该尽早进行*选择*。这是因为如果你在处理过程中尽早过滤掉不需要的数据，你也会限制需要连接、排序和分组的数据量。

一些关于特定类型的连接、CTE、排序等的规则可以被称为启发式，因此得名启发式优化。优化SQL查询不仅仅涉及关系代数和启发式，还要考虑你使用的是哪个数据库以及你使用的是哪种SQL方言等因素。

请注意，这种查询优化方法纯粹是理论上的，并未考虑数据库统计信息中的大量实际世界信息，这也是为什么你不会看到数据库仅使用这种优化方法来优化你的SQL查询。它们还会考虑基于成本的查询优化，我们将在下一节中讨论这一点。

# 基于成本的优化

这种方法采取了更实际的优化方法。它考虑了内存、CPU、网络等的约束条件，以及数据库维护的数据统计信息，如行数、平均行大小、表大小等。

虽然基于启发式的优化会根据经验法则重新排序查询树，但基于成本的优化则涉及评估几个查询执行计划，并根据执行查询的估算成本选择其中最优的一个。这个成本包括估算的时间、扫描的行数、使用的索引数量等。

由于基于成本的优化需要评估多个查询执行计划，因此可能需要更多时间来制定正确的执行计划。优化器也可能因为收集和分析数据库统计数据的开销而变得缓慢。然而，它通常比基于启发式的优化更有效。

大多数数据库不仅仅使用基于成本的优化器。它们通常采用混合方法，大部分优化基于成本，其余部分基于启发式方法、用户提示等。Snowflake的Jiaqi Yan在[CMU DB隔离技术讲座的一场会议中](https://youtu.be/CPWn1SZUZqE?t=1051)谈到了这一点。在下一部分中，我们将通过一些示例，看看混合查询优化是如何工作的。

*混合查询优化方法考虑了基于启发式的优化和基于成本的优化，并制定了一个平衡的查询优化计划。我们不会深入探讨混合查询优化的具体细节，因为不同数据库之间的实现差异很大。*

# 自适应查询优化

到目前为止，我们讨论了查询优化技术，这些技术仅在查询执行开始之前查看并改进查询执行计划。自适应查询优化是一种在查询执行过程中尝试改进计划的查询优化类型。这种用例可能对你来说很明显——分布式数据处理系统和处理大量数据以及高并发的查询引擎。

当你处理长时间运行的查询时，自适应查询优化的效果尤其显著，这些查询的处理任务被划分为多个作业分配给集群中的不同计算节点（无论技术是什么——Redshift、Snowflake、Databricks等）。数据的显著偏斜、不良的分区以及文件格式等问题，可能会使查询变慢。

自适应查询优化在查询执行过程中会关注这些问题以及更多问题。它还会查看查询的预期表现以及实际表现，借助多种指标来进行评估。通过这样的系统，查询引擎可以在查询执行时调整单个查询计划工作流或整个查询计划。

越来越多的数据库，特别是那些具备分布式数据处理能力的数据库，将最终使用某种版本的自适应查询优化，因为它解决了许多耗时的性能优化问题，例如确保数据均匀分布、根据内存和计算资源的可用性确保最佳分区大小等。我强烈推荐查看我在参考资料中分享的Databricks Data+AI 2020会议的相关内容。它对自适应查询优化的内部实现提供了一些实际的见解。

# 结论

这篇文章探讨了在各种数据库、数据仓库和数据处理引擎中使用的不同类型的查询优化器。了解优化器的类型对于数据工程中的查询优化和性能调优至关重要。随着规模的扩大，调优变得越来越困难。通过深入了解优化器，你将能够理解它的工作原理，以及如何调整其输出以满足你的需求和要求。

想想其他类型的空间和时间优化在应用中的想法，例如垃圾回收、缓存等。理解查询优化器为数据工程师带来的好处，与理解上述概念给软件开发者带来的好处类似。

# 参考文献

1.  [优化技术，数据库设计 424，马里兰大学](http://www.cbcb.umd.edu/confcour/Spring2014/CMSC424/query_optimization.pdf)

1.  [查询优化，数据库 II，CP 465，威尔弗里德·劳里埃大学](https://web.wlu.ca/science/physcomp/ikotsireas/CP465/W2-QueryOptimization/Query_Optimization.pdf)

1.  [关系查询优化，CS 3200，东北大学](https://www.ccs.neu.edu/home/kathleen/classes/cs3200/19-QOptimize.pdf)

1.  [MySQL 8.0 参考手册 — 优化概述](https://dev.mysql.com/doc/refman/8.0/en/optimize-overview.html)

1.  [PostgreSQL 内部概述 — 规划器/优化器](https://www.postgresql.org/docs/current/planner-optimizer.html)

1.  [Databricks 自适应查询执行 — Data+AI 峰会 2020](https://www.youtube.com/watch?v=jzrEc4r90N8)

如果你觉得这篇文章有用，请订阅并查看我在 🌲 [**Linktree**](https://linktr.ee/kovid) 上的所有作品。你还可以考虑通过使用我的推荐链接 [**购买 Medium 会员**](https://kovidrathee.medium.com/membership) 来支持我。谢谢！
