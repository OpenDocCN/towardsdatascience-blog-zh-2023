# 如何使用 Python 构建 ELT

> 原文：[https://towardsdatascience.com/how-to-build-an-elt-with-python-8f5d9d75a12e](https://towardsdatascience.com/how-to-build-an-elt-with-python-8f5d9d75a12e)

## 提取、加载和转换数据

[](https://medium.com/@marietruong?source=post_page-----8f5d9d75a12e--------------------------------)[![Marie Truong](../Images/2816e49beef958724dc0f38cfa49c4be.png)](https://medium.com/@marietruong?source=post_page-----8f5d9d75a12e--------------------------------)[](https://towardsdatascience.com/?source=post_page-----8f5d9d75a12e--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----8f5d9d75a12e--------------------------------) [Marie Truong](https://medium.com/@marietruong?source=post_page-----8f5d9d75a12e--------------------------------)

·发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----8f5d9d75a12e--------------------------------) ·阅读时间 7 分钟·2023年2月7日

--

![](../Images/3bb2cf8a93d38e55adefa041419b80d8.png)

图片由 [JJ Ying](https://unsplash.com/@jjying?utm_source=medium&utm_medium=referral) 提供，来源于 [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

ELT（提取、加载、转换）是一种现代的数据集成方法，与 ETL（提取、转换、加载）略有不同。ETL 在将数据加载到数据仓库之前进行转换，而 ELT 则将原始数据直接加载到数据仓库中，并使用 SQL 进行转换。

构建 ELT 是数据和分析工程师工作中非常重要的一部分，它也可以成为数据分析师和科学家更广泛领域的有用技能，或者是那些构建完整作品集的求职者。

在这篇文章中，我们将使用来自 [dummyJSON](https://dummyjson.com/) 的数据在 Python 中构建一个简短的 ELT 管道。dummyJSON 是一个虚假的 REST API，提供 9 种类型的资源：

![](../Images/63f9d7d997ffb2a73d9b21d5c41a3987.png)

dummyjson.com 的截图

我们将尝试找出哪些客户在我们的虚拟商店中花费了最多的钱。

这个脚本将包括 3 个步骤：

1.  从 dummyJSON API 提取数据

1.  将原始数据加载到 BigQuery

1.  执行查询以进行分析

让我们开始构建我们的数据管道吧！

# 提取数据

我们需要从 API 中检索 2 个资源：购物车和用户。

让我们创建一个函数，执行 API 调用并返回 JSON 数据：

[PRE0]

我们使用 **requests** 库来发出简单的 HTTP GET 请求。我们通过状态码检查请求是否成功，并返回 JSON 数据。

[PRE1]

我们已经有了关于订单的数据！让我们尝试获取客户数据：

[PRE2]

这次，有些事情引起了我们的注意：总共有 100 个用户，但我们只收到了 30 个。

![](../Images/07b7c1c7143edc8e7c90c6a6d51785af.png)

作者截图

因此，我们需要再次调用那个API，直到我们获取所有数据，跳过我们已经拥有的数据。然而，我们不希望将那些*total*、*skip*和*limit*键发送到数据仓库；让我们只保留用户和购物车。

这是我们更新后的函数：

[PRE3]

这一次，我们有了100个用户！

# 加载数据

现在，是时候将数据上传到BigQuery了。我们将使用[BigQuery Python客户端库](https://cloud.google.com/bigquery/docs/reference/libraries)。

![](../Images/67f493aa3d84f23c718c80a2abbb3f57.png)

来源：[cloud.google.com/bigquery/docs/batch-loading-data](http://cloud.google.com/bigquery/docs/batch-loading-data)

从文档中可以看到，可以将本地文件加载到BigQuery中。目前，我们的JSON只是一个字典。让我们将其下载到本地文件中。

我们将使用原生库**json**并将JSON数据写入文件。需要记住的是，BigQuery接受换行符分隔的JSON格式，而不是逗号分隔格式。

[PRE4]

我们现在可以检查我们的carts.json文件是否为正确的JSON格式：

[PRE5]

现在让我们尝试上传我们的文件！

首先，我们需要[下载Python客户端库](https://cloud.google.com/bigquery/docs/reference/libraries)。

完成后，我们需要[下载服务账户密钥](https://cloud.google.com/bigquery/docs/authentication/service-account-file)并创建一个环境变量，以告诉BigQuery我们的凭证存储在哪里。在终端中，我们可以输入以下命令：

[PRE6]

然后，我们可以编写Python函数。幸运的是，BigQuery文档为我们提供了代码示例：

![](../Images/a98dd38fd0458a0b7c93aabaac288d7e.png)

作者截图

我们可以使用这个示例定义一个新函数：

[PRE7]

[PRE8]

我们告诉BigQuery每次都截断我们的表格，因此如果我们重新运行脚本，现有行将被覆盖。

我们现在在BigQuery中有了我们的两个表：

![](../Images/40a669a1e0ec8bdd1355a5b43bfad3de.png)

作者截图

# 转换数据

现在是时候进入ELT中的最后一部分了！

我们希望有一个包含用户及其在我们商店消费金额的表格。

让我们连接两个表格以获取这些信息：

[PRE9]

![](../Images/1c71b7052b8f3a7a0b7f59703d641317.png)

作者截图

看来Trace Douglas是我们的最高消费者！让我们将这个表格作为ELT的一部分添加。

[PRE10]

我移除了ORDER BY，因为这在计算上很昂贵；我们仍然可以在查询**dummy_best_spenders**表时对结果进行排序。

让我们检查一下我们的表格是否已创建：

![](../Images/24a0e10ad92790fc0311bb985ba07139.png)

作者截图

就这样，我们用几行代码完成了第一个ELT！

# 进一步探索ELT

在处理实际和更大的项目时，还有一些其他事项需要考虑：

+   我们将处理更大的数据量。每天都有新数据，所以我们必须逐步追加数据到表格中，而不是每天处理所有数据。

+   -   随着我们的 ELT 变得越来越复杂，涉及多个数据源，我们可能需要使用像 Airflow 或 Prefect 这样的工作流编排工具。

+   -   我们只能将小于 10MB 的文件直接加载到 BigQuery 中。要加载更大的文件，我们需要先将其加载到 Cloud Storage 中。

# -   资源

+   [BigQuery 客户端库](https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.client.Client)

+   -   [Requests: HTTP for Humans](https://requests.readthedocs.io/en/latest/)

+   [JSON 编码器和解码器](https://docs.python.org/3/library/json.html)

-   希望你喜欢这篇文章！如果你喜欢，请关注我获取更多关于 Python、SQL 和分析的内容。

-   成为会员并阅读 Medium 上的所有故事。你的会员费用将直接支持我和你阅读的其他作者。你还将获得对 Medium 上每个故事的完全访问权限。

-   [## 通过我的推荐链接加入 Medium — Marie Truong](https://medium.com/@marietruong/membership?source=post_page-----8f5d9d75a12e--------------------------------)

### -   阅读 Marie Truong（以及 Medium 上其他成千上万位作者）的每个故事。你的会员费用直接支持…

-   [medium.com](https://medium.com/@marietruong/membership?source=post_page-----8f5d9d75a12e--------------------------------)
