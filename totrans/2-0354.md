# 回填精通：提升数据工程专业技能

> 原文：[https://towardsdatascience.com/backfilling-mastery-elevating-data-engineering-expertise-a6873fb7ed2e](https://towardsdatascience.com/backfilling-mastery-elevating-data-engineering-expertise-a6873fb7ed2e)

## 数据工程

## 数据工程师应对回填难题的实用指南

[](https://tamimi-naser.medium.com/?source=post_page-----a6873fb7ed2e--------------------------------)[![纳赛尔·塔米米](../Images/8d43c66ea3c0ef9b49c7d33dbc008c28.png)](https://tamimi-naser.medium.com/?source=post_page-----a6873fb7ed2e--------------------------------)[](https://towardsdatascience.com/?source=post_page-----a6873fb7ed2e--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----a6873fb7ed2e--------------------------------) [纳赛尔·塔米米](https://tamimi-naser.medium.com/?source=post_page-----a6873fb7ed2e--------------------------------)

·发布于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----a6873fb7ed2e--------------------------------) ·阅读时长7分钟·2023年11月17日

--

![](../Images/ca03f6688b8f11402878f079d3beac93.png)

图片由 [Towfiqu barbhuiya](https://unsplash.com/@towfiqu999999?utm_source=medium&utm_medium=referral) 提供，来源于 [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

# 什么是回填？

想象一下，你刚开始一个新的数据管道，从一个你之前没有解析过的来源获取数据（例如，从API或现有的Hive表中提取信息）。现在，你的任务是让它看起来像你很久以前就收集了这些数据。这就是我们在数据工程中所说的数据回填的一个例子。

但这不仅仅是启动一个新的数据管道或表。你可能有一个已经收集数据一段时间的表，而突然你需要更改数据（例如由于新的指标定义），或者从新的数据源中添加更多数据。或者你的数据中可能有一个尴尬的空白，你只是想修补它。所有这些情况都是数据回填的例子。共同的特点是“回到”过去，并用一些历史数据“填补”你的表格。

下图（图1）展示了一个简单的回填场景。在这个实例中，一个每日任务从两个上游来源（一个是平台A，另一个是平台B）检索数据。数据集的结构是第一个分区为‘ds’，第二个分区（或子分区）代表平台。不幸的是，由于某些问题，从2023年10月3日到2023年10月5日的数据缺失。为了弥补这一空缺，启动了回填操作（回填任务于2023年10月8日开始）。

![](../Images/775860d0506ae23c029144b6f6afef9b.png)

图1）一个简单的回填场景

# 回填与重述

在继续之前简要说明一下：在数据工程领域，我们通常会遇到两种情况：“回填”一个表格或“重述”一个表格。这些过程虽然有些相似，但也存在一些微妙的差异。回填是指在数据集中填充缺失或不完整的数据。它通常用于更新历史数据或修正数据缺口。相反，重述表格涉及对表格的内容或结构进行重大修改。这种转换通常是为了纠正错误、更新数据模型或对数据集进行重大更改。为了简化起见，考虑到这些术语的微妙差异，在本文中我们将这两种过程统称为“回填”。

值得一提的是，不同的工程师可能对这些过程的称谓有所不同。

# 让我们谈谈设计

让我们深入探讨一下。你正在设计新的表格模式并规划 ETL 过程。一定要认真考虑回填。因此，花点时间问问自己：我的设计是否适用于常规（主要是每日）任务以及处理未来回填任务？当需要填补缺失数据时，我是否能够轻松完成，还是每次修复时都要经历繁琐的手动步骤？

有时你需要在设计中找到一个平衡点。你希望系统运行顺畅，不仅仅是处理日常数据流，也要在修复数据集中的任何缺口时同样顺畅。因此，现在对设计多加关注，可以为将来节省不少麻烦！

例如，你可能会认为，如果你对这个表格进行回填，你需要覆盖之前的数据而不是追加数据。在这种情况下，如果你使用的是 Hive 表格，也许 Hive 分区可以帮助你更轻松地实现这个目标。在这种情况下，你可以根据日期（通常称为“ds”）定义一个分区，并将你的 ETL 更改为覆盖该分区而不是追加到其中。采用这种模式设计，每次你在表格上写入数据时，之前的分区（在这种情况下是之前的“ds”日期）将被移除，并用新数据替换。然而，你可能会预见到每次回填可能只需要影响“ds”的一部分。例如，查看图1和ds=2023–10–05。在这种情况下，部分数据成功加载，而部分数据加载失败。在这种情况下，你可以定义一个辅助分区（如果需要，也可以定义三级分区）来支持对未来某一特定日期的部分回填。同时，你也希望尽可能保持分区数量较低，以避免小分区（这可能导致数据处理效率低下）。

另一种有效的策略是将新回填的数据写入一个不同的分区位置，而不是覆盖磁盘上的现有分区位置。这可以通过例如在分区位置路径中引入一个独特的 runtime_id 目录来实现。随后，将 Hive 元数据存储中的分区位置从旧路径更新到新路径。这种方法允许保留以前的数据（作为预防措施），同时仍然能够更新整个分区。以下文件夹结构是我们如何使用 runtime_id 在同一表位置下保持不同版本的回填的示例。请记住，这种技术要求你的 ETL 更新 Hive 元数据存储数据库中的分区位置。

[PRE0]

此外，除了你常规的（例如每日的）工作流外，你可能还需要开发一个准备就绪的回填工作流，以应对需要回填数据的情况。例如，如果你使用 Apache Airflow，你可以有一个每日的 DAG 处理你的常规调度数据加载任务，并为回填数据设置一个单独的 DAG。在这种情况下，如果发生需要快速回填数据的情况，你将有一个现成的 DAG 可以使用。

# 开始回填

你精心设计了表模式和 ETL 管道，预见到未来需要进行数据回填。现在，经过几天、几周，甚至几个月，期待已久的数据回填时刻终于到来了。但你应该采取什么步骤？这是否仅仅是运行你的回填工作流/DAG 来处理指定日期范围，还是在点击回填按钮之前需要更仔细的考虑？

不幸的是，设计并不是唯一需要克服的挑战。回填过程本身可能相当复杂。首先，你必须确保回填是可行的。例如，某些 API 可能不支持超出特定回溯期的历史数据，而一些源表由于隐私限制可能不会保留较长时间的数据。确认你的特定时间范围内回填是否可行是至关重要的。

现在，假设幸运站在你这边，数据可用性没有问题。下一步要考虑的是你的表格用户。添加或修改数据，特别是历史数据，可能会影响下游用户。负责任的数据工程师会考虑这些行为对产品用户的影响，并尊重他们的体验。在某些情况下，提前通知下游用户回填操作可能是必要的，以便他们获取最新的数据。此外，你还需要评估列的变化如何影响其他表格。在开放的编码生态系统中，工程师可以合作检查其他项目和数据管道以进行验证。如果下游用户依赖于即将修改的列，评估影响并探索替代方案（如扩展表格而不是改变列逻辑）是至关重要的。你能协助他们更新ETL逻辑，还是应该将他们引导到替代数据源？

从本质上讲，对你和你的团队所负责的内容展示责任感，是区分优秀工程师与效果较差工程师的关键。

# 验证

现在你的回填工作已经完成，下一步至关重要的是验证。使用一些基本技术可以加快验证过程。

首先，验证回填过程的完成是至关重要的。有时，即使看起来回填作业已经成功执行，错误的参数可能导致没有实际更新或数据写入表格。因此，在验证回填数据之前，必须确认回填过程成功执行。在表格中引入一个捕获处理时间戳的特定列可以帮助验证数据是否已最近更新。或者，检查与新分区位置关联的`runtime_id`也是一种方法。正如设计部分所述，在分区路径中包含可选的`runtime_id`允许直接检查表路径。这可以简便地识别回填操作后是否创建了新的`runtime_id`文件夹。

如果你的回填工作使用了源表来填补空白，最直接的方法是从源表中聚合指标，并与目标表进行比较。编写一个复制ETL逻辑的查询可以进行全面的比较，尽管这可能需要一些时间和精力。然而，这个查询有双重作用，不仅有助于即时验证，还作为未来检查的有价值工具。建议在你的ETL文档中记录并存储这些查询，以便持续使用。

在补填仅集中在某些列而未向表中引入新行的情况下，额外的验证方法包括检查未更改列与其之前状态的比较。例如，评估这些列在补填前后的总和可以确保未对未受影响的区域进行任何非预期的更改。

# 摘要

总结一下，这篇文章介绍了一些数据工程中的最佳补填实践。我们分解了补填和重新声明表之间的区别。同时，强调了智能设计在处理常规任务和补填工作中的重要作用。我们解决了补填过程中的难题，例如数据可用性以及保持下游伙伴的信息通畅。最后，我们提到数据工程师需要关注其更改对下游用户的影响，并在需要补填时负责任地行动。
