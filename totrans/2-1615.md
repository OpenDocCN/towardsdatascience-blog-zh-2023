# 主成分分析与霍特林T2及SPE/DmodX方法的异常值检测

> 原文：[https://towardsdatascience.com/outlier-detection-using-principal-component-analysis-and-hotellings-t2-and-spe-dmodx-methods-625b3c90897](https://towardsdatascience.com/outlier-detection-using-principal-component-analysis-and-hotellings-t2-and-spe-dmodx-methods-625b3c90897)

## 由于PCA的敏感性，它可以用于检测多变量数据集中的异常值。

[](https://erdogant.medium.com/?source=post_page-----625b3c90897--------------------------------)[![Erdogan Taskesen](../Images/8e62cdae0502687710d8ae4bbcd8966e.png)](https://erdogant.medium.com/?source=post_page-----625b3c90897--------------------------------)[](https://towardsdatascience.com/?source=post_page-----625b3c90897--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----625b3c90897--------------------------------) [Erdogan Taskesen](https://erdogant.medium.com/?source=post_page-----625b3c90897--------------------------------)

·发表于[Towards Data Science](https://towardsdatascience.com/?source=post_page-----625b3c90897--------------------------------) ·阅读时长11分钟·2023年3月11日

--

![](../Images/c6d1216a283cf22c5bca9061dca4820b.png)

照片由[Andrew Ridley](https://unsplash.com/@aridley88?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)提供，拍摄于[Unsplash](https://unsplash.com/photos/jR4Zf-riEjI?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

主成分分析（PCA）是一种广泛使用的降维技术，能够在保持相关信息的同时减少维度。由于其敏感性，它也可以用于检测多变量数据集中的异常值。异常值检测可以为异常情况提供早期预警，允许专家在问题升级之前识别和解决问题。然而，由于高维度和缺乏标签，在多变量数据集中检测异常值可能具有挑战性。PCA在异常值检测中提供了几个优势。***我将描述使用PCA进行异常值检测的概念。通过实际示例，我将展示如何为连续和分类数据集创建一个无监督模型来检测异常值。***

## 异常值检测。

异常值可以通过***单变量***或***多变量***方法建模（见图1）。在单变量方法中，异常值是通过对一个变量进行数据分布分析来检测的。有关单变量异常值检测的更多详细信息，请参阅以下博客文章[1]：

[](/outlier-detection-using-distribution-fitting-in-univariate-data-sets-ac8b7a14d40e?source=post_page-----625b3c90897--------------------------------) [## 单变量数据集中的分布拟合异常值检测

### 了解如何使用概率密度函数检测离群点，以获得快速且轻量的模型和可解释的结果。

towardsdatascience.com](/outlier-detection-using-distribution-fitting-in-univariate-data-sets-ac8b7a14d40e?source=post_page-----625b3c90897--------------------------------)

多变量方法使用多个特征，因此可以检测具有（非）线性关系或偏斜分布的离群点。scikit-learn库有多种多变量离群点检测解决方案，例如一类分类器、孤立森林和局部离群因子[2]。***在这篇博客中，我将专注于使用主成分分析[3]进行多变量离群点检测，其自身具有可解释性等优点；离群点可以通过主成分分析的降维得到可视化。***

![](../Images/fc58358d39954cd5542e2f58f431be9f.png)

图1\. 单变量与多变量分析在离群点检测中的概述。*多变量数据集的离群点检测将在此博客中描述（*图像由作者提供）。

## 异常与新颖性

***异常与新颖性***是与标准/预期行为偏离的观察结果，也称为离群点。尽管有一些不同：***异常是之前见过的偏差***，通常用于检测欺诈、入侵或故障。***新颖性是之前未见过的偏差***，用于识别新的模式或事件。在这种情况下，使用领域知识非常重要。由于什么是正常或预期的定义可以是主观的并且基于应用而有所不同，因此检测异常和新颖性都可能具有挑战性。

# 主成分分析用于离群点检测。

主成分分析（PCA）是一种线性变换，它减少了数据的维度并寻找数据中方差最大的方向。由于这种方法的特性，它对具有不同值范围的变量以及离群点都很敏感。一个优点是它允许在二维或三维散点图中可视化数据，使得更容易直观地确认检测到的离群点。此外，它提供了对响应变量的良好解释性。PCA的另一个重大优点是它可以与其他方法结合使用，例如不同的距离度量，以提高离群点检测的准确性。在这里，我将使用包含两种离群点检测方法的PCA库：Hotelling’s T2 和 SPE/DmodX。有关更多细节，请阅读关于主成分分析和`pca`库的博客文章[3]。

[](/what-are-pca-loadings-and-biplots-9a7897f2e559?source=post_page-----625b3c90897--------------------------------) [## 什么是PCA负荷和如何有效使用Biplots?

### 主成分分析的实用指南

[towardsdatascience.com](/what-are-pca-loadings-and-biplots-9a7897f2e559?source=post_page-----625b3c90897--------------------------------)

*如果你觉得这篇关于异常值检测的文章对你有帮助，* [*关注我*](http://erdogant.medium.com/) *以保持最新内容！通过我的* [*推荐链接*](https://medium.com/@erdogant/membership) *来支持这篇内容，这将为你提供Medium会员无限制的学习和阅读。*

# 连续随机变量的异常值检测。

让我们从一个示例开始，演示如何使用[Hotelling’s T2](https://erdogant.github.io/pca/pages/html/Outlier%20detection.html#)和[SPE/DmodX](https://erdogant.github.io/pca/pages/html/Outlier%20detection.html#spe-dmodx)进行连续随机变量的异常值检测。我将使用来自sklearn的*wine dataset*，该数据集包含178个样本，13个特征和3个葡萄酒类别[4]。

[PRE0]

[PRE1]

我们可以在数据框中看到每个特征的值范围差异很大，因此归一化步骤很重要。归一化步骤是[*pca library*](https://erdogant.github.io/pca/)中的一个内置功能，可以通过`normalize=True`设置。在初始化时，我们可以分别指定异常值检测方法，`ht2`用于Hotelling’s T2，`spe`用于SPE/DmodX方法。

[PRE2]

运行fit函数后，*pca*库会对每个样本进行异常值评分。对于每个样本，会收集多个统计数据，如下面代码部分所示。数据框中的前四列（`y_proba`、`p_raw`、`y_score`和`y_bool`）是使用Hotelling’s T2方法检测的异常值。后两列（`y_bool_spe`和`y_score_spe`）则基于SPE/DmodX方法。

[PRE3]

**Hotelling’s T2** 计算了基于前`n_components`的卡方检验和P值，从而允许通过`y_proba`对异常值进行从强到弱的排序。请注意，异常值的搜索空间是PC1到PC5，因为预期最高的方差（因此也是异常值）会出现在前几个组件中。注意，深度是可选的，以防方差在前五个组件中捕捉得不好。让我们为葡萄酒数据集绘制异常值并标记它们（图2）。

[PRE4]

![](../Images/5face2d00a99585174c9763e0781b358.png)

图2。左面板：PC1与PC2的关系图以及使用Hotelling’s T2方法检测的9个异常值的投影样本。右面板：带有异常值的三维图。（图片由作者提供）

**SPE/DmodX**方法是实际观察值与其投影之间的距离度量，使用主成分。距离中心的值由Hotelling’s T2值表示，因此图3中的椭圆表示样本超出Hotelling’s T2的边界。样本根据前两个主成分的均值和协方差被标记为异常值（图3）。换句话说，当它在椭圆之外时。

[PRE5]

![](../Images/5e7d7da4b6d17b425f16dec0e34c7849.png)

图3A. 使用SPE/DmodX方法检测到的离群值用菱形标出。使用Hotelling T2方法检测到的离群值用十字标出。（作者提供的图像）

![](../Images/facf901d760aad88afe6e75c4c8c98a7.png)

图3B. 使用SPE/DmodX方法检测到的离群值在3D图中可视化。

使用两种方法的结果，我们现在也可以计算重叠情况。在这种用例中，有5个离群值重叠（*见下方代码部分*）。

[PRE6]

# 分类变量的离群值检测。

对于分类变量中的离群值检测，我们首先需要对分类变量进行离散化，使得距离可以互相比较。通过离散化的数据集（独热编码），我们可以使用PCA方法，并应用Hotelling’s T2和SPE/DmodX方法。我将使用学生成绩数据集[5]进行演示，该数据集包含649个样本和33个变量。我们将按照*下方的代码部分*导入数据集。关于列描述的更多细节可以在[这里](https://archive.ics.uci.edu/ml/datasets/student+performance)找到。如果数据集中存在标识符列或浮点类型的变量，我会将其删除或将其分类为离散区间，但在这里不会删除任何列。

[PRE7]

变量需要进行独热编码，以确保变量之间的距离可以相互比较。这会导致649个样本产生177列（见下方`code`部分）。

[PRE8]

我们现在可以使用处理后的独热数据框作为PCA的输入并检测离群值。在初始化过程中，我们可以设置`normalize=True`以对数据进行标准化，并且需要指定离群值检测方法。

[PRE9]

Hotelling T2检验检测到85个离群值，SPE/DmodX方法检测到6个离群值（图4，见图例）。两个方法重叠的离群值数量为5个。我们可以使用`biplot`功能绘制图形，并将样本根据任何类别（例如`sex`标签）进行着色，以便进一步调查。离群值用`x`或`*`标记。这是进行深入检查的良好起点；在我们的案例中，我们可以在图4中看到这5个离群值与其他所有样本逐渐分离。我们可以对离群值进行排名，查看载荷，并深入调查这些学生（*见前述代码部分*）。为了对离群值进行排名，我们可以使用Hotelling T2方法的`y_proba`（值越低越好），以及SPE/DmodX方法的`y_score_spe`（值越大越好，它是样本到中心的欧几里得距离）。

[PRE10]

![](../Images/93736b498cc6ba780d1e90dad2f20c35.png)

图4. 使用SPE/DmodX方法检测到的离群值用菱形标出。使用Hotelling T2方法检测到的离群值用十字标出。（作者提供的图像）

# 结束语。

我展示了如何使用 PCA 对连续和分类变量进行多变量异常值检测。通过使用*pca*库，我们可以使用 Hotelling 的 T2 和/或 SPE/DmodX 方法来确定候选异常值。每个变量对主成分的贡献可以通过负载获取，并在低维 PC 空间中使用双变量图进行可视化。这些可视化见解有助于提供关于异常值检测的直觉，并判断是否需要后续分析。一般来说，异常值检测可能具有挑战性，因为确定什么被认为是正常的可能是主观的，并且根据具体应用而有所不同。

*保持安全，保持冷静。*

***干杯，E.***

*如果你觉得这篇关于异常值检测的文章对你有帮助，* [*关注我*](http://erdogant.medium.com/) *以便了解我最新的内容！通过使用我的* [*推荐链接*](https://medium.com/@erdogant/membership) *支持这篇内容，这将为你提供 Medium 会员的无限学习和阅读机会。*

## 软件

+   [PCA Github/文档](https://erdogant.github.io/pca/)

+   [PCA 笔记本示例](https://erdogant.github.io/pca/pages/html/Documentation.html#colab-notebook)

## 让我们联系！

+   [让我们在 LinkedIn 上联系](https://www.linkedin.com/in/erdogant/)

+   [关注我的 Github](https://github.com/erdogant)

+   [关注我的 Medium](https://erdogant.medium.com/)

## 参考资料

1.  E. Taskesen, [*PCA 负载和双变量图是什么？*](/what-are-pca-loadings-and-biplots-9a7897f2e559)，Medium，Towards Data Science，2022年4月

1.  Scikit-Learn，[*异常值检测*](https://scikit-learn.org/stable/modules/outlier_detection.html)。

1.  E. Taskesen，[*如何为你的数据找到最佳理论分布*](/how-to-find-the-best-theoretical-distribution-for-your-data-a26e5673b4bd)，2023年2月 Medium。

1.  Wine 数据集，[*https://archive-beta.ics.uci.edu/dataset/109/wine*](https://archive-beta.ics.uci.edu/dataset/109/wine)

1.  P. Cortez 和 A. Silva，[*利用数据挖掘预测中学生表现*](https://archive-beta.ics.uci.edu/dataset/320/student+performance)*，ISBN 978–9077381–39–7*
