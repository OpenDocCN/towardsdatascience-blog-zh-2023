- en: Identifying New and Returning Customers in BigQuery using SQL
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/identifying-new-and-returning-customers-in-bigquery-using-sql-81f44c9e3598](https://towardsdatascience.com/identifying-new-and-returning-customers-in-bigquery-using-sql-81f44c9e3598)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: To better understand your customer's interests and behaviors, as well as to
    improve your marketing strategy
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://romaingranger.medium.com/?source=post_page-----81f44c9e3598--------------------------------)[![Romain
    Granger](../Images/ef3e5fa4f2e35f822830ed803df2cef2.png)](https://romaingranger.medium.com/?source=post_page-----81f44c9e3598--------------------------------)[](https://towardsdatascience.com/?source=post_page-----81f44c9e3598--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----81f44c9e3598--------------------------------)
    [Romain Granger](https://romaingranger.medium.com/?source=post_page-----81f44c9e3598--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----81f44c9e3598--------------------------------)
    ·8 min read·Jan 4, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/91184e9b57fb6e50c3e8cec94a069d4e.png)'
  prefs: []
  type: TYPE_IMG
- en: Photo by [Vincent van Zalinge](https://unsplash.com/@vincentvanzalinge?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  prefs: []
  type: TYPE_NORMAL
- en: Key benefits
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Classifying customers, both new and returning, can help in defining which marketing
    or sale strategy to use. Without a doubt, it will depend on the nature of your
    business whether you prioritize acquisition, retention, or both.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before delving into the SQL approach and steps, here is a simple definition
    and business example of the terms:'
  prefs: []
  type: TYPE_NORMAL
- en: '**New customer:** Someone who makes their first purchase'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Returning customer:** Someone who has made several purchases'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Let’s take for example **a car company** and **a coffee shop** company:'
  prefs: []
  type: TYPE_NORMAL
- en: '**For a car company**, returning customers is likely to be low, because car
    purchases are typically infrequent due to a high price point and customers may
    only make one purchase every few years. The strategy might be to focus on acquisition
    and reaching out to new customers.'
  prefs: []
  type: TYPE_NORMAL
- en: '**In contrast, online coffee shops** sell consumable products that are purchased
    on a regular basis, such as coffee beans or ground coffee. The price point is
    much more affordable, which makes the likelihood of a customer returning higher.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Strategy can be adapted to both: Either for acquiring new customers via free
    products, **giveaways**, upper funnel advertising, or trying to drive brand **discovery
    and awareness**. Either for returning customers through tailored marketing and
    messaging, **product recommendations**, incentives and **discounts**, a loyalty
    program, and so on.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In SQL, giving a label to your customers could help you enable a few insights
    projects:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Understanding customer behavior**: By examining returning customers’ behavior
    and derived patterns, you might learn what motivates them to buy again'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Personalization and custom messaging**: By forwarding to your marketing tools
    attributes (eg. `new` or `returning`) and creating special marketing segments
    for each customer type'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Customer experience and satisfaction**: By running surveys or looking at
    customer services issues raised by customer type'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Product education or understanding**: By looking at product onboarding and
    usage (some products may be more difficult to understand or use at first.)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let’s jump into the data and make a classification step by step!
  prefs: []
  type: TYPE_NORMAL
- en: Creating a table with customers, orders, and dates
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To illustrate how to achieve this classification, we will use some data from
    the [Google Merchandise Store](https://shop.googlemerchandisestore.com/), an online
    store that sells Google-branded products.
  prefs: []
  type: TYPE_NORMAL
- en: In this data set, we do have **three months of history** (from November 1, 2020,
    to January 31, 2021) with all different kinds of events (purchase, page view,
    session_start, add_to_cart, etc.)
  prefs: []
  type: TYPE_NORMAL
- en: Our first step will be to build a basic table **with 3 fields** containing **orders
    by customer and date.**
  prefs: []
  type: TYPE_NORMAL
- en: 'The SQL query for Google Analytics 4 (GA4) data looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The data is filtered to only include **rows representing purchases** with a
    valid transaction id.
  prefs: []
  type: TYPE_NORMAL
- en: It’s worth noting that Google Analytics will store a default `(not set)` value
    if the data isn’t accessible, isn’t being tracked properly, or for other reasons.
  prefs: []
  type: TYPE_NORMAL
- en: The results are then **grouped across all three dimensions** so that each row
    represents a unique order per client per date.
  prefs: []
  type: TYPE_NORMAL
- en: This yields the following data table, and **we are done with our first step!**
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/1676d04d273ee0f3b418fa3670a13c95.png)'
  prefs: []
  type: TYPE_IMG
- en: Each row represents an order placed by a customer on a specific date (Image
    by [Author](https://romaingranger.medium.com/))
  prefs: []
  type: TYPE_NORMAL
- en: If you’d like to read more about not set values, you can refer to the Google
    Analytics documentation.
  prefs: []
  type: TYPE_NORMAL
- en: '[## What the value (not set) means'
  prefs: []
  type: TYPE_NORMAL
- en: is a placeholder name that Analytics uses when it hasn't received any information
    for the dimension you have selected…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: support.google.com](https://support.google.com/analytics/answer/2820717?hl=en&source=post_page-----81f44c9e3598--------------------------------#zippy=%2Cin-this-article)
  prefs: []
  type: TYPE_NORMAL
- en: If you want to access and explore the Google Analytics 4 sample data set, you
    can access it from this link.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset?source=post_page-----81f44c9e3598--------------------------------)
    [## BigQuery sample dataset for Google Analytics 4 eCommerce web implementation
    | Google Analytics…'
  prefs: []
  type: TYPE_NORMAL
- en: Google Merchandise Store is an online store that sells Google-branded merchandise.
    The site uses Google Analytics 4's…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: developers.google.com](https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset?source=post_page-----81f44c9e3598--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Classifying customers as new or returning
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Our goal is to determine whether a customer is new or returning based on their
    order history and add a column to our table to give them a label.
  prefs: []
  type: TYPE_NORMAL
- en: We use a window function, `DENSE_RANK()`, to find the first order placed by
    each customer.
  prefs: []
  type: TYPE_NORMAL
- en: When the **order’s rank is 1**, we consider the customer `'new'`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When the **order’s rank is greater than 1**, then we consider the customer `'returning'`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Using `DENSE_RANK()` allows us to **assign the same rank to multiple orders
    made on the same day**. For more details about this function and other numbering
    functions, you can read this medium article:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/differences-between-numbering-functions-in-bigquery-using-sql-658fb7c9af65?source=post_page-----81f44c9e3598--------------------------------)
    [## Differences between Numbering Functions in BigQuery using SQL'
  prefs: []
  type: TYPE_NORMAL
- en: Learn how to use rank, dense rank, row number, cumulative distribution, percentiles
    rank, quartiles, percentiles, and…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/differences-between-numbering-functions-in-bigquery-using-sql-658fb7c9af65?source=post_page-----81f44c9e3598--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: You would see in the new column, `customer_type` , the label depending on the
    `order_date` and the `customer_id`.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/83c431eb7d49d79ef0fce8dc695dca0f.png)'
  prefs: []
  type: TYPE_IMG
- en: Customer's classification as new or returning based on their order history (Image
    by [Author](https://romaingranger.medium.com/))
  prefs: []
  type: TYPE_NORMAL
- en: On September 12, 2020, the customer `13285520` makes the first order and was
    given the label `'new'`.
  prefs: []
  type: TYPE_NORMAL
- en: Then, on December 12, 2020, this same customer makes a second order, which resulted
    in having a `'returning'` type.
  prefs: []
  type: TYPE_NORMAL
- en: Analyzing visually new and returning customers
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can then plot over time the share of new vs returning customers:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/83eba1fa48a7ace94e18e6072c89468e.png)'
  prefs: []
  type: TYPE_IMG
- en: New vs returning customers over time (Image by [Author](https://romaingranger.medium.com/))
  prefs: []
  type: TYPE_NORMAL
- en: In this case, we observe that most of the customers are new, and few are actually
    returning over time. But let’s keep in mind that we do not have a lot of historical
    data.
  prefs: []
  type: TYPE_NORMAL
- en: Repeat purchase rate
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: One potential benefit of categorizing clients as `new` or `returning` is that
    we can compute a metric that provides us with a general score that indicates how
    many customers return to buy.
  prefs: []
  type: TYPE_NORMAL
- en: 'From our previous overtime chart, we can assume that the Google Merchant Store
    has a low repeat purchase rate. To compute this metric, we use the following formula:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Repeat Customer Rate (%) = (Number of returning customers / Total number
    of customers) × 100**'
  prefs: []
  type: TYPE_NORMAL
- en: In our case in this 3-month period, we have 3713 customers (note that they are
    all new at one point), out of these, 256 made more than one order.
  prefs: []
  type: TYPE_NORMAL
- en: This gives (256/3713) * 100 = **6.9% repeat customer rate**
  prefs: []
  type: TYPE_NORMAL
- en: Additional suggestions and ideas
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Considering time resolution
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In our example, we are looking at customer orders on a daily basis, with the
    idea that time plays a role and not only the number of orders.
  prefs: []
  type: TYPE_NORMAL
- en: If you would run a query only looking at the number of orders per customer,
    with no time perception (eg. assuming that a customer with more than 1 order is
    `returning`), it might happen that some customers have multiple orders on the
    same day, which in this case, they would be perceived as returning, but would
    maybe not return later in time.
  prefs: []
  type: TYPE_NORMAL
- en: In addition, looking back on a monthly or on yearly basis might also lead to
    different numbers. The longer the time period, the higher the chance for a customer
    to be both, `new` and `returning` . In this case, it’s about managing duplicates
    and adding an extra classification like `both` or prioritize either the`new` or
    the`returning` type.
  prefs: []
  type: TYPE_NORMAL
- en: 'To illustrate this idea, let’s look by month for only the year 2020 (we stored
    the previous query result in a table called `customer_table`):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: The `STRING_AGG()` function is used to concatenate the distinct `customer_type`
    values into a single string ordered alphabetically (it is then easier to use with
    a `CASE WHEN` statement as the value’s order will stay alphabetically sorted).
  prefs: []
  type: TYPE_NORMAL
- en: 'The query would return the following results:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/174c79c099c2da8051b6464d6372b8f8.png)'
  prefs: []
  type: TYPE_IMG
- en: A customer may be new and return within the same month (Image by [Author](https://romaingranger.medium.com/))
  prefs: []
  type: TYPE_NORMAL
- en: As you can see, on December 2020, the customer (`234561…901`) was making the
    first order, and in the same month, return and order again.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this case, you might want to define a classification of either:'
  prefs: []
  type: TYPE_NORMAL
- en: Consider these customers as `new`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Consider these customers as `both`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To change the label in SQL, you could do it like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: We could find a more ideal query by directly grouping by month**,** however,
    this could be **useful** when **using it in a reporting tool and keeping a daily
    resolution,** but adding a filter on a dashboard, for example.
  prefs: []
  type: TYPE_NORMAL
- en: 'The table with the new field would look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/efaa5db1652502e6313e44f9ce48a9df.png)'
  prefs: []
  type: TYPE_IMG
- en: Customers who are both new and returning are classified differently (Image by
    [Author](https://romaingranger.medium.com/))
  prefs: []
  type: TYPE_NORMAL
- en: Additional supporting metrics
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: While the repeat purchase rate indicates can be an indicator of loyalty or satisfaction
    customers may have towards your products, it does not indicate how much revenue
    they generate (are they bringing more value) or if customers are happy with their
    purchases.
  prefs: []
  type: TYPE_NORMAL
- en: 'To support this assumption, we could combine repeat purchase rate with other
    metrics such as:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Customer lifetime value (CLV)**, for example, can be a significant growth
    metric that shows how long a customer will stay with you and how much they will
    spend on your products'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Net Promoter Score (NPS)** can be another interesting metric, to evaluate
    customer satisfaction and maybe understand with additional questions or surveys,
    why they are purchasing again'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: There are several other indicators we could add, including Average Order Value
    (AOV) or client retention rate using a monthly or yearly cohort-based approach.
  prefs: []
  type: TYPE_NORMAL
- en: We might also use RFM scores (Recency, Frequency, Monetary) or other methods
    to better understand your customer base.
  prefs: []
  type: TYPE_NORMAL
- en: References & Dataset
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The dataset used in this article comes from the [BigQuery public data](https://cloud.google.com/bigquery/public-data)
    and is a sample of Google analytics data under the [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)
    license.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset?source=post_page-----81f44c9e3598--------------------------------)
    [## BigQuery sample dataset for Google Analytics 4 eCommerce web implementation
    | Google Analytics…'
  prefs: []
  type: TYPE_NORMAL
- en: Google Merchandise Store is an online store that sells Google-branded merchandise.
    The site uses Google Analytics 4's…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: developers.google.com](https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset?source=post_page-----81f44c9e3598--------------------------------)
  prefs: []
  type: TYPE_NORMAL
