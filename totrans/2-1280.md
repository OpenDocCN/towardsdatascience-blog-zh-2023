# Hugging Face Diffusers 可以正确加载 LoRA

> 原文：[https://towardsdatascience.com/hugging-face-diffusers-can-correctly-load-lora-now-a332501342a3](https://towardsdatascience.com/hugging-face-diffusers-can-correctly-load-lora-now-a332501342a3)

## 使用最新的 Diffusers Monkey Patching 函数加载 LoRA 与 A1111 比较，结果完全相同

[](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)[![Andrew Zhu (Shudong Zhu)](../Images/46f07a875a42bcc4e0c262aea5e2a504.png)](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)[](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------) [Andrew Zhu (Shudong Zhu)](https://xhinker.medium.com/?source=post_page-----a332501342a3--------------------------------)

·发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----a332501342a3--------------------------------) ·5 min 阅读·2023年7月28日

--

从 Hugging Face 的 Diffusers 代码库中拉取最新代码，并发现与 LoRA 加载相关的最新代码已更新，现在可以进行 Monkey-Patching LoRA 加载。

要安装最新的 Diffusers：

[PRE0]

根据我的测试，LoRA 加载功能昨天生成了略有缺陷的结果。本文讨论了如何使用 Diffusers 包中的最新 LoRA 加载器。

## 加载 LoRA 并更新 Stable Diffusion 模型权重

自从程序员使用 Diffusers 以来，LoRA 一直无法轻松加载。为了将 LoRA 加载到检查点模型中并输出与 A1111 的 Stable Diffusion Webui 相同的结果，我们需要使用额外的自定义代码来加载权重，如本文所述。

[](/improving-diffusers-package-for-high-quality-image-generation-a50fff04bdd4?source=post_page-----a332501342a3--------------------------------) [## 改进 Diffusers 包以实现高质量图像生成

### 克服令牌大小限制、自定义模型加载、LoRA 支持、文本反演支持等

[towardsdatascience.com](/improving-diffusers-package-for-high-quality-image-generation-a50fff04bdd4?source=post_page-----a332501342a3--------------------------------)

本文提供的解决方案运行良好且快速，但需要额外管理 LoRA α 权重，我们需要创建一个变量来记住当前的 LoRA 权重 α。因为加载 LoRA 的代码只是将 LoRA 的 A 和 B 矩阵简单地加在一起。

![](../Images/154a503a4e388678150c2d06d0f17b5f.png)

LoRA 权重

然后与主要检查点模型权重 W 合并。

![](../Images/9ebd02b5d43e5e91b4d0aabbc96abf39.png)

将 LoRA 权重与检查点权重合并

要移除LoRA权重，我们需要一个负的-α来移除LoRA权重，或者重新创建管道。

## 加载LoRA的猴子修补方式

使用LoRA的另一种方法是修补执行模块前向过程的代码，并在计算文本嵌入和注意力分数时引入LoRA权重。

![](../Images/98b8861a423a8e3ee63462bd4f1b8aab.png)

用LoRA修补模型

这就是Diffusers LoraLoaderMixin处理LoRA加载的方式。这个方法的好处是没有更新模型权重，我们可以轻松重置LoRA并提供新的α来定义LoRA权重。

然而，在今天（2023年7月26日）之前，Diffusers的LoraLoaderMixin加载LoRA并生成的结果与A1111有些不同。今天的代码修复了这个问题。“修复”是指，你可以使用Diffusers加载检查点模型及LoRA，并生成与A1111 SD webui完全相同的结果。

## 使用Diffusers的LoraLoaderMixin加载LoRA

假设我们有一个`safetensor`文件格式的LoRA文件，使用Diffusers加载LoRA就像这样简单。

[PRE1]

只需一行代码：`text2img_pipe.load_lora_weights(lora_path)`。测试其中一个著名的LoRA — [LowRA](https://civitai.com/models/48139/lowra)，这个LoRA可以将图像转换为暗模式。

让我们测试一下加载和不加载LoRA的效果。

[PRE2]

结果如下，左侧是没有加载LoRA的图像，右侧是加载了LoRA后生成的图像，使用了`text2img_pipe.load_lora_weights(lora_path).`

![](../Images/ba0440c6896e91461b8a805ee43c0fd5.png)

图1\. LowRA LoRA可以生成暗模式图像，由Andrew Zhu使用Diffusers生成

## 使用Diffusers加载带权重的LoRA

即使我们现在可以用一行代码加载LoRA，我们仍然没有看到对LoRA权重参数的支持。例如，我们希望结果变得更亮，并设置LoRA权重为0.5。在A1111 Stable Diffusion Webui中，我们可以将LoRA权重设置为：`<lora:LowRA:0.5>`

我们如何将0.5添加到Diffusers包中？似乎没有办法，但我们可以在LoRA加载过程中进行黑客操作，像这样插入我们的值：

[PRE3]

左侧是来自A1111 SD Webui的结果，右侧是来自Diffusers的结果，二者使用相同的LoRA权重为0.5，Euler调度器，种子：3135098381

![](../Images/86c3959685bb676e3c09f93e645a2aa6.png)

图2\. Diffusers与LoRA可以生成与A1111相同的图像。图像由Andrew Zhu使用A1111 SD WebUi（左）和Diffusers（右）生成

你能看出区别吗？

要重置LoRA，只需调用`unload_lora_weights`函数：

[PRE4]

## 总结

这篇文章讨论了Diffusers的最新代码更新，这是一个开源的Stable Diffusion包，允许我们使用Python生成AI图像。此外，我们可以根据具体需求自由添加和更改代码。

长时间以来，只有 A1111 Stable Diffusion WebUI 能完全支持 LoRA，现在我们可以使用 Python 控制 Diffusers 加载数千个社区共享的 LoRA，并完全自动化图像生成，这为 GAI 图像生成打开了一扇新门。

总结来说，本文的贡献如下：

1.  介绍了将 LoRA safetensors 文件加载到 Diffusers Stable Diffusion 管道中的最简单方法（单行代码）。

1.  提供了一种简单的黑客方式来在 LoRA 加载阶段加载 LoRA 权重。

## 参考文献

[1] Hugging Face, 大型语言模型的低秩适配（LoRA），[https://huggingface.co/docs/diffusers/training/lora](https://huggingface.co/docs/diffusers/training/lora)

[2] LowRA，[https://civitai.com/models/48139/lowra](https://civitai.com/models/48139/lowra)

[3] 使用辅助状态加载 Kohya-ss 风格的 LoRA，[https://github.com/huggingface/diffusers/pull/4147](https://github.com/huggingface/diffusers/pull/4147)

[4] Simo Ryu(cloneofsimo), lora，[https://github.com/cloneofsimo/lora](https://github.com/cloneofsimo/lora)
