# 数据平台的持续集成和部署

> 原文：[https://towardsdatascience.com/continuous-integration-and-deployment-for-data-platforms-817bf1b6bed1](https://towardsdatascience.com/continuous-integration-and-deployment-for-data-platforms-817bf1b6bed1)

## 数据工程师和机器学习操作的CI/CD

[](https://mshakhomirov.medium.com/?source=post_page-----817bf1b6bed1--------------------------------)[![💡Mike Shakhomirov](../Images/bc6895c7face3244d488feb97ba0f68e.png)](https://mshakhomirov.medium.com/?source=post_page-----817bf1b6bed1--------------------------------)[](https://towardsdatascience.com/?source=post_page-----817bf1b6bed1--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----817bf1b6bed1--------------------------------) [💡Mike Shakhomirov](https://mshakhomirov.medium.com/?source=post_page-----817bf1b6bed1--------------------------------)

·发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----817bf1b6bed1--------------------------------) ·阅读时间9分钟·2023年4月14日

--

![](../Images/fd7ac2298a3ebce9921e027ae8163cd9.png)

图片由 [Emmy Sobieski](https://unsplash.com/@emmy_s?utm_source=medium&utm_medium=referral) 提供，来源于 [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

什么是数据环境？数据工程师将基础设施资源分为实时和暂存，以创建隔离的区域（环境），在这些区域中，他们可以测试ETL服务和数据管道，然后再将其推广到生产环境中。

**数据环境** 指的是一组应用程序和相关的物理基础设施资源，这些资源支持数据存储、传输、处理和数据转换，以支持公司的目标和计划。

**这个故事** 提供了 **适用于数据的CI/CD技术概述** 和一个简单的 **ETL** 服务的 **工作示例**，该服务使用 **Python** 构建，并通过 **Github Actions** 以 **基础设施即代码**（IaC）进行部署。

## 持续集成和持续交付（CI/CD）

持续集成和持续交付（CI/CD）是一种软件开发策略，所有开发人员在一个共同的代码仓库上协作，当做出更改时，会使用自动化构建过程来发现任何潜在的代码问题。

![](../Images/6a68cf39e925c7b6f79982657c32ab9f.png)

作者提供的图像

## CI/CD的好处

CI/CD的主要技术优势之一是它提高了整体代码质量并节省了时间。

> 使用基础设施即代码的自动化CI/CD管道解决了许多问题。

[](https://levelup.gitconnected.com/infrastructure-as-code-for-beginners-a4e36c805316?source=post_page-----817bf1b6bed1--------------------------------) [## 初学者的基础设施即代码

### 使用这些模板像专业人士一样部署数据管道

[levelup.gitconnected.com](https://levelup.gitconnected.com/infrastructure-as-code-for-beginners-a4e36c805316?source=post_page-----817bf1b6bed1--------------------------------)

**更快交付**

每天多次添加新功能并不是一件容易的任务。然而，如果我们拥有简化的CI/CD工作流，这绝对是可以实现的。

使用CI/CD工具，如GoCD、Code Pipeline、Docker、Kubernetes、Circle CI、Travis CI等，开发团队现在可以独立且自动地构建、测试和部署。

**减少错误**

在开发过程中晚些时候发现和解决代码问题是费时且昂贵的。当功能出现错误并发布到生产环境时，这变得尤为重要。

通过使用CI/CD管道更频繁地测试和部署代码，测试人员将能够及时发现问题并立即进行修复。这有助于实时降低风险。

**减少人工干预和提高透明度**

测试应自动运行，以确保新代码或新功能不会损坏任何已有功能。在整个过程中，我们希望获得有关开发、测试和部署周期的定期更新和信息。

**轻松回滚**

为了防止生产环境的停机，如果新发布或功能出现问题，通常会立即部署最近一次成功的构建。这是另一个出色的CI/CD功能，便于轻松回滚。

**详尽的日志**

了解部署过程至关重要。了解代码为何失败则更为重要。DevOps和CI/CD集成中最重要的部分之一是可观察性。能够阅读我们构建的详尽日志绝对是必备功能。

## 我们什么时候使用CI/CD来处理数据平台？

**管理数据资源和基础设施**：通过CI/CD技术和工具，我们可以配置、部署和管理我们可能需要的数据管道基础设施资源，例如云存储桶、无服务器微服务以执行ETL任务、事件流和队列。像AWS Cloudformation和Terraform这样的工具可以轻松管理基础设施，为测试、预发布和生产环境提供资源。

**SQL单元测试**：CI/CD有助于数据转换。如果我们有一个以ELT模式转换数据的数据管道，我们可以自动化SQL单元测试以测试其背后的逻辑。一个好的例子是GitHub Actions工作流，它编译我们的SQL脚本并运行单元测试。

[](/unit-tests-for-sql-scripts-with-dependencies-in-dataform-847133b803b7?source=post_page-----817bf1b6bed1--------------------------------) [## SQL脚本的单元测试及其依赖项

### 以及数据仓库Gitflow管道来自动运行

[towardsdatascience.com](/unit-tests-for-sql-scripts-with-dependencies-in-dataform-847133b803b7?source=post_page-----817bf1b6bed1--------------------------------)

**验证ETL过程**：许多数据管道严重依赖ETL（提取、转换、加载）操作。我们希望确保任何提交到GitHub代码库的更改都能正确处理数据。这可以通过实施自动化**集成测试**来实现。以下是一个简单的实现示例：

[](https://mydataschool.com/blog/data-platform-unit-and-integration-tests-explained/?source=post_page-----817bf1b6bed1--------------------------------) [## 数据平台单元和集成测试解释

### 如何进行这个练习以及如何将其应用到我们的数据管道中？这是我自己提出的一个好问题。

mydataschool.com](https://mydataschool.com/blog/data-platform-unit-and-integration-tests-explained/?source=post_page-----817bf1b6bed1--------------------------------)

**监控数据管道**。一个很好的例子是使用CI/CD和基础设施即代码来配置通知主题和警报，用于ETL资源，例如Lambda等。如果我们的ETL处理服务出现问题，例如错误数量达到阈值，我们可以通过选定的渠道接收通知。以下是一个AWS Cloudformation示例：

## 如何为数据平台设置CI/CD管道？

![](../Images/947060c560a5af8a23c8a169682d229f.png)

示例CI/CD管道。作者提供的图像。

**步骤 1\. 创建一个代码库**

这是一个基础步骤。需要一个版本控制系统。我们希望确保我们代码中的每个更改都进行版本控制，保存到云端，并且在需要时可以恢复。

**步骤 2\. 添加构建步骤**

现在，当我们有了代码库后，我们可以配置CI/CD管道来实际构建项目。假设我们有一个ETL微服务，它从AWS S3加载数据到数据仓库。此步骤将涉及在隔离的本地环境中构建Lambda包，即在Github中。在此步骤中，CI/CD服务必须能够收集所有所需的代码包来编译我们的服务。例如，如果我们有一个简单的AWS Lambda来执行ETL任务，我们将需要构建这个包：

[PRE0]

**步骤 3\. 运行测试**

我们希望确保我们部署的数据管道的更改按预期工作。这可以通过编写良好的单元测试和集成测试来实现。然后，我们将配置我们的CI/CD管道来运行这些测试，例如，每次我们提交更改或合并到主分支时。举例来说，我们可以配置Gitflow Actions来运行`**pytest test.py**`或`**npm run test**`来测试我们的**AWS Lambda**。如果测试成功，我们可以进行下一步。

**步骤 4\. 部署到预发布环境**

在此步骤中，我们继续实现持续集成。我们的项目已经成功构建，所有测试都通过了，现在我们希望在暂存环境中部署。这里的环境指的是资源。CI/CD管道可以配置为使用与此特定环境相关的设置，通过基础设施即代码进行最终部署。

**Lambda示例**。此bash脚本可以添加到CI/CD管道的相关步骤中：

[PRE1]

**步骤5\. 部署到生产环境**

> 这是最后一步，通常在我们100%确认一切正常时**手动触发**。

![](../Images/bd47c202a438ad7702541056d3c7309a.png)

图片由作者提供

CI/CD将使用用于生产环境的IaC设置。例如，我们可能希望提供仅与生产相关的任何基础设施资源，即我们的Lambda函数名称应为`pipeline-manager-live`。这些资源参数和配置设置必须在我们的Cloudformation堆栈文件中提及。例如，我们可能希望我们的**ETL Lambda由S3桶中的Cloudwatch事件触发，每当创建新S3对象时**。在这种情况下，我们需要在参数中提供此S3桶的名称。另一个例子是我们的Lambda设置**如内存和超时**。对于暂存服务，不需要过度配置内存，但在生产环境中，我们希望它能够处理更大的数据量。

CI/CD生产环境步骤示例：

[PRE2]

![](../Images/e826dcbc72527e8cd4db0bc311fced24.png)

图片由作者提供

> 回滚、版本控制和安全性可以通过CI/CD服务设置和IaC来处理。

## 带有基础设施即代码和AWS Lambda的CI/CD管道示例

假设我们有一个典型的代码库，其中一些ETL服务（AWS Lambda）通过AWS Cloudformation进行部署。

这可以是一个数据管道管理应用程序或其他执行ETL任务的工具。

我们的代码库文件夹结构如下：

[PRE3]

我们将在.github/workflows文件夹中使用**deploy_staging.yaml**和**deploy_live.yaml**来定义我们的CI/CD管道。

> 在任何**Pull Request**上，我们希望运行测试并在暂存环境中部署。

然后，如果一切正常，我们将把代码推广到生产环境，并将堆栈部署到生产环境。

![](../Images/29a2109d76dc7ab68dcb506da2c5bac6.png)

图片由作者提供

该管道将使用Github仓库的机密，我们将在其中复制粘贴AWS凭证。

![](../Images/c747bd72d1fe8fc3b606c644e220b01e.png)

图片由作者提供

在STAGING AND TESTS成功执行且所有测试通过后，我们可以手动将代码推广到生产环境。我们可以使用`workflow_dispatch:`来完成此操作：

![](../Images/3f0e1f6a198058d88f0ac34f83372695.png)

图片由作者提供

## 市场上可用的CI/CD工具

有各种CI/CD解决方案可以用于自动化数据管道测试、部署和监控。Github Actions是一个很好的工具，但有时我们可能需要更多和/或不同的工具。

**这不是一个详尽的列表，但以下是一些值得尝试的热门技术：**

**AWS CodePipeline:** 每个管道每月$1.5的可靠工具。包括通过基础设施即代码进行的自动构建和部署等许多功能。

**Circle CI:** Circle CI 是一个基于云的 CI/CD 系统，用于自动化数据管道的测试和部署。它有多个连接器和插件，使其设置和操作变得简单。

**Jenkins:** Jenkins 是一个免费的开源自动化服务器，用于持续集成和部署。它提供了多种插件和连接器，使其成为一个强大的数据管道管理解决方案。

**GitLab CI/CD:** GitLab CI/CD 是一个基于云的系统，允许团队在一个位置管理代码和数据管道的变更。它具有易于使用的界面，用于创建、测试和部署数据管道。

**Travis CI:** Travis CI 是一个基于云的 CI/CD 系统，用于自动化数据管道的测试和部署。它易于设置和使用，使其成为缺乏自动化经验的团队的热门选择。

**GoCD:** GoCD 是一个免费的开源构建和发布工具。它是免费的，并且大量依赖 bash 脚本。

## **结论**

CI/CD 的主要好处之一是提高代码质量。持续集成和部署为数据平台工程师和 ML Ops 带来了许多好处。我们数据管道部署的每一步都可以轻松监控和管理，以确保更快的交付且生产中没有错误。这节省了时间，并帮助工程师提高生产力。

我希望这个故事中给出的简单示例对你有所帮助。利用它作为模板，我能够为容器化应用程序创建强大且灵活的 CI/CD 管道。自动化部署和测试如今几乎已成标准。我们还可以做更多的事情，包括 ML Ops 和为数据科学提供资源。

市场上有很多 CI/CD 工具。一些是免费的，一些不是，但提供了更多灵活的设置，可能更适合你的数据堆栈。我对初学者的建议是从免费的工具开始，并尝试实现这个故事中的示例。它描述了一个可以为任何数据服务复制的过程。

## 推荐阅读

1\. [https://docs.github.com/en/actions](https://docs.github.com/en/actions)

2\. [https://stackoverflow.com/questions/58877569/how-to-trigger-a-step-manually-with-github-actions](https://stackoverflow.com/questions/58877569/how-to-trigger-a-step-manually-with-github-actions)

3\. [https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html](https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html)

4\. [https://medium.com/gitconnected/infrastructure-as-code-for-beginners-a4e36c805316](https://medium.com/gitconnected/infrastructure-as-code-for-beginners-a4e36c805316)

5\. [https://betterprogramming.pub/great-data-platforms-use-conventional-commits-51fc22a7417c](https://betterprogramming.pub/great-data-platforms-use-conventional-commits-51fc22a7417c)
