- en: Uncovering the Limitations of Traditional DiD Method
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a](https://towardsdatascience.com/uncovering-the-limitations-of-traditional-did-method-2f068f56d19a)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Dealing with Multiple Time Periods and Staggered Treatment Timing
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[![Nazlı
    Alagöz](../Images/7275df914f7e3e492861ffe20df10b8f.png)](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)[](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    [Nazlı Alagöz](https://medium.com/@nalagoz13?source=post_page-----2f068f56d19a--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----2f068f56d19a--------------------------------)
    ·11 min read·Feb 21, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/44dea706340ac506d236a11bad3313ec.png)'
  prefs: []
  type: TYPE_IMG
- en: Cover image, generated by the author using [NightCafé](https://creator.nightcafe.studio/)
  prefs: []
  type: TYPE_NORMAL
- en: Difference-in-Differences (DiD) is a popular statistical method for estimating
    the causal impact of interventions in observational studies by comparing the outcome
    difference between two groups before and after treatment. Most DiD guides focus
    solely on the canonical DiD setup where there are only two periods and two groups
    (treated and nontreated).
  prefs: []
  type: TYPE_NORMAL
- en: However, in many real-world applications of DiD, there are multiple time periods
    and variations in the treatment timing. **Recent studies on DiD show that DiD
    may give significantly misleading estimates of the treatment effects in these
    situations**. In certain scenarios, the treatment effect estimates may show an
    opposite sign compared to the actual treatment effect.
  prefs: []
  type: TYPE_NORMAL
- en: '**In this article, I’ll discuss an important issue that can occur in the canonical
    DiD setup when staggered treatment timing and multiple time periods are present**.
    I’ll also present solutions to address this issue. It’s important to note that
    while I will focus solely on this one issue in DiD, for a more comprehensive overview
    of other potential challenges, you can refer to [my previous article](/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65).
    Additionally, I’ll provide further resources at the end of this article for those
    who wish to delve deeper into DiD issues.'
  prefs: []
  type: TYPE_NORMAL
- en: Lockdowns and Music Consumption Example
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To provide an example, let's consider a hypothetical scenario. Imagine that
    we run a music streaming service that operates in various countries. We want to
    investigate the effects of Covid-19 lockdowns on music consumption in these countries.
    By examining the impact of reduced mobility, we can gain insights into whether
    listening to music is associated with certain activities, such as commuting, as
    opposed to working from home.
  prefs: []
  type: TYPE_NORMAL
- en: Since we cannot manipulate the implementation of lockdowns, it’s not feasible
    to conduct an A/B test to examine their effects. Therefore, we must rely on observational
    data. In this case, we utilize the varying times that lockdowns were imposed in
    the countries included in our dataset. In this example, the treatment is the implementation
    of a lockdown. For this toy example, I simulated a dataset, the details of which
    can be found [in my previous article](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65)
    and [this Gist](https://gist.github.com/nazlialagoz/b66b15b295029029bca9162d1df00cef).
    All the analysis code is also available in [this Gist](https://gist.github.com/nazlialagoz/85d0713f157ffeacdc71b581a0da07d0).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/15f5cf79cb4b9e3d3d32e2e41ca2d706.png)'
  prefs: []
  type: TYPE_IMG
- en: A snapshot of the data for selected columns, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'We have data on 1000 units or customers for each period that they are observed.
    `cohort_period`indicates in which period a unit is treated and therefore which
    treatment cohort they belong to. A unit is treated ( `treat = 1`) when `cohort_period
    >= period.` `hrs_listened` is the outcome of interest indicating the total music
    consumption (hours). There are two cohorts in the dataset: the early-treated cohort
    and the late-treated cohort. The early cohort is treated in period 2 and the late
    cohort is treated in period 3\. In total, there are five periods, starting from
    period 0 and ending with period 4.'
  prefs: []
  type: TYPE_NORMAL
- en: As we have an observational dataset, where treatment is not randomly assigned,
    a simple difference-in-means approach cannot be employed to estimate the treatment
    effect. Instead, we aim to distinguish the treatment effects from customer- and
    season-related factors, and to achieve this, we utilize a DiD framework.
  prefs: []
  type: TYPE_NORMAL
- en: Just before we get into DiD, although this is not possible in real-life applications,
    in this simulated dataset I know the true treatment effects for each treatment
    cohort and period. Below, I visualize these as they will be necessary to evaluate
    the estimated treatment effects in the next steps.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/21f5cbd4922d737f3964f05d45b5b33e.png)'
  prefs: []
  type: TYPE_IMG
- en: True treatment effects per cohort and period, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: As seen in this graph, the true treatment effects for both cohorts are positive
    for all the periods. The treatment effect increases over time for both cohorts.
    However, overall the treatment effect is greater and increases quite a lot over
    the treated periods for cohort 2 compared to cohort 3\. Thus, there is heterogeneity
    in treatment effects across treatment cohorts and periods.
  prefs: []
  type: TYPE_NORMAL
- en: Canonical DiD
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Suppose that we are not aware that having multiple periods and staggered treatment
    can lead to misleading estimates when using the canonical DiD method. Thus, naively,
    we decide to use the canonical DiD setup to account for seasonality in the listening
    patterns and customer-specific effects in our observational dataset. We use a
    DiD setup like this [1]:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/062129395b7660bb69c16370b5ca0e6d.png)'
  prefs: []
  type: TYPE_IMG
- en: Canonical DiD, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: '*Y*ᵢₜ is the outcome of interest. αᵢ is the unit-fixed effects that controls
    for time-constant unit characteristics. γₜ is the time-fixed effects that controls
    for time trends or seasonality. D*ᵢₜ* is the treatment dummy at time *t* for unit
    *i.* ϵᵢₜ is the random error. The coefficient of interest βᵈᵈindicates the treatment
    effect.'
  prefs: []
  type: TYPE_NORMAL
- en: 'We estimate the treatment effect using canonical DiD setup in R:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/adbb0868f1b2df6270f98e77665c5648.png)'
  prefs: []
  type: TYPE_IMG
- en: Canonical DiD estimates, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'The estimated treatment effect is -0.47 (though not statistically significant)!
    But how can this be when we have positive (and generally big) treatment effects
    for each treated cohort and period? **The reason for this is that DiD estimator
    is a weighted average of all possible two-group/two-period DiD estimators in the
    data** [2]. In other words, the canonical DiD estimate can be decomposed into
    a weighted average two-group x two-period treatment estimates. This is called
    **Goodman-Bacon decomposition**. Let’s get the weights and estimates used to calculate
    the canonical DiD estimates using ‘bacondecomp’ package [2]:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/991331562951380ee12132bbd7ae77a2.png)'
  prefs: []
  type: TYPE_IMG
- en: Goodman-Bacon Decomposition, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the image above, I show the Goodman-Bacon decomposition for our canonical
    DiD estimate. Indeed, if we sum these estimates up with their respective weights
    we get exactly the treatment effect estimated by the canonical DiD: 0.5 x -4.53
    + 0.5 x 3.59 = -0.47\. Since we have 2 groups and 2 periods where the treatment
    indicator changes we have 2 comparisons.'
  prefs: []
  type: TYPE_NORMAL
- en: Let’s examine this table in detail to see what the issue is. We start with the
    second comparison where the treatment estimate is 3.59\. Here, the control group
    (‘untreated’) is the late-treated group, cohort 3\. The ‘treated’ group is the
    early-treated group, cohort 2\. I am putting the ‘treated’ and ‘untreated’ in
    quotes because as you might remember all groups in our dataset are eventually
    treated. ‘treated’ and ‘untreated’, here, rather refer to groups used as **treatment**
    and **control** groups by the canonical DiD estimator.
  prefs: []
  type: TYPE_NORMAL
- en: Let’s move on to the first comparison highlighted in red where the estimate
    is -4.53\. **Here, the early-treated group (cohort 2) is used as the control group
    for the late-treated group by the canonical estimator**! This comparison does
    not make much sense. Still, everything would work fine if the treatment effects
    were constant across cohorts and periods. In this application, as well as in many
    others, this is not the case. Since the treatment effects are higher and dynamically
    increasing for the early-treated group, in comparison it seems as if the treatment
    effect for the late-treated group is negative! **The comparisons where the early-treated
    group is used as the control group for the late-treated groups are called forbidden
    comparisons** [2].
  prefs: []
  type: TYPE_NORMAL
- en: How to address this problem?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The main solution to this problem is to not restrict the treatment effect to
    a single estimate and to carefully choose the control group. In the next steps,
    we are going to see how to do this. First, I am going to demonstrate how to address
    this problem without a particular DiD package. Later, I will use an R package
    that’s specifically designed for DiD with multiple time periods.
  prefs: []
  type: TYPE_NORMAL
- en: Addressing the issue without relying on a specific DiD package
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'First, let''s address this problem without relying on a specific DiD package.
    I know that there are two things that I need to do to get a good estimate of the
    treatment effect: **(1) not restrict the treatment effect estimation to a single
    coefficient, (2) make sure that I have a good control group** [3][4].'
  prefs: []
  type: TYPE_NORMAL
- en: In essence, it is necessary to account for variations in treatment effects across
    different cohorts and periods. Moreover, it's crucial to ensure that there are
    untreated observations available for each period being assessed for treatment
    effects. This is because using treated observations as controls can lead to significantly
    misleading results, as previously noted.
  prefs: []
  type: TYPE_NORMAL
- en: 'As you remember, I only have treated groups in this dataset: the cohort treated
    in period 2 (early-treated) and the cohort treated in period 3 (late-treated).
    Clearly, I cannot estimate any treatment effects for the late-treated cohort as
    there are no not-yet-treated observations to use as controls when they are treated.'
  prefs: []
  type: TYPE_NORMAL
- en: There is more hope for the early-treated group as when they were treated the
    late-treated group was not yet treated. This means that we can certainly estimate
    a treatment effect in period 2 for the early treated cohort. However, we cannot
    estimate any treatment effects for further periods as there are no untreated observations
    from period 3 onward. This is why we will drop periods that have no untreated
    units. Let’s code this up.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Now, it is time to estimate the only treatment effect that we can estimate.
    We will only estimate a treatment effect for the early treated group in period
    2.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/f9ca9b36528b05c2c5ba3b2b3258d4df.png)'
  prefs: []
  type: TYPE_IMG
- en: Regression results after accounting for staggered treatment, image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'As seen from the results above, the estimated treatment effect is much more
    sensible this time: 3.6\. This means that the lockdown resulted in a 3.6 hours
    increase in music consumption for this cohort in this period. The point estimate
    is not exactly equal to the true treatment effect (approx. 4 hrs) because of the
    noise in the data.'
  prefs: []
  type: TYPE_NORMAL
- en: Addressing the issue using ‘did’ package
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As an alternative to doing everything manually let’s use the `[did](https://bcallaway11.github.io/did/index.html)`
    [package by Callaway and Sant’Anna](https://bcallaway11.github.io/did/index.html)
    [3]. What we need to do is to use `att_gt` function to estimate the treatment
    effects at cohort- and period-level using the right control group. Below, the
    code is given. One thing here that is important is that you need to specify the
    `control_group` as `'notyettreated'` because this function by default tries to
    find an untreated group to use as the control group.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/f862df108ad3bd9c38ebe29f766d4a64.png)'
  prefs: []
  type: TYPE_IMG
- en: did package results, image by author.
  prefs: []
  type: TYPE_NORMAL
- en: '`att_gt` function estimates cohort-period-specific treatment effects, i.e.,
    `ATT(g,t)`. We are interested in the treatment effect for cohort 2 in period 2
    and this is given as 3.4 hrs. This is almost the same as the treatment effects
    we estimated without relying on this package. There can be some differences in
    the estimates due to the exact process of estimation. The ‘treatment effects’
    for the period before the treatment is also reported in the first line and this
    is not statistically significant as expected because in this case, I know that
    there are no systemic changes to the outcome variable prior to the intervention.
    We can also graph these results with a single line of code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/8af2f0d0cf4c9208732971e0605e22b8.png)'
  prefs: []
  type: TYPE_IMG
- en: Visualizing did package results, image by author.
  prefs: []
  type: TYPE_NORMAL
- en: This graph is also useful to check the overtime trends pre- and post-treatment.
    This type of visualization comes especially handy when estimating treatment effects
    for many cohorts and periods, though in this case I only have one cohort and two
    periods for which I can make estimations.
  prefs: []
  type: TYPE_NORMAL
- en: Using this package has additional advantages compared to my manual method relevant
    here. As long as you specify the required variables for the `att_gt` function
    you don’t need to do much else. You don't even need to drop the periods without
    untreated observations as this package already takes this into account and estimates
    effects only for periods where there is a valid control group. Another nice advantage
    is that the package as default reports uniform confidence intervals that accounts
    for multiple hypothesis testing (and this results in wider confidence bands due
    to a higher critical value used). The differences in the exact estimates between
    the two methods are due to the exact estimation method is not exactly the same.
  prefs: []
  type: TYPE_NORMAL
- en: Coming back to our example, we see that the lockdown has a positive effect on
    music consumption (though we were able to estimate this only for one cohort in
    one period). This indicates that actually music listening is complementary to
    staying at home.
  prefs: []
  type: TYPE_NORMAL
- en: Conclusions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Here are the key takeaways from this article:'
  prefs: []
  type: TYPE_NORMAL
- en: Canonical DiD can lead to misleading estimates in applications where there are
    multiple periods and variations in treatment timing.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To prevent this issue, one can use estimators that account for multiple periods
    and variations in treatment timing.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: These estimators are suitable for staggered treatment contexts because they
    allow for flexible treatment effects and only estimate treatment effects for periods
    in which there is a valid control group.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: This is not the only issue that might come up when doing DiD analysis. For other
    issues, [see my previous post on event studies](https://medium.com/towards-data-science/event-studies-for-causal-inference-the-dos-and-donts-863f29ca7b65).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*References*'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[1] Angrist, J. D., & Pischke, J. S. (2009). [*Mostly harmless econometrics:
    An empiricist’s companion*](https://www.mostlyharmlesseconometrics.com/). Princeton
    university press.'
  prefs: []
  type: TYPE_NORMAL
- en: '[2] Goodman-Bacon, Andrew. (2021) “[Difference-in-differences with variation
    in treatment timing](https://www.nber.org/papers/w25018).” *Journal of Econometrics*
    225.2: 254–277.'
  prefs: []
  type: TYPE_NORMAL
- en: '[3] Callaway, B., & Sant’Anna, P. H. (2021). [Difference-in-differences with
    multiple time periods](https://doi.org/10.1016/j.jeconom.2020.12.001). *Journal
    of Econometrics*, *225*(2), 200–230.'
  prefs: []
  type: TYPE_NORMAL
- en: '[4] Wooldridge, J. M. (2021). [Two-way fixed effects, the two-way mundlak regression,
    and difference-in-differences estimators](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3906345).
    *Available at SSRN 3906345*.'
  prefs: []
  type: TYPE_NORMAL
- en: Other Useful Resources on DiD
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '***Videos:***'
  prefs: []
  type: TYPE_NORMAL
- en: '[Pedro H.C. Sant’Anna — “Difference-in-Differences with Multiple Time Periods”](https://www.youtube.com/watch?v=VLviaylakAo&t=62s)'
  prefs: []
  type: TYPE_NORMAL
- en: '[Andrew Goodman-Bacon “Difference-in-Differences with Variation in Treatment
    Timing”](https://www.youtube.com/watch?v=m1xSMNTKoMs)'
  prefs: []
  type: TYPE_NORMAL
- en: '***A nice paper that summarizes recent DiD literature:***'
  prefs: []
  type: TYPE_NORMAL
- en: Roth, J., Sant’Anna, P. H., Bilinski, A., & Poe, J. (2022). [What’s trending
    in difference-in-differences? A synthesis of the recent econometrics literature](https://arxiv.org/abs/2201.01194).
    *arXiv preprint arXiv:2201.01194*.
  prefs: []
  type: TYPE_NORMAL
- en: '[***A compilation of many DiD-related resources.***](https://asjadnaqvi.github.io/DiD/docs/02_R/)'
  prefs: []
  type: TYPE_NORMAL
- en: Thank you for reading!
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '*If you liked the post and would like to see more of my articles consider*
    [*following me*](https://medium.com/@nalagoz13)*.*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Disclaimer****: I write to learn so it might be that you spot an error in
    the article or code. If you do so, please let me know.*'
  prefs: []
  type: TYPE_NORMAL
