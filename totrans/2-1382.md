# 初级开发者编写多页 SQL 查询；高级开发者使用窗口函数

> 原文：[https://towardsdatascience.com/junior-developers-write-multi-page-sql-queries-seniors-use-window-functions-f82dfeb8e378](https://towardsdatascience.com/junior-developers-write-multi-page-sql-queries-seniors-use-window-functions-f82dfeb8e378)

## 在记录的上下文中执行计算的一种优雅方法

[](https://thuwarakesh.medium.com/?source=post_page-----f82dfeb8e378--------------------------------)[![Thuwarakesh Murallie](../Images/44f1a14a899426592bbd8c7f73ce169d.png)](https://thuwarakesh.medium.com/?source=post_page-----f82dfeb8e378--------------------------------)[](https://towardsdatascience.com/?source=post_page-----f82dfeb8e378--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----f82dfeb8e378--------------------------------) [Thuwarakesh Murallie](https://thuwarakesh.medium.com/?source=post_page-----f82dfeb8e378--------------------------------)

·发表于 [Towards Data Science](https://towardsdatascience.com/?source=post_page-----f82dfeb8e378--------------------------------) ·阅读时间 7 分钟·2023年3月13日

--

![](../Images/5ecd316079b782495a6f38876a60a489.png)

图片由 [R Mo](https://unsplash.com/@mooo3721?utm_source=medium&utm_medium=referral) 提供，来自 [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

想象一下你经营一个全国性的电子商店。你必须确定每个商店对州销售额的贡献。

如果你刚开始学习 SQL，你可能会考虑一下，开发一个极其出色的查询，可能看起来像下面这样。

[PRE0]

[PRE1]

这肯定能完成工作。但如果你把这个解释给别人，他们会跟你过得很痛苦。

相反，如果你让一位高级开发者来做同样的事情，他们会写出如下的查询：

[PRE2]

这个更加简洁的版本使用了窗口函数。

窗口函数创建一个与当前记录相关的记录窗口，并在该窗口内进行操作。在这个例子中，窗口是状态。

我第一次遇到窗口函数是在几年前，当时我为一个零售客户工作。他们的客户数据集非常庞大，他们希望查看每个顾客群体的购买模式变化——比如80年代和90年代出生的人群等。

[](/fast-load-data-to-sql-from-python-2d67aea946c0?source=post_page-----f82dfeb8e378--------------------------------) [## Python 到 SQL — 我现在可以快20倍地加载数据

### 上传大量数据的好坏丑方法

towardsdatascience.com](/fast-load-data-to-sql-from-python-2d67aea946c0?source=post_page-----f82dfeb8e378--------------------------------) [](/5-advanced-sql-techniques-for-real-life-projects-f2db9b6680e2?source=post_page-----f82dfeb8e378--------------------------------) [## 这5种 SQL 技巧涵盖了大约80%的实际项目

### 加速你的 SQL 学习曲线。

towardsdatascience.com](/5-advanced-sql-techniques-for-real-life-projects-f2db9b6680e2?source=post_page-----f82dfeb8e378--------------------------------)

从那时起，窗口函数成为了我最喜欢的工具，我在几乎每个分析项目中至少使用一次。这是因为我们经常需要在记录的上下文中进行计算。

本文是SQL中窗口函数的简单介绍。最重要的是，我们需要了解如何定义窗口以及我们在窗口上执行什么操作。

如果你打算跟随本文中的示例，让我们创建一个表并插入一些虚拟值。

[PRE3]

## SQL窗口函数的基础

这是一个查询，显示每个州每家商店的平均销售额和总销售额。

[PRE4]

[PRE5]

让我们仔细研究窗口函数。

![](../Images/eb6dfcda371a45a207d650ffbc49c455.png)

作者插图。

每个窗口函数都有这两个部分。我们在OVER关键字后定义窗口。在此示例中，我们仅使用州列对数据集进行分区。操作将在共享相同州的记录之间执行。

此外，你可以使用ORDER BY关键字重新排列窗口记录。以下查询使用它来获取每家商店在其州内的排名。

[PRE6]

[PRE7]

你可以使用[RANK](https://www.sqlshack.com/overview-of-sql-rank-functions/)或[ROW_NUMBER](https://www.simplilearn.com/tutorials/sql-tutorial/row-number-funtion-in-sql)代替[DENSE_RANK](https://learn.microsoft.com/en-us/sql/t-sql/functions/dense-rank-transact-sql?view=sql-server-ver16)。这三个关键字之间的区别在于它们处理平局的方式。

ROW_NUMBER会为平局分配一个顺序号，不重视平局。RANK会为平局分配相同的排名并跳过下一个。例如，如果两个商店的销售值相同，它们都会得到第1名。但是第2名会被跳过，下一个则得到第3名。DENSE_RANK也会为平局分配相同的编号，但不会跳过下一个编号。下一个记录将获得紧接着的排名。

## 我们可以使用窗口函数的有趣方法

窗口函数有许多令人兴奋的应用。正如我之前提到的，我在几乎每个SQL项目中都使用它。以下是我们可以使用窗口函数的一些常见方式。

由于我们已经在基础示例中查看了排名，这里不再重新讨论。但排名是窗口函数最常见的用例之一。

**1\. 计算累计总数**

我们也可能需要在有时间数据的地方计算累计总数。换句话说，我们应该将所有先前的值累加到某一点。

在我们的商店销售示例中，这可能是每家商店自年初以来每个月底的销售额。这是完成此任务的查询。

[PRE8]

[PRE9]

上述查询将按月份列对窗口中的记录进行排序。在任何月份，销售数据只会累积到该月份。

**2\. 与组统计数据比较。**

可能会有需要将每条记录与其组平均值进行比较的情况。例如，我们可能会对查看每个店铺的状态平均值感兴趣。

这是用于此的SQL查询。

[PRE10]

[PRE11]

**3\. 计算移动平均**

移动平均在处理时间序列数据时非常典型。移动平均通常比单个数据点噪声更小。你总是能在金融数据分析中看到它，比如股市数据。但我们也可以在任何领域找到类似的应用。

这是针对我们店铺销售数据的SQL查询。它计算了每个店铺的3点移动平均。

[PRE12]

[PRE13]

仔细观察我们如何定义窗口。除了通常出现的PARTITION BY和ORDER BY关键字，我们还使用了一些其他关键字。我们告诉SQL只考虑前2条记录和当前记录。通过更改参数，你甚至可以计算不同点的移动平均。

同样，你还可以计算**前瞻性移动平均**。以下是用于此的SQL查询：

[PRE14]

[PRE15]

## 结论

窗口函数在意识到它们的实用性后，已经成为我的最爱。因此，通过这篇文章，我分享了基础知识和一些常用的窗口函数应用。

但你可以通过窗口函数做更多的事情。虽然这篇博客文章没有广泛涉及，但基础知识应该能让你编写出精彩的SQL语句。

> 感谢阅读，朋友！如果你喜欢我的文章，欢迎在[**LinkedIn**](https://www.linkedin.com/in/thuwarakesh/)、[**Twitter**](https://twitter.com/Thuwarakesh)和[**Medium**](https://thuwarakesh.medium.com/)上保持联系。
> 
> 还不是Medium会员？请使用此链接[**成为会员**](https://thuwarakesh.medium.com/membership)，因为你无需额外付费，我可以通过推荐你获得少量佣金。
