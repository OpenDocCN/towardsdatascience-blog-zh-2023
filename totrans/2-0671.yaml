- en: Dates and Subqueries in SQL
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/dates-and-subqueries-in-sql-eaf58a3c6cf9](https://towardsdatascience.com/dates-and-subqueries-in-sql-eaf58a3c6cf9)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Working with dates in SQL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://mgcodesandstats.medium.com/?source=post_page-----eaf58a3c6cf9--------------------------------)[![Michael
    Grogan](../Images/af9ce19e2f61efb07664124e664c7e81.png)](https://mgcodesandstats.medium.com/?source=post_page-----eaf58a3c6cf9--------------------------------)[](https://towardsdatascience.com/?source=post_page-----eaf58a3c6cf9--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----eaf58a3c6cf9--------------------------------)
    [Michael Grogan](https://mgcodesandstats.medium.com/?source=post_page-----eaf58a3c6cf9--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----eaf58a3c6cf9--------------------------------)
    ·4 min read·Jan 27, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/cb2b6541ac41db27d9f3485efa264d94.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Source: Photo by [webandi](https://pixabay.com/users/webandi-1460261/) from
    [Pixabay](https://pixabay.com/photos/calendar-dates-schedule-days-1990453/)'
  prefs: []
  type: TYPE_NORMAL
- en: It is often the case that when working with a SQL database, one typically has
    to work with tables that contain a date column showing the date for each relevant
    record.
  prefs: []
  type: TYPE_NORMAL
- en: However, the ability of SQL to work with dates and yield valuable insights from
    such data types is often not well understood.
  prefs: []
  type: TYPE_NORMAL
- en: Weather Data Example
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let us consider the following example. Suppose there exists a weather database
    with recorded dates and relevant weather information in a table. Here is a snippet
    of the data:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/efbed3572df7cc1824766dab42d85521.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Source: Table (and data) created by author using PostgreSQL. Table displayed
    in pgAdmin4.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Also, let us suppose that a month variable has been defined in the table and
    the relevant values have been extracted from the table as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Now, for the purposes of ensuring that we have sufficient temperature records
    for each month and do not have too long a lag between records — let us assume
    that we would like to calculate the **average duration** between each consecutive
    record in the table, and group them by month.
  prefs: []
  type: TYPE_NORMAL
- en: 'This task will be accomplished by:'
  prefs: []
  type: TYPE_NORMAL
- en: Calculating the difference between each consecutive date using the LAG() function
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Using a subquery to calculate the average duration between each record that
    has been calculated in step 1, and then grouping them by month
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Calculate duration between dates
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: By using the LAG function, we can calculate the duration between each consecutive
    date. However, we would also like to display the date and month columns in the
    new table as well — we will need to use the month column when it comes to subsequently
    grouping the average duration by month.
  prefs: []
  type: TYPE_NORMAL
- en: 'To accomplish this, we must:'
  prefs: []
  type: TYPE_NORMAL
- en: Calculate the duration between dates by subtracting the difference between each
    consecutive date using the LAG function
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Inner join the relevant table to itself through the use of an INNER JOIN function
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This is done as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the generated table from the above query:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/7d194cc97f607f410e70baa3d0cdf7a4.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Source: Table (and data) created by author using PostgreSQL. Table displayed
    in pgAdmin4.'
  prefs: []
  type: TYPE_NORMAL
- en: We can see that for the weather data recorded last month — there is less than
    a day of duration for most entries — meaning that weather patterns are being recorded
    with regularity and we are likely obtaining a representative sample for that month!
  prefs: []
  type: TYPE_NORMAL
- en: Using subquery with a GROUP BY function
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Having calculated the above table, we now wish to calculate the average duration
    between recorded dates by month.
  prefs: []
  type: TYPE_NORMAL
- en: In order to do this using the data we have just generated above — we must now
    use a subquery. That is to say, we will be incorporating the above query into
    a broader aggregate query that can use the GROUP BY function.
  prefs: []
  type: TYPE_NORMAL
- en: 'To group the duration by month, the following query is run:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the generated data:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/e63a8fa1f690eefacbd412e3c1144959.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Source: Table (and data) created by author using PostgreSQL. Table displayed
    in pgAdmin4.'
  prefs: []
  type: TYPE_NORMAL
- en: From the above, we can see that across months 1–12 (January to December) — we
    have calculated the average duration between each recorded date for each month.
  prefs: []
  type: TYPE_NORMAL
- en: Conclusion
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In this article, you have seen:'
  prefs: []
  type: TYPE_NORMAL
- en: How to extract month values from dates
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to use the LAG function to calculate differences in duration between consecutive
    dates
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use of subqueries to allow for use of aggregate functions such as GROUP BY
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Many thanks for reading, and any questions or feedback are greatly appreciated!
    You can also find the original article [here](https://www.michael-grogan.com/articles/dates-subqueries),
    along with further examples of useful SQL practices.
  prefs: []
  type: TYPE_NORMAL
- en: '*Disclaimer: This article is written on an “as is” basis and without warranty.
    It was written with the intention of providing an overview of data science concepts,
    and should not be interpreted as professional advice. The findings and interpretations
    in this article are those of the author and are not endorsed by or affiliated
    with any third-party mentioned in this article. The author has no relationship
    with any third parties mentioned in this article.*'
  prefs: []
  type: TYPE_NORMAL
