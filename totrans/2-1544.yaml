- en: Multilevel Regression with R
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/multilevel-regression-with-r-eb3eb7d8de88](https://towardsdatascience.com/multilevel-regression-with-r-eb3eb7d8de88)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Understanding the Hierarchical Linear Models from this simple explanation with
    examples
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://gustavorsantos.medium.com/?source=post_page-----eb3eb7d8de88--------------------------------)[![Gustavo
    Santos](../Images/a19a9f4525cdeb6e7a76cd05246aa622.png)](https://gustavorsantos.medium.com/?source=post_page-----eb3eb7d8de88--------------------------------)[](https://towardsdatascience.com/?source=post_page-----eb3eb7d8de88--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----eb3eb7d8de88--------------------------------)
    [Gustavo Santos](https://gustavorsantos.medium.com/?source=post_page-----eb3eb7d8de88--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page-----eb3eb7d8de88--------------------------------)
    ·9 min read·May 15, 2023
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/df6a3d8f1bd84381780b225b2e4fde4c.png)'
  prefs: []
  type: TYPE_IMG
- en: Photo by [Lidya Nada](https://unsplash.com/@lidyanada?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)
    on [Unsplash](https://unsplash.com/photos/BnzqQwerUOY?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)
  prefs: []
  type: TYPE_NORMAL
- en: Introduction
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Regression models are out there for a long time now, much longer before Machine
    Learning was a thing. Statisticians have been using these models to understand
    the relationship between variables even before the 1900s, when Sir Francis Galton
    (1885) introduced the idea.
  prefs: []
  type: TYPE_NORMAL
- en: Fortunately, the theory has developed so much since then, and so have the computers
    and technology, up to the point that we can say that it is an easy (if not the
    easiest) model to create these days.
  prefs: []
  type: TYPE_NORMAL
- en: However, do not be fooled by its easiness to implement. It is easy, but not
    that simple. There are more than one kind of regression models available, not
    just Ordinary Least Squares (OLS).
  prefs: []
  type: TYPE_NORMAL
- en: The one we will talk about in this post is the Hierarchical Linear Model (HLM),
    or simply put, the **multilevel regression**.
  prefs: []
  type: TYPE_NORMAL
- en: Getting Ready
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Before we dive into the content, let’s get familiar with the dataset to be used
    in this example and the libraries we will need to code along.
  prefs: []
  type: TYPE_NORMAL
- en: Load the following libraries. Remembering that if you don’t have any of those
    installed, just use `install.packages("library_name")`.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The dataset **Gasoline** is available in many R libraries. For this example,
    it was accessed via library `nlme` from R, under the license GPL 2.0\. It is originally
    from *Prater, N. H. (1955), Estimate gasoline yields from crudes, Petroleum Refiner,
    35*.
  prefs: []
  type: TYPE_NORMAL
- en: 'This data frame has the variables:'
  prefs: []
  type: TYPE_NORMAL
- en: '`**yield**`: percentage of crude oil converted to gasoline'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`**endpoint**`: temperature (degrees F) at which all the gasoline is vaporized'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`**Sample**`: crude oil sample number'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`**API**`: crude oil gravity (degrees API)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`**vapor**`: the vapor pressure of the crude oil (lbf/in2 )'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`**ASTM**`: the temperature at which 10% of the crude oil has become vapor.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '***Objective****: our goal will be to predict the* `yield` *number, or how
    much of the oil will be converted to gasoline from a sample.*'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: A small review about OLS
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In the OLS regression model, we take one or more explanatory variables ***[X]***
    and try to use those numbers to explain the behavior of the subject measured by
    the response variable ***[y]***.
  prefs: []
  type: TYPE_NORMAL
- en: 'The best statistical test for feature selection for OLS is correlation. After
    all, one of the most used measures of how good the line fits the data is the R²,
    which is nothing more than the correlation squared (Side *note: there are other
    measures for model performance that should be used together with R², for sure*).'
  prefs: []
  type: TYPE_NORMAL
- en: Thus, we aim to draw a line that best fits the data. In other words, we want
    this line to go along with the data points, drawing sort of an average value for
    the response variable. Additionally, we want that the difference between the points
    in this line and the real data points will be the minimum possible.
  prefs: []
  type: TYPE_NORMAL
- en: Being a little more technical, the response variable will be determined by an
    equation where we want to optimize the values of an intercept point *alpha* on
    the y axis and the slope of this line, which is determined by the *beta* coefficient,
    just as described below.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/1307ccfe43864ef7936f7d958b745a8a.png)'
  prefs: []
  type: TYPE_IMG
- en: Equation of the Simple Linear Regression. Image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'If we look at our dataset, this is what the OLS model will do:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/0e215c86f732a90bcd6e3950d417a0cc.png)'
  prefs: []
  type: TYPE_IMG
- en: OLS Regression model created out of the Gasoline Dataset. Image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: It’s a good fit, but not the best model. It can somehow explain the variance
    of `yield`, but we can do much better, as we will see next.
  prefs: []
  type: TYPE_NORMAL
- en: Hierarchical Linear Models [HLM]
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An HLM differs from the traditional OLS models because it takes in consideration
    the natural grouping of the data.
  prefs: []
  type: TYPE_NORMAL
- en: Multilevel Regression is like creating one different regression model for each
    group in your data.
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'From our data, what immediately calls my attention is that there are different
    `Sample`. So, it raises the questions:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Would the different samples impact the estimate of yield?*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*If we add multiple levels of regression by sample, do we have better results?*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](../Images/d7c3c3d2ceb353c828a1b820e61c3bf6.png)'
  prefs: []
  type: TYPE_IMG
- en: Extract of the Gasoline dataset. Image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: Components
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The HLM models are composed of the fixed effects and the random effects components.
    The **fixed effects** can estimate the relationship between the X variables and
    y, while the **random effects** component will determine different coefficients
    for intercept and slope for each group, helping to create an estimate that is
    more appropriate for each group.
  prefs: []
  type: TYPE_NORMAL
- en: See below how it would look like the multilevel regression model.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/ca5204b24b00731e1e291072feead5cd.png)'
  prefs: []
  type: TYPE_IMG
- en: Multilevel model HLM2, with level 1= observation and level 2= Sample. Image
    by the author.
  prefs: []
  type: TYPE_NORMAL
- en: In practice, what happens is that a regression model is created to calculate
    the fixed component, which is a *y = a + bx* for each observation of each group.
    Then, in sequence, it is calculated the random component, that is an adjustment
    for more or less, according to the best intercept and/or slope for that group.
  prefs: []
  type: TYPE_NORMAL
- en: The HLM models can have random components varying only the intercept, only the
    slope, or both. In the previous figure, the random component is for both intercept
    and slope, given that the regression lines by sample are not parallel and have
    different intercept points.
  prefs: []
  type: TYPE_NORMAL
- en: Coding
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let’s now create an OLS model and an HLM with 2 levels and then compare the
    results.
  prefs: []
  type: TYPE_NORMAL
- en: We can run a correlation test to know the best variables to use for the regression,
    first. We’ll see that `endpoint` is the variable with the highest correlation
    with `yield`.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: The OLS model is pretty straightforward to be created in R. The native function
    `lm()` can handle that easily. Let’s see.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Results: The model is statistically significant (p-value for the F Test <0.05),
    and the coefficients are also significant.'
  prefs: []
  type: TYPE_NORMAL
- en: 'R²: 50%'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Loglik: -109.52'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'MAE: 5.95 (yield mean = 19.66)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'RMSE: 7.41 (standard deviation: 10.72)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Our main absolute error is about 30% of the mean value of *y*. It’s too much.
    Like we saw in the figure with the single regression line, the line is well positioned,
    but it can’t completely capture the variance, as there are many points that are
    too far away from the average.
  prefs: []
  type: TYPE_NORMAL
- en: Now let’s try running an HLM.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Here’s what’s going on in this code. We have ran a multilevel model using the
    function `lme` from the `nlme` library. The **fixed component** is the regression
    `yield ~ endpoint`. The **random component** is only for intercept. Notice that
    `random = ~1 | Sample`. The `~1` means fixed slope — or parallel regression lines
    by group — and random intercept calculated by `Sample`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Instead of a simple *y = a + bx,* this model becomes:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Fixed: [**intercept + b*endpoint**] +'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Random: [ **intercept random effect by Sample + error**]'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Comparing it to the OLS model, notice how it improved.
  prefs: []
  type: TYPE_NORMAL
- en: 'Loglik: -87.7153 (the higher the number, the better).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'MAE: 1.16'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'RMSE: 1.52'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Wow. It improved a lot already: around 20% improvement in the LogLik measure.'
  prefs: []
  type: TYPE_NORMAL
- en: '*Can we still improve it even more?* We can try to add another variable to
    the model. We will choose `vapor`, as it is the next strongest correlation with
    our response variable.'
  prefs: []
  type: TYPE_NORMAL
- en: This time, we will run an HLM with random component for slope and intercept,
    meaning we will allow our model to vary where it cross the y axis and how inclined
    is the fitted line, instead of leaving it static as parallel lines.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the code snippet below, we are calculating a fixed component (regression
    by observation, by Sample) of the `yield` in function of `endpoint` and `vapor`.
    The random component will calculate the slope of our regression based on the `endpoint`
    values and the intercept based on the `Sample`. This next model will be:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Fixed: [**intercept + (b1 * endpoint) + (b2 * vapor)**] +'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Random: [ **intercept random effect by Sample + slope random effect * endpoint
    + error**]'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Just so I won’t be unfair with the OLS model, I also ran another model with
    the vapor variable. Next, we will compare all the models.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/fb55d123301379e3f05aba3b70a1faea.png)'
  prefs: []
  type: TYPE_IMG
- en: Comparison of the 4 models created. Image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: Despite the model OLS with `endpoint+vapor` gave us an interesting LogLik value,
    let’s look it closer in the predictions to have a sense of which model is a better
    fit.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: The OLS model 2 did a very good job, but the multilevel regressions are more
    consistent. Look at the fitted values for rows 4, 5, 9, 10, 12, for example, where
    both multilevel models will give us better estimates. However, despite these errors,
    the OLS2 is not a bad model at all for this data.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/921c87916cb354748fb588beff3973cf.png)'
  prefs: []
  type: TYPE_IMG
- en: Comparison of the 4 models created. Image by the author.
  prefs: []
  type: TYPE_NORMAL
- en: This final visual can give us a nice comparative view of the models. No doubt
    that the best fit is the last HLM model on the bottom right corner.
  prefs: []
  type: TYPE_NORMAL
- en: Before You Go
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this tutorial, I wanted to give you a nice introduction to the Hierarchical
    Linear Models, or multilevel regression models. They can be very handy when you
    have data that is naturally nested in groups, and these groups will affect how
    the estimates will be done.
  prefs: []
  type: TYPE_NORMAL
- en: With Multilevel models, you can allow the regression lines to vary their slope
    and/or intercept by group.
  prefs: []
  type: TYPE_NORMAL
- en: The package to be used for modeling with HLM in R is the `nlme`.
  prefs: []
  type: TYPE_NORMAL
- en: Here is the code for this exercise, in GitHub.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/gurezende/Studying/tree/master/R/Multilevel%20Regression?source=post_page-----eb3eb7d8de88--------------------------------)
    [## Studying/R/Multilevel Regression at master · gurezende/Studying'
  prefs: []
  type: TYPE_NORMAL
- en: You can't perform that action at this time. You signed in with another tab or
    window. You signed out in another tab or…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/gurezende/Studying/tree/master/R/Multilevel%20Regression?source=post_page-----eb3eb7d8de88--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: If you liked this content, don’t forget to follow me.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://gustavorsantos.medium.com/?source=post_page-----eb3eb7d8de88--------------------------------)
    [## Gustavo Santos - Medium'
  prefs: []
  type: TYPE_NORMAL
- en: Read writing from Gustavo Santos on Medium. Data Scientist. I extract insights
    from data to help people and companies…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: gustavorsantos.medium.com](https://gustavorsantos.medium.com/?source=post_page-----eb3eb7d8de88--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Also, if you’re considering joining Medium as a member, so you can access my
    articles and thousands of other good content, [here’s my referral code for you](https://medium.com/@gustavorsantos/membership)
    .
  prefs: []
  type: TYPE_NORMAL
- en: You can find me on [LinkedIn](https://www.linkedin.com/in/gurezende/) and you
    can [book a quick chat with me via TopMate](https://topmate.io/gustavo_santos).
  prefs: []
  type: TYPE_NORMAL
- en: Reference
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[Fávero, L. & Belfiore, P. 2022\. *Manual de Análise de Dados*. 1 ed. LTC,
    Rio de Janeiro, Brazil.](https://www.amazon.com.br/Manual-An%C3%A1lise-Dados-Luiz-F%C3%A1vero/dp/8535270876)'
  prefs: []
  type: TYPE_NORMAL
