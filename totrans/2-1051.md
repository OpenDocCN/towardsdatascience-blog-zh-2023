# 在Colab上免费托管你的Google Earth Engine RESTful API

> 原文：[https://towardsdatascience.com/host-your-google-earth-engine-restful-apis-on-colab-for-free-3a95abc729d0](https://towardsdatascience.com/host-your-google-earth-engine-restful-apis-on-colab-for-free-3a95abc729d0)

## 使用FastAPI和ngrok

[](https://dgg32.medium.com/?source=post_page-----3a95abc729d0--------------------------------)[![黄四兴](../Images/48f445636ed1e32a53b610f6afc93ef2.png)](https://dgg32.medium.com/?source=post_page-----3a95abc729d0--------------------------------)[](https://towardsdatascience.com/?source=post_page-----3a95abc729d0--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page-----3a95abc729d0--------------------------------) [黄四兴](https://dgg32.medium.com/?source=post_page-----3a95abc729d0--------------------------------)

·发表于[Towards Data Science](https://towardsdatascience.com/?source=post_page-----3a95abc729d0--------------------------------) ·阅读时长8分钟·2023年1月6日

--

![](../Images/5ed2171b29624898c3a85015cd02aad1.png)

图片由[NASA](https://unsplash.com/@nasa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)提供，[Unsplash](https://unsplash.com/images/nature/earth?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)上的照片

地理空间数据的需求一直很高。它揭示了我们星球随时间变化的情况。当我们谈到地理空间时，我们会想到[Google Earth Engine](https://earthengine.google.com/) (GEE)。该服务有几个优势。它托管了跨度超过37年的大量数据集合。所有计算都在谷歌强大的云基础设施上运行。更重要的是，对于非营利项目，它是免费的。通过GEE，我们可以免费研究[土地利用和土地覆盖](https://medium.com/geekculture/monitor-land-use-changes-with-google-earth-engine-65cd15e10c6c) (LULC)、[植被](https://medium.com/p/909a2ad51a48)、本地气候（[这里](https://medium.com/p/c6aa77fecdb1)和[这里](https://medium.com/p/ae21261854d6)），甚至[美国的农作物生产](https://medium.com/p/9cfd14813e99)。

然而，GEE确实有较高的门槛。首先，必须精通JavaScript或Python。其次，我们需要熟悉许多地理空间概念，如图像集合、几何体和卫星波段。第三，它的异步请求-响应模式对于新手来说需要一些时间来适应。

这对许多数据科学家来说是一个小挑战。大多数情况下，他们只希望快速获得一组坐标的某些值，例如土壤pH值或平均地表温度。截止目前，他们需要进行相当多的编码，因为GEE没有提供RESTful API。如果我们能自己填补这个空白岂不是很好（视频1）？我们的API应该封装一些常见的GEE计算，并提供互联网HTTP访问。

![](../Images/9632d01b74d6d2de04831c9114b171c8.png)

视频1\. 使用FastAPI在Google Colab上创建的Google Earth Engine API。视频由作者提供。

让我们在本文中完成它。我选择了[FastAPI](https://fastapi.tiangolo.com/)来完成这项工作。这个流行的库允许我们用Python构建高性能的API，Python是GEE中的两种服务语言之一。Google Colab是首选的平台。Colab不仅与GEE无缝集成，而且在[ngrok](https://ngrok.com/)的帮助下，还可以通过HTTP公开提供API（视频1）。在本文中，我将描述两个API的构建。其中一个返回土地温度，另一个计算给定坐标集的土壤pH值。之后，我将演示如何使用这些API从[BacDive](https://bacdive.dsmz.de/)获取一些细菌的元数据。

这里定义了API。

[](https://colab.research.google.com/drive/1BNsFLHA_ISC7sDSLF4-znBNY9YSIUbh1?usp=sharing&source=post_page-----3a95abc729d0--------------------------------) [## Google Colaboratory GEE APIs

colab.research.google.com](https://colab.research.google.com/drive/1BNsFLHA_ISC7sDSLF4-znBNY9YSIUbh1?usp=sharing&source=post_page-----3a95abc729d0--------------------------------)

这是一个Python应用程序，它通过我们的GEE API在BacDive中验证数据。

[](https://colab.research.google.com/drive/12NXlV6Q8Qrs6hLqEIeEmQ1cm_CElCkOB?usp=sharing&source=post_page-----3a95abc729d0--------------------------------) [## Google Colaboratory BacDive

colab.research.google.com](https://colab.research.google.com/drive/12NXlV6Q8Qrs6hLqEIeEmQ1cm_CElCkOB?usp=sharing&source=post_page-----3a95abc729d0--------------------------------)

# 1\. Google Earth Engine API与FastAPI和ngrok的结合

首先，你需要一个[Google Earth Engine账户](https://earthengine.google.com/signup/)和一个[ngrok账户](https://dashboard.ngrok.com/signup)。在你的账户页面找到ngrok的Authtoken（图1）。

![](../Images/a08e0958258bc02ef0ba8277a41d01f9.png)

图1\. 将Authtoken存储在你的ngrok账户页面。图片由作者提供。

## 1.1 初始化

创建一个Colab笔记本。在库导入后，让我们初始化GEE和ngrok。首先，按照Google的说明进行身份验证和初始化GEE（第1和第2行）。之后，`input`函数会提示你输入ngrok的Authtoken（第3行）。将你的Authtoken粘贴到输入框中并确认。然后，代码将在第4行授权你的ngrok实例。

[PRE0]

## 1.2 GEE封装函数

接下来，我们可以创建一些封装函数来封装GEE交互。

[PRE1]

一般来说，GEE将测量结果存储在图像中。某些测量，例如海拔和土壤pH，只做了一次，它们被存储在单个图像中。相比之下，其他测量，如土壤温度和降水量，是周期性进行的，因此它们被存储在图像集合中。两个函数`generate_collection`（第1-3行）和`generate_image`（第14-15行）分别返回图像集合和单个图像。接下来，我们想获取目标区域的平均测量值（第5-12行 & 第17-18行）。

## 1.3 FastAPI

现在是时候在我们的笔记本中设置FastAPI了。

[PRE2]

在这个代码块中，我们首先初始化一个FastAPI应用。然后定义了三个路由：根路由，`land-surface-temperature`和`soil-ph`。在后两个路由中，我们使用了第1.2节中的函数来请求GEE中的测量值。温度值来自于`MOD11A1.061 Terra Land Surface Temperature and Emissivity Daily Global 1km`数据集（[MODIS数据和产品在LP DAAC中获取，无后续使用、销售或再分发的限制](https://developers.google.com/earth-engine/datasets/catalog/MODIS_061_MOD11A1#terms-of-use)），而pH值由`OpenLandMap Soil pH in H2O`数据集提供（[CC-BY-SA-4.0](https://spdx.org/licenses/CC-BY-SA-4.0.html)）。

## 1.4 ngrok

现在让我们开始API服务。这里的代码借鉴自[一个回答](https://stackoverflow.com/questions/63833593/how-to-run-fastapi-uvicorn-in-google-colab)在stackoverflow.com上。

[PRE3]

代码将生成一个端点URL并继续运行（视频1）。

## 1.5 测试

我们现在可以测试服务。点击端点URL，你将看到根路由的“hello world”消息（视频1）。

令人惊讶的是，FastAPI会自动生成文档。你可以在`/redoc`路由下访问它（图2）。

![](../Images/08a40f14f1cd561d1d59ed5f5052617f.png)

图2\. 文档由FastAPI准备。图片由作者提供。

让我们测试`land-surface-temperature` API。在URL中的“？”标记后，将所需参数编码为键值对。例如，以下查询字符串允许我们获取2020年1月1日到2020年5月1日（52.72389418745157, -92.03593750000002）的地表温度。

[PRE4]

![](../Images/67d871616cf004a5ced9da477a3fbd67.png)

图3\. 2020年1月1日到2020年5月1日（52.72389418745157, -92.03593750000002）的地表温度。图片由作者提供。

请注意，返回的值是以开尔文为单位的（图3）。

`soil-ph` API的工作原理类似。但它不需要采样周期。因此，以下查询字符串可以单独请求相同坐标对的土壤pH值（视频1）。

[PRE5]

# 2\. 比较BacDive的实验室结果与GEE的野外元数据

[**BacDive**](https://bacdive.dsmz.de/)数据库由DSMZ创建，收集了关于细菌分离株的信息，包括其生长温度、pH值和代谢特征。请注意，它几乎所有的信息都是在实验室中生成的。微生物在野外的行为很可能有所不同。

最近，[**BacDive**](https://bacdive.dsmz.de/)已集成了[**Microbeatlas**](https://microbeatlas.org/)。嵌入的[Microbeatlas](https://microbeatlas.org/)地图显示了许多细菌16S序列的全球分布（图4）。

![](../Images/3ca372d78a44bc5fd86a86239ab39ea8.png)

图4\. [BacDive](https://bacdive.dsmz.de/strain/132485)与[Microbeatlas](https://microbeatlas.org/)。作者提供的图片。

这个交叉验证非常棒。现在，研究人员不仅可以了解细菌在实验室中的行为（BacDive），还可以了解它们在全球范围内的分布（Microbeatlas）。但我们可以做得更多。我们可以从新推出的GEE APIs中收集野外的元数据，并将其与BacDive的实验室结果进行比较。这种比较可以向我们展示细菌在实验室和野外的生活是否有所不同。

以细菌[*Rhodopseudomonas palustris* R1](https://bacdive.dsmz.de/strain/1822)为例。它的Microbeatlas [页面](https://microbeatlas.org/index.html?action=taxon&taxon_id=90_86%3B96_297%3B97_329%3B98_429%3B99_5209&stattab=map) 显示该细菌可以在长长的样本列表中找到（图5）。

![](../Images/079c61d1fec73eca2a0212f2c271cd8a.png)

图5\. 根据[Microbeatlas](https://microbeatlas.org/index.html?action=taxon&taxon_id=90_86%3B96_297%3B97_329%3B98_429%3B99_5209&stattab=map)，全球范围内的[*Rhodopseudomonas palustris* R1](https://bacdive.dsmz.de/strain/1822)分布。作者提供的图片。

截至2023年1月5日，[Microbeatlas](https://microbeatlas.org/)中的`DOWNLOAD`按钮无法使用。因此，我使用“soil”关键词过滤了这些样本。然后我检查了前几个样本，并选择了那些具有完整位置和时间数据的样本（表1）。

表1\. 五个样本[*Rhodopseudomonas palustris* R1](https://bacdive.dsmz.de/strain/1822)丰富存在的土壤。

使用以下Python代码，我们可以获取这些样本的土地温度和pH值（也可以在我上面的Colab链接中找到）。

[PRE6]

结果见表2。

表2\. 根据GEE的五个样本的温度和pH值。

一方面，这些前五个样本的温度值范围为11至19°C，远低于BacDive中显示的28–30°C的生长温度。另一方面，BacDive没有记录该细菌的生长pH值。但我们的结果表明，[*Rhodopseudomonas palustris* R1](https://bacdive.dsmz.de/strain/1822)在酸性土壤中丰富存在，从而填补了BacDive中的信息空白。

# 结论

本文展示了使用 FastAPI 和 ngrok 在 Colab 上为 GEE 原型化自己的 RESTful API 是多么简单。只需几行代码，我们就可以在互联网上免费设置功能完善的 API。现在我们可以通过简单的 URL 请求 GEE 的地理空间结果。希望这些 API 也能吸引更多用户和研究人员使用 GEE。我在本文中仅展示了两个 API。我鼓励你为你的项目构建更多的 API。你也可以修改查询字符串的设计。但请注意，这种设置并不具备可扩展性。在生产环境中，我们最好将 API 部署到 [Deta](https://www.deta.sh/?ref=fastapi) 或其他云基础设施上。

正如你在 BacDive 部分看到的，这些简单的 API 非常有用。我们使用它们填补了 BacDive 中的信息空白。但为何止步于此呢？例如，我们可以对全球微生物 DNA 进行测序，并将结果与 GEE 元数据结合。这些分析可能揭示有助于或限制某些微生物传播的环境因素。这些知识可以帮助我们对抗传染病和遏制疫情。

*来自 BacDive 的数据采用* [*知识共享 4.0 国际许可证*](http://creativecommons.org/licenses/by/4.0/)*。*

[## 通过我的推荐链接加入 Medium - 黄思行](https://dgg32.medium.com/membership?source=post_page-----3a95abc729d0--------------------------------)

### 作为 Medium 会员，你的会员费的一部分将用于支持你阅读的作者，你还可以完全访问每一个故事…

[dgg32.medium.com](https://dgg32.medium.com/membership?source=post_page-----3a95abc729d0--------------------------------)
